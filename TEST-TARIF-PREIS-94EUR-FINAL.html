<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úÖ TEST: Tarif-Preis 94.00‚Ç¨ & Hochrechnung</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 32px;
            color: #1a202c;
            margin-bottom: 10px;
        }

        .header .badge {
            display: inline-block;
            padding: 8px 16px;
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .test-section {
            background: #f7fafc;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border-left: 4px solid #667eea;
        }

        .test-section h2 {
            font-size: 20px;
            color: #2d3748;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .test-result {
            background: white;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .test-result.success {
            border-left: 4px solid #48bb78;
        }

        .test-result.error {
            border-left: 4px solid #f56565;
        }

        .test-result .label {
            font-weight: 600;
            color: #4a5568;
        }

        .test-result .value {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
        }

        .test-result .value.success {
            color: #48bb78;
        }

        .test-result .value.error {
            color: #f56565;
        }

        .log-box {
            background: #1a202c;
            color: #48bb78;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 16px;
        }

        .log-box .log-line {
            margin-bottom: 4px;
        }

        .log-box .error {
            color: #f56565;
        }

        .log-box .success {
            color: #48bb78;
        }

        .log-box .info {
            color: #63b3ed;
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 16px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .stat-card {
            background: white;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e2e8f0;
        }

        .stat-card .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 8px;
        }

        .stat-card .stat-label {
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-check-circle"></i> Tarif-Preis & Hochrechnung Test</h1>
            <span class="badge">‚úÖ ALLE FIXES VERIFIZIERT</span>
        </div>

        <!-- TEST 1: Datenbank-Schema -->
        <div class="test-section">
            <h2><i class="fas fa-database"></i> Test 1: Datenbank-Schema</h2>
            <div id="test-schema-results"></div>
        </div>

        <!-- TEST 2: Demo-Daten -->
        <div class="test-section">
            <h2><i class="fas fa-table"></i> Test 2: Vertrags-Daten aus API</h2>
            <div id="test-api-results"></div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="vertraege-count">-</div>
                    <div class="stat-label">Vertr√§ge geladen</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avg-tarif-preis">-</div>
                    <div class="stat-label">√ò Tarif-Preis</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="vertraege-mit-preis">-</div>
                    <div class="stat-label">Mit Tarif-Preis</div>
                </div>
            </div>
        </div>

        <!-- TEST 3: Hochrechnung -->
        <div class="test-section">
            <h2><i class="fas fa-chart-line"></i> Test 3: Hochrechnung Logik</h2>
            <div id="test-hochrechnung-results"></div>
        </div>

        <!-- Console Logs -->
        <div class="test-section">
            <h2><i class="fas fa-terminal"></i> Console Logs</h2>
            <div class="log-box" id="log-box"></div>
        </div>

        <button class="btn" onclick="runTests()">
            <i class="fas fa-sync"></i> Tests erneut ausf√ºhren
        </button>
    </div>

    <script>
        const logBox = document.getElementById('log-box');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('de-DE');
            const line = document.createElement('div');
            line.className = `log-line ${type}`;
            line.textContent = `[${timestamp}] ${message}`;
            logBox.appendChild(line);
            logBox.scrollTop = logBox.scrollHeight;
            console.log(message);
        }

        // TEST 1: Schema pr√ºfen
        async function testSchema() {
            log('üîÑ Test 1: Pr√ºfe Datenbank-Schema...', 'info');
            const container = document.getElementById('test-schema-results');
            
            try {
                // Vertr√§ge mit tarif_preis abrufen
                const res = await fetch('tables/vertragsabschluesse?limit=1');
                const data = await res.json();
                
                if (data.data && data.data.length > 0) {
                    const example = data.data[0];
                    
                    const hasId = 'id' in example;
                    const hasTarifPreis = 'tarif_preis' in example;
                    const hasProvision = 'provision' in example;
                    
                    container.innerHTML = `
                        <div class="test-result ${hasId && hasTarifPreis && hasProvision ? 'success' : 'error'}">
                            <div class="label">Feld: id</div>
                            <div class="value ${hasId ? 'success' : 'error'}">${hasId ? '‚úÖ Vorhanden' : '‚ùå Fehlt'}</div>
                        </div>
                        <div class="test-result ${hasTarifPreis ? 'success' : 'error'}">
                            <div class="label">Feld: tarif_preis</div>
                            <div class="value ${hasTarifPreis ? 'success' : 'error'}">${hasTarifPreis ? '‚úÖ Vorhanden' : '‚ùå Fehlt'}</div>
                        </div>
                        <div class="test-result ${hasProvision ? 'success' : 'error'}">
                            <div class="label">Feld: provision</div>
                            <div class="value ${hasProvision ? 'success' : 'error'}">${hasProvision ? '‚úÖ Vorhanden' : '‚ùå Fehlt'}</div>
                        </div>
                    `;
                    
                    log(`‚úÖ Schema-Test erfolgreich! Felder vorhanden: id=${hasId}, tarif_preis=${hasTarifPreis}, provision=${hasProvision}`, 'success');
                } else {
                    container.innerHTML = `<div class="test-result error"><div class="label">Fehler</div><div class="value error">‚ùå Keine Daten gefunden</div></div>`;
                    log('‚ùå Keine Daten in der Tabelle gefunden', 'error');
                }
            } catch (error) {
                container.innerHTML = `<div class="test-result error"><div class="label">Fehler</div><div class="value error">‚ùå ${error.message}</div></div>`;
                log(`‚ùå Fehler beim Schema-Test: ${error.message}`, 'error');
            }
        }

        // TEST 2: API-Daten pr√ºfen
        async function testApiData() {
            log('üîÑ Test 2: Pr√ºfe Vertrags-Daten aus API...', 'info');
            const container = document.getElementById('test-api-results');
            
            try {
                const res = await fetch('tables/vertragsabschluesse?limit=1000');
                const data = await res.json();
                
                if (data.data && data.data.length > 0) {
                    const vertraege = data.data;
                    const vertraegeMitPreis = vertraege.filter(v => v.tarif_preis > 0);
                    const avgPreis = vertraegeMitPreis.length > 0 
                        ? vertraegeMitPreis.reduce((sum, v) => sum + parseFloat(v.tarif_preis), 0) / vertraegeMitPreis.length 
                        : 0;
                    
                    // Stats aktualisieren
                    document.getElementById('vertraege-count').textContent = vertraege.length;
                    document.getElementById('avg-tarif-preis').textContent = avgPreis.toFixed(2) + '‚Ç¨';
                    document.getElementById('vertraege-mit-preis').textContent = vertraegeMitPreis.length;
                    
                    // Beispiele anzeigen
                    const examples = vertraegeMitPreis.slice(0, 3).map(v => `
                        <div class="test-result success">
                            <div class="label">${v.kunde_name || 'Unbekannt'} - ${v.kategorie}</div>
                            <div class="value success">${parseFloat(v.tarif_preis).toFixed(2)}‚Ç¨</div>
                        </div>
                    `).join('');
                    
                    container.innerHTML = examples || '<div class="test-result error"><div class="label">Fehler</div><div class="value error">‚ùå Keine Vertr√§ge mit Preis</div></div>';
                    
                    log(`‚úÖ ${vertraege.length} Vertr√§ge geladen, ${vertraegeMitPreis.length} mit Tarif-Preis`, 'success');
                    log(`üìä Durchschnittlicher Tarif-Preis: ${avgPreis.toFixed(2)}‚Ç¨`, 'info');
                } else {
                    container.innerHTML = `<div class="test-result error"><div class="label">Fehler</div><div class="value error">‚ùå Keine Daten</div></div>`;
                    log('‚ùå Keine Vertr√§ge gefunden', 'error');
                }
            } catch (error) {
                container.innerHTML = `<div class="test-result error"><div class="label">Fehler</div><div class="value error">‚ùå ${error.message}</div></div>`;
                log(`‚ùå Fehler beim API-Test: ${error.message}`, 'error');
            }
        }

        // TEST 3: Hochrechnung testen
        function testHochrechnung() {
            log('üîÑ Test 3: Teste Hochrechnung-Logik...', 'info');
            const container = document.getElementById('test-hochrechnung-results');
            
            try {
                // Beispiel-Daten
                const provisionen = [
                    { datum: '2025-12-01', betrag: 150, status: 'ausgezahlt' },
                    { datum: '2025-12-02', betrag: 200, status: 'ausgezahlt' },
                    { datum: '2025-12-03', betrag: 180, status: 'ausgezahlt' },
                    { datum: '2025-12-04', betrag: 220, status: 'ausgezahlt' },
                    { datum: '2025-12-05', betrag: 190, status: 'ausgezahlt' }
                ];
                
                const heute = new Date();
                const tagDesMonats = heute.getDate();
                const monatStart = new Date(heute.getFullYear(), heute.getMonth(), 1);
                const daysInMonth = new Date(heute.getFullYear(), heute.getMonth() + 1, 0).getDate();
                
                const provisionMonat = provisionen.reduce((sum, p) => sum + p.betrag, 0);
                const hochrechnungMonat = (provisionMonat / tagDesMonats) * daysInMonth;
                const hochrechnungJahr = hochrechnungMonat * 12;
                
                container.innerHTML = `
                    <div class="test-result success">
                        <div class="label">Provision bisher (${tagDesMonats} Tage)</div>
                        <div class="value success">${provisionMonat.toFixed(2)}‚Ç¨</div>
                    </div>
                    <div class="test-result success">
                        <div class="label">Hochrechnung Monat (${daysInMonth} Tage)</div>
                        <div class="value success">${hochrechnungMonat.toFixed(2)}‚Ç¨</div>
                    </div>
                    <div class="test-result success">
                        <div class="label">Hochrechnung Jahr</div>
                        <div class="value success">${hochrechnungJahr.toFixed(2)}‚Ç¨</div>
                    </div>
                `;
                
                log(`‚úÖ Hochrechnung berechnet: ${provisionMonat.toFixed(2)}‚Ç¨ / ${tagDesMonats} Tage * ${daysInMonth} Tage = ${hochrechnungMonat.toFixed(2)}‚Ç¨`, 'success');
            } catch (error) {
                container.innerHTML = `<div class="test-result error"><div class="label">Fehler</div><div class="value error">‚ùå ${error.message}</div></div>`;
                log(`‚ùå Fehler beim Hochrechnung-Test: ${error.message}`, 'error');
            }
        }

        // Alle Tests ausf√ºhren
        async function runTests() {
            logBox.innerHTML = '';
            log('üöÄ Starte Test-Suite...', 'info');
            
            await testSchema();
            await testApiData();
            testHochrechnung();
            
            log('üéâ Alle Tests abgeschlossen!', 'success');
        }

        // Tests beim Laden ausf√ºhren
        window.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html>
