<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#3b82f6">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Admin Dashboard - DeinCheck</title>
    <link rel="icon" type="image/png" href="images/favicon-admin.png">
    <link rel="apple-touch-icon" href="images/favicon-admin.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/mobile-app.css">
    <script src="js/local-persistence.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ APPLE-STYLE ADMIN DASHBOARD - PREMIUM DESIGN 2026
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Premium Apple Color Palette */
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --success-light: #34d399;
            --warning: #f59e0b;
            --warning-light: #fbbf24;
            --danger: #ef4444;
            --danger-light: #f87171;
            --info: #0ea5e9;
            
            /* Text Colors */
            --text: #1e293b;
            --text-secondary: #475569;
            --text-light: #64748b;
            --text-muted: #94a3b8;
            
            /* Backgrounds */
            --bg: #f8fafc;
            --bg-subtle: #f1f5f9;
            --white: #ffffff;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-glow: 0 0 40px rgba(99, 102, 241, 0.15);
            
            /* Sidebar */
            --sidebar-width: 280px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: var(--text);
            min-height: 100vh;
        }
        
        /* Smooth Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-subtle);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        /* ğŸ“± MOBILE HEADER - STANDARD VERSTECKT (Desktop) */
        .mobile-header {
            display: none;
        }
        
        /* ğŸ“± MOBILE OVERLAY */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .sidebar-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ¯ SIDEBAR - PREMIUM GLASS DESIGN
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: linear-gradient(180deg, #ffffff 0%, #fafbfc 100%);
            border-right: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.04);
            z-index: 1000;
            overflow-y: auto;
            overflow-x: hidden;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
            position: relative;
            overflow: hidden;
        }
        
        .sidebar-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 0.875rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            position: relative;
            z-index: 1;
        }

        .sidebar-logo-icon {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.35rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar-logo-text {
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-logo-text span:first-child {
            font-size: 1.1rem;
            font-weight: 800;
            letter-spacing: -0.5px;
        }
        
        .sidebar-logo-text span:last-child {
            font-size: 0.7rem;
            font-weight: 500;
            opacity: 0.85;
            letter-spacing: 0.5px;
        }

        /* Sidebar Navigation */
        .sidebar-nav {
            padding: 1rem 0;
            padding-bottom: 100px;
        }

        .nav-section {
            margin-bottom: 0.5rem;
        }

        .nav-section-title {
            padding: 1rem 1.5rem 0.5rem;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-muted);
            letter-spacing: 1px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.875rem;
            padding: 0.75rem 1.5rem;
            margin: 0.125rem 0.75rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 12px;
            position: relative;
        }

        .nav-item:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: var(--primary);
            transform: translateX(4px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.35), 0 2px 4px rgba(99, 102, 241, 0.2);
        }
        
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 60%;
            background: white;
            border-radius: 0 4px 4px 0;
            opacity: 0.6;
        }

        .nav-item i {
            font-size: 1.1rem;
            width: 22px;
            text-align: center;
            transition: transform 0.2s;
        }
        
        .nav-item:hover i {
            transform: scale(1.1);
        }

        .nav-item span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Nav Badge */
        .nav-badge {
            margin-left: auto;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--danger) 0%, var(--danger-light) 100%);
            color: white;
            min-width: 20px;
            text-align: center;
        }

        /* Legacy .tabs/.tab Styles fÃ¼r KompatibilitÃ¤t */
        .tabs {
            padding: 0.75rem 0;
        }

        .tab {
            display: flex;
            align-items: center;
            gap: 0.875rem;
            padding: 0.75rem 1.5rem;
            margin: 0.125rem 0.75rem;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-secondary);
            border: none;
            background: transparent;
            border-radius: 12px;
            width: calc(100% - 1.5rem);
            text-align: left;
        }

        .tab:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: var(--primary);
            transform: translateX(4px);
        }

        .tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.35);
        }

        .tab i {
            font-size: 1.1rem;
            width: 22px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ¯ MAIN CONTENT AREA
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .main-content {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ¯ TOP BAR - GLASS MORPHISM
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .topbar {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(226, 232, 240, 0.6);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .topbar-left h1 {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--text);
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .topbar-left h1 i {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .topbar-btn {
            padding: 0.65rem 1.25rem;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.875rem;
        }
        
        .topbar-btn:hover {
            transform: translateY(-2px);
        }

        .btn-logout {
            background: linear-gradient(135deg, var(--danger) 0%, var(--danger-light) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.25);
        }

        .btn-logout:hover {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.35);
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
        }

        /* Container */
        .container {
            max-width: 100%;
            padding: 2rem;
            animation: fadeIn 0.4s ease-out;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ“± MOBILE RESPONSIVE
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @media (max-width: 968px) {
            .sidebar {
                transform: translateX(-100%);
                max-height: 100vh;
                height: 100vh;
                overflow-y: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
                position: fixed !important;
                z-index: 9999 !important;
                box-shadow: 4px 0 30px rgba(0, 0, 0, 0.2);
            }

            .sidebar.active,
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .sidebar-nav {
                padding-bottom: 150px !important;
            }
            
            .sidebar {
                padding-bottom: env(safe-area-inset-bottom, 0px);
            }

            .main-content {
                margin-left: 0;
                position: relative;
                z-index: 1;
            }

            .topbar {
                padding: 1rem;
                position: sticky;
                top: 0;
                z-index: 100;
            }

            .topbar-left h1 {
                font-size: 1.25rem;
            }

            .container {
                padding: 1rem;
            }
            
            .sidebar-overlay {
                display: block;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(15, 23, 42, 0.6);
                backdrop-filter: blur(4px);
                z-index: 9998;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s;
            }
            
            .sidebar-overlay.active {
                opacity: 1;
                pointer-events: all;
            }
        }
        
        .sidebar-overlay {
            display: none;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ´ CARDS - PREMIUM GLASS DESIGN
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 1.75rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06), 0 1px 3px rgba(0, 0, 0, 0.04);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04);
            transform: translateY(-2px);
        }

        .card-title {
            font-size: 1.15rem;
            font-weight: 700;
            margin-bottom: 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text);
            letter-spacing: -0.3px;
        }
        
        .card-title i {
            margin-right: 10px;
            color: var(--primary);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ“ FORMS - MODERN INPUTS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.25rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }
        
        .form-group label i {
            margin-right: 6px;
            color: var(--primary);
            font-size: 0.8rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 0.95rem;
            font-family: inherit;
            background: var(--white);
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }
        
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--text-muted);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ”˜ BUTTONS - PREMIUM GRADIENTS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: inherit;
            text-decoration: none;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(99, 102, 241, 0.35);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.45);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-light) 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(16, 185, 129, 0.35);
        }

        .btn-success:hover {
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.45);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(100, 116, 139, 0.25);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #475569 0%, #64748b 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, var(--danger-light) 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(239, 68, 68, 0.35);
        }

        .btn-danger:hover {
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.45);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, var(--warning-light) 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(245, 158, 11, 0.35);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--border);
            color: var(--text-secondary);
        }
        
        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ“Š TABLES - PREMIUM DESIGN
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 1rem;
        }

        .data-table th {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 1rem;
            text-align: left;
            font-weight: 700;
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .data-table th:first-child {
            border-radius: 12px 0 0 0;
        }
        
        .data-table th:last-child {
            border-radius: 0 12px 0 0;
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-light);
            font-size: 0.9rem;
            color: var(--text);
            vertical-align: middle;
        }

        .data-table tr {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .data-table tbody tr:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }
        
        .data-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .data-table tbody tr:last-child td:first-child {
            border-radius: 0 0 0 12px;
        }
        
        .data-table tbody tr:last-child td:last-child {
            border-radius: 0 0 12px 0;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ·ï¸ BADGES - PREMIUM PILL DESIGN
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .badge {
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: default;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        /* Status Badges */
        .badge-neu-eingegangen {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
            color: white;
            animation: badge-pulse 2s ease-in-out infinite;
        }

        .badge-in-pruefung {
            background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%);
            color: white;
        }

        .badge-aktiviert {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
        }

        .badge-abgelehnt {
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            color: white;
        }

        .badge-ausstehend {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            color: white;
        }

        .badge-ausgezahlt {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
        }

        .badge-storniert {
            background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%);
            color: white;
        }

        /* Legacy Badges */
        .badge-success {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
        }

        .badge-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            color: white;
        }

        .badge-danger {
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            color: white;
        }

        .badge-info {
            background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%);
            color: white;
        }

        @keyframes badge-pulse {
            0%, 100% { 
                box-shadow: 0 2px 8px rgba(236, 72, 153, 0.3), 0 0 0 0 rgba(236, 72, 153, 0.5); 
            }
            50% { 
                box-shadow: 0 4px 12px rgba(236, 72, 153, 0.4), 0 0 0 6px rgba(236, 72, 153, 0); 
            }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ’¬ MESSAGES
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .success-message {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 1px solid #86efac;
            color: #166534;
            padding: 1rem 1.25rem;
            border-radius: 14px;
            margin-bottom: 1.25rem;
            display: none;
            font-weight: 500;
        }

        .error-message {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 1px solid #fca5a5;
            color: #991b1b;
            padding: 1rem 1.25rem;
            border-radius: 14px;
            margin-bottom: 1.25rem;
            display: none;
            font-weight: 500;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ“ˆ STATS GRID - GLASSMORPHISM
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.25rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 1.5rem;
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.08) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(30%, -30%);
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 2.25rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0.5rem 0;
            letter-spacing: -1px;
        }

        .stat-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ“‹ KANBAN / TASK MANAGEMENT
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .kanban-column {
            background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 16px;
            padding: 1rem;
            min-height: 400px;
            border: 1px solid var(--border-light);
        }

        .kanban-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            background: var(--white);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .kanban-title {
            font-weight: 700;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text);
        }

        .task-card {
            background: var(--white);
            border-radius: 14px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 4px solid transparent;
            border: 1px solid var(--border-light);
        }

        .task-card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            transform: translateY(-3px);
        }

        .task-card.priority-hoch {
            border-left-color: var(--danger);
        }

        .task-card.priority-mittel {
            border-left-color: var(--warning);
        }

        .task-card.priority-niedrig {
            border-left-color: var(--success);
        }

        .task-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 8px;
            color: var(--text);
        }

        .task-description {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .task-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
            font-size: 12px;
        }

        .task-assigned {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: var(--bg);
            padding: 4px 8px;
            border-radius: 6px;
            color: var(--primary);
            font-weight: 600;
        }

        .task-date {
            color: var(--text-light);
        }

        .task-date.overdue {
            color: var(--danger);
            font-weight: 600;
        }

        .project-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--white);
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary);
        }

        .close-btn {
            font-size: 28px;
            cursor: pointer;
            color: var(--text-light);
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: var(--danger);
        }

        .comment-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--border);
        }

        .comment-item {
            background: var(--bg);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .comment-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        .comment-text {
            font-size: 14px;
            color: var(--text);
        }

        @media (max-width: 968px) {
            html, body {
                overflow-x: hidden !important;
                max-width: 100vw !important;
            }

            .admin-header {
                padding: 15px;
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .tabs {
                overflow-x: auto;
                white-space: nowrap;
                padding: 15px;
                -webkit-overflow-scrolling: touch;
            }

            .tab {
                flex-shrink: 0;
            }

            .container {
                padding: 15px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 12px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .data-table {
                font-size: 14px;
                overflow-x: auto;
                display: block;
            }

            .kanban-board {
                grid-template-columns: 1fr;
                overflow-x: visible;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
                max-width: calc(100vw - 20px);
            }

            nav {
                padding: 15px !important;
            }

            #benachrichtigungDropdown {
                width: 300px !important;
                right: -50px;
            }
        }

        /* ğŸ“± TABLET-Ansicht (768px - 968px): 2 Spalten fÃ¼r Stat-Cards */
        @media (max-width: 968px) and (min-width: 641px) {
            .stats-grid[style*="repeat(4, 1fr)"] {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }

        @media (max-width: 640px) {
            .admin-header h1 {
                font-size: 18px;
            }

            .tabs {
                padding: 10px;
            }

            .tab {
                padding: 10px 15px;
                font-size: 13px;
            }
            
            /* ğŸ“± MOBILE-Ansicht (< 640px): 2 Spalten fÃ¼r Stat-Cards */
            .stats-grid[style*="repeat(4, 1fr)"] {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            
            /* Stat-Cards: GrÃ¶ÃŸere Touch-Targets auf Mobile */
            .stat-card {
                min-height: 100px;
                padding: 20px !important;
            }
            
            .stat-value {
                font-size: 28px !important;
            }
            
            .stat-label {
                font-size: 13px !important;
            }
            
            /* Buttons: GrÃ¶ÃŸere Touch-Targets */
            .btn {
                min-height: 44px;
                padding: 12px 20px !important;
                font-size: 14px !important;
            }
            
            /* Sortierungs-Dropdowns: GrÃ¶ÃŸer auf Mobile */
            select {
                min-height: 44px;
                font-size: 14px !important;
            }
            
            /* Card-Title: Flex-Direction column auf Mobile */
            .card-title {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 12px;
            }
            
            .card-title > div {
                width: 100%;
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            /* Hochrechnung Widget: 2 Spalten statt 4 */
            .card[style*="background: linear-gradient(135deg, #3b82f6"] > div[style*="grid-template-columns: repeat(4, 1fr)"] {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            
            /* Filter-Cards: 1 Spalte */
            .card > div[style*="grid-template-columns: repeat(auto-fit"] {
                grid-template-columns: 1fr !important;
            }
            
            /* ğŸ“± FILTER KOMPAKT AUF MOBILE */
            .form-group {
                margin-bottom: 12px !important;
            }
            
            .form-group label {
                font-size: 12px !important;
                margin-bottom: 4px !important;
            }
            
            .card {
                padding: 15px !important;
                margin-bottom: 15px !important;
            }
            
            /* Info-Box kompakter */
            .card > div[style*="background: linear-gradient(135deg, #3b82f6"] {
                padding: 12px 15px !important;
                margin-bottom: 15px !important;
            }
            
            /* Tables kompakter */
            .data-table th,
            .data-table td {
                padding: 8px 4px !important;
                font-size: 12px !important;
            }
            
            /* Stat-Cards kompakter */
            .stats-grid {
                gap: 10px !important;
                margin-bottom: 12px !important;
            }
            
            /* Akkordeon kompakter */
            .card > div[style*="border: 2px solid"] {
                margin-bottom: 10px !important;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-value {
                font-size: 24px;
            }

            .btn {
                padding: 10px 15px;
                font-size: 14px;
            }

            #benachrichtigungDropdown {
                width: 280px !important;
                right: -100px;
            }
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ“± KOMPLETTE MOBILE CSS FÃœR ADMIN-PORTAL
           Ãœberschreibt ALLE inline-styles mit !important
           Identisch zum Partner-Dashboard
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @media screen and (max-width: 968px) {
            /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               BASIS - HTML/BODY
               â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
            html, body {
                overflow-y: auto !important;
                overflow-x: hidden !important;
                -webkit-overflow-scrolling: touch !important;
                height: auto !important;
                min-height: 100vh !important;
                min-height: 100dvh !important;
                width: 100% !important;
                max-width: 100vw !important;
            }
            
            body {
                padding-top: calc(60px + env(safe-area-inset-top, 0px)) !important;
            }

            /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               MOBILE HEADER - FIXIERT, GROSS, SICHTBAR
               â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
            .mobile-header {
                display: flex !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                height: calc(65px + env(safe-area-inset-top, 0px)) !important;
                min-height: 65px !important;
                padding: env(safe-area-inset-top, 0px) 16px 0 16px !important;
                background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%) !important;
                align-items: center !important;
                justify-content: space-between !important;
                z-index: 99999 !important;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15) !important;
                transform: translateZ(0) !important;
                -webkit-transform: translateZ(0) !important;
                backface-visibility: hidden !important;
                -webkit-backface-visibility: hidden !important;
            }
            
            .mobile-header-center {
                flex: 1 !important;
                text-align: center !important;
                padding: 0 10px !important;
            }
            
            .mobile-header-title {
                font-size: 18px !important;
                font-weight: 700 !important;
                color: white !important;
                text-shadow: 0 1px 2px rgba(0,0,0,0.1) !important;
            }
            
            .mobile-header-user {
                font-size: 12px !important;
                color: rgba(255,255,255,0.9) !important;
                margin-top: 2px !important;
            }
            
            /* MENU BUTTON - GROSS UND SICHTBAR */
            .mobile-menu-btn {
                width: 50px !important;
                height: 50px !important;
                min-width: 50px !important;
                min-height: 50px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                background: rgba(255,255,255,0.25) !important;
                border: 2px solid rgba(255,255,255,0.3) !important;
                border-radius: 14px !important;
                color: white !important;
                font-size: 24px !important;
                cursor: pointer !important;
                -webkit-tap-highlight-color: transparent !important;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2) !important;
                transition: all 0.2s ease !important;
            }
            
            .mobile-menu-btn:active {
                transform: scale(0.95) !important;
                background: rgba(255,255,255,0.35) !important;
            }
            
            /* LOGOUT BUTTON */
            .mobile-logout-btn {
                width: 50px !important;
                height: 50px !important;
                min-width: 50px !important;
                min-height: 50px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                background: rgba(239,68,68,0.9) !important;
                border: none !important;
                border-radius: 14px !important;
                color: white !important;
                font-size: 20px !important;
                cursor: pointer !important;
                -webkit-tap-highlight-color: transparent !important;
                box-shadow: 0 4px 12px rgba(239,68,68,0.3) !important;
            }
            
            .mobile-logout-btn:active {
                transform: scale(0.95) !important;
            }

            /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               TOPBAR - VERSTECKEN
               â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
            .topbar {
                display: none !important;
            }

            /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               SIDEBAR - SLIDE IN
               â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
            .sidebar {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                bottom: 0 !important;
                width: 280px !important;
                max-width: 85vw !important;
                height: 100vh !important;
                height: 100dvh !important;
                transform: translateX(-100%) !important;
                transition: transform 0.3s ease !important;
                z-index: 10001 !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
                -webkit-overflow-scrolling: touch !important;
                padding-bottom: 0 !important;
                background: white !important;
            }
            
            .sidebar.mobile-open {
                transform: translateX(0) !important;
            }
            
            .sidebar-overlay {
                display: block !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                background: rgba(0,0,0,0.5) !important;
                z-index: 10000 !important;
                opacity: 0 !important;
                pointer-events: none !important;
                transition: opacity 0.3s !important;
            }
            
            .sidebar-overlay.active {
                opacity: 1 !important;
                pointer-events: all !important;
            }

            /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               SIDEBAR NAVIGATION - MOBILE (WIE PARTNER)
               â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
            .sidebar-nav {
                padding: 0.5rem 0 !important;
                padding-bottom: env(safe-area-inset-bottom, 20px) !important;
            }
            
            .nav-section {
                margin-bottom: 0.25rem !important;
            }
            
            .nav-section-title {
                padding: 0.4rem 1rem 0.2rem !important;
                font-size: 0.65rem !important;
                color: #a0aec0 !important;
            }
            
            .nav-item {
                padding: 0.6rem 1rem !important;
                font-size: 0.85rem !important;
                min-height: 42px !important;
                gap: 0.6rem !important;
            }
            
            .nav-item.active {
                margin: 0 0.5rem !important;
                border-radius: 8px !important;
            }
            
            .nav-item i {
                font-size: 0.95rem !important;
                width: 18px !important;
            }

            /* Legacy .tabs/.tab fÃ¼r KompatibilitÃ¤t */
            .tabs {
                padding: 0.5rem 0 !important;
                padding-bottom: env(safe-area-inset-bottom, 20px) !important;
            }
            
            .tab {
                padding: 0.6rem 1rem !important;
                font-size: 0.85rem !important;
                min-height: 42px !important;
                margin: 2px 0.5rem !important;
                border-radius: 8px !important;
                display: flex !important;
                align-items: center !important;
                gap: 0.6rem !important;
            }
            
            .tab i {
                font-size: 0.95rem !important;
                width: 18px !important;
            }
            


            /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               MAIN CONTENT
               â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
            .main-content {
                margin-left: 0 !important;
                width: 100% !important;
                min-width: 100% !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
                -webkit-overflow-scrolling: touch !important;
                height: auto !important;
                min-height: 100vh !important;
                padding-bottom: 100px !important;
            }
            
            .container {
                padding: 12px !important;
                max-width: 100% !important;
                width: 100% !important;
            }

            /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               TAB CONTENTS - Alle Bereiche
               â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
            .tab-content,
            [id^="tab-"],
            #tab-dashboard,
            #tab-interessenten,
            #tab-aufgaben,
            #tab-partner-verwaltung,
            #tab-all-in-one,
            #tab-umsatz,
            #tab-email,
            #tab-news,
            #tab-provisionen,
            #tab-akademie,
            #tab-partner-programm,
            #tab-kommunikation {
                overflow-y: auto !important;
                overflow-x: hidden !important;
                -webkit-overflow-scrolling: touch !important;
                max-height: none !important;
                height: auto !important;
                padding-bottom: 80px !important;
            }
            
            /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               TABELLEN - HORIZONTAL SCROLLBAR
               â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
            /* Cards mit Tabellen bekommen overflow */
            .card {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            .data-table {
                min-width: 700px !important;
                width: 100% !important;
            }
            
            .data-table th,
            .data-table td {
                white-space: nowrap !important;
                padding: 10px 8px !important;
                font-size: 12px !important;
            }
            
            /* Explizite Scroll-Container */
            div[style*="overflow-x: auto"],
            div[style*="overflow-x:auto"] {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
                max-width: 100% !important;
            }

            /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               STATS GRID - 2 SPALTEN
               â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
            .stats-grid,
            div.stats-grid,
            [class*="stats-grid"] {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }
            
            /* Alle inline grid-template-columns Ã¼berschreiben */
            [style*="grid-template-columns: repeat(4"],
            [style*="grid-template-columns: repeat(auto-fit, minmax(250px"],
            [style*="grid-template-columns: repeat(auto-fit, minmax(200px"],
            div[style*="display: grid"][style*="repeat(4"],
            div[style*="display: grid"][style*="minmax(250px"],
            div[style*="display: grid"][style*="minmax(200px"] {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }
            
            .stat-card,
            .stats-grid > div,
            [class*="stat-card"] {
                padding: 14px !important;
                border-radius: 12px !important;
                min-height: auto !important;
            }
            
            .stat-value,
            .stat-card-value,
            [class*="stat-value"] {
                font-size: 1.3rem !important;
            }
            
            .stat-label,
            .stat-card-title,
            [class*="stat-label"] {
                font-size: 11px !important;
            }
            
            .stat-change {
                font-size: 10px !important;
            }

            /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               CARDS
               â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
            .card,
            div.card,
            [class*="card"]:not(.stat-card) {
                padding: 14px !important;
                margin-bottom: 14px !important;
                border-radius: 12px !important;
                overflow: hidden !important;
            }
            
            .card-title {
                flex-wrap: wrap !important;
                gap: 10px !important;
                font-size: 0.95rem !important;
                padding: 12px !important;
                margin: -14px -14px 14px -14px !important;
            }

            /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               GRIDS - Verschiedene GrÃ¶ÃŸen
               â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
            /* Filter Grids */
            [style*="grid-template-columns: repeat(auto-fit, minmax(180px"],
            [style*="grid-template-columns: repeat(auto-fit, minmax(150px"],
            div[style*="display: grid"][style*="minmax(180px"],
            div[style*="display: grid"][style*="minmax(150px"] {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }
            
            /* Chart Grids - 1 Spalte */
            [style*="grid-template-columns: repeat(auto-fit, minmax(400px"],
            [style*="grid-template-columns: repeat(auto-fit, minmax(300px"],
            div[style*="display: grid"][style*="minmax(400px"],
            div[style*="display: grid"][style*="minmax(300px"] {
                display: grid !important;
                grid-template-columns: 1fr !important;
                gap: 14px !important;
            }
            
            /* Span 2 -> Span 1 */
            [style*="grid-column: span 2"],
            .card[style*="grid-column: span 2"],
            div[style*="grid-column: span 2"] {
                grid-column: span 1 !important;
            }

            /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               TABELLEN - Horizontal scrollbar
               â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
            [style*="overflow-x: auto"],
            .table-container,
            div[style*="overflow-x"] {
                width: 100% !important;
                max-width: 100% !important;
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
                border-radius: 10px !important;
            }
            
            table {
                min-width: 700px !important;
                font-size: 12px !important;
                border-collapse: collapse !important;
            }
            
            th, td {
                padding: 10px 6px !important;
                white-space: nowrap !important;
            }
            
            th {
                font-size: 11px !important;
                font-weight: 600 !important;
            }

            /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               BUTTONS - Touch-freundlich
               â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
            button,
            .btn,
            [class*="btn"],
            input[type="submit"],
            input[type="button"] {
                min-height: 44px !important;
                font-size: 13px !important;
                padding: 10px 14px !important;
                border-radius: 10px !important;
                -webkit-tap-highlight-color: transparent !important;
            }
            
            /* Kleine Icon-Buttons */
            button[style*="padding: 8px"],
            button[style*="padding: 10px"] {
                min-height: 40px !important;
                min-width: 40px !important;
            }

            /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               INPUTS - iOS Zoom verhindern
               â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
            input,
            select,
            textarea {
                font-size: 16px !important;
                min-height: 44px !important;
                padding: 10px 12px !important;
                border-radius: 10px !important;
                width: 100% !important;
                box-sizing: border-box !important;
            }
            
            input[type="date"],
            input[type="time"],
            input[type="datetime-local"] {
                min-height: 44px !important;
            }
            
            label {
                font-size: 12px !important;
                margin-bottom: 4px !important;
                display: block !important;
            }

            /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               MODALS
               â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
            .modal,
            [id*="modal"],
            div[style*="position: fixed"][style*="z-index"] {
                padding: 10px !important;
                align-items: flex-start !important;
                padding-top: 60px !important;
            }
            
            .modal-content,
            .modal > div,
            [id*="modal"] > div {
                width: 100% !important;
                max-width: 100% !important;
                max-height: 85vh !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch !important;
                border-radius: 16px !important;
                margin: 0 !important;
                padding: 16px !important;
            }
            
            .modal h2,
            .modal h3,
            [id*="modal"] h2,
            [id*="modal"] h3 {
                font-size: 1.1rem !important;
            }

            /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               FLEX CONTAINER - Responsive
               â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
            [style*="display: flex"][style*="gap"],
            div[style*="display: flex"][style*="justify-content: space-between"] {
                flex-wrap: wrap !important;
                gap: 10px !important;
            }
            
            /* Buttons nebeneinander -> untereinander bei wenig Platz */
            [style*="display: flex"][style*="gap"] > button,
            div[style*="display: flex"] > button {
                flex: 1 1 auto !important;
                min-width: 100px !important;
            }

            /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               HEADINGS
               â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
            h1 { font-size: 1.4rem !important; }
            h2 { font-size: 1.2rem !important; }
            h3 { font-size: 1rem !important; }
            h4 { font-size: 0.9rem !important; }
            
            [style*="font-size: 28px"],
            [style*="font-size: 24px"] {
                font-size: 1.2rem !important;
            }
            
            [style*="font-size: 32px"],
            [style*="font-size: 36px"] {
                font-size: 1.4rem !important;
            }

            /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               PADDING/MARGIN - Kompakter
               â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
            [style*="padding: 35px"],
            [style*="padding: 30px"],
            [style*="padding: 2rem"] {
                padding: 16px !important;
            }
            
            [style*="padding: 24px"],
            [style*="padding: 20px"],
            [style*="padding: 1.5rem"] {
                padding: 14px !important;
            }
            
            [style*="margin-bottom: 30px"],
            [style*="margin-bottom: 32px"] {
                margin-bottom: 16px !important;
            }
            
            [style*="margin-bottom: 24px"],
            [style*="margin-bottom: 20px"] {
                margin-bottom: 14px !important;
            }
            
            [style*="gap: 20px"],
            [style*="gap: 24px"] {
                gap: 12px !important;
            }
            
            [style*="gap: 15px"],
            [style*="gap: 16px"] {
                gap: 10px !important;
            }

            /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               SPEZIFISCHE BEREICHE
               â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
            /* Hero Section */
            #tab-dashboard > div:first-child {
                padding: 16px !important;
                border-radius: 12px !important;
                margin-bottom: 14px !important;
            }
            
            #tab-dashboard > div:first-child h2 {
                font-size: 1.2rem !important;
                margin-bottom: 6px !important;
            }
            
            #tab-dashboard > div:first-child p {
                font-size: 13px !important;
            }
            
            /* Listen mit begrenzter HÃ¶he */
            #schnellzugriff-vertraege-list,
            #partner-aktivitaeten-list,
            #interessenten-liste,
            #partner-table-body,
            [id*="-list"],
            [id*="-liste"] {
                max-height: 350px !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            /* Benachrichtigungs-Dropdown */
            #benachrichtigungDropdown {
                width: 90vw !important;
                max-width: 300px !important;
                right: 0 !important;
                left: auto !important;
                max-height: 70vh !important;
                overflow-y: auto !important;
            }
            
            /* Partner-Verwaltung Buttons */
            #tab-partner-verwaltung [style*="display: flex"][style*="gap"] {
                flex-direction: column !important;
            }
            
            #tab-partner-verwaltung [style*="display: flex"][style*="gap"] > button {
                width: 100% !important;
            }
            
            /* Akkordeon Items */
            [style*="border: 2px solid"],
            [style*="border: 1px solid"][style*="border-radius"] {
                margin-bottom: 10px !important;
                border-radius: 10px !important;
            }

            /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               STATUS BADGES
               â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
            [style*="padding: 4px 12px"][style*="border-radius"],
            [style*="padding: 6px 14px"][style*="border-radius"],
            .status-badge,
            [class*="badge"] {
                font-size: 10px !important;
                padding: 4px 8px !important;
                border-radius: 6px !important;
                white-space: nowrap !important;
            }

            /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               ICONS
               â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
            [style*="width: 45px"][style*="height: 45px"],
            [style*="width: 50px"][style*="height: 50px"],
            [style*="width: 60px"][style*="height: 60px"] {
                width: 40px !important;
                height: 40px !important;
                min-width: 40px !important;
            }
            
            [style*="width: 45px"] i,
            [style*="width: 50px"] i,
            [style*="width: 60px"] i {
                font-size: 16px !important;
            }
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           KLEINE HANDYS (< 400px)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @media screen and (max-width: 400px) {
            .stats-grid,
            [style*="grid-template-columns: repeat(2"],
            [style*="grid-template-columns: repeat(4"] {
                grid-template-columns: 1fr !important;
            }
            
            .stat-value,
            .stat-card-value {
                font-size: 1.1rem !important;
            }
            
            h1 { font-size: 1.2rem !important; }
            h2 { font-size: 1rem !important; }
            
            .container {
                padding: 10px !important;
            }
            
            button, .btn {
                font-size: 12px !important;
                padding: 8px 12px !important;
            }
            
            /* Filter untereinander */
            [style*="grid-template-columns: repeat(auto-fit, minmax(180px"],
            [style*="grid-template-columns: repeat(auto-fit, minmax(150px"] {
                grid-template-columns: 1fr !important;
            }
        }
        
        /* Toast Animations */
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
    
    <!-- ğŸ“± MOBILE CSS AM ENDE -->
    <link rel="stylesheet" href="css/mobile-app.css">
    
    <!-- ğŸ“± MOBILE FUNKTIONEN - MUSS IM HEAD SEIN! -->
    <script>
    window.isMobile = function() { return window.innerWidth <= 968; };
    
    window.toggleMobileSidebar = function() {
        var sidebar = document.getElementById('sidebar');
        var overlay = document.getElementById('sidebar-overlay');
        var icon = document.getElementById('mobile-menu-icon');
        if (!sidebar) return;
        
        if (sidebar.classList.contains('mobile-open')) {
            window.closeMobileSidebar();
        } else {
            sidebar.classList.add('mobile-open');
            if (overlay) overlay.classList.add('active');
            if (icon) { icon.classList.remove('fa-bars'); icon.classList.add('fa-times'); }
            document.body.style.overflow = 'hidden';
        }
    };
    
    window.closeMobileSidebar = function() {
        var sidebar = document.getElementById('sidebar');
        var overlay = document.getElementById('sidebar-overlay');
        var icon = document.getElementById('mobile-menu-icon');
        if (sidebar) sidebar.classList.remove('mobile-open');
        if (overlay) overlay.classList.remove('active');
        if (icon) { icon.classList.remove('fa-times'); icon.classList.add('fa-bars'); }
        document.body.style.overflow = '';
    };
    
    window.setupMobileUI = function() {
        // Nur Sidebar schlieÃŸen wenn nicht mehr mobil - CSS steuert den Header!
        if (!window.isMobile()) {
            window.closeMobileSidebar();
        }
    };
    
    document.addEventListener('DOMContentLoaded', window.setupMobileUI);
    window.addEventListener('resize', window.setupMobileUI);
    </script>
</head>
<body>
    <!-- ğŸ“± MOBILE HEADER - PER CSS GESTEUERT, NICHT INLINE -->
    <div class="mobile-header" id="mobile-header">
        <button class="mobile-menu-btn" onclick="window.toggleMobileSidebar()" type="button" aria-label="MenÃ¼ Ã¶ffnen">
            <i class="fas fa-bars" id="mobile-menu-icon"></i>
        </button>
        <div class="mobile-header-center">
            <div class="mobile-header-title">Admin Portal</div>
            <div class="mobile-header-user">Administrator</div>
        </div>
        <button class="mobile-logout-btn" onclick="logout()" type="button" title="Abmelden" aria-label="Abmelden">
            <i class="fas fa-sign-out-alt"></i>
        </button>
    </div>
    
    <!-- ğŸ“± MOBILE OVERLAY -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="window.closeMobileSidebar()"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <span>Admin Portal</span>
            </div>
        </div>

        <!-- Sidebar Navigation - WIE PARTNER-DASHBOARD STRUKTUR -->
        <nav class="sidebar-nav">
            <!-- Dashboard -->
            <div class="nav-section">
                <div class="nav-item active tab" onclick="switchTab('dashboard')">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </div>
            </div>

            <!-- Verwaltung -->
            <div class="nav-section">
                <div class="nav-section-title">Verwaltung</div>
                <div class="nav-item tab" onclick="switchTab('interessenten')">
                    <i class="fas fa-inbox"></i>
                    <span>Neue Anfragen</span>
                </div>
                <div class="nav-item tab" onclick="switchTab('aufgaben')">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Aufgaben & Projekte</span>
                </div>
                <div class="nav-item tab" onclick="switchTab('partner-verwaltung')">
                    <i class="fas fa-users"></i>
                    <span>Partner-Verwaltung</span>
                </div>
            </div>

            <!-- Finanzen -->
            <div class="nav-section">
                <div class="nav-section-title">Finanzen</div>
                <div class="nav-item tab" onclick="switchTab('all-in-one')">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Provisionen & VertrÃ¤ge</span>
                </div>
            </div>

            <!-- Training & Support -->
            <div class="nav-section">
                <div class="nav-section-title">Training</div>
                <div class="nav-item tab" onclick="switchTab('akademie')">
                    <i class="fas fa-graduation-cap"></i>
                    <span>Akademie</span>
                </div>
            </div>

            <!-- Marketing & Partner -->
            <div class="nav-section">
                <div class="nav-section-title">Marketing</div>
                <div class="nav-item tab" onclick="switchTab('partner-programm')">
                    <i class="fas fa-handshake"></i>
                    <span>Partner-Programm</span>
                </div>
            </div>

            <!-- Kommunikation -->
            <div class="nav-section">
                <div class="nav-section-title">Kommunikation</div>
                <div class="nav-item tab" onclick="switchTab('kommunikation')">
                    <i class="fas fa-comments"></i>
                    <span>Chat</span>
                </div>
                <div class="nav-item tab" onclick="switchTab('email')">
                    <i class="fas fa-envelope"></i>
                    <span>E-Mail</span>
                </div>
                <div class="nav-item tab" onclick="switchTab('news')">
                    <i class="fas fa-bullhorn"></i>
                    <span>News</span>
                </div>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div class="topbar">
            <div class="topbar-left">
                <h1 id="page-title">Neue Anfragen</h1>
            </div>
            <div class="topbar-right">
                <!-- Benachrichtigungs-Bell -->
                <div style="position: relative;">
                    <button onclick="toggleBenachrichtigungen()" style="padding: 10px; background: white; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; position: relative; transition: all 0.2s;">
                        <i class="fas fa-bell" style="font-size: 18px; color: #3b82f6;"></i>
                        <span id="benachrichtigungBadge" style="position: absolute; top: -5px; right: -5px; background: rgb(245, 101, 101); color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; font-weight: 700; display: none; align-items: center; justify-content: center;">0</span>
                    </button>
                    
                    <!-- Benachrichtigungs-Dropdown -->
                    <div id="benachrichtigungDropdown" style="display: none; position: absolute; top: 60px; right: 0; background: white; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); width: 400px; max-height: 500px; overflow-y: auto; z-index: 9999;">
                        <div style="padding: 15px; border-bottom: 2px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0; font-size: 16px; color: #2d3748;">ğŸ”” Benachrichtigungen</h3>
                            <button onclick="alleAlsGelesenMarkieren()" style="background: none; border: none; color: #3b82f6; font-size: 12px; cursor: pointer; font-weight: 600;">Alle als gelesen</button>
                        </div>
                        <div id="benachrichtigungListe" style="max-height: 400px; overflow-y: auto;">
                            <div style="padding: 30px; text-align: center; color: #718096;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i><br>
                                Lade Benachrichtigungen...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Logout Button -->
                <button class="topbar-btn btn-logout" onclick="window.location.href='index.html'">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <!-- Container -->
        <div class="container">
        <!-- ğŸ  Tab: Dashboard Ãœbersicht -->
        <div class="tab-content active" id="tab-dashboard">
            <!-- Hero Section -->
            <div style="background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); padding: 35px; border-radius: 16px; margin-bottom: 30px; color: white;">
                <h2 style="margin: 0 0 10px 0; font-size: 28px; font-weight: 700;">Willkommen im Admin Dashboard</h2>
                <p style="margin: 0; font-size: 16px; opacity: 0.95;">Ãœbersicht Ã¼ber alle wichtigen Kennzahlen und AktivitÃ¤ten</p>
            </div>

            <!-- 6 Key Metrics (mit HEUTE, GESTERN, WOCHE, MONAT, HOCHRECHNUNG) -->
            <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 30px;">
                <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">Provision Heute</div>
                    <div class="stat-value" style="color: white;" id="dash-today">0â‚¬</div>
                    <div class="stat-change" style="color: rgba(255,255,255,0.85);"><i class="fas fa-calendar-day"></i> <span id="dash-today-count">0 VertrÃ¤ge</span></div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white;">
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">Provision Gestern</div>
                    <div class="stat-value" style="color: white;" id="dash-yesterday">0â‚¬</div>
                    <div class="stat-change" style="color: rgba(255,255,255,0.85);"><i class="fas fa-calendar-minus"></i> <span id="dash-yesterday-count">0 VertrÃ¤ge</span></div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: white;">
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">Provision Woche</div>
                    <div class="stat-value" style="color: white;" id="dash-week">0â‚¬</div>
                    <div class="stat-change" style="color: rgba(255,255,255,0.85);"><i class="fas fa-calendar-week"></i> <span id="dash-week-count">0 VertrÃ¤ge</span></div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #ed8936, #dd6b20); color: white;">
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">Provision Monat</div>
                    <div class="stat-value" style="color: white;" id="dash-umsatz">0â‚¬</div>
                    <div class="stat-change" style="color: rgba(255,255,255,0.85);"><i class="fas fa-chart-line"></i> Aktueller Monat</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4299e1, #3182ce); color: white;">
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">VertrÃ¤ge (Monat)</div>
                    <div class="stat-value" style="color: white;" id="dash-vertraege">0</div>
                    <div class="stat-change" style="color: rgba(255,255,255,0.85);"><i class="fas fa-file-contract"></i> Dieser Monat</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">Hochrechnung Monat</div>
                    <div class="stat-value" style="color: white;" id="dash-prognose-monat">0â‚¬</div>
                    <div class="stat-change" style="color: rgba(255,255,255,0.85);"><i class="fas fa-calculator"></i> Ã˜ <span id="dash-avg-per-day">0â‚¬</span>/Tag</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                <button onclick="switchTab('interessenten')" style="padding: 18px; background: white; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; text-align: left; transition: all 0.2s; font-family: inherit;">
                    <div style="font-size: 24px; margin-bottom: 8px;">ğŸ“¥</div>
                    <div style="font-weight: 600; color: #2d3748; margin-bottom: 4px;">Anfragen</div>
                    <div style="font-size: 12px; color: #718096;">Neue Leads bearbeiten</div>
                </button>
                <button onclick="switchTab('partner-verwaltung')" style="padding: 18px; background: white; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; text-align: left; transition: all 0.2s; font-family: inherit;">
                    <div style="font-size: 24px; margin-bottom: 8px;">ğŸ‘¥</div>
                    <div style="font-weight: 600; color: #2d3748; margin-bottom: 4px;">Partner</div>
                    <div style="font-size: 12px; color: #718096;">Partner verwalten</div>
                </button>
                <button onclick="switchTab('vertraege')" style="padding: 18px; background: white; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; text-align: left; transition: all 0.2s; font-family: inherit;">
                    <div style="font-size: 24px; margin-bottom: 8px;">ğŸ“„</div>
                    <div style="font-weight: 600; color: #2d3748; margin-bottom: 4px;">VertrÃ¤ge</div>
                    <div style="font-size: 12px; color: #718096;">VertrÃ¤ge Ã¼berprÃ¼fen</div>
                </button>
                <button onclick="switchTab('news')" style="padding: 18px; background: white; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; text-align: left; transition: all 0.2s; font-family: inherit;">
                    <div style="font-size: 24px; margin-bottom: 8px;">ğŸ“¢</div>
                    <div style="font-weight: 600; color: #2d3748; margin-bottom: 4px;">News</div>
                    <div style="font-size: 12px; color: #718096;">News erstellen</div>
                </button>
            </div>
            
            <!-- âš¡ NEUE VERTRÃ„GE - SCHNELLZUGRIFF -->
            <div class="card" style="margin-bottom: 30px;">
                <div class="card-title" style="background: linear-gradient(135deg, #48bb78, #38a169); color: white; margin: -24px -24px 20px -24px; padding: 20px 24px; border-radius: 12px 12px 0 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-bolt" style="font-size: 24px;"></i>
                            <span style="font-size: 1.2rem; font-weight: 700;">Neue VertrÃ¤ge - Schnellzugriff</span>
                        </div>
                        <span id="neue-vertraege-count" style="background: rgba(255,255,255,0.3); padding: 6px 14px; border-radius: 50px; font-weight: 700; backdrop-filter: blur(10px);">0</span>
                    </div>
                </div>
                
                <!-- ğŸ” FILTER FÃœR SCHNELLZUGRIFF (NUR DATUM + KATEGORIE) -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px; padding: 0 4px;">
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #4a5568; font-weight: 600;">
                            <i class="fas fa-calendar"></i> Von Datum
                        </label>
                        <input type="date" id="schnell-von-datum" onchange="loadSchnellzugriffVertraege()" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#48bb78'" onblur="this.style.borderColor='#e2e8f0'">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #4a5568; font-weight: 600;">
                            <i class="fas fa-calendar"></i> Bis Datum
                        </label>
                        <input type="date" id="schnell-bis-datum" onchange="loadSchnellzugriffVertraege()" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#48bb78'" onblur="this.style.borderColor='#e2e8f0'">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #4a5568; font-weight: 600;">
                            <i class="fas fa-tags"></i> Kategorie
                        </label>
                        <select id="schnell-kategorie-filter" onchange="loadSchnellzugriffVertraege()" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#48bb78'" onblur="this.style.borderColor='#e2e8f0'">
                            <option value="alle">Alle Kategorien</option>
                            <option value="mobilfunk">Mobilfunk</option>
                            <option value="dsl_internet">DSL/Internet</option>
                            <option value="strom">Strom</option>
                            <option value="gas">Gas</option>
                            <option value="versicherung">Versicherung</option>
                        </select>
                    </div>
                </div>
                
                <!-- â„¹ï¸ INFO: Zeigt nur neue und zu prÃ¼fende VertrÃ¤ge -->
                <div style="background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
                    <i class="fas fa-info-circle" style="font-size: 20px;"></i>
                    <span style="font-size: 14px; font-weight: 500;">Hier werden nur VertrÃ¤ge mit Status <strong>"Neu eingegangen"</strong> und <strong>"In PrÃ¼fung"</strong> angezeigt. <strong style="text-decoration: underline; cursor: pointer;" onclick="window.springZuVertraege('alle')">â†’ Alle VertrÃ¤ge anzeigen</strong></span>
                </div>
                
                <div id="schnellzugriff-vertraege-list" style="max-height: 500px; overflow-y: auto;">
                    <div style="text-align: center; padding: 40px; color: #a0aec0;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 15px;"></i>
                        <p>Lade neue VertrÃ¤ge...</p>
                    </div>
                </div>
            </div>
            
            <!-- ğŸ”” PARTNER-AKTIVITÃ„TEN (VEREINHEITLICHT) -->
            <div class="card" style="margin-bottom: 30px; background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); border: none; color: white;">
                <div class="card-title" style="display: flex; justify-content: space-between; align-items: center; color: white; border-bottom: 1px solid rgba(255,255,255,0.2);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 45px; height: 45px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
                            <i class="fas fa-bell" style="font-size: 20px; animation: ringBell 2s ease-in-out infinite;"></i>
                        </div>
                        <span style="font-size: 1.2rem; font-weight: 700;">Partner-AktivitÃ¤ten</span>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span id="aktivitaeten-count" style="background: #f56565; color: white; padding: 6px 14px; border-radius: 50px; font-size: 0.9rem; font-weight: 700; box-shadow: 0 4px 12px rgba(245, 101, 101, 0.4); display: none;">0</span>
                        <button onclick="markAlleAktivitaetenGelesen()" style="padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 0.9rem; font-weight: 600; backdrop-filter: blur(10px); transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                            <i class="fas fa-check"></i> Alle gelesen
                        </button>
                    </div>
                </div>
                <style>
                    @keyframes ringBell {
                        0%, 100% { transform: rotate(0deg); }
                        10%, 30% { transform: rotate(-10deg); }
                        20%, 40% { transform: rotate(10deg); }
                        50% { transform: rotate(0deg); }
                    }
                </style>
                <div id="partner-aktivitaeten-list" style="max-height: 500px; overflow-y: auto;">
                    <div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.8);">
                        <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <p>Lade AktivitÃ¤ten...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Aufgaben & Projekte -->
        <div class="tab-content" id="tab-aufgaben">
            <!-- Header mit Stats & Buttons -->
            <div style="background: linear-gradient(135deg, #3b82f6, #60a5fa); padding: 30px; border-radius: 16px; margin-bottom: 30px; color: white;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                    <div>
                        <h2 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 700;">
                            <i class="fas fa-tasks"></i> Projekte & Aufgaben
                        </h2>
                        <p style="margin: 0; opacity: 0.9;">Verwalte deine Projekte und Tasks effizient</p>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <div style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); padding: 12px 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 700;" id="stats-total-projects">0</div>
                            <div style="font-size: 12px; opacity: 0.9;">Projekte</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); padding: 12px 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 700;" id="stats-active-tasks">0</div>
                            <div style="font-size: 12px; opacity: 0.9;">Offene Tasks</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); padding: 12px 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 700;" id="stats-completed-tasks">0</div>
                            <div style="font-size: 12px; opacity: 0.9;">Erledigt</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div style="display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap;">
                <!-- âœ… Vereinfachte Button-Leiste: Nur 3 Buttons! -->
                <button onclick="createNewProjekt()" style="padding: 14px 28px; background: var(--primary); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 15px; display: flex; align-items: center; gap: 10px; transition: all 0.2s; box-shadow: 0 2px 8px rgba(102,126,234,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 16px rgba(102,126,234,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(102,126,234,0.3)'">
                    <i class="fas fa-plus-circle"></i> Neues Projekt
                </button>
                <button onclick="filterProjekte('all')" id="filter-btn-all" style="padding: 14px 24px; background: var(--primary); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 15px; transition: all 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                    <i class="fas fa-th"></i> Alle
                </button>
                <button onclick="filterProjekte('completed')" id="filter-btn-completed" style="padding: 14px 24px; background: white; color: #48bb78; border: 2px solid #48bb78; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 15px; transition: all 0.2s;" onmouseover="this.style.background='#48bb78'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='#48bb78'">
                    <i class="fas fa-check-circle"></i> Abgeschlossen
                </button>
            </div>
            
            <!-- Projekte Grid (Innovativ!) -->
            <div id="projekte-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 24px;">
                <!-- Projekte werden hier geladen -->
                <div style="text-align: center; padding: 60px; color: #718096; grid-column: 1 / -1;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 16px;"></i>
                    <p style="margin: 0; font-size: 16px;">Lade Projekte...</p>
                </div>
            </div>
        </div>

        <!-- Tab: Partner-Verwaltung (ÃœBERARBEITET - Tabelle mit ALLEN Infos) -->
        <div class="tab-content" id="tab-partner-verwaltung" style="display: none;">
            <div style="margin-bottom: 24px;">
                <h2 style="font-size: 28px; font-weight: 700; color: #1a202c; margin: 0 0 8px 0;">
                    <i class="fas fa-users"></i> Partner-Verwaltung
                </h2>
                <p style="color: #718096; margin: 0;">VollstÃ¤ndige Ãœbersicht mit IBAN, Dokumenten, VertrÃ¤gen & Akademie-Status</p>
            </div>

            <!-- Neuer Partner Button + CSV Import -->
            <div style="margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
                <button onclick="openModalNeuerPartner()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 14px 28px; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 10px; box-shadow: 0 4px 14px rgba(16, 185, 129, 0.4); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(16, 185, 129, 0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 14px rgba(16, 185, 129, 0.4)'">
                    <i class="fas fa-user-plus" style="font-size: 18px;"></i>
                    Neuer Partner anlegen
                </button>
                <button onclick="openCSVImportModal()" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; padding: 14px 28px; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 10px; box-shadow: 0 4px 14px rgba(139, 92, 246, 0.4); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(139, 92, 246, 0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 14px rgba(139, 92, 246, 0.4)'">
                    <i class="fas fa-file-import" style="font-size: 18px;"></i>
                    CSV Import
                </button>
            </div>
            
            <!-- Filter & Stats -->
            <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                <!-- Stats in einer Zeile -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 12px; background: #f7fafc; border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: 700; color: #3b82f6;" id="partner-stat-gesamt">0</div>
                        <div style="font-size: 12px; color: #718096; margin-top: 4px;">Gesamt</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: #f7fafc; border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: 700; color: #48bb78;" id="partner-stat-aktiv">0</div>
                        <div style="font-size: 12px; color: #718096; margin-top: 4px;">Aktiv</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: #f7fafc; border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: 700; color: #ed8936;" id="partner-stat-neu">0</div>
                        <div style="font-size: 12px; color: #718096; margin-top: 4px;">Neu</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: #f7fafc; border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: 700; color: #4299e1;" id="partner-stat-onboarding">0</div>
                        <div style="font-size: 12px; color: #718096; margin-top: 4px;">Onboarding</div>
                    </div>
                </div>
                
                <!-- Filter -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #4a5568; font-weight: 600;">
                            <i class="fas fa-calendar"></i> Von Datum
                        </label>
                        <input type="date" id="partner-von-datum" onchange="filterPartner()" style="padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; width: 100%; background: white;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #4a5568; font-weight: 600;">
                            <i class="fas fa-calendar"></i> Bis Datum
                        </label>
                        <input type="date" id="partner-bis-datum" onchange="filterPartner()" style="padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; width: 100%; background: white;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #4a5568; font-weight: 600;">
                            <i class="fas fa-filter"></i> Status
                        </label>
                        <select id="filter-status" onchange="filterPartner()" style="padding: 10px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; cursor: pointer; background: white; width: 100%;">
                            <option value="">Alle Status</option>
                            <option value="aktiv">âœ… Aktiv</option>
                            <option value="neu">â­ Neu</option>
                            <option value="inaktiv">â¸ï¸ Inaktiv</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #4a5568; font-weight: 600;">
                            <i class="fas fa-store"></i> Modell
                        </label>
                        <select id="filter-modell" onchange="filterPartner()" style="padding: 10px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; cursor: pointer; background: white; width: 100%;">
                            <option value="">Alle Modelle</option>
                            <option value="ladenlokal">ğŸª Ladenlokal</option>
                            <option value="provisionspartner">ğŸ’¼ Provisionspartner</option>
                            <option value="affiliate">ğŸ”— Affiliate</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #4a5568; font-weight: 600;">
                            <i class="fas fa-tasks"></i> Onboarding
                        </label>
                        <select id="filter-onboarding" onchange="filterPartner()" style="padding: 10px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; cursor: pointer; background: white; width: 100%;">
                            <option value="">Alle Onboarding</option>
                            <option value="completed">âœ… Abgeschlossen</option>
                            <option value="incomplete">â³ Offen</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #4a5568; font-weight: 600;">
                            <i class="fas fa-sort"></i> Sortierung
                        </label>
                        <select id="filter-sortierung" onchange="filterPartner()" style="padding: 10px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; cursor: pointer; background: white; width: 100%;">
                            <option value="name">ğŸ“ Name (A-Z)</option>
                            <option value="datum">ğŸ“… Datum (Neueste)</option>
                            <option value="vertraege">ğŸ“„ Meiste VertrÃ¤ge</option>
                            <option value="provision">ğŸ’° HÃ¶chste Provision</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #4a5568; font-weight: 600;">
                            <i class="fas fa-search"></i> Suche
                        </label>
                        <input type="text" id="search-partner" placeholder="ğŸ” Name, E-Mail, IBAN" oninput="filterPartner()" style="padding: 10px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; width: 100%;">
                    </div>
                </div>
            </div>

            <!-- Partner-Tabelle (mit ALLEN Infos) -->
            <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; min-width: 1200px;">
                        <thead>
                            <tr style="background: #f7fafc; border-bottom: 2px solid #e2e8f0;">
                                <th style="padding: 14px 12px; text-align: left; font-size: 13px; font-weight: 600; color: #4a5568;">Partner</th>
                                <th style="padding: 14px 12px; text-align: left; font-size: 13px; font-weight: 600; color: #4a5568;">Status</th>
                                <th style="padding: 14px 12px; text-align: left; font-size: 13px; font-weight: 600; color: #4a5568;">Modell</th>
                                <th style="padding: 14px 12px; text-align: left; font-size: 13px; font-weight: 600; color: #4a5568;">IBAN</th>
                                <th style="padding: 14px 12px; text-align: center; font-size: 13px; font-weight: 600; color: #4a5568;">Dokumente</th>
                                <th style="padding: 14px 12px; text-align: center; font-size: 13px; font-weight: 600; color: #4a5568;">VertrÃ¤ge</th>
                                <th style="padding: 14px 12px; text-align: center; font-size: 13px; font-weight: 600; color: #4a5568;">Akademie</th>
                                <th style="padding: 14px 12px; text-align: center; font-size: 13px; font-weight: 600; color: #4a5568;">Onboarding</th>
                                <th style="padding: 14px 12px; text-align: center; font-size: 13px; font-weight: 600; color: #4a5568;">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="partner-table-body">
                            <tr>
                                <td colspan="9" style="padding: 60px; text-align: center; color: #718096;">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 16px; display: block;"></i>
                                    <p style="margin: 0; font-size: 16px;">Lade Partner...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 0 8px;">
                <div style="color: #718096; font-size: 14px;" id="partner-pagination-info">Zeige 0 von 0 Partnern</div>
                <div style="display: flex; gap: 8px;" id="partner-pagination-controls">
                    <!-- Pagination Buttons werden hier eingefÃ¼gt -->
                </div>
            </div>
        </div>

        <!-- MODAL: Partner Details -->
        <div id="modal-partner-details" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
            <div style="background: white; border-radius: 16px; padding: 0; max-width: 900px; width: 95%; max-height: 90vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                <!-- Header -->
                <div id="partner-modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); padding: 32px; color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h3 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 700;" id="partner-modal-name">Partner Name</h3>
                            <p style="margin: 0; opacity: 0.9; font-size: 16px;" id="partner-modal-email">partner@email.com</p>
                        </div>
                        <button onclick="closeModal('modal-partner-details')" style="background: rgba(255,255,255,0.2); border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; color: white; font-size: 20px; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- Content -->
                <div style="padding: 32px; max-height: calc(90vh - 140px); overflow-y: auto; overflow-x: auto;">
                    <div id="partner-modal-content" style="min-width: min-content;">
                        <!-- Wird dynamisch gefÃ¼llt -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- MODAL: Neuer Partner -->
        <div id="modal-neuer-partner" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
            <div style="background: white; border-radius: 16px; padding: 0; max-width: 600px; width: 90%; max-height: 90vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                <!-- Header -->
                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 32px; color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 28px; font-weight: 700;">
                            <i class="fas fa-user-plus"></i> Neuer Partner
                        </h3>
                        <button onclick="closeModal('modal-neuer-partner')" style="background: rgba(255,255,255,0.2); border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; color: white; font-size: 20px; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- Content -->
                <div style="padding: 32px; max-height: calc(90vh - 140px); overflow-y: auto;">
                    <!-- PersÃ¶nliche Daten -->
                    <div style="margin-bottom: 24px;">
                        <h4 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 700; color: #1a202c; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-user" style="color: #10b981;"></i> PersÃ¶nliche Daten
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #4a5568; font-size: 14px;">Vorname*</label>
                                <input type="text" id="neu-partner-vorname" placeholder="Max" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px;" required>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #4a5568; font-size: 14px;">Nachname*</label>
                                <input type="text" id="neu-partner-nachname" placeholder="Mustermann" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px;" required>
                            </div>
                        </div>
                        <div style="margin-top: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #4a5568; font-size: 14px;">E-Mail*</label>
                            <input type="email" id="neu-partner-email" placeholder="max@mustermann.de" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px;" required>
                        </div>
                        <div style="margin-top: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #4a5568; font-size: 14px;">Telefon</label>
                            <input type="tel" id="neu-partner-telefon" placeholder="+49 123 456789" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px;">
                        </div>
                        <div style="margin-top: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #4a5568; font-size: 14px;">Firma/Unternehmen</label>
                            <input type="text" id="neu-partner-firma" placeholder="Optional" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px;">
                        </div>
                    </div>

                    <!-- Partner-Konfiguration -->
                    <div style="margin-bottom: 24px;">
                        <h4 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 700; color: #1a202c; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-cog" style="color: #10b981;"></i> Partner-Konfiguration
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #4a5568; font-size: 14px;">Modell*</label>
                                <select id="neu-partner-modell" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; cursor: pointer;" required>
                                    <option value="ladenlokal">ğŸª Ladenlokal</option>
                                    <option value="onlineshop">ğŸ›’ Online-Shop</option>
                                    <option value="promotion">ğŸª Promotionstand</option>
                                    <option value="affiliate">ğŸ’» Affiliate Marketing</option>
                                    <option value="shop_in_shop">ğŸ¬ Shop-in-Shop</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #4a5568; font-size: 14px;">Status*</label>
                                <select id="neu-partner-status" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; cursor: pointer;" required>
                                    <option value="neu" selected>â­ Neu</option>
                                    <option value="aktiv">âœ… Aktiv</option>
                                    <option value="inaktiv">â¸ï¸ Inaktiv</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Zugang -->
                    <div style="margin-bottom: 24px;">
                        <h4 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 700; color: #1a202c; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-key" style="color: #10b981;"></i> Zugang
                        </h4>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #4a5568; font-size: 14px;">Passwort*</label>
                            <input type="password" id="neu-partner-passwort" placeholder="Mindestens 6 Zeichen" autocomplete="new-password" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px;" required>
                            <div style="margin-top: 8px; padding: 10px; background: #f0fdf4; border: 1px solid #10b981; border-radius: 6px; font-size: 13px; color: #065f46;">
                                <i class="fas fa-info-circle"></i> Der Partner erhÃ¤lt eine automatische Willkommens-E-Mail mit seinen Zugangsdaten.
                            </div>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                        <button onclick="closeModal('modal-neuer-partner')" style="padding: 12px 24px; background: #e2e8f0; color: #4a5568; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#cbd5e0'" onmouseout="this.style.background='#e2e8f0'">
                            Abbrechen
                        </button>
                        <button onclick="createNeuerPartner()" style="padding: 12px 24px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 18px rgba(16, 185, 129, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'">
                            <i class="fas fa-check"></i> Partner anlegen
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- MODAL: CSV Partner Import -->
        <div id="modal-csv-import" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
            <div style="background: white; border-radius: 16px; padding: 0; max-width: 900px; width: 95%; max-height: 90vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                <!-- Header -->
                <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); padding: 24px 32px; color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="margin: 0; font-size: 24px; font-weight: 700;">
                                <i class="fas fa-file-import"></i> CSV Partner Import
                            </h3>
                            <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">Partner aus CSV-Datei importieren</p>
                        </div>
                        <button onclick="closeModal('modal-csv-import')" style="background: rgba(255,255,255,0.2); border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; color: white; font-size: 20px;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- Content -->
                <div style="padding: 32px; max-height: calc(90vh - 100px); overflow-y: auto;">
                    <!-- Upload Area -->
                    <div id="csv-upload-area" style="border: 3px dashed #e2e8f0; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s; margin-bottom: 24px;" onclick="document.getElementById('csv-file-input').click()" ondragover="event.preventDefault(); this.style.borderColor='#8b5cf6'; this.style.background='#f5f3ff';" ondragleave="this.style.borderColor='#e2e8f0'; this.style.background='white';" ondrop="handleCSVDrop(event)">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #8b5cf6; margin-bottom: 16px;"></i>
                        <h4 style="margin: 0 0 8px 0; color: #1a202c;">CSV-Datei hochladen</h4>
                        <p style="margin: 0; color: #718096; font-size: 14px;">Ziehen Sie eine Datei hierher oder klicken Sie zum AuswÃ¤hlen</p>
                        <input type="file" id="csv-file-input" accept=".csv" style="display: none;" onchange="handleCSVSelect(event)">
                    </div>
                    
                    <!-- Import Options (hidden until file selected) -->
                    <div id="csv-options" style="display: none;">
                        <h4 style="margin: 0 0 16px 0; font-size: 18px; color: #1a202c;"><i class="fas fa-cog"></i> Import-Optionen</h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            <!-- Affiliate Option -->
                            <div style="background: #f7fafc; border-radius: 10px; padding: 16px;">
                                <label style="display: block; font-weight: 600; color: #1a202c; margin-bottom: 8px;">
                                    <i class="fas fa-link" style="color: #ec4899;"></i> Als Affiliate importieren?
                                </label>
                                <select id="csv-is-affiliate" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                                    <option value="yes">âœ… Ja, als Affiliates</option>
                                    <option value="no">âŒ Nein, normale Partner</option>
                                </select>
                            </div>
                            
                            <!-- Password Option -->
                            <div style="background: #f7fafc; border-radius: 10px; padding: 16px;">
                                <label style="display: block; font-weight: 600; color: #1a202c; margin-bottom: 8px;">
                                    <i class="fas fa-key" style="color: #f59e0b;"></i> Standard-Passwort
                                </label>
                                <input type="text" id="csv-default-password" value="Partner2026!" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                            </div>
                            
                            <!-- Password Change Option -->
                            <div style="background: #f7fafc; border-radius: 10px; padding: 16px;">
                                <label style="display: block; font-weight: 600; color: #1a202c; margin-bottom: 8px;">
                                    <i class="fas fa-sync-alt" style="color: #10b981;"></i> Passwort-Ã„nderung?
                                </label>
                                <select id="csv-must-change-password" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                                    <option value="yes">âœ… Ja, beim ersten Login</option>
                                    <option value="no">âŒ Nein</option>
                                </select>
                            </div>
                            
                            <!-- Status Option -->
                            <div style="background: #f7fafc; border-radius: 10px; padding: 16px;">
                                <label style="display: block; font-weight: 600; color: #1a202c; margin-bottom: 8px;">
                                    <i class="fas fa-check-circle" style="color: #3b82f6;"></i> Partner-Status
                                </label>
                                <select id="csv-partner-status" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                                    <option value="aktiv">âœ… Aktiv</option>
                                    <option value="neu">â­ Neu</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Preview -->
                        <div id="csv-preview" style="margin-bottom: 24px;">
                            <h4 style="margin: 0 0 12px 0; font-size: 16px; color: #1a202c;"><i class="fas fa-table"></i> Vorschau (<span id="csv-count">0</span> Partner)</h4>
                            <div style="max-height: 300px; overflow: auto; border: 2px solid #e2e8f0; border-radius: 10px;">
                                <table style="width: 100%; border-collapse: collapse; min-width: 600px;">
                                    <thead>
                                        <tr style="background: #f7fafc;">
                                            <th style="padding: 12px; text-align: left; font-size: 12px; text-transform: uppercase; color: #718096; border-bottom: 2px solid #e2e8f0;">#</th>
                                            <th style="padding: 12px; text-align: left; font-size: 12px; text-transform: uppercase; color: #718096; border-bottom: 2px solid #e2e8f0;">E-Mail</th>
                                            <th style="padding: 12px; text-align: left; font-size: 12px; text-transform: uppercase; color: #718096; border-bottom: 2px solid #e2e8f0;">Vorname</th>
                                            <th style="padding: 12px; text-align: left; font-size: 12px; text-transform: uppercase; color: #718096; border-bottom: 2px solid #e2e8f0;">Nachname</th>
                                            <th style="padding: 12px; text-align: left; font-size: 12px; text-transform: uppercase; color: #718096; border-bottom: 2px solid #e2e8f0;">Firma</th>
                                        </tr>
                                    </thead>
                                    <tbody id="csv-preview-body">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Progress -->
                        <div id="csv-progress" style="display: none; margin-bottom: 24px;">
                            <div style="background: #e2e8f0; border-radius: 10px; height: 20px; overflow: hidden;">
                                <div id="csv-progress-bar" style="background: linear-gradient(90deg, #8b5cf6, #7c3aed); height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <p id="csv-progress-text" style="text-align: center; margin: 12px 0 0 0; font-weight: 600; color: #1a202c;">0 / 0 importiert</p>
                        </div>
                        
                        <!-- Buttons -->
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button onclick="closeModal('modal-csv-import')" style="padding: 12px 24px; background: #e2e8f0; color: #4a5568; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">
                                Abbrechen
                            </button>
                            <button id="csv-import-btn" onclick="startCSVImport()" style="padding: 12px 24px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);">
                                <i class="fas fa-upload"></i> Import starten
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- MODAL: Neues Projekt -->
        <div id="modal-new-projekt" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 16px; padding: 32px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
                <h3 style="margin: 0 0 24px 0; font-size: 24px;"><i class="fas fa-folder-plus"></i> Neues Projekt erstellen</h3>
                
                <!-- 2-Spalten Layout fÃ¼r bessere Ãœbersicht -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Linke Spalte -->
                    <div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Projekt-Name*</label>
                            <input type="text" id="new-projekt-name" placeholder="z.B. Website Relaunch" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px;">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">PrioritÃ¤t</label>
                            <select id="new-projekt-prioritaet" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; cursor: pointer;">
                                <option value="low">ğŸŸ¢ Niedrig</option>
                                <option value="medium" selected>ğŸŸ¡ Mittel</option>
                                <option value="high">ğŸ”´ Hoch</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Kategorie</label>
                            <select id="new-projekt-kategorie" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; cursor: pointer;">
                                <option value="">Keine Kategorie</option>
                                <option value="entwicklung">ğŸ’» Entwicklung</option>
                                <option value="design">ğŸ¨ Design</option>
                                <option value="marketing">ğŸ“¢ Marketing</option>
                                <option value="vertrieb">ğŸ’¼ Vertrieb</option>
                                <option value="support">ğŸ’¬ Support</option>
                                <option value="admin">âš™ï¸ Administration</option>
                                <option value="dokumentation">ğŸ“ Dokumentation</option>
                                <option value="meeting">ğŸ‘¥ Meeting</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Zugewiesen an</label>
                            <input type="email" id="new-projekt-zugewiesen" placeholder="E-Mail (optional)" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px;">
                        </div>
                    </div>
                    
                    <!-- Rechte Spalte -->
                    <div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Status</label>
                            <select id="new-projekt-status" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; cursor: pointer;">
                                <option value="todo" selected>ğŸ“‹ Todo</option>
                                <option value="in_progress">ğŸ”„ In Bearbeitung</option>
                                <option value="done">âœ… Erledigt</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Deadline</label>
                            <input type="date" id="new-projekt-deadline" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; cursor: pointer;">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Kommentar</label>
                            <textarea id="new-projekt-kommentar" placeholder="ZusÃ¤tzliche Notizen..." style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; min-height: 108px; resize: vertical;"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Beschreibung Ã¼ber volle Breite -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Beschreibung</label>
                    <textarea id="new-projekt-beschreibung" placeholder="Detaillierte Beschreibung des Projekts..." style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; min-height: 80px; resize: vertical;"></textarea>
                </div>
                
                <div style="display: flex; gap: 12px; margin-top: 32px;">
                    <button onclick="saveProjekt()" style="flex: 1; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 15px;">
                        <i class="fas fa-check"></i> Projekt erstellen
                    </button>
                    <button onclick="closeModal('modal-new-projekt')" style="padding: 14px 24px; background: #e2e8f0; color: #718096; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
                        Abbrechen
                    </button>
                </div>
            </div>
        </div>
        
        <!-- MODAL: Task hinzufÃ¼gen -->
        <div id="modal-add-task" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 16px; padding: 32px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
                <h3 style="margin: 0 0 24px 0; font-size: 24px;"><i class="fas fa-plus-circle"></i> Neuen Task erstellen</h3>
                
                <input type="hidden" id="task-projekt-id">
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Task-Titel*</label>
                    <input type="text" id="new-task-titel" placeholder="z.B. Design erstellen" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px;">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Beschreibung</label>
                    <textarea id="new-task-beschreibung" placeholder="Details zum Task..." style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; min-height: 80px;"></textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">PrioritÃ¤t</label>
                    <select id="new-task-prioritaet" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; cursor: pointer;">
                        <option value="low">ğŸŸ¢ Niedrig</option>
                        <option value="medium" selected>ğŸŸ¡ Mittel</option>
                        <option value="high">ğŸ”´ Hoch</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Kategorie</label>
                    <select id="new-task-kategorie" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; cursor: pointer;">
                        <option value="">Keine Kategorie</option>
                        <option value="entwicklung">ğŸ’» Entwicklung</option>
                        <option value="design">ğŸ¨ Design</option>
                        <option value="marketing">ğŸ“¢ Marketing</option>
                        <option value="vertrieb">ğŸ’¼ Vertrieb</option>
                        <option value="support">ğŸ’¬ Support</option>
                        <option value="admin">âš™ï¸ Administration</option>
                        <option value="dokumentation">ğŸ“ Dokumentation</option>
                        <option value="meeting">ğŸ‘¥ Meeting</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Zugewiesen an</label>
                    <input type="email" id="new-task-zugewiesen" placeholder="E-Mail (optional)" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px;">
                    <div style="font-size: 12px; color: #718096; margin-top: 6px;">ğŸ’¡ Tipp: Partner oder Admin E-Mail eingeben</div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Status</label>
                    <select id="new-task-status" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; cursor: pointer;">
                        <option value="todo" selected>ğŸ“‹ Todo</option>
                        <option value="in_progress">ğŸ”„ In Bearbeitung</option>
                        <option value="done">âœ… Erledigt</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Deadline (optional)</label>
                    <input type="date" id="new-task-deadline" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px;">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Notizen / Kommentar</label>
                    <textarea id="new-task-notiz" placeholder="ZusÃ¤tzliche Notizen..." style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; min-height: 60px;"></textarea>
                </div>
                
                <div style="display: flex; gap: 12px; margin-top: 32px;">
                    <button onclick="saveTask()" style="flex: 1; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 15px;">
                        <i class="fas fa-check"></i> Task erstellen
                    </button>
                    <button onclick="closeModal('modal-add-task')" style="padding: 14px 24px; background: #e2e8f0; color: #718096; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
                        Abbrechen
                    </button>
                </div>
            </div>
        </div>
        
        <!-- MODAL: Task bearbeiten/Details -->
        <div id="modal-task-detail" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 16px; padding: 32px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h3 style="margin: 0; font-size: 24px;"><i class="fas fa-tasks"></i> Task Details</h3>
                    <button onclick="closeModal('modal-task-detail')" style="background: none; border: none; color: #718096; cursor: pointer; font-size: 24px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="task-detail-content">
                    <!-- Wird dynamisch gefÃ¼llt -->
                </div>
            </div>
        </div>

        <!-- ğŸ’° Tab: Provisionen - VertrÃ¤ge - Sonstiges (ALL-IN-ONE) -->
        <div class="tab-content" id="tab-all-in-one" style="display: none;">
            <!-- ğŸ“Š UMSATZ-TRACKING STATS -->
            <div style="margin-bottom: 32px;">
                <h2 style="font-size: 24px; font-weight: 700; color: #1a202c; margin: 0 0 16px 0;">
                    <i class="fas fa-chart-line"></i> Umsatz-Tracking
                </h2>
                
                <!-- â„¹ï¸ INFO BOX -->
                <div style="background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); border-radius: 12px; padding: 16px 20px; margin-bottom: 20px; color: white; display: flex; align-items: center; gap: 12px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                    <i class="fas fa-info-circle" style="font-size: 24px; opacity: 0.9;"></i>
                    <div style="flex: 1;">
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">ğŸ“Š Aktuelle ZeitrÃ¤ume (ungefiltert)</div>
                        <div style="font-size: 12px; opacity: 0.9;">Diese Stat-Cards zeigen IMMER die aktuellen ZeitrÃ¤ume (Heute, diese Woche, Vorwoche, dieser Monat). Sie sind NICHT durch Filter beeinflussbar. FÃ¼r gefilterte Ansichten nutze den Tab "Provisionen - VertrÃ¤ge - Sonstiges".</div>
                    </div>
                </div>

                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 16px;">
                    <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Provision (Heute)</div>
                        <div class="stat-value" style="color: white;" id="provision-heute-all">0 â‚¬</div>
                        <div style="font-size: 11px; opacity: 0.8; margin-top: 5px;" id="datum-heute">05.12.2025</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); color: white;">
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Provision (Woche)</div>
                        <div class="stat-value" style="color: white;" id="provision-woche-all">0 â‚¬</div>
                        <div style="font-size: 11px; opacity: 0.8; margin-top: 5px;" id="datum-woche">Mo 02.12 - So 08.12</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">Provision (Monat)</div>
                        <div class="stat-value" style="color: white;" id="provision-monat-all">0 â‚¬</div>
                        <div style="font-size: 11px; opacity: 0.8; margin-top: 5px;" id="datum-monat">Dezember 2025</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                        <div class="stat-label" style="color: rgba(255,255,255,0.9);">VertrÃ¤ge (Monat)</div>
                        <div class="stat-value" style="color: white;" id="provision-vertraege-monat-all">0</div>
                        <div style="font-size: 11px; opacity: 0.8; margin-top: 5px;" id="datum-vertraege-monat">Dezember 2025</div>
                    </div>
                </div>

                <!-- ğŸ“Š HOCHRECHNUNG & PROGNOSEN -->
                <div class="card" style="padding: 24px; margin-top: 24px; background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; font-size: 20px; color: white; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-chart-line"></i> Hochrechnung & Prognosen
                        </h3>
                        <div style="background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 12px; color: white; font-size: 14px;">
                            <strong>Aktueller Tag</strong>
                            <div id="hochrechnung-aktueller-tag" style="font-size: 24px; font-weight: bold; margin-top: 4px;">5</div>
                            <div style="font-size: 12px; opacity: 0.9;">von ~ Tagen</div>
                        </div>
                    </div>
                    <div style="color: rgba(255,255,255,0.9); font-size: 14px; margin-bottom: 16px;">
                        Basierend auf aktuellen Daten und Durchschnittswerten
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 12px; backdrop-filter: blur(10px);">
                            <div style="color: rgba(255,255,255,0.9); font-size: 14px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-calendar-day"></i> Monat-Hochrechnung
                            </div>
                            <div id="hochrechnung-monat" style="color: white; font-size: 32px; font-weight: bold;">0 â‚¬</div>
                            <div id="hochrechnung-monat-sub" style="color: rgba(255,255,255,0.8); font-size: 12px; margin-top: 4px;">Ã˜ pro Tag: 0 â‚¬</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 12px; backdrop-filter: blur(10px);">
                            <div style="color: rgba(255,255,255,0.9); font-size: 14px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-calendar-alt"></i> Jahres-Hochrechnung
                            </div>
                            <div id="hochrechnung-jahr" style="color: white; font-size: 32px; font-weight: bold;">0 â‚¬</div>
                            <div id="hochrechnung-jahr-sub" style="color: rgba(255,255,255,0.8); font-size: 12px; margin-top: 4px;">Ã˜ pro Monat: 0 â‚¬</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 12px; backdrop-filter: blur(10px);">
                            <div style="color: rgba(255,255,255,0.9); font-size: 14px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-rocket"></i> Prognose (Best Case)
                            </div>
                            <div id="hochrechnung-prognose" style="color: white; font-size: 32px; font-weight: bold;">0 â‚¬</div>
                            <div id="hochrechnung-prognose-sub" style="color: rgba(255,255,255,0.8); font-size: 12px; margin-top: 4px;">+10% Wachstum</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 12px; backdrop-filter: blur(10px);">
                            <div style="color: rgba(255,255,255,0.9); font-size: 14px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-bullseye"></i> Zielerreichung
                            </div>
                            <div id="hochrechnung-zielerreichung" style="color: white; font-size: 32px; font-weight: bold;">0%</div>
                            <div id="hochrechnung-zielerreichung-sub" style="color: rgba(255,255,255,0.8); font-size: 12px; margin-top: 4px;">Ziel: 5000 â‚¬</div>
                        </div>
                    </div>
                </div>

                <!-- ğŸ“ˆ GRAFIKEN -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 24px;">
                    <!-- Linien-Chart: Umsatz Ã¼ber Zeit -->
                    <div class="card" style="padding: 20px;">
                        <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #1a202c;">
                            <i class="fas fa-chart-line"></i> Provision Ã¼ber Zeit
                        </h3>
                        <div style="height: 300px;">
                            <canvas id="chart-umsatz-zeit"></canvas>
                        </div>
                    </div>

                    <!-- Balken-Chart: VertrÃ¤ge pro Kategorie -->
                    <div class="card" style="padding: 20px;">
                        <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #1a202c;">
                            <i class="fas fa-chart-bar"></i> VertrÃ¤ge pro Kategorie
                        </h3>
                        <div style="height: 300px;">
                            <canvas id="chart-vertraege-kategorie"></canvas>
                        </div>
                    </div>

                    <!-- Kreisdiagramm: Provision pro Partner -->
                    <div class="card" style="padding: 20px; grid-column: span 2;">
                        <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #1a202c;">
                            <i class="fas fa-chart-pie"></i> Provision pro Partner (Top 5)
                        </h3>
                        <div style="height: 300px;">
                            <canvas id="chart-provision-partner"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ğŸ“„ VERTRÃ„GE (NEU: AN ERSTER STELLE) -->
            <div style="margin-bottom: 32px;">
                <h2 style="font-size: 24px; font-weight: 700; color: #1a202c; margin: 0 0 16px 0;">
                    <i class="fas fa-file-contract"></i> VertrÃ¤ge
                </h2>
                <div class="stats-grid" style="margin-bottom: 16px;">
                    <div class="stat-card">
                        <div class="stat-label">Gesamt VertrÃ¤ge</div>
                        <div class="stat-value" id="stat-vertraege-gesamt-all">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Aktiviert</div>
                        <div class="stat-value" style="color: var(--success);" id="stat-vertraege-aktiviert-all">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">In Bearbeitung</div>
                        <div class="stat-value" style="color: var(--warning);" id="stat-vertraege-bearbeitung-all">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Abgelehnt</div>
                        <div class="stat-value" style="color: var(--danger);" id="stat-vertraege-abgelehnt-all">0</div>
                    </div>
                </div>

                <!-- ğŸ’° GESAMT-PROVISION (GROSSE ANZEIGE) -->
                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 16px; padding: 32px; margin-bottom: 24px; box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3); text-align: center;">
                    <div style="color: rgba(255,255,255,0.9); font-size: 16px; font-weight: 600; margin-bottom: 12px; letter-spacing: 1px;">
                        <i class="fas fa-euro-sign" style="margin-right: 8px;"></i> GESAMT-PROVISION
                    </div>
                    <div id="stat-vertraege-provision-all" style="color: white; font-size: 56px; font-weight: 900; line-height: 1.2; text-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                        0,00 â‚¬
                    </div>
                    <div style="color: rgba(255,255,255,0.8); font-size: 14px; margin-top: 12px; font-weight: 500;">
                        Basierend auf den aktuellen Filtern
                    </div>
                </div>

                <!-- ğŸ” FILTER -->
                <div class="card" style="margin-bottom: 16px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>Zeitraum</label>
                            <select id="vertraege-zeitraum-filter" onchange="handleVertraegeZeitraumChange()">
                                <option value="alle">Alle ZeitrÃ¤ume</option>
                                <option value="heute">Heute</option>
                                <option value="woche">Diese Woche</option>
                                <option value="monat" selected>Dieser Monat</option>
                                <option value="benutzerdefiniert">ğŸ“… Benutzerdefiniert</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Von Datum</label>
                            <input type="date" id="vertraege-von-datum" onchange="filterVertraegeByPartner()" style="padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>Bis Datum</label>
                            <input type="date" id="vertraege-bis-datum" onchange="filterVertraegeByPartner()" style="padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>Kategorie</label>
                            <select id="vertraege-kategorie-filter" onchange="filterVertraegeByPartner()">
                                <option value="alle">Alle Kategorien</option>
                                <option value="mobilfunk">ğŸ“± Mobilfunk</option>
                                <option value="dsl">ğŸŒ DSL/Internet</option>
                                <option value="strom">âš¡ Strom</option>
                                <option value="versicherung">ğŸ›¡ï¸ Versicherung</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="vertraege-status-filter" onchange="filterVertraegeByPartner()">
                                <option value="alle">Alle Status</option>
                                <option value="aktiviert">Aktiviert</option>
                                <option value="in_pruefung">In PrÃ¼fung</option>
                                <option value="neu_eingegangen">Neu eingegangen</option>
                                <option value="abgelehnt">Abgelehnt</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Suche Partner</label>
                            <input type="text" id="vertraege-partner-search" placeholder="ğŸ” Partner suchen..." oninput="filterVertraegeByPartner()" style="padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>
                </div>

                <!-- ğŸ“Š PARTNER-LISTE (AKKORDEON) -->
                <div class="card">
                    <div class="card-title">
                        <span>Partner-VertrÃ¤ge</span>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <select id="partner-vertraege-sortierung" onchange="sortPartnerVertraege()" style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
                                <option value="anzahl">ğŸ“Š Meiste VertrÃ¤ge</option>
                                <option value="name-az">ğŸ“ Name (A-Z)</option>
                                <option value="datum-neueste">ğŸ“… Datum (Neueste)</option>
                                <option value="provision-hoch">ğŸ’° HÃ¶chste Provision</option>
                            </select>
                            <button class="btn btn-primary" onclick="loadAllInOneData()">
                                <i class="fas fa-sync"></i> Aktualisieren
                            </button>
                        </div>
                    </div>
                    <div id="vertraege-partner-list-all" style="display: grid; gap: 12px;">
                        <!-- Partner-Akkordeon wird hier eingefÃ¼gt -->
                    </div>
                    
                    <!-- ğŸ“„ PAGINATION -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <button class="btn btn-secondary" onclick="vertraegePrevPage()" id="vertraege-prev-btn">
                            <i class="fas fa-chevron-left"></i> ZurÃ¼ck
                        </button>
                        <span id="vertraege-page-info" style="font-size: 14px; color: #4a5568; font-weight: 600;">Seite 1 von 1</span>
                        <button class="btn btn-primary" onclick="vertraegeNextPage()" id="vertraege-next-btn">
                            Weiter <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ğŸ’° PROVISIONEN -->
            <div style="margin-bottom: 32px;">
                <h2 style="font-size: 24px; font-weight: 700; color: #1a202c; margin: 0 0 16px 0;">
                    <i class="fas fa-euro-sign"></i> Provisionen
                </h2>

                <!-- ğŸ” FILTER FÃœR PROVISIONEN -->
                <div class="card" style="margin-bottom: 16px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>Von Datum</label>
                            <input type="date" id="provisionen-von-datum" onchange="filterProvisionenByPartner()" style="padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>Bis Datum</label>
                            <input type="date" id="provisionen-bis-datum" onchange="filterProvisionenByPartner()" style="padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>Partner</label>
                            <input type="text" id="provisionen-partner-filter" placeholder="ğŸ” Partner suchen..." oninput="filterProvisionenByPartner()" style="padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div class="form-group">
                            <label>Typ</label>
                            <select id="provisionen-typ-filter" onchange="filterProvisionenByPartner()">
                                <option value="alle">Alle Typen</option>
                                <option value="mobilfunk">Mobilfunk</option>
                                <option value="dsl">DSL/Internet</option>
                                <option value="strom">Strom</option>
                                <option value="versicherung">Versicherung</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="provisionen-status-filter" onchange="filterProvisionenByPartner()">
                                <option value="alle">Alle Status</option>
                                <option value="ausstehend">Ausstehend</option>
                                <option value="ausgezahlt">Ausgezahlt</option>
                                <option value="storniert">Storniert</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ğŸ“Š PARTNER-LISTE (AKKORDEON) -->
                <div class="card">
                    <div class="card-title">
                        <span>Partner-Provisionen (sortiert nach Betrag)</span>
                        <button class="btn btn-primary" onclick="loadAllInOneData()">
                            <i class="fas fa-sync"></i> Aktualisieren
                        </button>
                    </div>
                    <div id="provisionen-partner-list-all" style="display: grid; gap: 12px;">
                        <!-- Partner-Akkordeon wird hier eingefÃ¼gt -->
                    </div>
                    
                    <!-- ğŸ“„ PAGINATION -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <button class="btn btn-secondary" onclick="provisionenPrevPage()" id="provisionen-prev-btn">
                            <i class="fas fa-chevron-left"></i> ZurÃ¼ck
                        </button>
                        <span id="provisionen-page-info" style="font-size: 14px; color: #4a5568; font-weight: 600;">Seite 1 von 1</span>
                        <button class="btn btn-primary" onclick="provisionenNextPage()" id="provisionen-next-btn">
                            Weiter <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ğŸ’³ AUSZAHLUNGEN -->
            <div style="margin-bottom: 32px;">
                <h2 style="font-size: 24px; font-weight: 700; color: #1a202c; margin: 0 0 16px 0;">
                    <i class="fas fa-money-bill-wave"></i> Auszahlungen
                </h2>

                <!-- ğŸ” FILTER FÃœR AUSZAHLUNGEN -->
                <div class="card" style="margin-bottom: 16px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>Von Datum</label>
                            <input type="date" id="auszahlungen-von-datum" onchange="filterAuszahlungenByPartner()" style="padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>Bis Datum</label>
                            <input type="date" id="auszahlungen-bis-datum" onchange="filterAuszahlungenByPartner()" style="padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>Partner</label>
                            <input type="text" id="auszahlungen-partner-filter" placeholder="ğŸ” Partner suchen..." oninput="filterAuszahlungenByPartner()" style="padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="auszahlungen-status-filter" onchange="filterAuszahlungenByPartner()">
                                <option value="alle">Alle Status</option>
                                <option value="ausstehend">Ausstehend</option>
                                <option value="ausgezahlt">Ausgezahlt</option>
                                <option value="storniert">Storniert</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 16px;">
                    <div class="stat-card">
                        <div class="stat-label">Gesamt Ausgezahlt</div>
                        <div class="stat-value" id="stat_auszahlungen_gesamt-all" style="color: #48bb78;">0 â‚¬</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Ausstehend</div>
                        <div class="stat-value" id="stat_auszahlungen_ausstehend-all" style="color: #ed8936;">0 â‚¬</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Abgelehnt/Storniert</div>
                        <div class="stat-value" id="stat_auszahlungen_storniert-all" style="color: #f56565;">0 â‚¬</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Anzahl Auszahlungen</div>
                        <div class="stat-value" id="stat_auszahlungen_anzahl-all">0</div>
                    </div>
                </div>

                <!-- ğŸ“Š PARTNER-LISTE (AKKORDEON) -->
                <div class="card">
                    <div class="card-title">
                        <span>Partner-Auszahlungen (sortiert nach Betrag)</span>
                        <button class="btn btn-primary" onclick="loadAllInOneData()">
                            <i class="fas fa-sync"></i> Aktualisieren
                        </button>
                    </div>
                    <div id="auszahlungen-partner-list-all" style="display: grid; gap: 12px;">
                        <!-- Partner-Akkordeon wird hier eingefÃ¼gt -->
                    </div>
                    
                    <!-- ğŸ“„ PAGINATION -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <button class="btn btn-secondary" onclick="auszahlungenPrevPage()" id="auszahlungen-prev-btn">
                            <i class="fas fa-chevron-left"></i> ZurÃ¼ck
                        </button>
                        <span id="auszahlungen-page-info" style="font-size: 14px; color: #4a5568; font-weight: 600;">Seite 1 von 1</span>
                        <button class="btn btn-primary" onclick="auszahlungenNextPage()" id="auszahlungen-next-btn">
                            Weiter <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ğŸ¯ ZIEL-ERREICHUNG & STATISTIK -->
            <div style="margin-bottom: 32px;">
                <h2 style="font-size: 24px; font-weight: 700; color: #1a202c; margin: 0 0 16px 0;">
                    <i class="fas fa-trophy"></i> Ziel-Erreichung & Statistik
                </h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px;">
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; padding: 24px; color: white; box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Staffel 1 erreicht</div>
                        <div style="font-size: 36px; font-weight: 700;" id="stat-staffel1-all">0</div>
                        <div style="font-size: 13px; opacity: 0.8; margin-top: 4px;">Partner (10 VertrÃ¤ge)</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ff9500 0%, #ff5e3a 100%); border-radius: 12px; padding: 24px; color: white; box-shadow: 0 4px 14px rgba(255, 149, 0, 0.3);">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Staffel 2 erreicht</div>
                        <div style="font-size: 36px; font-weight: 700;" id="stat-staffel2-all">0</div>
                        <div style="font-size: 13px; opacity: 0.8; margin-top: 4px;">Partner (30 VertrÃ¤ge)</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); border-radius: 12px; padding: 24px; color: white; box-shadow: 0 4px 14px rgba(102, 126, 234, 0.3);">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Ã˜ Fortschritt</div>
                        <div style="font-size: 36px; font-weight: 700;" id="stat-avg-progress-all">0%</div>
                        <div style="font-size: 13px; opacity: 0.8; margin-top: 4px;">Alle Partner</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%); border-radius: 12px; padding: 24px; color: #8b6914; box-shadow: 0 4px 14px rgba(255, 215, 0, 0.3);">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Bonus ausgezahlt</div>
                        <div style="font-size: 36px; font-weight: 700;" id="stat-total-bonus-all">0â‚¬</div>
                        <div style="font-size: 13px; opacity: 0.8; margin-top: 4px;">Gesamt</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">
                        <span>Partner-Fortschritt</span>
                        <button class="btn btn-primary" onclick="loadZielErreichung()">
                            <i class="fas fa-sync"></i> Aktualisieren
                        </button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Partner</th>
                                    <th>Modell</th>
                                    <th>Mobilfunk</th>
                                    <th>Internet</th>
                                    <th>Strom</th>
                                    <th>Fortschritt</th>
                                    <th>Erreichte Staffel</th>
                                    <th>Bonus</th>
                                </tr>
                            </thead>
                            <tbody id="ziel-table-body-all"></tbody>
                        </table>
                    </div>
                </div>

                <!-- ğŸ“‹ ALLE VERTRÃ„GE (FLACHE TABELLE mit CSV-Export) -->
                <div class="card" style="margin-top: 32px;">
                    <div class="card-title">
                        <span>ğŸ“‹ Alle VertrÃ¤ge</span>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <select id="alle-vertraege-sortierung" onchange="sortAlleVertraege()" style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
                                <option value="">ğŸ”€ Sortierung</option>
                                <option value="name-az">ğŸ“ Name (A-Z)</option>
                                <option value="datum-neueste">ğŸ“… Datum (Neueste)</option>
                                <option value="provision-hoch">ğŸ’° HÃ¶chste Provision</option>
                            </select>
                            <button class="btn btn-success" onclick="exportVertraegeToCSV()">
                                <i class="fas fa-download"></i> CSV Export
                            </button>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table id="alle-vertraege-table" style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead>
                                <tr style="background: #f7fafc; border-bottom: 2px solid #e2e8f0;">
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #4a5568;">Datum</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #4a5568;">Partner</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #4a5568;">Kategorie</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #4a5568;">Produkt</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #4a5568;">Kunde</th>
                                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #4a5568;">Partner-Provision</th>
                                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #4a5568;">Kundenpreis (Monat)</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #4a5568;">Status</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #4a5568;">Aktionen</th>
                                </tr>
                            </thead>
                            <tbody id="alle-vertraege-tbody">
                                <tr>
                                    <td colspan="9" style="padding: 40px; text-align: center; color: #a0aec0;">
                                        <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i>
                                        <div style="margin-top: 10px;">Lade VertrÃ¤ge...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- Pagination fÃ¼r Alle VertrÃ¤ge -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <button class="btn btn-secondary" onclick="alleVertraegePrevPage()" id="alle-vertraege-prev-btn">
                            <i class="fas fa-chevron-left"></i> ZurÃ¼ck
                        </button>
                        <span id="alle-vertraege-page-info" style="font-size: 14px; color: #4a5568; font-weight: 600;">Seite 1 von 1</span>
                        <button class="btn btn-primary" onclick="alleVertraegeNextPage()" id="alle-vertraege-next-btn">
                            Weiter <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Umsatz-Tracking -->
        <div class="tab-content" id="tab-umsatz">
            <!-- Stats Overview (NUR Provision) -->
            <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 25px;">
                <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">Provision (Heute)</div>
                    <div class="stat-value" style="color: white;" id="provision-heute">0 â‚¬</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); color: white;">
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">Provision (Woche)</div>
                    <div class="stat-value" style="color: white;" id="provision-woche">0 â‚¬</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">Provision (Monat)</div>
                    <div class="stat-value" style="color: white;" id="provision-monat">0 â‚¬</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">VertrÃ¤ge (Monat)</div>
                    <div class="stat-value" style="color: white;" id="vertraege-monat">0</div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">Dieser Monat</div>
                </div>
            </div>
            
            <!-- ğŸ†• HOCHRECHNUNG & PROGNOSEN -->
            <div style="background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); border-radius: 16px; padding: 24px; margin-bottom: 25px; color: white;">
                <!-- DEBUG INFO -->
                <div id="debug-version-info" style="background: rgba(255,255,255,0.15); padding: 8px 12px; border-radius: 8px; margin-bottom: 16px; font-size: 11px; font-family: monospace; display: none;">
                    ğŸ”§ Debug: Version wird geladen...
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h3 style="margin: 0 0 8px 0; font-size: 22px; font-weight: 700;"><i class="fas fa-chart-line"></i> Hochrechnung & Prognosen</h3>
                        <p style="margin: 0; opacity: 0.9; font-size: 14px;">Basierend auf aktuellen Daten und Durchschnittswerten</p>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <button onclick="loadUmsatzData()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
                            <i class="fas fa-sync-alt"></i> Aktualisieren
                        </button>
                        <div style="background: rgba(255,255,255,0.2); padding: 12px 20px; border-radius: 10px; text-align: center; backdrop-filter: blur(10px);">
                            <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">Aktueller Tag</div>
                            <div style="font-size: 20px; font-weight: 700;" id="current-day-of-month">-</div>
                            <div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">von <span id="total-days-in-month">-</span> Tagen</div>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px;">
                    <!-- Monats-Hochrechnung -->
                    <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <i class="fas fa-calendar-alt" style="font-size: 24px; opacity: 0.9;"></i>
                            <div>
                                <div style="font-size: 12px; opacity: 0.8;">Monat-Hochrechnung</div>
                                <div style="font-size: 24px; font-weight: 700;" id="prognose-monat">0 â‚¬</div>
                            </div>
                        </div>
                        <div style="font-size: 11px; opacity: 0.7; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2);">
                            Ã˜ pro Tag: <span id="avg-per-day">0 â‚¬</span>
                        </div>
                    </div>
                    
                    <!-- Jahres-Hochrechnung -->
                    <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <i class="fas fa-calendar-check" style="font-size: 24px; opacity: 0.9;"></i>
                            <div>
                                <div style="font-size: 12px; opacity: 0.8;">Jahres-Hochrechnung</div>
                                <div style="font-size: 24px; font-weight: 700;" id="prognose-jahr">0 â‚¬</div>
                            </div>
                        </div>
                        <div style="font-size: 11px; opacity: 0.7; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2);">
                            Ã˜ pro Monat: <span id="avg-per-month">0 â‚¬</span>
                        </div>
                    </div>
                    
                    <!-- Bis Monatsende -->
                    <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <i class="fas fa-bullseye" style="font-size: 24px; opacity: 0.9;"></i>
                            <div>
                                <div style="font-size: 12px; opacity: 0.8;">Bis Monatsende</div>
                                <div style="font-size: 24px; font-weight: 700;" id="prognose-rest-monat">0 â‚¬</div>
                            </div>
                        </div>
                        <div style="font-size: 11px; opacity: 0.7; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2);">
                            Noch <span id="days-remaining">...</span> Tage
                        </div>
                    </div>
                    
                    <!-- Wachstum -->
                    <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <i class="fas fa-chart-line" style="font-size: 24px; opacity: 0.9;"></i>
                            <div>
                                <div style="font-size: 12px; opacity: 0.8;">Wachstum (vs. Vormonat)</div>
                                <div style="font-size: 24px; font-weight: 700;" id="growth-percentage">+0%</div>
                            </div>
                        </div>
                        <div style="font-size: 11px; opacity: 0.7; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2);">
                            Trend: <span id="growth-trend">ğŸ“ˆ Steigend</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- â„¹ï¸ INFO: Filter wurden entfernt, da Stat-Cards bereits alle ZeitrÃ¤ume (Heute/Woche/Monat) anzeigen -->

            <!-- Partner Ranking -->
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-trophy"></i> Partner-Ranking (Top 10)</span>
                </div>
                <div id="partner-ranking"></div>
            </div>

            <!-- ğŸ“ AKADEMIE-FORTSCHRITT -->
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-graduation-cap"></i> Akademie-Fortschritt (Partner)</span>
                    <button onclick="loadAkademieFortschritt()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                        <i class="fas fa-sync"></i> Aktualisieren
                    </button>
                </div>
                <div id="akademie-fortschritt" style="max-height: 500px; overflow-y: auto;">
                    <div style="text-align: center; padding: 40px; color: #a0aec0;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Lade Akademie-Fortschritt...</p>
                    </div>
                </div>
            </div>

            <!-- Kategorie-Ãœbersicht -->
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-chart-pie"></i> Umsatz nach Kategorie</span>
                </div>
                <div style="height: 400px;">
                    <canvas id="kategorieChart"></canvas>
                </div>
            </div>

            <!-- TÃ¤gliche Ãœbersicht -->
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-chart-bar"></i> TÃ¤glicher Umsatz-Verlauf</span>
                </div>
                <div style="height: 400px;">
                    <canvas id="tagesChart"></canvas>
                </div>
            </div>

            <!-- Detaillierte Tabelle -->
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-table"></i> Alle VerkÃ¤ufe</span>
                    <button class="btn btn-success" onclick="exportUmsatzCSV()">
                        <i class="fas fa-download"></i> CSV Export
                    </button>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>Partner</th>
                            <th>Kategorie</th>
                            <th>Produkt</th>
                            <th>Kunde</th>
                            <th>ğŸ’° Partner-Provision</th>
                            <th>ğŸ’³ Kundenpreis (Monat)</th>
                            <th>Status</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody id="umsatzTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Tab: E-Mail senden -->
        <div class="tab-content" id="tab-email">
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-paper-plane"></i> E-Mail an Partner senden</span>
                </div>

                <div class="success-message" id="emailSuccess">
                    âœ… E-Mail erfolgreich versendet!
                </div>

                <div class="error-message" id="emailError">
                    âŒ Fehler beim Versenden der E-Mail
                </div>

                <form id="emailForm">
                    <div class="form-group">
                        <label>EmpfÃ¤nger *</label>
                        <select id="email-empfaenger" required onchange="toggleEmpfaengerDetails()">
                            <option value="">Bitte wÃ¤hlen...</option>
                            <option value="alle">ğŸ“§ Alle Partner</option>
                            <option value="einzeln">ğŸ‘¤ Einzelner Partner</option>
                        </select>
                    </div>

                    <div class="form-group" id="partner-select-group" style="display: none;">
                        <label>Partner auswÃ¤hlen *</label>
                        <select id="email-partner">
                            <option value="">Bitte wÃ¤hlen...</option>
                        </select>
                    </div>

                    <div id="empfaenger-info" style="background: var(--bg); padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none;">
                        <strong>ğŸ“Š EmpfÃ¤nger-Ãœbersicht:</strong>
                        <div id="empfaenger-details" style="margin-top: 10px;"></div>
                    </div>

                    <div class="form-group">
                        <label>Betreff *</label>
                        <input type="text" id="email-betreff" required placeholder="z.B. Neue Provision-SÃ¤tze ab Februar">
                    </div>

                    <div class="form-group">
                        <label>Nachricht *</label>
                        <textarea id="email-nachricht" rows="8" required placeholder="Schreibe deine Nachricht hier...

Hallo {{vorname}},

verwende {{vorname}}, {{nachname}}, {{email}} fÃ¼r Platzhalter.

Viele GrÃ¼ÃŸe
Dein Team"></textarea>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> E-Mail senden
                        </button>
                        <button type="button" class="btn" style="background: var(--text-light); color: white;" onclick="previewEmail()">
                            <i class="fas fa-eye"></i> Vorschau
                        </button>
                    </div>
                </form>
            </div>

            <!-- E-Mail Verlauf -->
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-history"></i> E-Mail Verlauf</span>
                    <button class="btn btn-primary" onclick="loadEmailVerlauf()">
                        <i class="fas fa-sync"></i> Aktualisieren
                    </button>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>EmpfÃ¤nger</th>
                            <th>Betreff</th>
                            <th>Gesendet von</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="emailVerlaufTable">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 30px; color: var(--text-light);">
                                Noch keine E-Mails versendet
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: News & Aktionen -->
        <div class="tab-content" id="tab-news">
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-plus-circle"></i> Neue News/Aktion erstellen</span>
                </div>

                <div class="success-message" id="newsSuccess">
                    âœ… News erfolgreich gespeichert!
                </div>

                <form id="newsForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Titel *</label>
                            <input type="text" id="news-titel" required placeholder="z.B. Neue Provision-SÃ¤tze">
                        </div>

                        <div class="form-group">
                            <label>Typ *</label>
                            <select id="news-typ" required>
                                <option value="info">â„¹ï¸ Info</option>
                                <option value="warnung">âš ï¸ Warnung</option>
                                <option value="erfolg">âœ… Erfolg</option>
                                <option value="aktion">ğŸ”¥ Aktion</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Inhalt *</label>
                        <textarea id="news-inhalt" rows="4" required placeholder="Nachrichtentext hier eingeben..."></textarea>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>PrioritÃ¤t *</label>
                            <select id="news-prioritaet" required>
                                <option value="hoch">ğŸ”´ Hoch</option>
                                <option value="mittel">ğŸŸ¡ Mittel</option>
                                <option value="niedrig">ğŸŸ¢ Niedrig</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Zielgruppe *</label>
                            <select id="news-zielgruppe" required onchange="toggleZielgruppeInputs()">
                                <option value="alle">Alle Partner</option>
                                <option value="modell">Nach Modell filtern</option>
                                <option value="partner">Bestimmte Partner (E-Mails)</option>
                            </select>
                        </div>

                        <div class="form-group" id="news-modell-group" style="display: none;">
                            <label>Modell wÃ¤hlen</label>
                            <select id="news-modell-filter">
                                <option value="ladenlokal">Ladenlokal ğŸª</option>
                                <option value="promotion">Promotion ğŸ“£</option>
                                <option value="shopinshop">Shop-in-Shop ğŸ¬</option>
                                <option value="onlineshop">Online-Shop ğŸ’»</option>
                                <option value="affiliate">Affiliate ğŸ¤</option>
                            </select>
                        </div>

                        <div class="form-group" id="news-partner-group" style="display: none;">
                            <label>Partner E-Mails (kommagetrennt)</label>
                            <input type="text" id="news-partner-emails" placeholder="email1@test.de, email2@test.de">
                            <small style="color: var(--text-light); font-size: 12px;">E-Mails mit Komma trennen</small>
                        </div>

                        <div class="form-group">
                            <label>Icon (FontAwesome)</label>
                            <input type="text" id="news-icon" placeholder="fa-bell" value="fa-bell">
                            <small style="color: var(--text-light); font-size: 12px;">z.B. fa-bell, fa-fire, fa-trophy</small>
                        </div>

                        <div class="form-group">
                            <label>GÃ¼ltig bis (optional)</label>
                            <input type="date" id="news-gueltig">
                        </div>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="news-aktiv" checked style="width: auto;">
                            <span>Sofort fÃ¼r Partner sichtbar</span>
                        </label>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> News speichern
                    </button>
                </form>
            </div>

            <!-- News-Ãœbersicht -->
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-list"></i> Alle News & Aktionen</span>
                    <button class="btn btn-primary" onclick="loadNews()">
                        <i class="fas fa-sync"></i> Aktualisieren
                    </button>
                </div>
                <table class="data-table" id="newsTable">
                    <thead>
                        <tr>
                            <th>Titel</th>
                            <th>Typ</th>
                            <th>Zielgruppe</th>
                            <th>Erstellt</th>
                            <th>Status</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="6" style="text-align: center; color: #a0aec0; padding: 40px;">Lade News...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Ziel-Erreichung & Statistik -->
        <div class="tab-content" id="tab-ziel-erreichung" style="display: none;">
            <div style="margin-bottom: 24px;">
                <h2 style="font-size: 28px; font-weight: 700; color: #1a202c; margin: 0 0 8px 0;">
                    <i class="fas fa-trophy"></i> Ziel-Erreichung & Statistik
                </h2>
                <p style="color: #718096; margin: 0;">Ãœbersicht aller Partner mit Fortschritt zu Bonus-Staffeln</p>
            </div>

            <!-- Statistik-Cards -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px;">
                <!-- Staffel 1 Stats -->
                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; padding: 24px; color: white; box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Staffel 1 erreicht</div>
                    <div style="font-size: 36px; font-weight: 700;" id="stat-staffel1">0</div>
                    <div style="font-size: 13px; opacity: 0.8; margin-top: 4px;">Partner (10 VertrÃ¤ge)</div>
                </div>
                <!-- Staffel 2 Stats -->
                <div style="background: linear-gradient(135deg, #ff9500 0%, #ff5e3a 100%); border-radius: 12px; padding: 24px; color: white; box-shadow: 0 4px 14px rgba(255, 149, 0, 0.3);">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Staffel 2 erreicht</div>
                    <div style="font-size: 36px; font-weight: 700;" id="stat-staffel2">0</div>
                    <div style="font-size: 13px; opacity: 0.8; margin-top: 4px;">Partner (30 VertrÃ¤ge)</div>
                </div>
                <!-- Durchschnittlicher Fortschritt -->
                <div style="background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); border-radius: 12px; padding: 24px; color: white; box-shadow: 0 4px 14px rgba(102, 126, 234, 0.3);">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Ã˜ Fortschritt</div>
                    <div style="font-size: 36px; font-weight: 700;" id="stat-avg-progress">0%</div>
                    <div style="font-size: 13px; opacity: 0.8; margin-top: 4px;">Alle Partner</div>
                </div>
                <!-- Gesamt Bonus ausgezahlt -->
                <div style="background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%); border-radius: 12px; padding: 24px; color: #8b6914; box-shadow: 0 4px 14px rgba(255, 215, 0, 0.3);">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Bonus ausgezahlt</div>
                    <div style="font-size: 36px; font-weight: 700;" id="stat-total-bonus">0â‚¬</div>
                    <div style="font-size: 13px; opacity: 0.8; margin-top: 4px;">Gesamt</div>
                </div>
            </div>

            <!-- Filter & Aktualisieren -->
            <div style="background: white; padding: 16px 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; gap: 12px; align-items: center;">
                    <select id="filter-staffel" onchange="filterZielErreichung()" style="padding: 10px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; cursor: pointer; background: white;">
                        <option value="">Alle Staffeln</option>
                        <option value="staffel1">Staffel 1 (10 VertrÃ¤ge)</option>
                        <option value="staffel2">Staffel 2 (30 VertrÃ¤ge)</option>
                        <option value="none">Noch keine Staffel erreicht</option>
                    </select>
                    <input type="text" id="search-ziel" placeholder="ğŸ” Suche Partner..." oninput="filterZielErreichung()" style="padding: 10px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; width: 250px;">
                </div>
                <button onclick="loadZielErreichung()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s;" onmouseover="this.style.background='#5568d3'" onmouseout="this.style.background='#3b82f6'">
                    <i class="fas fa-sync"></i> Aktualisieren
                </button>
            </div>

            <!-- Partner-Fortschritt Tabelle -->
            <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f7fafc; border-bottom: 2px solid #e2e8f0;">
                                <th style="padding: 14px 12px; text-align: left; font-size: 13px; font-weight: 600; color: #4a5568;">Partner</th>
                                <th style="padding: 14px 12px; text-align: center; font-size: 13px; font-weight: 600; color: #4a5568;">Modell</th>
                                <th style="padding: 14px 12px; text-align: center; font-size: 13px; font-weight: 600; color: #4a5568;">Mobilfunk</th>
                                <th style="padding: 14px 12px; text-align: center; font-size: 13px; font-weight: 600; color: #4a5568;">Internet</th>
                                <th style="padding: 14px 12px; text-align: center; font-size: 13px; font-weight: 600; color: #4a5568;">Strom</th>
                                <th style="padding: 14px 12px; text-align: left; font-size: 13px; font-weight: 600; color: #4a5568;">Fortschritt</th>
                                <th style="padding: 14px 12px; text-align: center; font-size: 13px; font-weight: 600; color: #4a5568;">Erreichte Staffel</th>
                                <th style="padding: 14px 12px; text-align: center; font-size: 13px; font-weight: 600; color: #4a5568;">Bonus</th>
                            </tr>
                        </thead>
                        <tbody id="ziel-table-body">
                            <tr>
                                <td colspan="8" style="padding: 60px; text-align: center; color: #718096;">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 16px; display: block;"></i>
                                    <p style="margin: 0; font-size: 16px;">Lade Ziel-Erreichung...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- âœ… PAGINATION FÃœR ZIEL-ERREICHUNG -->
                <div id="ziel-pagination" style="display: flex; justify-content: center; align-items: center; gap: 12px; margin-top: 20px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                    <button onclick="zielPrevPage()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-chevron-left"></i> ZurÃ¼ck
                    </button>
                    <span id="ziel-page-info" style="font-size: 14px; color: #4a5568; font-weight: 600;">Seite 1 von 1</span>
                    <button onclick="zielNextPage()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                        Weiter <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab: Interessenten / Neue Anfragen -->
        <div class="tab-content" id="tab-interessenten">
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-inbox"></i> Neue Anfragen & Interessenten</span>
                    <button class="btn btn-primary" onclick="loadInteressenten()">
                        <i class="fas fa-sync"></i> Aktualisieren
                    </button>
                </div>

                <!-- ğŸ¨ MODERNE STAT-CARDS MIT GRADIENTS -->
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px;">
                    <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); color: white; border: none;">
                        <div class="stat-label" style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin-bottom: 10px;">
                            <i class="fas fa-inbox" style="margin-right: 6px;"></i> Neue Anfragen
                        </div>
                        <div class="stat-value" style="color: white; font-size: 2.5rem; font-weight: 700;" id="stat-neu">0</div>
                        <div style="font-size: 0.8rem; opacity: 0.85; margin-top: 5px;">Zu bearbeiten</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); color: white; border: none;">
                        <div class="stat-label" style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin-bottom: 10px;">
                            <i class="fas fa-phone" style="margin-right: 6px;"></i> Kontaktiert
                        </div>
                        <div class="stat-value" style="color: white; font-size: 2.5rem; font-weight: 700;" id="stat-kontaktiert">0</div>
                        <div style="font-size: 0.8rem; opacity: 0.85; margin-top: 5px;">In Bearbeitung</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; border: none;">
                        <div class="stat-label" style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin-bottom: 10px;">
                            <i class="fas fa-calendar-check" style="margin-right: 6px;"></i> Termin vereinbart
                        </div>
                        <div class="stat-value" style="color: white; font-size: 2.5rem; font-weight: 700;" id="stat-termin">0</div>
                        <div style="font-size: 0.8rem; opacity: 0.85; margin-top: 5px;">NÃ¤chster Schritt</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%); color: white; border: none; cursor: pointer;" onclick="scrollToBestandsPartner()">
                        <div class="stat-label" style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin-bottom: 10px;">
                            <i class="fas fa-user-clock" style="margin-right: 6px;"></i> Bestands-Partner
                        </div>
                        <div class="stat-value" style="color: white; font-size: 2.5rem; font-weight: 700;" id="stat-bestandspartner-login">0</div>
                        <div style="font-size: 0.8rem; opacity: 0.85; margin-top: 5px;">Erst-Logins</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); color: white; border: none;">
                        <div class="stat-label" style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin-bottom: 10px;">
                            <i class="fas fa-chart-line" style="margin-right: 6px;"></i> Gesamt
                        </div>
                        <div class="stat-value" style="color: white; font-size: 2.5rem; font-weight: 700;" id="stat-gesamt">0</div>
                        <div style="font-size: 0.8rem; opacity: 0.85; margin-top: 5px;">Alle Anfragen</div>
                    </div>
                </div>
                
                <!-- ğŸ†• BESTANDS-PARTNER ERST-LOGINS - KOLLABIERBAR -->
                <div class="card" id="bestandspartner-section" style="margin-bottom: 25px; border: 2px solid #9f7aea;">
                    <div class="card-title" style="background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%); color: white; margin: -20px -20px 20px -20px; padding: 15px 20px; border-radius: 10px 10px 0 0; cursor: pointer;" onclick="toggleBestandsPartnerSection()">
                        <span><i class="fas fa-user-clock"></i> Bestands-Partner Erst-Logins (313 aus CSV) <i class="fas fa-chevron-down" id="bp-collapse-icon" style="margin-left: 10px; transition: transform 0.3s;"></i></span>
                        <div style="display: flex; gap: 10px;" onclick="event.stopPropagation();">
                            <select id="bestandspartner-filter" onchange="filterBestandsPartner()" style="padding: 8px 12px; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer;">
                                <option value="alle">Alle anzeigen</option>
                                <option value="eingeloggt">âœ… Eingeloggt</option>
                                <option value="ausstehend">â³ Noch nicht eingeloggt</option>
                                <option value="pw_geaendert">ğŸ” PW geÃ¤ndert</option>
                                <option value="pw_nicht_geaendert">âš ï¸ PW nicht geÃ¤ndert</option>
                            </select>
                            <button class="btn" style="background: white; color: #805ad5;" onclick="loadBestandsPartnerLogins()">
                                <i class="fas fa-sync"></i> Aktualisieren
                            </button>
                            <button class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);" onclick="toggleBestandsPartnerSection()" title="Einklappen/Ausklappen">
                                <i class="fas fa-compress-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div id="bp-content-wrapper" style="transition: all 0.3s ease;">
                    
                    <!-- Quick Stats fÃ¼r Bestands-Partner -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;" id="bestandspartner-stats">
                        <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-radius: 12px; padding: 15px; text-align: center; border: 1px solid #bbf7d0;">
                            <div style="font-size: 0.8rem; color: #16a34a; font-weight: 600; margin-bottom: 5px;"><i class="fas fa-check-circle"></i> Eingeloggt</div>
                            <div style="font-size: 1.75rem; font-weight: 800; color: #15803d;" id="bp-stat-eingeloggt">0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 12px; padding: 15px; text-align: center; border: 1px solid #fcd34d;">
                            <div style="font-size: 0.8rem; color: #d97706; font-weight: 600; margin-bottom: 5px;"><i class="fas fa-clock"></i> Ausstehend</div>
                            <div style="font-size: 1.75rem; font-weight: 800; color: #b45309;" id="bp-stat-ausstehend">0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-radius: 12px; padding: 15px; text-align: center; border: 1px solid #93c5fd;">
                            <div style="font-size: 0.8rem; color: #2563eb; font-weight: 600; margin-bottom: 5px;"><i class="fas fa-key"></i> PW geÃ¤ndert</div>
                            <div style="font-size: 1.75rem; font-weight: 800; color: #1d4ed8;" id="bp-stat-pw-geaendert">0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fae8ff, #f5d0fe); border-radius: 12px; padding: 15px; text-align: center; border: 1px solid #e879f9;">
                            <div style="font-size: 0.8rem; color: #a21caf; font-weight: 600; margin-bottom: 5px;"><i class="fas fa-users"></i> Gesamt</div>
                            <div style="font-size: 1.75rem; font-weight: 800; color: #86198f;" id="bp-stat-gesamt">313</div>
                        </div>
                    </div>
                    
                    <!-- Suche -->
                    <div style="margin-bottom: 15px;">
                        <input type="text" id="bestandspartner-suche" placeholder="ğŸ” Suche nach E-Mail oder Name..." onkeyup="filterBestandsPartner()" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#9f7aea'" onblur="this.style.borderColor='#e2e8f0'">
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 120px;">Status</th>
                                    <th>Erst-Login</th>
                                    <th>E-Mail</th>
                                    <th>Name</th>
                                    <th style="width: 140px;">Passwort</th>
                                    <th>Letzter Login</th>
                                    <th style="text-align: center; width: 120px;">Aktion</th>
                                </tr>
                            </thead>
                            <tbody id="bestandsPartnerTable">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 30px; color: var(--text-light);">
                                        <i class="fas fa-spinner fa-spin"></i> Lade Bestands-Partner...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination Controls -->
                    <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <span id="bestandspartner-count-info" style="font-size: 0.85rem; color: #64748b;">Zeige 0 von 0 Bestands-Partnern</span>
                        
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <select id="bp-page-size" onchange="changeBPPageSize()" style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;">
                                <option value="10" selected>10 pro Seite</option>
                                <option value="25">25 pro Seite</option>
                                <option value="50">50 pro Seite</option>
                                <option value="100">100 pro Seite</option>
                            </select>
                            
                            <div id="bp-pagination" style="display: flex; gap: 5px; align-items: center;">
                                <!-- Pagination Buttons werden dynamisch eingefÃ¼gt -->
                            </div>
                        </div>
                        
                        <span style="background: #f1f5f9; padding: 6px 12px; border-radius: 6px; font-weight: 600; font-size: 0.85rem;">
                            <i class="fas fa-database"></i> Aus CSV importiert
                        </span>
                    </div>
                    </div><!-- Ende bp-content-wrapper -->
                </div>

                <!-- ğŸ” FILTER FÃœR ANFRAGEN -->
                <div class="card" style="margin-bottom: 16px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label><i class="fas fa-calendar"></i> Von Datum</label>
                            <input type="date" id="anfragen-von-datum" onchange="filterAnfragen()" style="padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-calendar"></i> Bis Datum</label>
                            <input type="date" id="anfragen-bis-datum" onchange="filterAnfragen()" style="padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-filter"></i> Status</label>
                            <select id="anfragen-status-filter" onchange="filterAnfragen()">
                                <option value="alle">Alle Status</option>
                                <option value="neu">Neu</option>
                                <option value="kontaktiert">Kontaktiert</option>
                                <option value="termin">Termin vereinbart</option>
                                <option value="abgeschlossen">Abgeschlossen</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-store"></i> Modell</label>
                            <select id="anfragen-kanal-filter" onchange="filterAnfragen()">
                                <option value="alle">Alle Modelle</option>
                                <option value="ladenlokal">ğŸª Ladenlokal</option>
                                <option value="promotion">ğŸ“¢ Promotion Stand</option>
                                <option value="onlineshop">ğŸ’» Online Shop</option>
                                <option value="shopinshop">ğŸ¬ Shop-in-Shop</option>
                                <option value="affiliate">ğŸ”— Affiliate</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Tabelle mit horizontalem Scroll fÃ¼r Mobile -->
                <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                    <table class="data-table" style="min-width: 800px;">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Datum</th>
                                <th>Name</th>
                                <th>Modell</th>
                                <th>Kontakt</th>
                                <th>Erfahrung</th>
                                <th>Aktion</th>
                            </tr>
                        </thead>
                        <tbody id="interessentenTable">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 30px; color: var(--text-light);">
                                    <i class="fas fa-spinner fa-spin"></i> Lade Anfragen...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Provisionen -->
        <div class="tab-content" id="tab-provisionen">
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-euro-sign"></i> Neue Provision eintragen</span>
                </div>

                <div class="success-message" id="provisionSuccess">
                    âœ… Provision erfolgreich eingetragen!
                </div>

                <form id="provisionForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Partner E-Mail *</label>
                            <input type="email" id="prov_email" list="partnerList" required placeholder="partner@example.com">
                            <datalist id="partnerList"></datalist>
                        </div>

                        <div class="form-group">
                            <label>Betrag (â‚¬) *</label>
                            <input type="number" id="prov_betrag" step="0.01" min="0" required placeholder="150.00">
                        </div>

                        <div class="form-group">
                            <label>Typ *</label>
                            <select id="prov_typ" required>
                                <option value="">Bitte wÃ¤hlen...</option>
                                <option value="mobilfunk">Mobilfunk</option>
                                <option value="dsl">DSL/Internet</option>
                                <option value="strom">Strom</option>
                                <option value="versicherung">Versicherung</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Status *</label>
                            <select id="prov_status" required>
                                <option value="ausstehend">Ausstehend</option>
                                <option value="ausgezahlt">Ausgezahlt</option>
                                <option value="storniert">Storniert</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Tarif-Name *</label>
                        <input type="text" id="prov_tarif" required placeholder="O2 Mobile M">
                    </div>

                    <div class="form-group">
                        <label>Kundenname (optional)</label>
                        <input type="text" id="prov_kunde" placeholder="Max Mustermann">
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Provision speichern
                    </button>
                </form>
            </div>

            <!-- Letzte Provisionen -->
            <div class="card">
                <div class="card-title">
                    <span>Letzte Provisionen</span>
                    <button class="btn btn-primary" onclick="loadProvisionen()">
                        <i class="fas fa-sync"></i> Aktualisieren
                    </button>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Partner</th>
                            <th>Betrag</th>
                            <th>Typ</th>
                            <th>Tarif</th>
                            <th>Datum</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="provisionenTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Auszahlungen -->
        <div class="tab-content" id="tab-auszahlungen">
            <!-- Stats -->
            <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 25px;">
                <div class="stat-card">
                    <div class="stat-label">Gesamt Ausgezahlt</div>
                    <div class="stat-value" id="stat_auszahlungen_gesamt" style="color: #48bb78;">0 â‚¬</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Ausstehend</div>
                    <div class="stat-value" id="stat_auszahlungen_ausstehend" style="color: #ed8936;">0 â‚¬</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Abgelehnt/Storniert</div>
                    <div class="stat-value" id="stat_auszahlungen_abgelehnt" style="color: #f56565;">0 â‚¬</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Anzahl Auszahlungen</div>
                    <div class="stat-value" id="stat_auszahlungen_anzahl">0</div>
                </div>
            </div>

            <!-- Filter & Suche -->
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-money-bill-wave"></i> Alle Auszahlungen</span>
                    <div style="display: flex; gap: 12px;">
                        <select id="filter_auszahlungen_status" onchange="loadAuszahlungen()" style="padding: 8px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; cursor: pointer;">
                            <option value="">Alle Status</option>
                            <option value="ausgezahlt">âœ… Ausgezahlt</option>
                            <option value="ausstehend">â³ Ausstehend</option>
                            <option value="in_bearbeitung">ğŸ”„ In Bearbeitung</option>
                            <option value="abgelehnt">âŒ Abgelehnt</option>
                            <option value="storniert">ğŸš« Storniert</option>
                        </select>
                        <input type="text" id="search_auszahlungen" placeholder="Partner suchen..." onkeyup="loadAuszahlungen()" style="padding: 8px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; width: 250px;">
                        <button class="btn btn-primary" onclick="loadAuszahlungen()">
                            <i class="fas fa-sync"></i> Aktualisieren
                        </button>
                    </div>
                </div>

                <!-- Auszahlungen-Tabelle -->
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Partner</th>
                                <th>E-Mail</th>
                                <th>Betrag</th>
                                <th>Tarif</th>
                                <th>Typ</th>
                                <th>Status</th>
                                <th>Datum</th>
                                <th>Ausgezahlt am</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="auszahlungenTable">
                            <!-- Wird dynamisch gefÃ¼llt -->
                        </tbody>
                    </table>
                </div>

                <!-- Loading State -->
                <div id="auszahlungen-loading" style="display: none; text-align: center; padding: 40px; color: #718096;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 12px;"></i>
                    <p>Lade Auszahlungen...</p>
                </div>

                <!-- Empty State -->
                <div id="auszahlungen-empty" style="display: none; text-align: center; padding: 60px; color: #a0aec0;">
                    <i class="fas fa-inbox" style="font-size: 64px; margin-bottom: 20px; opacity: 0.3;"></i>
                    <h3 style="margin: 0 0 8px 0; color: #718096;">Keine Auszahlungen gefunden</h3>
                    <p style="margin: 0; font-size: 14px;">Es wurden noch keine Provisionen ausgezahlt.</p>
                </div>
            </div>
        </div>

        <!-- Tab: Partner -->
        <div class="tab-content" id="tab-partner">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Gesamt Partner</div>
                    <div class="stat-value" id="stat_partner">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Aktive Partner</div>
                    <div class="stat-value" id="stat_aktiv">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Neue Partner</div>
                    <div class="stat-value" id="stat_neu">0</div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">
                    <span>Alle Partner</span>
                    <button class="btn btn-primary" onclick="loadPartner()">
                        <i class="fas fa-sync"></i> Aktualisieren
                    </button>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>E-Mail</th>
                            <th>Modell</th>
                            <th>Status</th>
                            <th>Registriert</th>
                        </tr>
                    </thead>
                    <tbody id="partnerTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Projekte -->
        <div class="tab-content" id="tab-projekte">
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-tasks"></i> Projekt-Status aktualisieren</span>
                </div>

                <div class="success-message" id="projektSuccess">
                    âœ… Projekt erfolgreich aktualisiert!
                </div>

                <form id="projektForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Partner E-Mail *</label>
                            <input type="email" id="proj_email" list="partnerList2" required>
                            <datalist id="partnerList2"></datalist>
                        </div>

                        <div class="form-group">
                            <label>Fortschritt (%) *</label>
                            <input type="number" id="proj_fortschritt" min="0" max="100" required>
                        </div>

                        <div class="form-group">
                            <label>Status *</label>
                            <select id="proj_status" required>
                                <option value="in_bearbeitung">In Bearbeitung</option>
                                <option value="abgeschlossen">Abgeschlossen</option>
                                <option value="pausiert">Pausiert</option>
                            </select>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Projekt aktualisieren
                    </button>
                </form>
            </div>

            <div class="card">
                <div class="card-title">Aktive Projekte</div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Partner</th>
                            <th>Typ</th>
                            <th>Fortschritt</th>
                            <th>Start</th>
                            <th>Ziel</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="projekteTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Dokumente -->
        <div class="tab-content" id="tab-dokumente">
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-folder"></i> Hochgeladene Dokumente</span>
                    <button class="btn btn-primary" onclick="loadDokumente()">
                        <i class="fas fa-sync"></i> Aktualisieren
                    </button>
                </div>

                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 25px;">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #ed8936;">
                            <i class="fas fa-upload"></i>
                        </div>
                        <div class="stat-value" id="stat-dok-hochgeladen">0</div>
                        <div class="stat-label">Hochgeladen</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #48bb78;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-value" id="stat-dok-geprueft">0</div>
                        <div class="stat-label">GeprÃ¼ft</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #f56565;">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="stat-value" id="stat-dok-abgelehnt">0</div>
                        <div class="stat-label">Abgelehnt</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #4299e1;">
                            <i class="fas fa-folder-open"></i>
                        </div>
                        <div class="stat-value" id="stat-dok-gesamt">0</div>
                        <div class="stat-label">Gesamt</div>
                    </div>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Datum</th>
                            <th>Partner</th>
                            <th>Typ</th>
                            <th>Dateiname</th>
                            <th>Dokument</th>
                            <th>Aktion</th>
                        </tr>
                    </thead>
                    <tbody id="dokumenteTable">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 30px; color: var(--text-light);">
                                <i class="fas fa-spinner fa-spin"></i> Lade Dokumente...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Akademie & Onboarding -->
        <div class="tab-content" id="tab-akademie">
            <!-- ğŸ“ Header -->
            <div style="background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); padding: 25px; border-radius: 12px; margin-bottom: 25px; color: white; box-shadow: 0 4px 14px rgba(102, 126, 234, 0.3);">
                <h2 style="margin: 0 0 10px 0; font-size: 24px; font-weight: 700;">ğŸ“ Akademie & Schulung</h2>
                <p style="margin: 0; opacity: 0.95; font-size: 15px;">Partner-Fortschritt, Zertifikate und Schulungsstatus auf einen Blick</p>
            </div>

            <!-- Stats -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 25px;">
                <div style="background: linear-gradient(135deg, #10b981, #059669); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                    <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">Onboarding abgeschlossen</div>
                    <div style="font-size: 32px; font-weight: 700;" id="stat_onboarding">0</div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Partner</div>
                </div>
                <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                    <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">Partner in Schulung</div>
                    <div style="font-size: 32px; font-weight: 700;" id="stat_schulung">0</div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Aktiv</div>
                </div>
                <div style="background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">
                    <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">Zertifikate ausgestellt</div>
                    <div style="font-size: 32px; font-weight: 700;" id="stat_zertifikate">0</div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Gesamt</div>
                </div>
                <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);">
                    <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">Ã˜ Fortschritt</div>
                    <div style="font-size: 32px; font-weight: 700;" id="stat_avg_fortschritt">0%</div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Alle Partner</div>
                </div>
            </div>

            <!-- ğŸ“Š SCHÃ–NE STATISTIK-DIAGRAMME -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 20px; margin-bottom: 25px;">
                
                <!-- ğŸ“Š DIAGRAMM 1: Modul-Fortschritt Balkendiagramm -->
                <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #e2e8f0;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                        <div>
                            <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: #1e293b;">ğŸ“Š Modul-AbschlÃ¼sse</h3>
                            <p style="margin: 4px 0 0 0; font-size: 13px; color: #64748b;">Anzahl abgeschlossener Module pro Kurs</p>
                        </div>
                        <div style="background: linear-gradient(135deg, #3b82f6, #60a5fa); width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-chart-bar" style="color: white; font-size: 18px;"></i>
                        </div>
                    </div>
                    <div style="height: 280px; position: relative;">
                        <canvas id="chart-modul-abschluesse"></canvas>
                    </div>
                </div>

                <!-- ğŸ© DIAGRAMM 2: Zertifikate-Verteilung Donut -->
                <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #e2e8f0;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                        <div>
                            <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: #1e293b;">ğŸ† Zertifikate-Verteilung</h3>
                            <p style="margin: 4px 0 0 0; font-size: 13px; color: #64748b;">Verteilung nach Modul</p>
                        </div>
                        <div style="background: linear-gradient(135deg, #f59e0b, #d97706); width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-award" style="color: white; font-size: 18px;"></i>
                        </div>
                    </div>
                    <div style="height: 280px; position: relative;">
                        <canvas id="chart-zertifikate-verteilung"></canvas>
                    </div>
                </div>

                <!-- ğŸ“ˆ DIAGRAMM 3: Partner-AktivitÃ¤t Linie -->
                <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #e2e8f0; grid-column: span 2;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                        <div>
                            <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: #1e293b;">ğŸ“ˆ Partner-LernaktivitÃ¤t</h3>
                            <p style="margin: 4px 0 0 0; font-size: 13px; color: #64748b;">Fortschrittsverteilung aller Partner</p>
                        </div>
                        <div style="background: linear-gradient(135deg, #10b981, #059669); width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-chart-line" style="color: white; font-size: 18px;"></i>
                        </div>
                    </div>
                    <div style="height: 250px; position: relative;">
                        <canvas id="chart-partner-aktivitaet"></canvas>
                    </div>
                </div>
            </div>

            <!-- ğŸ“ PARTNER-AKKORDEON (wie Provisionen/VertrÃ¤ge) -->
            <div class="card" style="margin-bottom: 25px;">
                <div class="card-title" style="background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; border-radius: 10px 10px 0 0; padding: 20px;">
                    <span><i class="fas fa-graduation-cap"></i> Partner-Fortschritt</span>
                    <div style="display: flex; gap: 8px;">
                        <select id="akademie-filter-status" onchange="filterAkademieByPartner()" style="padding: 8px 12px; border: 2px solid white; background: white; color: #3b82f6; border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: 600;">
                            <option value="">Alle Partner</option>
                            <option value="fertig">âœ… 100% Abgeschlossen</option>
                            <option value="fortschritt">ğŸ”„ In Bearbeitung</option>
                            <option value="offen">â¸ï¸ Noch nicht gestartet (0%)</option>
                        </select>
                        <button onclick="loadAkademie()" style="padding: 8px 16px; background: white; color: #3b82f6; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-sync"></i> Aktualisieren
                        </button>
                    </div>
                </div>
                
                <!-- ğŸ“Š PARTNER-AKKORDEON -->
                <div id="akademie-partner-list" style="padding: 20px; display: grid; gap: 12px;">
                    <div style="text-align: center; padding: 40px; color: #a0aec0;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 15px;"></i>
                        <p>Lade Partner-Fortschritt...</p>
                    </div>
                </div>
                
                <!-- ğŸ“„ PAGINATION -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-top: 2px solid #e2e8f0;">
                    <button onclick="akademiePrevPage()" id="akademie-prev-btn" style="padding: 10px 20px; background: #f7fafc; color: #4a5568; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#edf2f7'" onmouseout="this.style.background='#f7fafc'">
                        <i class="fas fa-chevron-left"></i> ZurÃ¼ck
                    </button>
                    <span id="akademie-page-info" style="font-size: 14px; color: #4a5568; font-weight: 600;">Seite 1 von 1</span>
                    <button onclick="akademieNextPage()" id="akademie-next-btn" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#5568d3'" onmouseout="this.style.background='#3b82f6'">
                        Weiter <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- ğŸ¤ Tab: Partner-Programm (MLM) -->
        <div class="tab-content" id="tab-partner-programm">
            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 25px; border-radius: 12px; margin-bottom: 25px; color: white;">
                <h2 style="margin: 0 0 10px 0; font-size: 24px; font-weight: 700;">ğŸ¤ Partner-Programm</h2>
                <p style="margin: 0; opacity: 0.95; font-size: 15px;">Ãœbersicht aller geworbenen Partner und Provisionen</p>
            </div>

            <!-- Statistiken -->
            <div class="stats-grid" style="margin-bottom: 25px;">
                <div class="stat-card">
                    <div class="stat-label">Gesamt Partner</div>
                    <div class="stat-value" id="mlm-gesamt">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Aktive Werbungen</div>
                    <div class="stat-value" id="mlm-aktiv">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Gesamt-Provision</div>
                    <div class="stat-value" id="mlm-provision">0â‚¬</div>
                </div>
            </div>

            <!-- Tabelle -->
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-list"></i> Geworbene Partner</span>
                    <button class="btn btn-primary" onclick="loadMLM()">
                        <i class="fas fa-sync"></i> Aktualisieren
                    </button>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Werber</th>
                            <th>Geworbener Partner</th>
                            <th>Registriert am</th>
                            <th>Status</th>
                            <th>VertrÃ¤ge</th>
                            <th>Provision</th>
                        </tr>
                    </thead>
                    <tbody id="mlm-table-body">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #a0aec0;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 15px;"></i>
                                <p>Lade Partner-Programm...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ğŸ’¬ Tab: Live Chat -->
        <!-- ğŸ“¢ Tab: KOMMUNIKATION (konsolidiert: Live Chat, Tickets, Termine) -->
        <div class="tab-content" id="tab-kommunikation">
            <div style="background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); padding: 25px; border-radius: 12px; margin-bottom: 25px; color: white;">
                <h2 style="margin: 0 0 10px 0; font-size: 24px; font-weight: 700;">ğŸ“¢ Kommunikation</h2>
                <p style="margin: 0; opacity: 0.95; font-size: 15px;">Live Chat â€¢ Support Tickets â€¢ Termine - alles an einem Ort</p>
            </div>

            <!-- ğŸ’¬ LIVE CHAT -->
            <div class="card" style="margin-bottom: 25px;">
                <div class="card-title" style="background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; border-radius: 10px 10px 0 0; padding: 20px;">
                    <span><i class="fas fa-comments"></i> ğŸ’¬ Live Chat</span>
                    <button onclick="loadChatMessages()" style="padding: 8px 16px; background: white; color: #3b82f6; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        <i class="fas fa-sync"></i> Aktualisieren
                    </button>
                </div>
                <div id="chat-list" style="min-height: 350px; padding: 20px;">
                    <div style="text-align: center; padding: 60px; color: #a0aec0;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 40px; margin-bottom: 20px;"></i>
                        <p>Lade Chat-Nachrichten...</p>
                    </div>
                </div>
            </div>

            <!-- ğŸ« SUPPORT TICKETS -->
            <div class="card" style="margin-bottom: 25px;">
                <div class="card-title" style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white; border-radius: 10px 10px 0 0; padding: 20px;">
                    <span><i class="fas fa-ticket-alt"></i> ğŸ« Support Tickets</span>
                    <button onclick="loadTickets()" style="padding: 8px 16px; background: white; color: #f5576c; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        <i class="fas fa-sync"></i> Aktualisieren
                    </button>
                </div>
                
                <div class="stats-grid" style="padding: 20px; gap: 12px;">
                    <div class="stat-card" style="background: #fff5f5;">
                        <div class="stat-label">Offen</div>
                        <div class="stat-value" id="tickets-offen" style="color: #f56565;">0</div>
                    </div>
                    <div class="stat-card" style="background: #fffaf0;">
                        <div class="stat-label">In Bearbeitung</div>
                        <div class="stat-value" id="tickets-bearbeitung" style="color: #ed8936;">0</div>
                    </div>
                    <div class="stat-card" style="background: #f0fff4;">
                        <div class="stat-label">GelÃ¶st</div>
                        <div class="stat-value" id="tickets-geloest" style="color: #48bb78;">0</div>
                    </div>
                    <div class="stat-card" style="background: #edf2f7;">
                        <div class="stat-label">Gesamt</div>
                        <div class="stat-value" id="tickets-gesamt" style="color: #4a5568;">0</div>
                    </div>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ticket-Nr</th>
                            <th>Partner</th>
                            <th>Betreff</th>
                            <th>Kategorie</th>
                            <th>PrioritÃ¤t</th>
                            <th>Status</th>
                            <th>Erstellt</th>
                        </tr>
                    </thead>
                    <tbody id="ticketsTable">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #a0aec0;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 15px;"></i>
                                <p>Lade Tickets...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- ğŸ“… TERMINE & KALENDER -->
            <div class="card" style="margin-bottom: 25px;">
                <div class="card-title" style="background: linear-gradient(135deg, #4fd1c5, #38b2ac); color: white; border-radius: 10px 10px 0 0; padding: 20px;">
                    <span><i class="fas fa-calendar-alt"></i> ğŸ“… Termine & Kalender</span>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="openNeuerTerminModal()" style="padding: 8px 16px; background: white; color: #38b2ac; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-plus-circle"></i> Neuer Termin
                        </button>
                        <button onclick="loadTermine()" style="padding: 8px 16px; background: white; color: #38b2ac; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-sync"></i>
                        </button>
                    </div>
                </div>

                <!-- Kalender & Termine nebeneinander (kompakt) -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px;">
                    
                    <!-- Kalender -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <button onclick="changeMonth(-1)" style="padding: 8px 12px; background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div id="calendar-header" style="text-align: center; font-size: 16px; font-weight: 700; color: #1a202c;">
                                November 2025
                            </div>
                            <button onclick="changeMonth(1)" style="padding: 8px 12px; background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        
                        <!-- Kalender Grid -->
                        <div id="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;">
                            <!-- Wird mit JavaScript gefÃ¼llt -->
                        </div>
                    </div>

                    <!-- Termine Liste -->
                    <div>
                        <h4 style="margin: 0 0 15px 0; font-size: 14px; font-weight: 700; color: #4a5568;">Kommende Termine</h4>
                        <div id="termine-liste" style="display: flex; flex-direction: column; gap: 12px; max-height: 400px; overflow-y: auto;">
                            <div style="text-align: center; padding: 40px; color: #a0aec0;">
                                <i class="fas fa-calendar-check" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
                                <p>Keine Termine vorhanden</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Alle Termine Tabelle -->
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>Uhrzeit</th>
                            <th>Titel</th>
                            <th>Partner</th>
                            <th>Typ</th>
                            <th>Status</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody id="termineTable">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #a0aec0;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 15px;"></i>
                                <p>Lade Termine...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ğŸ†• Tab: Partner Status Check -->
        <div class="tab-content" id="tab-status-check">
            <div class="card">
                <div class="card-title">
                    <span>ğŸ” Partner Status Check</span>
                </div>
                <p style="color: #718096; margin-bottom: 25px;">ÃœberprÃ¼fen Sie den aktuellen Onboarding-Status direkt aus der Datenbank</p>
                
                <div style="margin-bottom: 25px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #4a5568;">Partner E-Mail-Adresse:</label>
                    <input type="email" 
                           id="statusCheckEmail" 
                           placeholder="partner@beispiel.de" 
                           style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; transition: all 0.3s;"
                           onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'"
                           onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'">
                </div>
                
                <button class="btn btn-primary" onclick="checkPartnerStatus()">
                    <i class="fas fa-search"></i> Status Ã¼berprÃ¼fen
                </button>
                
                <div id="statusCheckResults" style="display: none; margin-top: 30px; padding-top: 30px; border-top: 2px solid #e2e8f0;">
                    <h3 style="margin-bottom: 20px; color: #2d3748;">ğŸ“Š Aktueller Status</h3>
                    <div id="statusCheckItems"></div>
                    
                    <div style="background: #e0e7ff; border-left: 4px solid #3b82f6; padding: 16px; border-radius: 10px; margin-top: 20px;">
                        <strong style="color: #4c51bf;">â„¹ï¸ Info:</strong> Diese Daten werden direkt aus der Datenbank geladen (keine Caches). 
                        Sie sehen hier genau das, was auch das Dashboard sehen sollte.
                    </div>
                    
                    <details style="margin-top: 20px;">
                        <summary style="cursor: pointer; font-weight: 600; color: #4a5568; padding: 10px; background: #f7fafc; border-radius: 8px;">
                            ğŸ”§ Raw Database JSON anzeigen
                        </summary>
                        <pre id="statusCheckRawData" style="background: #1a202c; color: #e2e8f0; padding: 20px; border-radius: 10px; margin-top: 10px; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6; overflow-x: auto;"></pre>
                    </details>
                </div>
            </div>
        </div>

        <!-- ğŸ†• Tab: Partner Import (vereint) -->
        <div class="tab-content" id="tab-partner-import">
            <div class="card">
                <div class="card-title">
                    <span>ğŸ“¤ Partner Import</span>
                </div>
                <p style="color: #718096; margin-bottom: 25px;">Importieren Sie Partner aus CSV-Dateien (Shopify-Format oder Custom-Format)</p>
                
                <div style="background: #fffbeb; border: 1px solid #fbbf24; border-radius: 10px; padding: 20px; margin-bottom: 25px;">
                    <h4 style="margin: 0 0 10px 0; color: #92400e;">âš ï¸ Wichtige Hinweise:</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #92400e;">
                        <li>CSV-Datei muss Header-Zeile enthalten</li>
                        <li>Mindestens E-Mail-Feld erforderlich</li>
                        <li>Existierende Partner werden Ã¼bersprungen</li>
                        <li>Max. 100 Partner pro Import</li>
                    </ul>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #4a5568;">CSV-Datei auswÃ¤hlen:</label>
                    <input type="file" 
                           id="csvFileInput" 
                           accept=".csv" 
                           style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px;">
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #4a5568;">Standard-Tarif:</label>
                        <select id="importTarif" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px;">
                            <option value="basic">Basic</option>
                            <option value="standard">Standard</option>
                            <option value="premium">Premium</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #4a5568;">Standard-Modell:</label>
                        <select id="importModell" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px;">
                            <option value="affiliate">Affiliate</option>
                            <option value="reseller">Reseller</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #4a5568;">Standard-Status:</label>
                        <select id="importStatus" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px;">
                            <option value="neu">Neu</option>
                            <option value="aktiv">Aktiv</option>
                            <option value="inaktiv">Inaktiv</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #4a5568;">ğŸ”„ Bei Duplikaten:</label>
                        <select id="importDuplicateAction" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px;">
                            <option value="skip">â­ï¸ Ãœberspringen</option>
                            <option value="update">ğŸ”„ Aktualisieren (Felder ergÃ¤nzen)</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="startImport()">
                    <i class="fas fa-upload"></i> Import starten
                </button>
                
                <div id="importProgress" style="display: none; margin-top: 25px;">
                    <div style="background: #f7fafc; border-radius: 10px; padding: 20px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                            <span style="font-weight: 600; color: #2d3748;">Import lÃ¤uft...</span>
                            <span id="importProgressText" style="color: #3b82f6; font-weight: 700;">0 / 0</span>
                        </div>
                        <div style="width: 100%; background: #e2e8f0; border-radius: 10px; height: 20px; overflow: hidden;">
                            <div id="importProgressBar" style="width: 0%; background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); height: 100%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>
                
                <div id="importResults" style="display: none; margin-top: 25px;"></div>
            </div>
        </div>

        <!-- Tab: VertrÃ¤ge Ãœbersicht -->
        <div class="tab-content" id="tab-vertraege">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Gesamt VertrÃ¤ge</div>
                    <div class="stat-value" id="stat-vertraege-gesamt">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Aktiviert</div>
                    <div class="stat-value" style="color: var(--success);" id="stat-vertraege-aktiviert">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">In Bearbeitung</div>
                    <div class="stat-value" style="color: var(--warning);" id="stat-vertraege-bearbeitung">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Abgelehnt</div>
                    <div class="stat-value" style="color: var(--danger);" id="stat-vertraege-abgelehnt">0</div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-file-contract"></i> Alle VertrÃ¤ge</span>
                    <button class="btn btn-primary" onclick="loadVertraege()">
                        <i class="fas fa-sync"></i> Aktualisieren
                    </button>
                </div>

                <!-- Filter Buttons -->
                <div style="display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap;">
                    <button onclick="filterVertraegeByType('all')" id="filter-all" class="filter-btn active" style="padding: 10px 20px; border: 2px solid #e2e8f0; background: white; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s;">
                        ğŸ“‹ Alle
                    </button>
                    <button onclick="filterVertraegeByType('tool')" id="filter-tool" class="filter-btn" style="padding: 10px 20px; border: 2px solid #e2e8f0; background: white; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s;">
                        ğŸ”§ Partner-Tool
                    </button>
                    <button onclick="filterVertraegeByType('shop')" id="filter-shop" class="filter-btn" style="padding: 10px 20px; border: 2px solid #e2e8f0; background: white; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s;">
                        ğŸ›’ Partner-Shops <span id="shop-count" style="background: linear-gradient(135deg, #d4a528, #b8860b); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 6px;">0</span>
                    </button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <input type="text" 
                           id="vertraegeSearch" 
                           placeholder="ğŸ” Suchen nach Kunde, Partner, Vertragsnr..." 
                           oninput="filterVertraege()"
                           style="width: 100%; padding: 12px 20px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px;">
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Vertragsnr.</th>
                            <th>Datum</th>
                            <th>Kunde</th>
                            <th>Partner</th>
                            <th>Kategorie</th>
                            <th>Provision</th>
                            <th>Status</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody id="vertraegeTable">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-light);">
                                Lade VertrÃ¤ge...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Vertrags-Details Modal -->
    <div id="vertragDetailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; overflow-y: auto;">
        <div style="max-width: 1000px; margin: 50px auto; background: white; border-radius: 15px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="margin: 0; color: var(--primary);"><i class="fas fa-file-contract"></i> Vertrags-Details</h2>
                <button onclick="closeVertragDetailModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light);">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div id="vertragDetailsContent" style="display: grid; gap: 20px;">
                <!-- Content will be loaded here -->
            </div>

            <div style="display: flex; gap: 15px; margin-top: 30px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeVertragDetailModal()">
                    <i class="fas fa-times"></i> SchlieÃŸen
                </button>
                <button class="btn btn-primary" onclick="saveVertragChanges()">
                    <i class="fas fa-save"></i> Speichern
                </button>
            </div>
        </div>
    </div>

    <script>
        // Tab-Wechsel
        function switchTab(tabName) {
            console.log('ğŸ”„ switchTab called with:', tabName);
            
            // ğŸ“± MOBILE: Sidebar schlieÃŸen
            if (window.isMobile && window.isMobile()) {
                window.closeMobileSidebar();
            }
            
            // Alle Nav-Items und Tabs deaktivieren
            document.querySelectorAll('.nav-item, .tab').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            // Aktiven Tab in Sidebar markieren (nav-item oder tab)
            const clickedTab = document.querySelector(`.nav-item[onclick*="${tabName}"], .tab[onclick*="${tabName}"]`);
            if (clickedTab) {
                clickedTab.classList.add('active');
                console.log('âœ… Tab in Sidebar aktiviert:', tabName);
            }
            
            // Content-Bereich anzeigen
            const targetTab = document.getElementById('tab-' + tabName);
            if (targetTab) {
                targetTab.classList.add('active');
                targetTab.style.display = 'block';
                console.log('âœ… Content-Bereich angezeigt:', 'tab-' + tabName);
            } else {
                console.error('âŒ Tab-Content nicht gefunden:', 'tab-' + tabName);
                return;
            }
            
            // ğŸ“± MOBILE: Scroll zum Seitenanfang
            window.scrollTo(0, 0);
            
            // Update page title
            const titles = {
                'dashboard': 'Dashboard Ãœbersicht',
                'interessenten': 'Neue Anfragen',
                'aufgaben': 'Aufgaben & Projekte',
                'all-in-one': 'Provisionen - VertrÃ¤ge - Sonstiges',
                'umsatz': 'Umsatz-Tracking',
                'email': 'E-Mail senden',
                'news': 'News & Aktionen',
                'provisionen': 'Provisionen',
                'auszahlungen': 'Auszahlungen Ãœbersicht',
                'vertraege': 'VertrÃ¤ge Ãœbersicht',
                'partner': 'Partner-Verwaltung',
                'partner-verwaltung': 'Partner-Verwaltung',
                'projekte': 'Projekte verwalten',
                'dokumente': 'Dokumente prÃ¼fen',
                'akademie': 'Akademie & Onboarding',
                'live-chat': 'Live Chat',
                'tickets': 'Support Tickets',
                'status-check': 'Partner Status Check',
                'partner-import': 'Partner Import'
            };
            const pageTitle = document.getElementById('page-title');
            if (pageTitle && titles[tabName]) {
                pageTitle.textContent = titles[tabName];
            }
            
            // Daten laden
            console.log('ğŸ”„ switchTab: Lade Daten fÃ¼r Tab:', tabName);
            if (tabName === 'dashboard') {
                loadDashboardOverview();
                loadPartnerAktivitaeten();
            }
            if (tabName === 'interessenten') loadInteressenten();
            if (tabName === 'aufgaben') {
                console.log('âœ… Tab "aufgaben" erkannt â†’ loadProjekte() wird aufgerufen!');
                loadProjekte();
            }
            if (tabName === 'umsatz') loadUmsatzData();
            if (tabName === 'email') { loadPartnerForEmail(); loadEmailVerlauf(); }
            if (tabName === 'news') loadNews();
            if (tabName === 'provisionen') loadProvisionen();
            if (tabName === 'auszahlungen') loadAuszahlungen();
            if (tabName === 'vertraege') loadVertraege();
            if (tabName === 'partner') loadPartner();
            if (tabName === 'partner-verwaltung') {
                console.log('âœ… Tab "partner-verwaltung" erkannt â†’ loadPartnerVerwaltung() wird aufgerufen!');
                loadPartnerVerwaltung();
            }
            if (tabName === 'ziel-erreichung') {
                console.log('âœ… Tab "ziel-erreichung" erkannt â†’ loadZielErreichung() wird aufgerufen!');
                loadZielErreichung();
            }
            if (tabName === 'dashboard') {
                console.log('âœ… Tab "dashboard" erkannt â†’ loadDashboardData() wird aufgerufen!');
                loadDashboardData();
            }
            if (tabName === 'all-in-one') {
                console.log('âœ… Tab "all-in-one" erkannt â†’ loadAllInOneData() + loadZielErreichung() + loadDashboardData() werden aufgerufen!');
                
                // SCHRITT 1: All-in-One Daten laden
                loadAllInOneData();
                
                // SCHRITT 2: Ziel-Erreichung laden (fÃ¼r Partner-Fortschritt Tabelle)
                if (typeof loadZielErreichung === 'function') {
                    console.log('ğŸ† Lade Ziel-Erreichung fÃ¼r All-in-One Tab...');
                    loadZielErreichung();
                }
                
                // SCHRITT 3: Charts laden (mit kleiner VerzÃ¶gerung, damit Canvas-Elemente sichtbar sind)
                setTimeout(() => {
                    console.log('ğŸ¨ Canvas-Elemente prÃ¼fen...');
                    const canvas1 = document.getElementById('chart-umsatz-zeit');
                    const canvas2 = document.getElementById('chart-vertraege-kategorie');
                    const canvas3 = document.getElementById('chart-provision-partner');
                    console.log('ğŸ“Š Canvas vorhanden:', {
                        'chart-umsatz-zeit': !!canvas1,
                        'chart-vertraege-kategorie': !!canvas2,
                        'chart-provision-partner': !!canvas3
                    });
                    
                    if (typeof window.loadDashboardData === 'function') {
                        console.log('ğŸ“Š Lade Charts fÃ¼r All-in-One Tab...');
                        window.loadDashboardData();
                    } else {
                        console.error('âŒ window.loadDashboardData ist nicht definiert!');
                    }
                }, 500);
            }
            if (tabName === 'projekte') loadProjekte();
            if (tabName === 'dokumente') loadDokumente();
            if (tabName === 'akademie') loadAkademie();
            
            // Close mobile sidebar after selection
            if (window.innerWidth <= 968) {
                const sidebar = document.getElementById('sidebar');
                if (sidebar) sidebar.classList.remove('active');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ“± MOBILE - Funktionen sind im HEAD definiert!
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Legacy toggle function
        window.toggleSidebar = window.toggleMobileSidebar;
        
        // Close sidebar when clicking tab on mobile
        document.addEventListener('click', function(event) {
            if (isMobile() && event.target.closest('.tab')) {
                setTimeout(closeMobileSidebar, 150);
            }
        });
        
        // ====================================
        // ğŸ†• PARTNER STATUS CHECK
        // ====================================
        
        async function checkPartnerStatus() {
            const email = document.getElementById('statusCheckEmail').value.trim().toLowerCase();
            const resultsDiv = document.getElementById('statusCheckResults');
            const itemsDiv = document.getElementById('statusCheckItems');
            const rawDataDiv = document.getElementById('statusCheckRawData');
            
            if (!email) {
                alert('Bitte geben Sie eine E-Mail-Adresse ein.');
                return;
            }
            
            try {
                // Fetch mit Cache-Buster
                const response = await fetch(`tables/partners?limit=100&_t=${Date.now()}`, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    }
                });
                
                const result = await response.json();
                const partner = result.data.find(p => p.email && p.email.toLowerCase() === email);
                
                if (!partner) {
                    alert('âŒ Partner nicht gefunden in der Datenbank.');
                    return;
                }
                
                // Ergebnisse anzeigen
                displayStatusResults(partner, itemsDiv, rawDataDiv);
                resultsDiv.style.display = 'block';
                resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
            } catch (error) {
                console.error('Fehler:', error);
                alert('âŒ Fehler beim Laden der Daten: ' + error.message);
            }
        }
        
        function displayStatusResults(partner, itemsDiv, rawDataDiv) {
            const onboardingCompleted = partner.onboarding_completed || false;
            const mainStatus = onboardingCompleted 
                ? { class: 'success', icon: 'âœ…', text: 'VOLLZUGRIFF', color: 'success-text' }
                : { class: 'warning', icon: 'â³', text: 'IM ONBOARDING', color: 'warning-text' };
            
            const items = [
                {
                    label: 'ğŸ¯ Hauptstatus',
                    value: `${mainStatus.icon} ${mainStatus.text}`,
                    class: mainStatus.class
                },
                {
                    label: 'ğŸ“§ E-Mail',
                    value: partner.email,
                    class: 'success'
                },
                {
                    label: 'ğŸ‘¤ Name',
                    value: `${partner.vorname || ''} ${partner.nachname || ''}`.trim() || 'Nicht angegeben',
                    class: 'success'
                },
                {
                    label: 'ğŸ“ Vertrag unterschrieben',
                    value: partner.vertrag_unterschrieben ? 'âœ“ JA' : 'âœ— NEIN',
                    class: partner.vertrag_unterschrieben ? 'success' : 'error'
                },
                {
                    label: 'ğŸ“„ Dokumente hochgeladen',
                    value: partner.dokumente_hochgeladen ? 'âœ“ JA' : 'âœ— NEIN',
                    class: partner.dokumente_hochgeladen ? 'success' : 'error'
                },
                {
                    label: 'ğŸ“ Schulung absolviert',
                    value: partner.schulung_absolviert ? 'âœ“ JA' : 'âœ— NEIN',
                    class: partner.schulung_absolviert ? 'success' : 'error'
                },
                {
                    label: 'ğŸ¦ Bankdaten hinterlegt',
                    value: partner.bankdaten_hinterlegt ? 'âœ“ JA' : 'âœ— NEIN',
                    class: partner.bankdaten_hinterlegt ? 'success' : 'error'
                },
                {
                    label: 'ğŸ¯ Erster Vertrag abgeschlossen',
                    value: partner.erster_vertrag_abgeschlossen ? 'âœ“ JA' : 'âœ— NEIN',
                    class: partner.erster_vertrag_abgeschlossen ? 'success' : 'error'
                },
                {
                    label: 'ğŸ“Š Status',
                    value: partner.status || 'unbekannt',
                    class: 'success'
                },
                {
                    label: 'ğŸ« Tarif',
                    value: (partner.tarif || 'basic').toUpperCase(),
                    class: 'success'
                }
            ];
            
            itemsDiv.innerHTML = items.map(item => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: ${item.class === 'success' ? '#f0fdf4' : item.class === 'error' ? '#fef2f2' : '#fffbeb'}; border-radius: 10px; margin-bottom: 12px; border-left: 4px solid ${item.class === 'success' ? '#22c55e' : item.class === 'error' ? '#ef4444' : '#f59e0b'};">
                    <span style="font-weight: 600; color: #2d3748;">${item.label}</span>
                    <span style="font-weight: 700; font-size: 18px; color: ${item.class === 'success' ? '#22c55e' : item.class === 'error' ? '#ef4444' : '#f59e0b'};">${item.value}</span>
                </div>
            `).join('');
            
            rawDataDiv.textContent = JSON.stringify(partner, null, 2);
        }
        
        // ====================================
        // ğŸ†• PARTNER IMPORT - KOMPLETT NEU
        // ====================================
        
        // CSV-Zeile korrekt parsen (RFC 4180 kompatibel)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // Escaped quote ""
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            
            // Trim und AnfÃ¼hrungszeichen entfernen
            return result.map(val => val.trim().replace(/^"|"$/g, ''));
        }
        
        // Helper: Wert aus Partner-Objekt holen (verschiedene Schreibweisen)
        function getCSVValue(p, ...keys) {
            for (const key of keys) {
                const val = p[key];
                if (val && typeof val === 'string' && val.trim()) {
                    return val.trim();
                }
            }
            return '';
        }
        
        // CSV-Feld zu Partner-Feld Mapping
        const CSV_FIELD_MAPPING = {
            // E-Mail (Pflicht)
            'email': 'email',
            'e-mail': 'email',
            'email address': 'email',
            
            // Name
            'first name': 'vorname',
            'firstname': 'vorname',
            'vorname': 'vorname',
            'last name': 'nachname',
            'lastname': 'nachname',
            'nachname': 'nachname',
            
            // Kontakt
            'phone': 'phone',
            'telefon': 'phone',
            'telefonnummer': 'phone',
            'tel': 'phone',
            'mobile': 'phone',
            
            // Adresse
            'address': 'adresse',
            'adresse': 'adresse',
            'strasse': 'adresse',
            'street': 'adresse',
            'city': 'stadt',
            'stadt': 'stadt',
            'ort': 'stadt',
            'zipcode': 'plz',
            'plz': 'plz',
            'zip': 'plz',
            'postleitzahl': 'plz',
            'country': 'land',
            'land': 'land',
            'state': 'bundesland',
            'bundesland': 'bundesland',
            
            // Firma
            'company': 'firma',
            'firma': 'firma',
            'unternehmen': 'firma',
            
            // Online
            'website': 'website',
            'webseite': 'website',
            'facebook': 'facebook',
            'instagram': 'instagram',
            'youtube': 'youtube',
            'tiktok': 'tiktok',
            
            // Affiliate
            'referral code': 'referral_code',
            'referral_code': 'referral_code',
            'code': 'referral_code',
            'standard link': 'standard_link',
            'standard_link': 'standard_link',
            'shortlink': 'shortlink',
            'short link': 'shortlink',
            'network link': 'network_link',
            'network_link': 'network_link',
            'parent name': 'parent_name',
            'parent_name': 'parent_name',
            'parent email': 'parent_email',
            'parent_email': 'parent_email',
            
            // Zahlung
            'payment method': 'payment_method',
            'payment_method': 'payment_method',
            'payment info': 'payment_info',
            'payment_info': 'payment_info',
            'iban': 'iban',
            
            // Sonstiges
            'coupons': 'coupons',
            'additional infos': 'additional_infos',
            'additional_infos': 'additional_infos',
            'personal detail': 'personal_detail',
            'personal_detail': 'personal_detail'
        };
        
        async function startImport() {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Bitte wÃ¤hlen Sie eine CSV-Datei aus.');
                return;
            }
            
            const tarif = document.getElementById('importTarif').value;
            const modell = document.getElementById('importModell').value;
            const status = document.getElementById('importStatus').value;
            const duplicateAction = document.getElementById('importDuplicateAction').value;
            
            const progressDiv = document.getElementById('importProgress');
            const resultsDiv = document.getElementById('importResults');
            const progressBar = document.getElementById('importProgressBar');
            const progressText = document.getElementById('importProgressText');
            
            progressDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            
            try {
                const text = await file.text();
                const lines = text.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    alert('CSV-Datei ist leer oder enthÃ¤lt keine Daten.');
                    return;
                }
                
                // Header parsen mit parseCSVLine (gleiche Funktion wie fÃ¼r Daten)
                const rawHeaders = parseCSVLine(lines[0]);
                const headers = rawHeaders.map(h => h.toLowerCase().trim());
                
                console.log('ğŸ“‹ CSV Headers gefunden:', headers);
                console.log('ğŸ“‹ Anzahl Headers:', headers.length);
                
                // Datenzeilen parsen - ALLE Zeilen
                const partners = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    // CSV-Zeile parsen
                    const values = parseCSVLine(line);
                    
                    // Partner-Objekt mit gemappten Feldern erstellen
                    const partner = { _raw: {} };
                    
                    headers.forEach((header, index) => {
                        const value = (values[index] || '').trim();
                        // Original speichern
                        partner._raw[header] = value;
                        
                        // Gemapptes Feld setzen
                        const mappedField = CSV_FIELD_MAPPING[header];
                        if (mappedField && value) {
                            partner[mappedField] = value;
                        }
                    });
                    
                    // Debug: Erste Zeile loggen
                    if (i === 1) {
                        console.log('ğŸ“ Erste Datenzeile - Raw Headers:', headers);
                        console.log('ğŸ“ Erste Datenzeile - Raw Values:', values);
                        console.log('ğŸ“ Erste Datenzeile - Gemappter Partner:', partner);
                    }
                    
                    // Nur hinzufÃ¼gen wenn E-Mail vorhanden
                    if (partner.email) {
                        partners.push(partner);
                    }
                }
                
                console.log('ğŸ‘¥ Partner zum Importieren:', partners.length);
                if (partners.length > 0) {
                    console.log('ğŸ“ Beispiel-Partner:', {
                        email: partners[0].email,
                        vorname: partners[0].vorname,
                        nachname: partners[0].nachname,
                        phone: partners[0].phone,
                        adresse: partners[0].adresse,
                        stadt: partners[0].stadt,
                        plz: partners[0].plz,
                        referral_code: partners[0].referral_code
                    });
                }
                
                let imported = 0;
                let skipped = 0;
                let errors = 0;
                
                // ğŸ” EINMALIG alle existierenden Partner laden (fÃ¼r Duplikat-Check)
                progressText.textContent = 'PrÃ¼fe existierende Partner...';
                const existingRes = await fetch('tables/partners?limit=5000&_t=' + Date.now());
                const existingData = await existingRes.json();
                
                // Map fÃ¼r schnellen Lookup: E-Mail -> Partner-Objekt (mit ID fÃ¼r Update)
                const existingPartnersMap = new Map();
                existingData.data.forEach(p => {
                    if (p.email) {
                        existingPartnersMap.set(p.email.toLowerCase(), p);
                    }
                });
                console.log('ğŸ“§ Existierende Partner:', existingPartnersMap.size);
                
                let updated = 0; // ZÃ¤hler fÃ¼r aktualisierte Partner
                
                // Import durchfÃ¼hren
                for (let i = 0; i < partners.length; i++) {
                    const p = partners[i];
                    const email = p.email; // Bereits durch Mapping gesetzt
                    
                    if (!email) {
                        console.log('âš ï¸ Partner ohne E-Mail Ã¼bersprungen:', p);
                        errors++;
                        continue;
                    }
                    
                    progressText.textContent = `${i + 1} / ${partners.length}`;
                    progressBar.style.width = ((i + 1) / partners.length * 100) + '%';
                    
                    try {
                        // PrÃ¼fen ob Partner existiert
                        const existingPartner = existingPartnersMap.get(email.toLowerCase());
                        
                        if (existingPartner) {
                            if (duplicateAction === 'skip') {
                                skipped++;
                                continue;
                            }
                            // duplicateAction === 'update' -> Partner aktualisieren
                        }
                        
                        // Partner erstellen - Bereits gemappte Felder verwenden
                        const partnerData = {
                            // Basis-Daten (bereits durch Mapping gesetzt)
                            email: p.email,
                            passwort: 'Partner1234',
                            
                            // PersÃ¶nliche Daten
                            vorname: p.vorname || '',
                            nachname: p.nachname || '',
                            
                            // Kontaktdaten
                            phone: p.phone || '',
                            
                            // Adresse
                            adresse: p.adresse || '',
                            plz: p.plz || '',
                            stadt: p.stadt || '',
                            land: p.land || 'DE',
                            bundesland: p.bundesland || '',
                            
                            // Firma
                            firma: p.firma || '',
                            
                            // Online-PrÃ¤senz
                            website: p.website || '',
                            facebook: p.facebook || '',
                            instagram: p.instagram || '',
                            youtube: p.youtube || '',
                            tiktok: p.tiktok || '',
                            
                            // Affiliate-Daten
                            referral_code: p.referral_code || '',
                            standard_link: p.standard_link || '',
                            shortlink: p.shortlink || '',
                            network_link: p.network_link || '',
                            parent_name: p.parent_name || '',
                            parent_email: p.parent_email || '',
                            ist_affiliate: true,
                            
                            // Zahlungsdaten
                            payment_method: p.payment_method || '',
                            payment_info: p.payment_info || '',
                            iban: p.iban || '',
                            kontoinhaber: p.kontoinhaber || '',
                            
                            // ZusÃ¤tzliche Infos
                            coupons: p.coupons || '',
                            additional_infos: p.additional_infos || '',
                            personal_detail: p.personal_detail || '',
                            
                            // System-Felder
                            tarif: tarif,
                            modell: modell,
                            status: status,
                            registriert_am: Date.now(),
                            onboarding_completed: modell === 'affiliate',
                            vertrag_unterschrieben: modell === 'affiliate',
                            dokumente_hochgeladen: false,
                            schulung_absolviert: false,
                            bankdaten_hinterlegt: !!(getCSVValue(p, 'iban', 'payment info', 'payment_info')),
                            erster_vertrag_abgeschlossen: false
                        };
                        
                        // Debug: Ersten Partner loggen
                        if (i === 0) {
                            console.log('ğŸ“ Erster Partner wird erstellt/aktualisiert:', partnerData);
                        }
                        
                        if (existingPartner && duplicateAction === 'update') {
                            // ğŸ”„ Partner AKTUALISIEREN (PATCH) - nur Felder die einen Wert haben
                            const updateData = {};
                            Object.entries(partnerData).forEach(([key, value]) => {
                                // Nur Felder Ã¼bernehmen die einen echten Wert haben
                                // und nicht die System-Felder Ã¼berschreiben
                                if (value && value !== '' && value !== 'Deutschland' && 
                                    !['registriert_am', 'onboarding_completed', 'vertrag_unterschrieben', 
                                      'dokumente_hochgeladen', 'schulung_absolviert', 'bankdaten_hinterlegt',
                                      'erster_vertrag_abgeschlossen', 'passwort'].includes(key)) {
                                    updateData[key] = value;
                                }
                            });
                            
                            if (Object.keys(updateData).length > 0) {
                                await fetch(`tables/partners/${existingPartner.id}`, {
                                    method: 'PATCH',
                                    headers: {'Content-Type': 'application/json'},
                                    body: JSON.stringify(updateData)
                                });
                                updated++;
                                console.log(`ğŸ”„ Partner aktualisiert: ${email}`, updateData);
                            } else {
                                skipped++;
                            }
                        } else {
                            // ğŸ†• Neuer Partner (POST)
                            await fetch('tables/partners', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify(partnerData)
                            });
                            
                            // E-Mail zur Map hinzufÃ¼gen (falls doppelt in CSV)
                            existingPartnersMap.set(email.toLowerCase(), { email });
                            imported++;
                        }
                        
                    } catch (error) {
                        console.error('Fehler bei Partner:', email, error);
                        errors++;
                    }
                    
                    // Kurze Pause um Server nicht zu Ã¼berlasten
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                
                // Ergebnisse anzeigen
                resultsDiv.innerHTML = `
                    <div style="background: #f0fdf4; border: 2px solid #86efac; border-radius: 10px; padding: 20px;">
                        <h3 style="margin: 0 0 15px 0; color: #065f46;">âœ… Import abgeschlossen!</h3>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #22c55e;">${imported}</div>
                                <div style="font-size: 14px; color: #065f46;">âœ… Neu importiert</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #3b82f6;">${updated}</div>
                                <div style="font-size: 14px; color: #1e40af;">ğŸ”„ Aktualisiert</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #f59e0b;">${skipped}</div>
                                <div style="font-size: 14px; color: #92400e;">â­ï¸ Ãœbersprungen</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #ef4444;">${errors}</div>
                                <div style="font-size: 14px; color: #991b1b;">âŒ Fehler</div>
                            </div>
                        </div>
                    </div>
                `;
                resultsDiv.style.display = 'block';
                progressDiv.style.display = 'none';
                
                // ğŸ”„ WICHTIG: Partner-Tabelle und Statistiken neu laden!
                console.log('ğŸ”„ Aktualisiere Partner-Tabelle nach Import...');
                await loadPartnerVerwaltung();
                
            } catch (error) {
                console.error('Import-Fehler:', error);
                alert('âŒ Fehler beim Import: ' + error.message);
                progressDiv.style.display = 'none';
            }
        }

        // Interessenten laden
        // ğŸ” FILTER-FUNKTION FÃœR ANFRAGEN
        let allAnfragenData = []; // Globale Variable fÃ¼r Filter
        
        async function filterAnfragen() {
            if (allAnfragenData.length === 0) {
                await loadInteressenten();
                return;
            }
            
            const vonDatum = document.getElementById('anfragen-von-datum')?.value;
            const bisDatum = document.getElementById('anfragen-bis-datum')?.value;
            const statusFilter = document.getElementById('anfragen-status-filter')?.value || 'alle';
            const kanalFilter = document.getElementById('anfragen-kanal-filter')?.value || 'alle';
            
            let filtered = [...allAnfragenData];
            
            // Datum Filter
            if (vonDatum || bisDatum) {
                filtered = filtered.filter(a => {
                    const datum = new Date(a.eingegangen_am);
                    const von = vonDatum ? new Date(vonDatum) : null;
                    const bis = bisDatum ? new Date(bisDatum) : null;
                    
                    if (von && datum < von) return false;
                    if (bis && datum > bis) return false;
                    return true;
                });
            }
            
            // Status Filter
            if (statusFilter !== 'alle') {
                filtered = filtered.filter(a => {
                    if (statusFilter === 'termin') return a.anfrage_status === 'termin_vereinbart';
                    return a.anfrage_status === statusFilter;
                });
            }
            
            // Modell Filter (statt Kanal)
            if (kanalFilter !== 'alle') {
                filtered = filtered.filter(a => (a.modell || '').toLowerCase() === kanalFilter.toLowerCase());
            }
            
            // Stats aktualisieren
            const neu = filtered.filter(i => i.anfrage_status === 'neu').length;
            const kontaktiert = filtered.filter(i => i.anfrage_status === 'kontaktiert').length;
            const termin = filtered.filter(i => i.anfrage_status === 'termin_vereinbart').length;
            
            document.getElementById('stat-neu').textContent = neu;
            document.getElementById('stat-kontaktiert').textContent = kontaktiert;
            document.getElementById('stat-termin').textContent = termin;
            document.getElementById('stat-gesamt').textContent = filtered.length;
            
            // Tabelle neu rendern
            renderAnfragenTable(filtered);
        }
        
        function renderAnfragenTable(data) {
            const modellIcons = {
                'ladenlokal': '<i class="fas fa-store"></i>',
                'promotion': '<i class="fas fa-bullhorn"></i>',
                'onlineshop': '<i class="fas fa-laptop"></i>',
                'shopinshop': '<i class="fas fa-store-alt"></i>',
                'affiliate': '<i class="fas fa-link"></i>'
            };
            
            const modellNamen = {
                'ladenlokal': 'Ladenlokal',
                'promotion': 'Promotion Stand',
                'onlineshop': 'Online Shop',
                'shopinshop': 'Shop-in-Shop',
                'affiliate': 'Affiliate'
            };
            
            const tbody = document.getElementById('interessentenTable');
            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px; color: var(--text-light);">
                            <i class="fas fa-inbox"></i><br><br>
                            Keine Anfragen gefunden
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = data.map(int => {
                const statusColors = {
                    'neu': 'primary',
                    'kontaktiert': 'warning',
                    'termin_vereinbart': 'success',
                    'abgeschlossen': 'success',
                    'abgelehnt': 'danger'
                };
                
                const statusTexte = {
                    'neu': 'ğŸ†• Neu',
                    'kontaktiert': 'ğŸ“ Kontaktiert',
                    'termin_vereinbart': 'ğŸ“… Termin',
                    'abgeschlossen': 'âœ… Abgeschlossen',
                    'abgelehnt': 'âŒ Abgelehnt'
                };
                
                return `
                    <tr style="cursor: pointer;" onclick="showInteressentDetails('${int.id}')">
                        <td>
                            <span class="badge badge-${statusColors[int.anfrage_status]}">
                                ${statusTexte[int.anfrage_status]}
                            </span>
                        </td>
                        <td>${new Date(int.eingegangen_am).toLocaleDateString('de-DE', {day: '2-digit', month: '2-digit', year: 'numeric'})}<br>
                            <small style="color: var(--text-light);">${new Date(int.eingegangen_am).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'})}</small>
                        </td>
                        <td>
                            <strong>${int.vorname} ${int.nachname}</strong><br>
                            <small style="color: var(--text-light);">${int.firma || '-'}</small>
                        </td>
                        <td>
                            ${modellIcons[int.modell]} <strong>${modellNamen[int.modell]}</strong>
                        </td>
                        <td>
                            ${int.email}<br>
                            <small style="color: var(--text-light);">${int.phone || 'Keine Nummer'}</small>
                        </td>
                        <td>${int.erfahrung}</td>
                        <td>
                            <button class="btn btn-small btn-primary" onclick="event.stopPropagation(); showInteressentDetails('${int.id}')">
                                <i class="fas fa-eye"></i> Details
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        async function loadInteressenten() {
            try {
                // Visuelles Feedback
                const buttons = document.querySelectorAll('button[onclick="loadInteressenten()"]');
                buttons.forEach(btn => {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> LÃ¤dt...';
                });
                
                // ğŸ”„ Cache-Busting: Verhindert gecachte Daten
                const response = await fetch(`tables/interessenten?sort=-eingegangen_am&_t=${Date.now()}`, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    }
                });
                const result = await response.json();
                
                // ğŸ”¥ Speichere Daten global fÃ¼r Filter
                allAnfragenData = result.data;
                
                // Button zurÃ¼cksetzen
                buttons.forEach(btn => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-sync"></i> Aktualisieren';
                });
                
                // Stats berechnen
                const neu = result.data.filter(i => i.anfrage_status === 'neu').length;
                const kontaktiert = result.data.filter(i => i.anfrage_status === 'kontaktiert').length;
                const termin = result.data.filter(i => i.anfrage_status === 'termin_vereinbart').length;
                
                document.getElementById('stat-neu').textContent = neu;
                document.getElementById('stat-kontaktiert').textContent = kontaktiert;
                document.getElementById('stat-termin').textContent = termin;
                document.getElementById('stat-gesamt').textContent = allAnfragenData.length;
                
                // Tabelle rendern
                renderAnfragenTable(allAnfragenData);
            } catch (error) {
                console.error('Fehler beim Laden:', error);
                document.getElementById('interessentenTable').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px; color: var(--danger);">
                            <i class="fas fa-exclamation-triangle"></i> Fehler beim Laden der Daten
                        </td>
                    </tr>
                `;
            }
            
            // ğŸ†• Lade auch Bestands-Partner Logins
            loadBestandsPartnerLogins();
        }

        // ğŸ†• BESTANDS-PARTNER ERST-LOGINS LADEN - ERWEITERT + KOMPLETT GEFIXT
        let alleBestandsPartner = []; // Global fÃ¼r Filter
        
        // ğŸ“§ BEKANNTE BESTANDS-PARTNER E-MAILS (aus CSV importiert)
        // Diese Liste wird verwendet um Partner zu identifizieren die noch nicht in der DB sind
        const BEKANNTE_BESTANDS_EMAILS = [
            // Hier kommen die E-Mails aus der CSV - fÃ¼r jetzt nutzen wir ist_bestandspartner oder ist_affiliate
        ];
        
        async function loadBestandsPartnerLogins() {
            console.log('ğŸ“Š Lade Bestands-Partner Logins...');
            
            try {
                const response = await fetch('tables/partners?limit=1000');
                const result = await response.json();
                
                console.log('ğŸ“Š Alle Partner aus DB:', result.data?.length || 0);
                
                // ğŸ”¥ VERBESSERTER FILTER: 
                // - ist_bestandspartner === true ODER
                // - ist_affiliate === true (alle Affiliates sind Bestands-Partner) ODER
                // - hat erst_login (wurde schon mal eingeloggt)
                let gefiltert = (result.data || []).filter(p => {
                    const istBestand = p.ist_bestandspartner === true;
                    const istAffiliate = p.ist_affiliate === true;
                    const hatErstLogin = !!p.erst_login;
                    
                    return istBestand || istAffiliate || hatErstLogin;
                });
                
                console.log('ğŸ“Š Bestands-Partner VOR Deduplizierung:', gefiltert.length);
                
                // ğŸ”¥ DUPLIKATE ENTFERNEN - Behalte den Eintrag mit dem neuesten Login oder der meisten Daten
                const emailMap = new Map();
                gefiltert.forEach(p => {
                    const email = (p.email || '').toLowerCase().trim();
                    if (!email) return;
                    
                    const existing = emailMap.get(email);
                    if (!existing) {
                        emailMap.set(email, p);
                    } else {
                        // Behalte den "besseren" Eintrag:
                        // 1. Hat erst_login > kein erst_login
                        // 2. Hat passwort_geaendert > nicht geaendert
                        // 3. Neuerer Eintrag (updated_at)
                        const pBetter = (
                            (p.erst_login && !existing.erst_login) ||
                            (p.passwort_muss_geaendert_werden === false && existing.passwort_muss_geaendert_werden !== false) ||
                            (p.updated_at && existing.updated_at && new Date(p.updated_at) > new Date(existing.updated_at))
                        );
                        if (pBetter) {
                            emailMap.set(email, p);
                        }
                    }
                });
                
                alleBestandsPartner = Array.from(emailMap.values());
                const duplikateEntfernt = gefiltert.length - alleBestandsPartner.length;
                console.log('ğŸ“Š Bestands-Partner NACH Deduplizierung:', alleBestandsPartner.length);
                console.log('ğŸ“Š Duplikate entfernt:', duplikateEntfernt);
                
                // Warnung wenn viele Duplikate
                if (duplikateEntfernt > 10) {
                    console.warn(`âš ï¸ ACHTUNG: ${duplikateEntfernt} Duplikate in der Datenbank gefunden! Bitte bereinigen.`);
                }
                
                // Sortiere nach erst_login (eingeloggte zuerst, dann neueste zuerst)
                alleBestandsPartner.sort((a, b) => {
                    // Eingeloggte zuerst
                    if (a.erst_login && !b.erst_login) return -1;
                    if (!a.erst_login && b.erst_login) return 1;
                    // Dann nach Datum sortieren
                    if (a.erst_login && b.erst_login) {
                        return new Date(b.erst_login) - new Date(a.erst_login);
                    }
                    // Alphabetisch nach E-Mail fÃ¼r nicht-eingeloggte
                    return (a.email || '').localeCompare(b.email || '');
                });
                
                // Statistiken berechnen
                const eingeloggt = alleBestandsPartner.filter(p => p.erst_login).length;
                const ausstehend = alleBestandsPartner.filter(p => !p.erst_login).length;
                const pwGeaendert = alleBestandsPartner.filter(p => p.passwort_muss_geaendert_werden === false).length;
                const gesamt = alleBestandsPartner.length;
                
                console.log(`ğŸ“Š Stats: ${eingeloggt} eingeloggt, ${ausstehend} ausstehend, ${pwGeaendert} PW geÃ¤ndert, ${gesamt} gesamt`);
                
                // Stats aktualisieren
                const statEingeloggt = document.getElementById('bp-stat-eingeloggt');
                const statAusstehend = document.getElementById('bp-stat-ausstehend');
                const statPwGeaendert = document.getElementById('bp-stat-pw-geaendert');
                const statGesamt = document.getElementById('bp-stat-gesamt');
                const statHeader = document.getElementById('stat-bestandspartner-login');
                
                if (statEingeloggt) statEingeloggt.textContent = eingeloggt;
                if (statAusstehend) statAusstehend.textContent = ausstehend;
                if (statPwGeaendert) statPwGeaendert.textContent = pwGeaendert;
                if (statGesamt) statGesamt.textContent = gesamt;
                if (statHeader) statHeader.textContent = eingeloggt;
                
                // Tabelle rendern
                renderBestandsPartnerTable(alleBestandsPartner);
                
            } catch (error) {
                console.error('âŒ Fehler beim Laden der Bestands-Partner:', error);
                document.getElementById('bestandsPartnerTable').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px; color: var(--danger);">
                            <i class="fas fa-exclamation-triangle"></i> Fehler beim Laden: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
        
        // ğŸ†• Filter-Funktion fÃ¼r Bestands-Partner
        function filterBestandsPartner() {
            const filterWert = document.getElementById('bestandspartner-filter')?.value || 'alle';
            const suchtext = (document.getElementById('bestandspartner-suche')?.value || '').toLowerCase();
            
            let gefiltert = alleBestandsPartner;
            
            // Status-Filter
            if (filterWert === 'eingeloggt') {
                gefiltert = gefiltert.filter(p => p.erst_login);
            } else if (filterWert === 'ausstehend') {
                gefiltert = gefiltert.filter(p => !p.erst_login);
            } else if (filterWert === 'pw_geaendert') {
                gefiltert = gefiltert.filter(p => p.passwort_muss_geaendert_werden === false);
            } else if (filterWert === 'pw_nicht_geaendert') {
                gefiltert = gefiltert.filter(p => p.passwort_muss_geaendert_werden !== false);
            }
            
            // Textsuche
            if (suchtext) {
                gefiltert = gefiltert.filter(p => {
                    const email = (p.email || '').toLowerCase();
                    const name = ((p.vorname || '') + ' ' + (p.nachname || '')).toLowerCase();
                    return email.includes(suchtext) || name.includes(suchtext);
                });
            }
            
            // Bei Filter zurÃ¼ck auf Seite 1
            bpCurrentPage = 1;
            renderBestandsPartnerTable(gefiltert);
        }
        
        // ğŸ†• PAGINATION VARIABLEN
        let bpCurrentPage = 1;
        let bpPageSize = 10;
        let bpFilteredPartner = [];
        
        // Seite wechseln
        function goToBPPage(page) {
            bpCurrentPage = page;
            renderBestandsPartnerTable(bpFilteredPartner);
        }
        
        // SeitengrÃ¶ÃŸe Ã¤ndern
        function changeBPPageSize() {
            bpPageSize = parseInt(document.getElementById('bp-page-size')?.value || 25);
            bpCurrentPage = 1; // ZurÃ¼ck zur ersten Seite
            renderBestandsPartnerTable(bpFilteredPartner);
        }
        
        // ğŸ†• Tabelle rendern MIT PAGINATION
        function renderBestandsPartnerTable(partner) {
            const tbody = document.getElementById('bestandsPartnerTable');
            const countInfo = document.getElementById('bestandspartner-count-info');
            const paginationDiv = document.getElementById('bp-pagination');
            
            if (!tbody) return;
            
            // Gefilterte Partner speichern fÃ¼r Pagination
            bpFilteredPartner = partner;
            
            if (partner.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px; color: var(--text-light);">
                            <i class="fas fa-info-circle"></i> Keine Bestands-Partner gefunden
                        </td>
                    </tr>
                `;
                if (countInfo) countInfo.textContent = 'Zeige 0 von ' + alleBestandsPartner.length + ' Bestands-Partnern';
                if (paginationDiv) paginationDiv.innerHTML = '';
                return;
            }
            
            // PAGINATION BERECHNEN
            const totalPages = Math.ceil(partner.length / bpPageSize);
            const startIndex = (bpCurrentPage - 1) * bpPageSize;
            const endIndex = Math.min(startIndex + bpPageSize, partner.length);
            const paginatedPartner = partner.slice(startIndex, endIndex);
            
            // Tabelle mit paginierten Daten rendern
            tbody.innerHTML = paginatedPartner.map(p => {
                const hatErstLogin = !!p.erst_login;
                const pwGeaendert = p.passwort_muss_geaendert_werden === false;
                
                // Status Badge
                const statusBadge = hatErstLogin 
                    ? '<span style="background: linear-gradient(135deg, #48bb78, #38a169); color: white; padding: 5px 14px; border-radius: 20px; font-size: 11px; font-weight: 700; box-shadow: 0 2px 8px rgba(72, 187, 120, 0.3);"><i class="fas fa-check"></i> Eingeloggt</span>'
                    : '<span style="background: linear-gradient(135deg, #e2e8f0, #cbd5e1); color: #64748b; padding: 5px 14px; border-radius: 20px; font-size: 11px; font-weight: 700;"><i class="fas fa-clock"></i> Ausstehend</span>';
                
                // Passwort Badge - ERWEITERT
                let pwBadge;
                if (hatErstLogin) {
                    if (pwGeaendert) {
                        pwBadge = '<span style="background: #dcfce7; color: #16a34a; padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 600;"><i class="fas fa-shield-alt"></i> Ãœbernommen âœ“</span>';
                    } else {
                        pwBadge = '<span style="background: #fef3c7; color: #d97706; padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 600;"><i class="fas fa-exclamation-triangle"></i> Nicht geÃ¤ndert</span>';
                    }
                } else {
                    pwBadge = '<span style="color: #94a3b8; font-size: 11px;">Warten auf Login</span>';
                }
                
                // Erst-Login Datum
                const erstLoginDatum = hatErstLogin 
                    ? new Date(p.erst_login).toLocaleString('de-DE', {day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'})
                    : '<span style="color: #94a3b8;">-</span>';
                
                // Letzter Login
                const letzterLogin = p.letzter_login 
                    ? new Date(p.letzter_login).toLocaleString('de-DE', {day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'})
                    : '<span style="color: #94a3b8;">-</span>';
                
                // Details-Button
                const detailsBtn = `<button onclick="goToPartnerDetails('${p.id}', '${p.email}')" style="padding: 7px 14px; background: linear-gradient(135deg, #9f7aea, #805ad5); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.2s; box-shadow: 0 2px 8px rgba(159, 122, 234, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(159, 122, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(159, 122, 234, 0.3)'"><i class="fas fa-eye"></i> Details</button>`;
                
                // Zeilen-Style
                let rowStyle = '';
                if (hatErstLogin && pwGeaendert) {
                    rowStyle = 'background: linear-gradient(135deg, #f0fff4 0%, #dcfce7 100%);';
                } else if (hatErstLogin && !pwGeaendert) {
                    rowStyle = 'background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);';
                }
                
                return `
                    <tr style="${rowStyle}">
                        <td>${statusBadge}</td>
                        <td style="font-size: 12px;">${erstLoginDatum}</td>
                        <td style="font-weight: 600; color: #334155;">${p.email || '-'}</td>
                        <td>${(p.vorname || '') + ' ' + (p.nachname || '') || '<span style="color: #94a3b8;">-</span>'}</td>
                        <td>${pwBadge}</td>
                        <td style="font-size: 12px;">${letzterLogin}</td>
                        <td style="text-align: center;">${detailsBtn}</td>
                    </tr>
                `;
            }).join('');
            
            // COUNT INFO aktualisieren
            if (countInfo) {
                countInfo.textContent = `Zeige ${startIndex + 1}-${endIndex} von ${partner.length} Bestands-Partnern`;
            }
            
            // PAGINATION BUTTONS rendern
            if (paginationDiv) {
                let paginationHTML = '';
                
                // ZurÃ¼ck-Button
                paginationHTML += `<button onclick="goToBPPage(${bpCurrentPage - 1})" ${bpCurrentPage === 1 ? 'disabled' : ''} style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; background: ${bpCurrentPage === 1 ? '#f1f5f9' : 'white'}; color: ${bpCurrentPage === 1 ? '#94a3b8' : '#334155'}; cursor: ${bpCurrentPage === 1 ? 'not-allowed' : 'pointer'}; font-weight: 600;"><i class="fas fa-chevron-left"></i></button>`;
                
                // Seiten-Buttons (max 5 sichtbar)
                let startPage = Math.max(1, bpCurrentPage - 2);
                let endPage = Math.min(totalPages, startPage + 4);
                if (endPage - startPage < 4) {
                    startPage = Math.max(1, endPage - 4);
                }
                
                if (startPage > 1) {
                    paginationHTML += `<button onclick="goToBPPage(1)" style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; font-weight: 600;">1</button>`;
                    if (startPage > 2) {
                        paginationHTML += `<span style="padding: 0 5px; color: #94a3b8;">...</span>`;
                    }
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    const isActive = i === bpCurrentPage;
                    paginationHTML += `<button onclick="goToBPPage(${i})" style="padding: 8px 14px; border: 2px solid ${isActive ? '#9f7aea' : '#e2e8f0'}; border-radius: 8px; background: ${isActive ? 'linear-gradient(135deg, #9f7aea, #805ad5)' : 'white'}; color: ${isActive ? 'white' : '#334155'}; cursor: pointer; font-weight: 700;">${i}</button>`;
                }
                
                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) {
                        paginationHTML += `<span style="padding: 0 5px; color: #94a3b8;">...</span>`;
                    }
                    paginationHTML += `<button onclick="goToBPPage(${totalPages})" style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; font-weight: 600;">${totalPages}</button>`;
                }
                
                // Weiter-Button
                paginationHTML += `<button onclick="goToBPPage(${bpCurrentPage + 1})" ${bpCurrentPage === totalPages ? 'disabled' : ''} style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; background: ${bpCurrentPage === totalPages ? '#f1f5f9' : 'white'}; color: ${bpCurrentPage === totalPages ? '#94a3b8' : '#334155'}; cursor: ${bpCurrentPage === totalPages ? 'not-allowed' : 'pointer'}; font-weight: 600;"><i class="fas fa-chevron-right"></i></button>`;
                
                paginationDiv.innerHTML = paginationHTML;
            }
        }
        
        function scrollToBestandsPartner() {
            document.getElementById('bestandspartner-section').scrollIntoView({ behavior: 'smooth' });
        }
        
        // ğŸ†• Toggle Bestands-Partner Sektion (einklappen/ausklappen)
        let bpSectionCollapsed = false;
        function toggleBestandsPartnerSection() {
            const contentWrapper = document.getElementById('bp-content-wrapper');
            const icon = document.getElementById('bp-collapse-icon');
            
            if (!contentWrapper) return;
            
            bpSectionCollapsed = !bpSectionCollapsed;
            
            if (bpSectionCollapsed) {
                contentWrapper.style.maxHeight = '0';
                contentWrapper.style.overflow = 'hidden';
                contentWrapper.style.opacity = '0';
                contentWrapper.style.padding = '0';
                if (icon) icon.style.transform = 'rotate(-90deg)';
            } else {
                contentWrapper.style.maxHeight = 'none';
                contentWrapper.style.overflow = 'visible';
                contentWrapper.style.opacity = '1';
                contentWrapper.style.padding = '';
                if (icon) icon.style.transform = 'rotate(0deg)';
            }
        }
        
        // ğŸ†• Zum Partner in der Partner-Verwaltung springen
        function goToPartnerDetails(partnerId, partnerEmail) {
            console.log('ğŸ” Spring zu Partner-Details:', partnerEmail);
            
            // Tab wechseln zu Partner-Verwaltung
            const partnerTab = document.querySelector('[data-tab="partner-verwaltung"]') || document.querySelector('[data-tab="partner"]');
            if (partnerTab) partnerTab.click();
            
            // Kurze VerzÃ¶gerung damit Tab lÃ¤dt
            setTimeout(() => {
                // Partner-Details Modal Ã¶ffnen
                if (typeof viewPartnerDetailsComplete === 'function') {
                    viewPartnerDetailsComplete(partnerId, partnerEmail);
                } else {
                    // Fallback: Direkt zur Partner-Tabelle scrollen und Partner markieren
                    const partnerSection = document.getElementById('tab-partner') || document.getElementById('tab-partner-verwaltung');
                    if (partnerSection) {
                        partnerSection.scrollIntoView({ behavior: 'smooth' });
                        showToast('Partner: ' + partnerEmail + ' - Details in der Partner-Tabelle', 'info');
                    }
                }
            }, 300);
        }

        // Interessent-Status aktualisieren
        async function updateInteressentStatus(id, newStatus) {
            try {
                const response = await fetch(`tables/interessenten/${id}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ anfrage_status: newStatus })
                });
                
                if (response.ok) {
                    loadInteressenten();
                }
            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler beim Aktualisieren des Status');
            }
        }

        // âœ… NEUE AKTIONS-MODAL FÃœR ANFRAGEN
        function showAnfrageActions(id, vorname, nachname, email) {
            // Entferne altes Modal falls vorhanden
            const existingModal = document.getElementById('anfrage-actions-modal');
            if (existingModal) existingModal.remove();
            
            // Erstelle neues Modal
            const modal = document.createElement('div');
            modal.id = 'anfrage-actions-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                animation: fadeIn 0.2s;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2); animation: slideUp 0.3s;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid #e2e8f0;">
                        <div>
                            <h3 style="margin: 0; font-size: 20px; color: #1a202c;">Aktionen</h3>
                            <p style="margin: 5px 0 0 0; font-size: 14px; color: #718096;">${vorname} ${nachname}</p>
                        </div>
                        <button onclick="document.getElementById('anfrage-actions-modal').remove()" style="background: #f7fafc; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 18px; color: #4a5568; transition: all 0.2s;" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f7fafc'">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div style="display: grid; gap: 12px;">
                        <!-- Termin vereinbaren -->
                        <button onclick="openTerminVereinbarenModal('${id}', '${vorname}', '${nachname}', '${email}')" style="padding: 16px; background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 15px; text-align: left; display: flex; align-items: center; gap: 12px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(102,126,234,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(102,126,234,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102,126,234,0.3)'">
                            <i class="fas fa-calendar-plus" style="font-size: 24px;"></i>
                            <div>
                                <div style="font-size: 15px; font-weight: 700;">Termin vereinbaren</div>
                                <div style="font-size: 12px; opacity: 0.9;">Call mit Partner planen</div>
                            </div>
                        </button>
                        
                        <!-- Partner aktivieren -->
                        <button onclick="aktivierePartner('${id}', '${vorname}', '${nachname}', '${email}')" style="padding: 16px; background: linear-gradient(135deg, #48bb78, #38a169); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 15px; text-align: left; display: flex; align-items: center; gap: 12px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(72,187,120,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(72,187,120,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(72,187,120,0.3)'">
                            <i class="fas fa-user-check" style="font-size: 24px;"></i>
                            <div>
                                <div style="font-size: 15px; font-weight: 700;">Partner aktivieren</div>
                                <div style="font-size: 12px; opacity: 0.9;">Als aktiven Partner anlegen</div>
                            </div>
                        </button>
                        
                        <!-- E-Mail senden -->
                        <button onclick="sendeEmailAnPartner('${id}', '${email}', '${vorname}', '${nachname}')" style="padding: 16px; background: linear-gradient(135deg, #4299e1, #3182ce); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 15px; text-align: left; display: flex; align-items: center; gap: 12px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(66,153,225,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(66,153,225,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(66,153,225,0.3)'">
                            <i class="fas fa-envelope" style="font-size: 24px;"></i>
                            <div>
                                <div style="font-size: 15px; font-weight: 700;">E-Mail senden</div>
                                <div style="font-size: 12px; opacity: 0.9;">Nachricht schreiben</div>
                            </div>
                        </button>
                        
                        <!-- Ablehnen -->
                        <button onclick="lehneAnfrageAb('${id}', '${vorname}', '${nachname}')" style="padding: 16px; background: linear-gradient(135deg, #f56565, #e53e3e); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 15px; text-align: left; display: flex; align-items: center; gap: 12px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(245,101,101,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(245,101,101,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(245,101,101,0.3)'">
                            <i class="fas fa-times-circle" style="font-size: 24px;"></i>
                            <div>
                                <div style="font-size: 15px; font-weight: 700;">Anfrage ablehnen</div>
                                <div style="font-size: 12px; opacity: 0.9;">Nicht geeignet</div>
                            </div>
                        </button>
                    </div>
                    
                    <button onclick="document.getElementById('anfrage-actions-modal').remove()" style="margin-top: 20px; width: 100%; padding: 12px; background: #f7fafc; color: #4a5568; border: 2px solid #e2e8f0; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s;" onmouseover="this.style.background='#edf2f7'" onmouseout="this.style.background='#f7fafc'">
                        <i class="fas fa-arrow-left"></i> Abbrechen
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // âœ… TERMIN VEREINBAREN MODAL
        function openTerminVereinbarenModal(anfrageId, vorname, nachname, email) {
            document.getElementById('anfrage-actions-modal').remove();
            
            const modal = document.createElement('div');
            modal.id = 'termin-vereinbaren-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                animation: fadeIn 0.2s;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 30px; max-width: 550px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2); animation: slideUp 0.3s;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid #e2e8f0;">
                        <div>
                            <h3 style="margin: 0; font-size: 20px; color: #1a202c;"><i class="fas fa-calendar-plus"></i> Termin vereinbaren</h3>
                            <p style="margin: 5px 0 0 0; font-size: 14px; color: #718096;">Mit ${vorname} ${nachname}</p>
                        </div>
                        <button onclick="document.getElementById('termin-vereinbaren-modal').remove()" style="background: #f7fafc; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 18px; color: #4a5568;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #4a5568;">Mit wem mÃ¶chten Sie einen Termin vereinbaren?</label>
                        <select id="termin-partner-select" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; cursor: pointer;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                            <option value="">Partner auswÃ¤hlen...</option>
                            <option value="${email}">${vorname} ${nachname} (${email})</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #4a5568;">Termin-Datum</label>
                        <input type="date" id="termin-datum" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #4a5568;">Uhrzeit</label>
                        <input type="time" id="termin-uhrzeit" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #4a5568;">Notizen (optional)</label>
                        <textarea id="termin-notizen" rows="3" placeholder="z.B. Themen fÃ¼r das GesprÃ¤ch..." style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; resize: vertical;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="speichereTermin('${anfrageId}', '${email}', '${vorname}', '${nachname}')" style="flex: 1; padding: 14px; background: #3b82f6; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 15px; transition: all 0.2s;" onmouseover="this.style.background='#5568d3'" onmouseout="this.style.background='#3b82f6'">
                            <i class="fas fa-check"></i> Termin speichern
                        </button>
                        <button onclick="document.getElementById('termin-vereinbaren-modal').remove()" style="padding: 14px 20px; background: #f7fafc; color: #4a5568; border: 2px solid #e2e8f0; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 15px;">
                            Abbrechen
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // âœ… TERMIN SPEICHERN
        async function speichereTermin(anfrageId, partnerEmail, vorname, nachname) {
            const datum = document.getElementById('termin-datum').value;
            const uhrzeit = document.getElementById('termin-uhrzeit').value;
            const notizen = document.getElementById('termin-notizen').value;
            
            if (!datum || !uhrzeit) {
                alert('Bitte Datum und Uhrzeit auswÃ¤hlen!');
                return;
            }
            
            try {
                // 1. Termin in DB speichern
                const terminData = {
                    partner_email: partnerEmail,
                    titel: `GesprÃ¤ch mit ${vorname} ${nachname}`,
                    datum: datum,
                    uhrzeit: uhrzeit,
                    typ: 'partner_call',
                    status: 'geplant',
                    notizen: notizen || ''
                };
                
                const terminResponse = await fetch('tables/termine', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(terminData)
                });
                
                if (!terminResponse.ok) throw new Error('Fehler beim Speichern des Termins');
                
                // 2. Anfrage-Status auf "termin_vereinbart" setzen
                await fetch(`tables/interessenten/${anfrageId}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ anfrage_status: 'termin_vereinbart' })
                });
                
                // 3. Modal schlieÃŸen & Success-Nachricht
                document.getElementById('termin-vereinbaren-modal').remove();
                showToast('âœ… Termin erfolgreich vereinbart!', 'success');
                
                // 4. Tabelle neu laden
                loadInteressenten();
                
            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler beim Speichern des Termins: ' + error.message);
            }
        }
        
        // âœ… PARTNER AKTIVIEREN
        async function aktivierePartner(anfrageId, vorname, nachname, email) {
            if (!confirm(`${vorname} ${nachname} wirklich als Partner aktivieren?`)) return;
            
            try {
                // Hole vollstÃ¤ndige Anfrage-Daten
                const anfrageResponse = await fetch(`tables/interessenten/${anfrageId}`);
                const anfrage = await anfrageResponse.json();
                
                // Erstelle Partner-Datensatz
                const partnerData = {
                    vorname: anfrage.vorname,
                    nachname: anfrage.nachname,
                    email: anfrage.email,
                    phone: anfrage.phone || '',
                    firma: anfrage.firma || '',
                    strasse: anfrage.strasse || '',
                    plz: anfrage.plz || '',
                    ort: anfrage.ort || '',
                    modell: anfrage.modell || 'ladenlokal',
                    status: 'aktiv',
                    onboarding_completed: false,
                    registriert_am: Date.now()
                };
                
                const partnerResponse = await fetch('tables/partners', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(partnerData)
                });
                
                if (!partnerResponse.ok) throw new Error('Fehler beim Anlegen des Partners');
                
                // Status der Anfrage auf "abgeschlossen" setzen
                await fetch(`tables/interessenten/${anfrageId}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ anfrage_status: 'abgeschlossen' })
                });
                
                document.getElementById('anfrage-actions-modal').remove();
                showToast('âœ… Partner erfolgreich aktiviert!', 'success');
                loadInteressenten();
                
            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler beim Aktivieren des Partners: ' + error.message);
            }
        }
        
        // âœ… E-MAIL SENDEN
        function sendeEmailAnPartner(anfrageId, email, vorname, nachname) {
            document.getElementById('anfrage-actions-modal').remove();
            
            // Wechsle zum E-Mail-Tab und fÃ¼lle EmpfÃ¤nger-Feld aus
            switchTab('email');
            
            setTimeout(() => {
                const emailInput = document.getElementById('emailPartnerSelect') || document.querySelector('input[type="email"]');
                if (emailInput) {
                    emailInput.value = email;
                }
                showToast(`E-Mail-Tab geÃ¶ffnet fÃ¼r ${vorname} ${nachname}`, 'info');
            }, 300);
        }
        
        // âœ… ANFRAGE ABLEHNEN
        async function lehneAnfrageAb(anfrageId, vorname, nachname) {
            if (!confirm(`Anfrage von ${vorname} ${nachname} wirklich ablehnen?`)) return;
            
            try {
                await fetch(`tables/interessenten/${anfrageId}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ anfrage_status: 'abgelehnt' })
                });
                
                document.getElementById('anfrage-actions-modal').remove();
                showToast('âŒ Anfrage abgelehnt', 'warning');
                loadInteressenten();
                
            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler beim Ablehnen der Anfrage');
            }
        }

        // âœ… WRAPPER-FUNKTIONEN FÃœR AKTIONEN AUS DEM DETAILS-MODAL
        function openTerminVereinbarenModalFromDetails() {
            if (!currentInteressent) return;
            closeInteressentModal();
            openTerminVereinbarenModal(currentInteressent.id, currentInteressent.vorname, currentInteressent.nachname, currentInteressent.email);
        }
        
        function aktivierePartnerFromDetails() {
            if (!currentInteressent) return;
            closeInteressentModal();
            aktivierePartner(currentInteressent.id, currentInteressent.vorname, currentInteressent.nachname, currentInteressent.email);
        }
        
        function sendeEmailAnPartnerFromDetails() {
            if (!currentInteressent) return;
            closeInteressentModal();
            sendeEmailAnPartner(currentInteressent.id, currentInteressent.email, currentInteressent.vorname, currentInteressent.nachname);
        }
        
        function lehneAnfrageAbFromDetails() {
            if (!currentInteressent) return;
            closeInteressentModal();
            lehneAnfrageAb(currentInteressent.id, currentInteressent.vorname, currentInteressent.nachname);
        }

        // âœ… TOAST-BENACHRICHTIGUNG (falls noch nicht vorhanden)
        function showToast(message, type = 'info') {
            const existingToast = document.getElementById('custom-toast');
            if (existingToast) existingToast.remove();
            
            const colors = {
                'success': '#48bb78',
                'error': '#f56565',
                'warning': '#ed8936',
                'info': '#4299e1'
            };
            
            const toast = document.createElement('div');
            toast.id = 'custom-toast';
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type] || colors.info};
                color: white;
                padding: 16px 24px;
                border-radius: 10px;
                font-weight: 600;
                font-size: 15px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 99999;
                animation: slideInRight 0.3s;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Details anzeigen (einfache Alert-Version - kann spÃ¤ter durch Modal ersetzt werden)
        // Global variable for current interessent
        let currentInteressent = null;

        async function showInteressentDetails(id) {
            try {
                const response = await fetch(`tables/interessenten/${id}`);
                currentInteressent = await response.json();
                
                // Update modal header
                document.getElementById('modalInteressentName').textContent = 
                    `${currentInteressent.vorname || ''} ${currentInteressent.nachname || ''}`.trim() || 'Interessent Details';
                
                // Personal Data
                const personalHtml = `
                    <div>
                        <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; margin-bottom: 3px;">Vorname</div>
                        <div style="font-weight: 600;">${currentInteressent.vorname || '-'}</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; margin-bottom: 3px;">Nachname</div>
                        <div style="font-weight: 600;">${currentInteressent.nachname || '-'}</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; margin-bottom: 3px;">E-Mail</div>
                        <div style="font-weight: 600;">${currentInteressent.email || '-'}</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; margin-bottom: 3px;">Telefon</div>
                        <div style="font-weight: 600;">${currentInteressent.phone || '-'}</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; margin-bottom: 3px;">Firma</div>
                        <div style="font-weight: 600;">${currentInteressent.firma || '-'}</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; margin-bottom: 3px;">Adresse</div>
                        <div style="font-weight: 600;">${currentInteressent.strasse || '-'}, ${currentInteressent.plz || ''} ${currentInteressent.ort || ''}</div>
                    </div>
                `;
                document.getElementById('modalPersonalData').innerHTML = personalHtml;
                
                // Business Data
                const businessHtml = `
                    <div>
                        <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; margin-bottom: 3px;">Partner-Modell</div>
                        <div style="font-weight: 600;">${currentInteressent.modell || '-'}</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; margin-bottom: 3px;">Erfahrung</div>
                        <div style="font-weight: 600;">${currentInteressent.erfahrung || '-'}</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; margin-bottom: 3px;">Status Person</div>
                        <div style="font-weight: 600;">${currentInteressent.status_person || '-'}</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; margin-bottom: 3px;">VertrÃ¤ge/Monat</div>
                        <div style="font-weight: 600;">${currentInteressent.vertraege_monat || '-'}</div>
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; margin-bottom: 3px;">
                            <i class="fas fa-star"></i> Interessenbereiche
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                            ${currentInteressent.interessen && Array.isArray(currentInteressent.interessen) && currentInteressent.interessen.length > 0 ? 
                                currentInteressent.interessen.map(interesse => {
                                    const icons = {
                                        'Mobilfunk': 'ğŸ“±',
                                        'DSL': 'ğŸŒ',
                                        'Strom': 'âš¡',
                                        'Versicherung': 'ğŸ›¡ï¸',
                                        'KI': 'ğŸ¤–',
                                        'Alle Bereiche': 'ğŸŒŸ'
                                    };
                                    return `
                                        <span style="background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                                            ${icons[interesse] || 'âœ“'} ${interesse}
                                        </span>
                                    `;
                                }).join('') 
                                : '<span style="color: var(--text-light);">Keine Interessen angegeben</span>'
                            }
                        </div>
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; margin-bottom: 3px;">Ziele</div>
                        <div style="font-weight: 600;">${currentInteressent.ziele || '-'}</div>
                    </div>
                `;
                document.getElementById('modalBusinessData').innerHTML = businessHtml;
                
                // ğŸ”¥ STANDORT & EIGENKAPITAL
                const standortKapitalHtml = `
                    <div>
                        <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; margin-bottom: 3px;">Standort</div>
                        <div style="font-weight: 600;">${currentInteressent.standort || '-'}</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; margin-bottom: 3px;">Eigenkapital</div>
                        <div style="font-weight: 600;">${currentInteressent.eigenkapital || '-'}</div>
                    </div>
                    ${currentInteressent.verkaufskanaele && Array.isArray(currentInteressent.verkaufskanaele) && currentInteressent.verkaufskanaele.length > 0 ? `
                    <div style="grid-column: 1 / -1;">
                        <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; margin-bottom: 3px;">
                            <i class="fas fa-store"></i> VerkaufskanÃ¤le
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                            ${currentInteressent.verkaufskanaele.map(kanal => {
                                const icons = {
                                    'vor-ort': 'ğŸª',
                                    'online': 'ğŸ’»',
                                    'beides': 'ğŸŒ'
                                };
                                const labels = {
                                    'vor-ort': 'Vor Ort',
                                    'online': 'Online',
                                    'beides': 'Vor Ort + Online'
                                };
                                return `
                                    <span style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                                        ${icons[kanal] || 'âœ“'} ${labels[kanal] || kanal}
                                    </span>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    ` : ''}
                `;
                document.getElementById('modalStandortKapital').innerHTML = standortKapitalHtml;
                
                // ğŸ”¥ UNTERSTÃœTZUNG (nur wenn Eigenkapital = "ja")
                if (currentInteressent.eigenkapital === 'ja' && currentInteressent.unterstuetzung && Array.isArray(currentInteressent.unterstuetzung) && currentInteressent.unterstuetzung.length > 0) {
                    const unterstuetzungHtml = `
                        <div style="background: var(--bg); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <h3 style="color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-hands-helping"></i> Wie kÃ¶nnen wir dich unterstÃ¼tzen?
                            </h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                ${currentInteressent.unterstuetzung.map(u => `
                                    <span style="background: var(--success); color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600;">
                                        <i class="fas fa-check-circle"></i> ${u}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    // FÃ¼ge nach "Standort & Eigenkapital" Container ein
                    const standortContainer = document.getElementById('modalStandortKapital').closest('div[style*="background"]');
                    if (standortContainer) {
                        standortContainer.insertAdjacentHTML('afterend', unterstuetzungHtml);
                    }
                }
                
                // ğŸ”¥ WEBSITE DETAILS (fÃ¼r Online-Shop)
                let websiteDetails = null;
                try {
                    websiteDetails = currentInteressent.website_details ? JSON.parse(currentInteressent.website_details) : null;
                } catch (e) {
                    console.warn('Konnte website_details nicht parsen:', e);
                }
                
                if (websiteDetails && currentInteressent.modell === 'onlineshop') {
                    const websiteHtml = `
                        <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; margin-bottom: 8px;">ğŸŒ Website-Details</div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid var(--border);">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <strong style="font-size: 11px; color: var(--text-light);">Art der Seite</strong>
                                    <div>${websiteDetails.art_seite || '-'}</div>
                                </div>
                                <div>
                                    <strong style="font-size: 11px; color: var(--text-light);">Seitenaufbau</strong>
                                    <div>${websiteDetails.seitenaufbau || '-'}</div>
                                </div>
                                <div>
                                    <strong style="font-size: 11px; color: var(--text-light);">Texte & Bilder</strong>
                                    <div>${websiteDetails.texte_bilder || '-'}</div>
                                </div>
                                <div>
                                    <strong style="font-size: 11px; color: var(--text-light);">Zielgruppe</strong>
                                    <div>${websiteDetails.zielgruppe || '-'}</div>
                                </div>
                                <div>
                                    <strong style="font-size: 11px; color: var(--text-light);">Design & Farben</strong>
                                    <div>${websiteDetails.design_farben || '-'}</div>
                                </div>
                                <div>
                                    <strong style="font-size: 11px; color: var(--text-light);">Logo</strong>
                                    <div>${websiteDetails.logo || '-'}</div>
                                </div>
                                <div>
                                    <strong style="font-size: 11px; color: var(--text-light);">Zahlungsmodell</strong>
                                    <div>${websiteDetails.zahlungsmodell || '-'}</div>
                                </div>
                                ${websiteDetails.kontaktmoeglichkeiten && Array.isArray(websiteDetails.kontaktmoeglichkeiten) && websiteDetails.kontaktmoeglichkeiten.length > 0 ? `
                                <div>
                                    <strong style="font-size: 11px; color: var(--text-light);">KontaktmÃ¶glichkeiten</strong>
                                    <div>${websiteDetails.kontaktmoeglichkeiten.join(', ')}</div>
                                </div>
                                ` : ''}
                                ${websiteDetails.extras ? `
                                <div style="grid-column: 1 / -1;">
                                    <strong style="font-size: 11px; color: var(--text-light);">Extras / ZusÃ¤tzliche WÃ¼nsche</strong>
                                    <div style="margin-top: 5px;">${websiteDetails.extras}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    document.getElementById('modalWebsiteDetails').innerHTML = websiteHtml;
                } else {
                    document.getElementById('modalWebsiteDetails').innerHTML = '';
                }
                
                // ğŸ”¥ SYSTEM & KI-TOOLS
                let systemTools = null;
                try {
                    systemTools = currentInteressent.system_tools ? JSON.parse(currentInteressent.system_tools) : null;
                } catch (e) {
                    console.warn('Konnte system_tools nicht parsen:', e);
                }
                
                let systemHtml = '';
                if (systemTools) {
                    // System Features
                    if (systemTools.system) {
                        const systemFeatures = [];
                        if (systemTools.system.automation) systemFeatures.push('Automatische System-Updates');
                        if (systemTools.system.leads) systemFeatures.push('Lead-Management System');
                        if (systemTools.system.reports) systemFeatures.push('Automatische Berichte & Statistiken');
                        
                        if (systemFeatures.length > 0) {
                            systemHtml += `
                                <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; margin-bottom: 8px;">âš™ï¸ System & Automatisierung</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;">
                                    ${systemFeatures.map(f => `
                                        <span style="background: var(--primary); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                            ${f}
                                        </span>
                                    `).join('')}
                                </div>
                            `;
                        }
                    }
                    
                    // KI Tools
                    if (systemTools.tools) {
                        const kiTools = [];
                        if (systemTools.tools.voicemind) kiTools.push('ğŸ¤– VoiceMind Anruf-KI');
                        if (systemTools.tools.chatai) kiTools.push('ğŸ’¬ Chat-KI fÃ¼r Website');
                        if (systemTools.tools.emailai) kiTools.push('ğŸ“§ E-Mail Marketing-KI');
                        
                        if (kiTools.length > 0) {
                            systemHtml += `
                                <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; margin-bottom: 8px;">ğŸš€ GewÃ¤hlte KI-Tools</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                    ${kiTools.map(t => `
                                        <span style="background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                            ${t}
                                        </span>
                                    `).join('')}
                                </div>
                            `;
                        }
                    }
                }
                document.getElementById('modalSystemTools').innerHTML = systemHtml;
                
                // KI Tools / Interessen - ENTFERNT (Duplikat mit Interessenbereiche oben)
                
                // Status
                const statusColors = {
                    'neu': 'primary',
                    'kontaktiert': 'warning',
                    'termin_vereinbart': 'success',
                    'qualifiziert': 'success',
                    'abgelehnt': 'danger'
                };
                const statusTexte = {
                    'neu': 'ğŸ†• Neu',
                    'kontaktiert': 'ğŸ“ Kontaktiert',
                    'termin_vereinbart': 'ğŸ“… Termin vereinbart',
                    'qualifiziert': 'âœ… Qualifiziert',
                    'abgelehnt': 'âŒ Abgelehnt'
                };
                const currentStatus = currentInteressent.anfrage_status || 'neu';
                document.getElementById('modalCurrentStatus').textContent = statusTexte[currentStatus];
                document.getElementById('modalCurrentStatus').className = `badge badge-${statusColors[currentStatus]}`;
                document.getElementById('modalStatusSelect').value = currentStatus;
                
                // Timestamps
                if (currentInteressent.eingegangen_am) {
                    const date = new Date(currentInteressent.eingegangen_am);
                    document.getElementById('modalRegistriertAm').textContent = 
                        date.toLocaleString('de-DE', {
                            day: '2-digit', month: '2-digit', year: 'numeric',
                            hour: '2-digit', minute: '2-digit'
                        });
                }
                if (currentInteressent.updated_at) {
                    const date = new Date(currentInteressent.updated_at);
                    document.getElementById('modalUpdatedAt').textContent = 
                        date.toLocaleString('de-DE', {
                            day: '2-digit', month: '2-digit', year: 'numeric',
                            hour: '2-digit', minute: '2-digit'
                        });
                }
                
                // Load notes and termine
                await loadInteressentNotes();
                await loadInteressentTermine();
                
                // Show modal
                document.getElementById('interessentModal').style.display = 'flex';
                
            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler beim Laden der Details');
            }
        }

        function closeInteressentModal() {
            document.getElementById('interessentModal').style.display = 'none';
            currentInteressent = null;
        }

        async function loadInteressentNotes() {
            try {
                const response = await fetch(`tables/notizen?limit=1000`);
                const data = await response.json();
                const notes = data.data.filter(note => note.interessent_id === currentInteressent.id);
                
                const notesList = document.getElementById('modalNotesList');
                if (notes.length === 0) {
                    notesList.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 20px;">Noch keine Notizen vorhanden</p>';
                    return;
                }
                
                notesList.innerHTML = notes
                    .sort((a, b) => b.erstellt_am - a.erstellt_am)
                    .map(note => {
                        const date = new Date(note.erstellt_am);
                        return `
                            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--primary);">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px; color: var(--text-light);">
                                    <strong>${note.admin_name || 'Admin'}</strong>
                                    <span>${date.toLocaleString('de-DE', {day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'})}</span>
                                </div>
                                <div style="color: var(--text);">${note.notiz}</div>
                            </div>
                        `;
                    }).join('');
            } catch (error) {
                console.error('Error loading notes:', error);
            }
        }

        async function addInteressentNote() {
            const noteText = document.getElementById('modalNewNote').value.trim();
            if (!noteText) {
                alert('Bitte eine Notiz eingeben!');
                return;
            }
            
            try {
                await fetch('tables/notizen', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        interessent_id: currentInteressent.id,
                        admin_id: 'admin-1',
                        admin_name: localStorage.getItem('adminEmail') || 'Admin',
                        notiz: noteText,
                        erstellt_am: Date.now()
                    })
                });
                
                document.getElementById('modalNewNote').value = '';
                await loadInteressentNotes();
            } catch (error) {
                console.error('Error adding note:', error);
                alert('Fehler beim Speichern der Notiz!');
            }
        }

        async function loadInteressentTermine() {
            try {
                const response = await fetch(`tables/termine?limit=1000`);
                const data = await response.json();
                const termine = data.data.filter(t => t.interessent_id === currentInteressent.id);
                
                const termineList = document.getElementById('modalTermineList');
                if (termine.length === 0) {
                    termineList.innerHTML = '<p style="color: var(--text-light); text-align: center;">Keine Termine</p>';
                    return;
                }
                
                termineList.innerHTML = termine
                    .sort((a, b) => b.termin_datum - a.termin_datum)
                    .map(termin => {
                        const date = new Date(termin.termin_datum);
                        const statusColors = {
                            'geplant': 'warning',
                            'bestaetigt': 'primary',
                            'abgeschlossen': 'success',
                            'abgesagt': 'danger'
                        };
                        return `
                            <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600; color: var(--primary);">${termin.termin_typ}</div>
                                        <div style="font-size: 12px; color: var(--text-light);">
                                            ${date.toLocaleString('de-DE', {day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'})}
                                        </div>
                                        ${termin.meeting_link ? `<a href="${termin.meeting_link}" target="_blank" style="color: var(--primary); font-size: 12px;"><i class="fas fa-external-link-alt"></i> Meeting Link</a>` : ''}
                                    </div>
                                    <span class="badge badge-${statusColors[termin.status]}">${termin.status}</span>
                                </div>
                            </div>
                        `;
                    }).join('');
            } catch (error) {
                console.error('Error loading termine:', error);
            }
        }

        async function changeInteressentStatus() {
            const newStatus = document.getElementById('modalStatusSelect').value;
            
            try {
                await fetch(`tables/interessenten/${currentInteressent.id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ anfrage_status: newStatus })
                });
                
                // Update UI
                const statusColors = { 'neu': 'primary', 'kontaktiert': 'warning', 'termin_vereinbart': 'success', 'qualifiziert': 'success', 'abgelehnt': 'danger' };
                const statusTexte = { 'neu': 'ğŸ†• Neu', 'kontaktiert': 'ğŸ“ Kontaktiert', 'termin_vereinbart': 'ğŸ“… Termin vereinbart', 'qualifiziert': 'âœ… Qualifiziert', 'abgelehnt': 'âŒ Abgelehnt' };
                document.getElementById('modalCurrentStatus').textContent = statusTexte[newStatus];
                document.getElementById('modalCurrentStatus').className = `badge badge-${statusColors[newStatus]}`;
                
                // Auto-note
                await fetch('tables/notizen', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        interessent_id: currentInteressent.id,
                        admin_id: 'admin-1',
                        admin_name: 'System',
                        notiz: `Status geÃ¤ndert zu: ${statusTexte[newStatus]}`,
                        erstellt_am: Date.now()
                    })
                });
                
                await loadInteressentNotes();
                await loadInteressenten(); // Refresh table
            } catch (error) {
                console.error('Error changing status:', error);
                alert('Fehler beim Ã„ndern des Status!');
            }
        }

        function openCallModal() {
            document.getElementById('callModal').style.display = 'flex';
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(10, 0, 0, 0);
            document.getElementById('terminDatum').value = tomorrow.toISOString().slice(0, 16);
        }

        function closeCallModal() {
            document.getElementById('callModal').style.display = 'none';
        }

        async function saveTermin() {
            const terminTyp = document.getElementById('terminTyp').value;
            const terminDatum = document.getElementById('terminDatum').value;
            const meetingLink = document.getElementById('meetingLink').value;
            const terminNotizen = document.getElementById('terminNotizen').value;
            
            if (!terminDatum) {
                alert('Bitte Datum und Uhrzeit auswÃ¤hlen!');
                return;
            }
            
            try {
                await fetch('tables/termine', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        interessent_id: currentInteressent.id,
                        partner_id: '',
                        termin_typ: terminTyp,
                        termin_datum: new Date(terminDatum).getTime(),
                        meeting_link: meetingLink,
                        status: 'geplant',
                        notizen: terminNotizen,
                        erstellt_am: Date.now()
                    })
                });
                
                // Auto-note
                await fetch('tables/notizen', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        interessent_id: currentInteressent.id,
                        admin_id: 'admin-1',
                        admin_name: 'System',
                        notiz: `Termin vereinbart: ${terminTyp} am ${new Date(terminDatum).toLocaleString('de-DE')}`,
                        erstellt_am: Date.now()
                    })
                });
                
                // Update status to termin_vereinbart
                if (currentInteressent.anfrage_status === 'neu' || currentInteressent.anfrage_status === 'kontaktiert') {
                    document.getElementById('modalStatusSelect').value = 'termin_vereinbart';
                    await changeInteressentStatus();
                }
                
                closeCallModal();
                await loadInteressentTermine();
                await loadInteressentNotes();
                alert('Termin erfolgreich gespeichert!');
            } catch (error) {
                console.error('Error saving termin:', error);
                alert('Fehler beim Speichern des Termins!');
            }
        }

        async function convertToPartner() {
            if (!confirm('MÃ¶chten Sie diesen Interessenten wirklich als Partner aktivieren?')) return;
            
            try {
                const password = generatePassword();
                const partnerData = {
                    email: currentInteressent.email,
                    passwort: password,
                    vorname: currentInteressent.vorname,
                    nachname: currentInteressent.nachname,
                    firma: currentInteressent.firma,
                    phone: currentInteressent.phone,
                    modell: currentInteressent.modell,
                    status: 'aktiv',
                    registriert_am: Date.now(),
                    onboarding_completed: false,
                    tarif: 'basic'
                };
                
                const response = await fetch('tables/partners', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(partnerData)
                });
                
                const partner = await response.json();
                
                // Update interessent
                await fetch(`tables/interessenten/${currentInteressent.id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        anfrage_status: 'qualifiziert',
                        partner_id: partner.id
                    })
                });
                
                // Add note
                await fetch('tables/notizen', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        interessent_id: currentInteressent.id,
                        admin_id: 'admin-1',
                        admin_name: 'System',
                        notiz: `Als Partner aktiviert! Partner-ID: ${partner.id}`,
                        erstellt_am: Date.now()
                    })
                });
                
                alert(`Partner erfolgreich aktiviert!\n\nE-Mail: ${partner.email}\nPasswort: ${password}\n\n(Bitte dem Partner per E-Mail zusenden)`);
                
                await showInteressentDetails(currentInteressent.id); // Refresh
                await loadInteressenten(); // Refresh table
            } catch (error) {
                console.error('Error converting to partner:', error);
                alert('Fehler beim Aktivieren des Partners!');
            }
        }

        function generatePassword() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789';
            let password = '';
            for (let i = 0; i < 10; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        function sendInteressentEmail() {
            window.location.href = `mailto:${currentInteressent.email}?subject=Ihre Anfrage bei EatOS&body=Hallo ${currentInteressent.vorname},`;
        }

        async function rejectInteressent() {
            const reason = prompt('Grund fÃ¼r Ablehnung (optional):');
            if (reason === null) return;
            
            try {
                document.getElementById('modalStatusSelect').value = 'abgelehnt';
                await changeInteressentStatus();
                
                if (reason) {
                    await fetch('tables/notizen', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            interessent_id: currentInteressent.id,
                            admin_id: 'admin-1',
                            admin_name: localStorage.getItem('adminEmail') || 'Admin',
                            notiz: `Abgelehnt. Grund: ${reason}`,
                            erstellt_am: Date.now()
                        })
                    });
                    await loadInteressentNotes();
                }
                
                alert('Interessent wurde abgelehnt.');
            } catch (error) {
                console.error('Error rejecting:', error);
                alert('Fehler beim Ablehnen!');
            }
        }

        // Provisionen eintragen
        document.getElementById('provisionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                partner_email: document.getElementById('prov_email').value,
                betrag: parseFloat(document.getElementById('prov_betrag').value),
                typ: document.getElementById('prov_typ').value,
                status: document.getElementById('prov_status').value,
                tarif: document.getElementById('prov_tarif').value,
                kunde_name: document.getElementById('prov_kunde').value || '',
                datum: new Date().toISOString()
            };
            
            try {
                const response = await fetch('tables/provisionen', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    document.getElementById('provisionSuccess').style.display = 'block';
                    setTimeout(() => {
                        document.getElementById('provisionSuccess').style.display = 'none';
                    }, 3000);
                    
                    this.reset();
                    loadProvisionen();
                }
            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler beim Speichern der Provision');
            }
        });

        // E-Mail Formular Handler
        document.getElementById('emailForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            console.log('ğŸ“§ E-Mail Formular submitted');
            
            const empfaengerSelect = document.getElementById('email_empfaenger');
            const betreff = document.getElementById('email_betreff').value;
            const nachricht = document.getElementById('email_nachricht').value;
            
            // EmpfÃ¤nger bestimmen
            let empfaenger = [];
            const empfaengerValue = empfaengerSelect.value;
            
            if (empfaengerValue === 'alle') {
                // Alle Partner laden
                try {
                    const response = await fetch('tables/partners?limit=1000');
                    const result = await response.json();
                    empfaenger = result.data.map(p => p.email);
                } catch (error) {
                    console.error('Fehler beim Laden der Partner:', error);
                    alert('Fehler beim Laden der Partner-Liste');
                    return;
                }
            } else if (empfaengerValue === 'aktive') {
                // Nur aktive Partner laden
                try {
                    const response = await fetch('tables/partners?limit=1000');
                    const result = await response.json();
                    empfaenger = result.data.filter(p => p.status === 'aktiv').map(p => p.email);
                } catch (error) {
                    console.error('Fehler beim Laden der Partner:', error);
                    alert('Fehler beim Laden der Partner-Liste');
                    return;
                }
            } else {
                // Einzelner Partner
                empfaenger = [empfaengerValue];
            }
            
            console.log('ğŸ“¬ EmpfÃ¤nger:', empfaenger.length, 'Partner');
            
            // E-Mail Verlauf speichern
            const emailData = {
                empfaenger: empfaenger.join(', '),
                betreff: betreff,
                nachricht: nachricht,
                gesendet_am: new Date().toISOString(),
                anzahl_empfaenger: empfaenger.length,
                status: 'gesendet'
            };
            
            try {
                const response = await fetch('tables/email_verlauf', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(emailData)
                });
                
                if (response.ok) {
                    // Erfolg anzeigen
                    alert(`âœ… E-Mail erfolgreich an ${empfaenger.length} Partner gesendet!`);
                    
                    // Formular zurÃ¼cksetzen
                    this.reset();
                    
                    // E-Mail Verlauf neu laden
                    loadEmailVerlauf();
                } else {
                    throw new Error('Fehler beim Speichern');
                }
            } catch (error) {
                console.error('âŒ Fehler beim Senden der E-Mail:', error);
                alert('Fehler beim Senden der E-Mail. Bitte versuchen Sie es erneut.');
            }
        });

        // E-Mail Vorschau
        function previewEmail() {
            const betreff = document.getElementById('email_betreff').value;
            const nachricht = document.getElementById('email_nachricht').value;
            const empfaenger = document.getElementById('email_empfaenger').value;
            
            let empfaengerText = empfaenger;
            if (empfaenger === 'alle') empfaengerText = 'Alle Partner';
            else if (empfaenger === 'aktive') empfaengerText = 'Alle aktiven Partner';
            
            const preview = `
                <div style="max-width: 600px; margin: 20px auto; padding: 20px; border: 2px solid #3b82f6; border-radius: 10px; background: white;">
                    <h2 style="color: #3b82f6; margin-bottom: 20px;">ğŸ“§ E-Mail Vorschau</h2>
                    <div style="margin-bottom: 15px;">
                        <strong>An:</strong> ${empfaengerText}
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>Betreff:</strong> ${betreff || '(Kein Betreff)'}
                    </div>
                    <div style="border-top: 2px solid #eee; padding-top: 15px;">
                        <strong>Nachricht:</strong><br>
                        <div style="white-space: pre-wrap; margin-top: 10px;">${nachricht || '(Keine Nachricht)'}</div>
                    </div>
                </div>
            `;
            
            const previewWindow = window.open('', 'E-Mail Vorschau', 'width=700,height=600');
            previewWindow.document.write(preview);
        }

        // E-Mail Verlauf laden
        async function loadEmailVerlauf() {
            try {
                console.log('ğŸ“¥ Lade E-Mail Verlauf...');
                const response = await fetch('tables/email_verlauf?limit=50&sort=-created_at');
                const result = await response.json();
                
                const tbody = document.getElementById('emailVerlaufTable');
                if (!tbody) return;
                
                if (result.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px; color: var(--text-light);">Noch keine E-Mails gesendet</td></tr>';
                    return;
                }
                
                tbody.innerHTML = result.data.map(email => `
                    <tr>
                        <td>${new Date(email.gesendet_am || email.created_at).toLocaleString('de-DE')}</td>
                        <td>${email.anzahl_empfaenger} Partner</td>
                        <td><strong>${email.betreff}</strong></td>
                        <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${email.nachricht}</td>
                        <td>
                            <span class="badge badge-success">
                                ${email.status || 'gesendet'}
                            </span>
                        </td>
                    </tr>
                `).join('');
                
                console.log('âœ… E-Mail Verlauf geladen:', result.data.length, 'EintrÃ¤ge');
            } catch (error) {
                console.error('âŒ Fehler beim Laden des E-Mail Verlaufs:', error);
            }
        }

        // Provisionen laden
        async function loadProvisionen() {
            try {
                const response = await fetch('tables/provisionen?limit=50&sort=-created_at');
                const result = await response.json();
                
                const tbody = document.getElementById('provisionenTable');
                tbody.innerHTML = result.data.map(prov => `
                    <tr>
                        <td>${prov.partner_email}</td>
                        <td><strong>â‚¬${prov.betrag.toFixed(2)}</strong></td>
                        <td>${prov.typ}</td>
                        <td>${prov.tarif}</td>
                        <td>${new Date(prov.datum).toLocaleDateString('de-DE')}</td>
                        <td>
                            <span class="badge badge-${prov.status === 'ausgezahlt' ? 'success' : 'warning'}">
                                ${prov.status}
                            </span>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Fehler:', error);
            }
        }

        // âœ… Auszahlungen laden (NEU!)
        async function loadAuszahlungen() {
            try {
                const loadingDiv = document.getElementById('auszahlungen-loading');
                const emptyDiv = document.getElementById('auszahlungen-empty');
                const tbody = document.getElementById('auszahlungenTable');
                
                // Loading anzeigen
                if (loadingDiv) loadingDiv.style.display = 'block';
                if (emptyDiv) emptyDiv.style.display = 'none';
                if (tbody) tbody.innerHTML = '';
                
                // Daten laden
                const response = await fetch('tables/provisionen?limit=500&sort=-created_at');
                const result = await response.json();
                
                // Filter anwenden
                const statusFilter = document.getElementById('filter_auszahlungen_status')?.value || '';
                const searchTerm = document.getElementById('search_auszahlungen')?.value?.toLowerCase() || '';
                
                let filtered = result.data;
                if (statusFilter) {
                    filtered = filtered.filter(p => p.status === statusFilter);
                }
                if (searchTerm) {
                    filtered = filtered.filter(p => 
                        p.partner_email?.toLowerCase().includes(searchTerm) ||
                        p.tarif?.toLowerCase().includes(searchTerm) ||
                        p.typ?.toLowerCase().includes(searchTerm)
                    );
                }
                
                // Stats berechnen
                const ausgezahlt = result.data.filter(p => p.status === 'ausgezahlt').reduce((sum, p) => sum + (p.betrag || 0), 0);
                const ausstehend = result.data.filter(p => p.status === 'ausstehend' || p.status === 'in_bearbeitung').reduce((sum, p) => sum + (p.betrag || 0), 0);
                const abgelehnt = result.data.filter(p => p.status === 'abgelehnt' || p.status === 'storniert').reduce((sum, p) => sum + (p.betrag || 0), 0);
                
                document.getElementById('stat_auszahlungen_gesamt').textContent = `${ausgezahlt.toFixed(2)} â‚¬`;
                document.getElementById('stat_auszahlungen_ausstehend').textContent = `${ausstehend.toFixed(2)} â‚¬`;
                document.getElementById('stat_auszahlungen_abgelehnt').textContent = `${abgelehnt.toFixed(2)} â‚¬`;
                document.getElementById('stat_auszahlungen_anzahl').textContent = result.data.length;
                
                // Loading verstecken
                if (loadingDiv) loadingDiv.style.display = 'none';
                
                // Tabelle fÃ¼llen
                if (filtered.length === 0) {
                    if (emptyDiv) emptyDiv.style.display = 'block';
                    return;
                }
                
                tbody.innerHTML = filtered.map(prov => {
                    // Status-Badge-Farbe
                    let statusColor = '#718096';
                    let statusIcon = 'â³';
                    let statusText = prov.status;
                    
                    if (prov.status === 'ausgezahlt') {
                        statusColor = '#48bb78';
                        statusIcon = 'âœ…';
                        statusText = 'Ausgezahlt';
                    } else if (prov.status === 'ausstehend') {
                        statusColor = '#ed8936';
                        statusIcon = 'â³';
                        statusText = 'Ausstehend';
                    } else if (prov.status === 'in_bearbeitung') {
                        statusColor = '#3b82f6';
                        statusIcon = 'ğŸ”„';
                        statusText = 'In Bearbeitung';
                    } else if (prov.status === 'abgelehnt') {
                        statusColor = '#f56565';
                        statusIcon = 'âŒ';
                        statusText = 'Abgelehnt';
                    } else if (prov.status === 'storniert') {
                        statusColor = '#a0aec0';
                        statusIcon = 'ğŸš«';
                        statusText = 'Storniert';
                    }
                    
                    const ausgezahltDatum = prov.ausgezahlt_am 
                        ? new Date(prov.ausgezahlt_am).toLocaleDateString('de-DE', {day: '2-digit', month: '2-digit', year: 'numeric'})
                        : '-';
                    
                    return `
                        <tr style="transition: background 0.2s;" onmouseover="this.style.background='#f7fafc'" onmouseout="this.style.background='white'">
                            <td style="font-weight: 600; color: #1a202c;">${prov.partner_name || 'Unbekannt'}</td>
                            <td style="color: #718096; font-size: 13px;">${prov.partner_email || '-'}</td>
                            <td style="font-size: 18px; font-weight: 700; color: ${statusColor};">â‚¬${(prov.betrag || 0).toFixed(2)}</td>
                            <td style="color: #4a5568; font-weight: 500;">${prov.tarif || '-'}</td>
                            <td>
                                <span style="background: #3b82f620; color: #3b82f6; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">
                                    ${prov.typ || 'Sonstige'}
                                </span>
                            </td>
                            <td>
                                <span style="background: ${statusColor}20; color: ${statusColor}; padding: 6px 14px; border-radius: 8px; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px;">
                                    ${statusIcon} ${statusText}
                                </span>
                            </td>
                            <td style="color: #718096; font-size: 13px;">${new Date(prov.datum || prov.created_at).toLocaleDateString('de-DE', {day: '2-digit', month: '2-digit', year: 'numeric'})}</td>
                            <td style="color: ${prov.ausgezahlt_am ? '#48bb78' : '#a0aec0'}; font-weight: ${prov.ausgezahlt_am ? '600' : '400'}; font-size: 13px;">
                                ${ausgezahltDatum}
                            </td>
                            <td>
                                <button onclick="viewAuszahlungDetail('${prov.id}')" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;" onmouseover="this.style.background='#5568d3'" onmouseout="this.style.background='#3b82f6'">
                                    <i class="fas fa-eye"></i> Details
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('âŒ Fehler beim Laden der Auszahlungen:', error);
                const loadingDiv = document.getElementById('auszahlungen-loading');
                const tbody = document.getElementById('auszahlungenTable');
                if (loadingDiv) loadingDiv.style.display = 'none';
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px; color: #f56565;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 12px;"></i>
                                <p>Fehler beim Laden der Auszahlungen: ${error.message}</p>
                            </td>
                        </tr>
                    `;
                }
            }
        }
        
        async function viewAuszahlungDetail(provisionId) {
            console.log('ğŸ” viewAuszahlungDetail called with ID:', provisionId);
            
            try {
                // âš¡ SOFORT Modal anzeigen (Loading State)
                const modal = document.createElement('div');
                modal.id = 'auszahlung-detail-modal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); padding: 20px;';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                
                const content = document.createElement('div');
                content.style.cssText = 'background: white; border-radius: 16px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);';
                content.innerHTML = `
                    <div style="padding: 60px; text-align: center;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #3b82f6; margin-bottom: 20px;"></i>
                        <p style="font-size: 18px; color: #718096;">Lade Details...</p>
                    </div>
                `;
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                console.log('âš¡ Modal angezeigt, starte API-Calls...');
                
                // âš¡ Timeout nach 10 Sekunden
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Timeout: Laden dauert zu lange (>10s)')), 10000)
                );
                
                // âš¡ Daten PARALLEL laden (viel schneller!) mit Timeout
                const [provRes, partnerRes] = await Promise.race([
                    Promise.all([
                        fetch(`tables/provisionen/${provisionId}`),
                        fetch(`tables/partners?limit=100`).catch(err => {
                            console.log('âš ï¸ Partner-Laden fehlgeschlagen (wird ignoriert):', err);
                            return null;
                        })
                    ]),
                    timeoutPromise
                ]);
                
                console.log('âœ… API-Calls abgeschlossen, verarbeite Daten...');
                
                if (!provRes.ok) {
                    throw new Error(`API-Fehler: ${provRes.status} ${provRes.statusText}`);
                }
                
                const prov = await provRes.json();
                console.log('ğŸ“¦ Provision geladen:', prov);
                
                // Partner finden (falls geladen)
                let partner = null;
                if (partnerRes && prov.partner_email) {
                    try {
                        const partnerData = await partnerRes.json();
                        partner = partnerData.data.find(p => p.email === prov.partner_email);
                        console.log('ğŸ‘¤ Partner gefunden:', partner ? 'Ja' : 'Nein');
                    } catch (e) {
                        console.log('âš ï¸ Partner nicht gefunden:', e);
                    }
                }
                
                console.log('ğŸ¨ Erstelle Modal-Content...');
                
                // Status-Farbe & Icon
                let statusColor = '#718096';
                let statusIcon = 'â³';
                let statusText = prov.status || 'Unbekannt';
                
                if (prov.status === 'ausgezahlt') {
                    statusColor = '#48bb78';
                    statusIcon = 'âœ…';
                    statusText = 'Ausgezahlt';
                } else if (prov.status === 'ausstehend') {
                    statusColor = '#ed8936';
                    statusIcon = 'â³';
                    statusText = 'Ausstehend';
                } else if (prov.status === 'in_bearbeitung') {
                    statusColor = '#3b82f6';
                    statusIcon = 'ğŸ”„';
                    statusText = 'In Bearbeitung';
                } else if (prov.status === 'abgelehnt') {
                    statusColor = '#f56565';
                    statusIcon = 'âŒ';
                    statusText = 'Abgelehnt';
                } else if (prov.status === 'storniert') {
                    statusColor = '#a0aec0';
                    statusIcon = 'ğŸš«';
                    statusText = 'Storniert';
                }
                
                // âš¡ Modal-Content aktualisieren (statt neu erstellen)
                content.innerHTML = `
                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, ${statusColor}, ${statusColor}dd); padding: 32px; color: white; border-radius: 16px 16px 0 0; position: relative;">
                        <button onclick="document.getElementById('auszahlung-detail-modal').remove()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 20px;">
                            <i class="fas fa-times"></i>
                        </button>
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px;">
                            <div style="font-size: 48px;">${statusIcon}</div>
                            <div>
                                <h2 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 700;">Auszahlung Detail</h2>
                                <p style="margin: 0; opacity: 0.9; font-size: 16px;">${statusText}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="padding: 32px;">
                        <!-- Betrag (groÃŸ & prominent) -->
                        <div style="text-align: center; margin-bottom: 32px; padding: 24px; background: ${statusColor}10; border-radius: 12px; border: 2px solid ${statusColor}30;">
                            <div style="font-size: 48px; font-weight: 700; color: ${statusColor}; margin-bottom: 8px;">
                                â‚¬${(prov.betrag || 0).toFixed(2)}
                            </div>
                            <div style="font-size: 14px; color: #718096; font-weight: 600;">
                                ${prov.tarif || 'Unbekannter Tarif'}
                            </div>
                        </div>
                        
                        <!-- Partner-Info -->
                        <div style="margin-bottom: 24px; padding: 20px; background: #f7fafc; border-radius: 12px;">
                            <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 700; color: #1a202c;">
                                <i class="fas fa-user-circle"></i> Partner-Informationen
                            </h3>
                            <div style="display: grid; gap: 12px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #718096;">Name:</span>
                                    <span style="font-weight: 600; color: #1a202c;">${prov.partner_name || 'Unbekannt'}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #718096;">E-Mail:</span>
                                    <span style="font-weight: 600; color: #1a202c;">${prov.partner_email || '-'}</span>
                                </div>
                                ${partner ? `
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #718096;">Modell:</span>
                                        <span style="font-weight: 600; color: #1a202c;">${partner.modell || '-'}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #718096;">Status:</span>
                                        <span style="font-weight: 600; color: #1a202c;">${partner.status || '-'}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- Provisions-Details -->
                        <div style="margin-bottom: 24px; padding: 20px; background: #f7fafc; border-radius: 12px;">
                            <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 700; color: #1a202c;">
                                <i class="fas fa-file-invoice-dollar"></i> Provisions-Details
                            </h3>
                            <div style="display: grid; gap: 12px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #718096;">Typ:</span>
                                    <span style="background: #3b82f620; color: #3b82f6; padding: 4px 12px; border-radius: 6px; font-size: 13px; font-weight: 600;">
                                        ${prov.typ || 'Sonstige'}
                                    </span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #718096;">Tarif:</span>
                                    <span style="font-weight: 600; color: #1a202c;">${prov.tarif || '-'}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #718096;">Kundenname:</span>
                                    <span style="font-weight: 600; color: #1a202c;">${prov.kunde_name || prov.kundenname || '-'}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #718096;">Status:</span>
                                    <span style="background: ${statusColor}20; color: ${statusColor}; padding: 6px 14px; border-radius: 8px; font-size: 13px; font-weight: 600;">
                                        ${statusIcon} ${statusText}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Datum-Info -->
                        <div style="margin-bottom: 24px; padding: 20px; background: #f7fafc; border-radius: 12px;">
                            <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 700; color: #1a202c;">
                                <i class="fas fa-calendar-alt"></i> Zeitlinie
                            </h3>
                            <div style="display: grid; gap: 12px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #718096;">Erstellt am:</span>
                                    <span style="font-weight: 600; color: #1a202c;">
                                        ${new Date(prov.datum || prov.created_at).toLocaleString('de-DE', {
                                            day: '2-digit',
                                            month: '2-digit',
                                            year: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        })}
                                    </span>
                                </div>
                                ${prov.ausgezahlt_am ? `
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #718096;">Ausgezahlt am:</span>
                                        <span style="font-weight: 600; color: #48bb78;">
                                            ${new Date(prov.ausgezahlt_am).toLocaleString('de-DE', {
                                                day: '2-digit',
                                                month: '2-digit',
                                                year: 'numeric',
                                                hour: '2-digit',
                                                minute: '2-digit'
                                            })}
                                        </span>
                                    </div>
                                ` : '<div style="text-align: center; color: #a0aec0; font-style: italic; padding: 8px;">Noch nicht ausgezahlt</div>'}
                            </div>
                        </div>
                        
                        <!-- System-Info (optional) -->
                        <div style="padding: 16px; background: #fafafa; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 11px; color: #a0aec0; display: grid; gap: 4px;">
                                <div>ID: ${prov.id || '-'}</div>
                                <div>Erstellt: ${new Date(prov.created_at).toLocaleString('de-DE')}</div>
                                ${prov.updated_at ? `<div>Aktualisiert: ${new Date(prov.updated_at).toLocaleString('de-DE')}</div>` : ''}
                            </div>
                        </div>
                        
                        <!-- Aktionen -->
                        <div style="margin-top: 24px; display: grid; gap: 12px;">
                            ${prov.status === 'ausstehend' ? `
                                <button onclick="updateAuszahlungStatus('${prov.id}', 'ausgezahlt')" style="padding: 14px; background: #48bb78; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 15px;">
                                    <i class="fas fa-check-circle"></i> Als ausgezahlt markieren
                                </button>
                                <button onclick="updateAuszahlungStatus('${prov.id}', 'abgelehnt')" style="padding: 14px; background: #f56565; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 15px;">
                                    <i class="fas fa-times-circle"></i> Als abgelehnt markieren
                                </button>
                            ` : ''}
                            <button onclick="document.getElementById('auszahlung-detail-modal').remove()" style="padding: 14px; background: #f7fafc; color: #4a5568; border: 2px solid #e2e8f0; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 15px;">
                                <i class="fas fa-arrow-left"></i> SchlieÃŸen
                            </button>
                        </div>
                    </div>
                `;
                
                console.log('âœ… Modal-Content aktualisiert, fertig!');
                
            } catch (error) {
                console.error('âŒ Fehler beim Laden der Auszahlung:', error);
                
                // Fehler im Modal anzeigen
                const modal = document.getElementById('auszahlung-detail-modal');
                if (modal) {
                    const content = modal.querySelector('div');
                    if (content) {
                        content.innerHTML = `
                            <div style="padding: 60px; text-align: center;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #f56565; margin-bottom: 20px;"></i>
                                <h3 style="color: #1a202c; margin: 0 0 12px 0;">Fehler beim Laden</h3>
                                <p style="color: #718096; margin: 0 0 24px 0;">${error.message}</p>
                                <button onclick="document.getElementById('auszahlung-detail-modal').remove()" style="padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    SchlieÃŸen
                                </button>
                            </div>
                        `;
                    }
                } else {
                    alert('Fehler beim Laden der Auszahlungs-Details!\n\n' + error.message);
                }
            }
        }
        
        // Status einer Auszahlung Ã¤ndern
        async function updateAuszahlungStatus(provisionId, newStatus) {
            if (!confirm(`Wirklich als "${newStatus}" markieren?`)) return;
            
            try {
                console.log('ğŸ”„ Update Auszahlungs-Status:', provisionId, 'â†’', newStatus);
                
                const updateData = {
                    status: newStatus,
                    ausgezahlt_am: newStatus === 'ausgezahlt' ? new Date().toISOString() : null
                };
                
                console.log('ğŸ“¤ Sende Update:', updateData);
                
                const response = await fetch(`tables/provisionen/${provisionId}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(updateData)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                console.log('âœ… Update erfolgreich:', result);
                
                // Modal schlieÃŸen & Liste neu laden
                document.getElementById('auszahlung-detail-modal')?.remove();
                await loadAuszahlungen();
                
                alert(`âœ… Status erfolgreich auf "${newStatus}" geÃ¤ndert!`);
            } catch (error) {
                console.error('âŒ Fehler beim Ã„ndern des Status:', error);
                alert('âŒ Fehler beim Ã„ndern des Status!\n\n' + error.message);
            }
        }

        // Partner laden
        async function loadPartner() {
            try {
                // Visuelles Feedback
                const buttons = document.querySelectorAll('button[onclick="loadPartner()"]');
                buttons.forEach(btn => {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> LÃ¤dt...';
                });
                
                // ğŸ”„ Cache-Busting: Verhindert gecachte Daten
                const response = await fetch(`tables/partners?_t=${Date.now()}`, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    }
                });
                const result = await response.json();
                
                // Stats
                document.getElementById('stat_partner').textContent = result.data.length;
                document.getElementById('stat_aktiv').textContent = result.data.filter(p => p.status === 'aktiv').length;
                document.getElementById('stat_neu').textContent = result.data.filter(p => p.status === 'neu').length;
                
                // Tabelle
                const tbody = document.getElementById('partnerTable');
                tbody.innerHTML = result.data.map(partner => `
                    <tr>
                        <td>${partner.vorname} ${partner.nachname}</td>
                        <td>${partner.email}</td>
                        <td>${partner.modell}</td>
                        <td>
                            <span class="badge badge-${partner.status === 'aktiv' ? 'success' : 'warning'}">
                                ${partner.status}
                            </span>
                        </td>
                        <td>${partner.registriert_am ? new Date(partner.registriert_am).toLocaleDateString('de-DE') : '-'}</td>
                    </tr>
                `).join('');
                
                // Autocomplete-Liste
                const datalist1 = document.getElementById('partnerList');
                const datalist2 = document.getElementById('partnerList2');
                const options = result.data.map(p => `<option value="${p.email}">`).join('');
                datalist1.innerHTML = options;
                datalist2.innerHTML = options;
                
                // Button zurÃ¼cksetzen
                buttons.forEach(btn => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-sync"></i> Aktualisieren';
                });
                
            } catch (error) {
                console.error('Fehler:', error);
                // Button auch bei Fehler zurÃ¼cksetzen
                const buttons = document.querySelectorAll('button[onclick="loadPartner()"]');
                buttons.forEach(btn => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-sync"></i> Aktualisieren';
                });
            }
        }

        // ğŸ†• ÃœBERARBEITETE Partner-Verwaltung (Tabelle mit ALLEN Infos)
        let allPartners = []; // Globale Variable fÃ¼r Filter
        let allVertraege = []; // ğŸ†• Global fÃ¼r Filter
        let allDokumente = []; // ğŸ†• Global fÃ¼r Filter
        let currentPage = 1;
        const partnersPerPage = 20;
        
        async function loadPartnerVerwaltung() {
            console.log('ğŸ‘¥ Lade Partner-Verwaltung (NEUE VERSION)... START!');
            const tbody = document.getElementById('partner-table-body');
            if (!tbody) {
                console.error('âŒ FATAL: partner-table-body Element nicht gefunden!');
                return;
            }
            console.log('âœ… partner-table-body Element gefunden:', tbody);

            // Loading-State
            tbody.innerHTML = `<tr><td colspan="9" style="padding: 60px; text-align: center; color: #718096;"><i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 16px; display: block;"></i><p style="margin: 0;">Lade Partner...</p></td></tr>`;

            try {
                console.log('ğŸŒ Fetching partners...');
                // ğŸ”„ Cache-Busting mit Timestamp fÃ¼r immer frische Daten
                const response = await fetch(`tables/partners?limit=1000&_t=${Date.now()}`, { 
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const result = await response.json();
                allPartners = result.data.sort((a, b) => b.registriert_am - a.registriert_am);
                
                console.log('âœ… Partner geladen:', allPartners.length);
                
                // Lade Zusatzdaten parallel (schneller!)
                const [vertraegeRes, dokumenteRes] = await Promise.all([
                    fetch(`tables/vertragsabschluesse?limit=1000`).then(r => r.json()).catch((err) => {
                        console.error('âš ï¸ VertrÃ¤ge-Fehler:', err);
                        return {data: []};
                    }),
                    fetch(`tables/dokumente?limit=1000`).then(r => r.json()).catch((err) => {
                        console.error('âš ï¸ Dokumente-Fehler:', err);
                        return {data: []};
                    })
                ]);
                
                // âœ… Global speichern fÃ¼r Filter
                allVertraege = vertraegeRes.data || [];
                allDokumente = dokumenteRes.data || [];
                
                console.log('âœ… VertrÃ¤ge geladen:', allVertraege.length);
                console.log('âœ… Dokumente geladen:', allDokumente.length);
                
                // Stats - ğŸ†• Bestands-Partner mit erst_login werden als "aktiv" gezÃ¤hlt
                const aktivPartner = allPartners.filter(p => 
                    p.status === 'aktiv' || 
                    p.status === 'Aktiv' || 
                    p.status === 'Approved' ||
                    (p.erst_login && (p.ist_bestandspartner || p.ist_affiliate))
                );
                const neuePartner = allPartners.filter(p => 
                    p.status === 'neu' || 
                    ((p.ist_bestandspartner || p.ist_affiliate) && p.erst_login && !p.onboarding_completed)
                );
                const bestandsEingeloggt = allPartners.filter(p => 
                    (p.ist_bestandspartner || p.ist_affiliate) && p.erst_login
                ).length;
                
                document.getElementById('partner-stat-gesamt').textContent = allPartners.length;
                document.getElementById('partner-stat-aktiv').textContent = aktivPartner.length;
                document.getElementById('partner-stat-neu').textContent = neuePartner.length;
                document.getElementById('partner-stat-onboarding').textContent = allPartners.filter(p => !p.onboarding_completed && !p.ist_affiliate).length;
                
                console.log('ğŸ“Š Partner-Stats: Gesamt=' + allPartners.length + ', Aktiv=' + aktivPartner.length + ', Bestands-Eingeloggt=' + bestandsEingeloggt);

                // Render Partner-Tabelle
                renderPartnerTable(allPartners, allVertraege, allDokumente);

            } catch (error) {
                console.error('âŒ Fehler:', error);
                tbody.innerHTML = `<tr><td colspan="9" style="padding: 60px; text-align: center; color: #e53e3e;"><i class="fas fa-exclamation-triangle" style="font-size: 32px; display: block; margin-bottom: 16px;"></i><p style="margin: 0 0 16px 0;">Fehler beim Laden</p><button onclick="loadPartnerVerwaltung()" style="padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;"><i class="fas fa-redo"></i> Erneut versuchen
                        </button>
                    </div>
                `;
                
                // User-Alert
                alert(`FEHLER beim Laden der Partner:\n\n${error.message}\n\nBitte:\n1. Hard Refresh (Ctrl+Shift+R)\n2. Inkognito-Modus testen\n3. Konsole (F12) Screenshot senden`);
            }
        }

        // Partner-Details Modal Ã¶ffnen (ERWEITERT mit ALLEN Informationen)
        async function openPartnerDetails(partner) {
            console.log('ğŸ” Ã–ffne Details fÃ¼r:', partner.email);
            
            // Modal-Header fÃ¼llen
            document.getElementById('partner-modal-name').textContent = `${partner.vorname || ''} ${partner.nachname || ''}`;
            document.getElementById('partner-modal-email').textContent = partner.email;
            
            // Modal anzeigen
            const modal = document.getElementById('modal-partner-details');
            modal.style.display = 'flex';
            
            // Content-Area
            const content = document.getElementById('partner-modal-content');
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: var(--primary);"></i>
                    <p style="margin: 16px 0 0 0; color: #718096;">Lade Daten...</p>
                </div>
            `;

            try {
                // Parallel: VertrÃ¤ge, Provisionen, Dokumente laden
                const [vertraegeRes, provisionenRes, dokumenteRes] = await Promise.all([
                    fetch(`tables/vertragsabschluesse?limit=100&_t=${Date.now()}`),
                    fetch(`tables/provisionen?limit=100&_t=${Date.now()}`),
                    fetch(`tables/dokumente?limit=100&_t=${Date.now()}`)
                ]);

                const vertraege = (await vertraegeRes.json()).data.filter(v => v.partner_email === partner.email);
                const provisionen = (await provisionenRes.json()).data.filter(p => p.partner_email === partner.email);
                const dokumente = (await dokumenteRes.json()).data.filter(d => d.partner_email === partner.email);

                // Provision Summen berechnen
                const gesamtProvision = provisionen.reduce((sum, p) => sum + (p.betrag || 0), 0);
                const ausgezahlt = provisionen.filter(p => p.status === 'ausgezahlt').reduce((sum, p) => sum + (p.betrag || 0), 0);
                const ausstehend = gesamtProvision - ausgezahlt;
                
                // Onboarding berechnen
                const onboardingSteps = [
                    partner.onboarding_termin,
                    partner.onboarding_bank,
                    partner.onboarding_dokumente,
                    partner.onboarding_ausweis,
                    partner.onboarding_akademie,
                    partner.onboarding_abschluss
                ];
                const onboardingCompleted = onboardingSteps.filter(s => s === true).length;
                const onboardingPercent = Math.round((onboardingCompleted / 6) * 100);

                content.innerHTML = `
                    <!-- Info-Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 32px;">
                        <div style="background: #f7fafc; border-radius: 10px; padding: 16px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: #3b82f6;">${vertraege.length}</div>
                            <div style="font-size: 12px; color: #718096; margin-top: 4px;">VertrÃ¤ge</div>
                        </div>
                        <div style="background: #f7fafc; border-radius: 10px; padding: 16px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: #48bb78;">${gesamtProvision.toFixed(2)}â‚¬</div>
                            <div style="font-size: 12px; color: #718096; margin-top: 4px;">Gesamt Provision</div>
                        </div>
                        <div style="background: #f7fafc; border-radius: 10px; padding: 16px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: #ed8936;">${ausstehend.toFixed(2)}â‚¬</div>
                            <div style="font-size: 12px; color: #718096; margin-top: 4px;">Ausstehend</div>
                        </div>
                        <div style="background: #f7fafc; border-radius: 10px; padding: 16px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: #4299e1;">${onboardingPercent}%</div>
                            <div style="font-size: 12px; color: #718096; margin-top: 4px;">Onboarding</div>
                        </div>
                    </div>

                    <!-- VOLLSTÃ„NDIGE Partner-Informationen (IMMER: Vorname, Nachname, E-Mail, Telefon, Adresse) -->
                    <div style="margin-bottom: 24px;">
                        <h4 style="font-size: 16px; font-weight: 600; color: #1a202c; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-user-circle" style="color: #3b82f6;"></i> Partner-Informationen
                        </h4>
                        <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 12px; padding: 20px; border: 2px solid #93c5fd;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <!-- Linke Spalte: PersÃ¶nliche Daten -->
                                <div style="display: flex; flex-direction: column; gap: 14px;">
                                    <div style="background: white; border-radius: 8px; padding: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                        <div style="font-size: 11px; color: #3b82f6; text-transform: uppercase; margin-bottom: 4px; font-weight: 600;">ğŸ‘¤ Vorname</div>
                                        <div style="font-weight: 700; color: #1a202c; font-size: 16px;">${partner.vorname || '-'}</div>
                                    </div>
                                    <div style="background: white; border-radius: 8px; padding: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                        <div style="font-size: 11px; color: #3b82f6; text-transform: uppercase; margin-bottom: 4px; font-weight: 600;">ğŸ‘¤ Nachname</div>
                                        <div style="font-weight: 700; color: #1a202c; font-size: 16px;">${partner.nachname || '-'}</div>
                                    </div>
                                    <div style="background: white; border-radius: 8px; padding: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                        <div style="font-size: 11px; color: #3b82f6; text-transform: uppercase; margin-bottom: 4px; font-weight: 600;">âœ‰ï¸ E-Mail</div>
                                        <div style="font-weight: 600; color: #1a202c; font-size: 14px; word-break: break-all;"><a href="mailto:${partner.email}" style="color: #3b82f6; text-decoration: none;">${partner.email || '-'}</a></div>
                                    </div>
                                    <div style="background: white; border-radius: 8px; padding: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                        <div style="font-size: 11px; color: #3b82f6; text-transform: uppercase; margin-bottom: 4px; font-weight: 600;">ğŸ“ Telefonnummer</div>
                                        <div style="font-weight: 700; color: #1a202c; font-size: 16px;"><a href="tel:${partner.phone || partner.telefon || ''}" style="color: #1a202c; text-decoration: none;">${partner.phone || partner.telefon || '-'}</a></div>
                                    </div>
                                </div>
                                <!-- Rechte Spalte: Adresse & Firma -->
                                <div style="display: flex; flex-direction: column; gap: 14px;">
                                    <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 8px; padding: 14px; border: 2px solid #86efac;">
                                        <div style="font-size: 11px; color: #16a34a; text-transform: uppercase; margin-bottom: 6px; font-weight: 600;">ğŸ“ Adresse</div>
                                        <div style="font-weight: 600; color: #166534; line-height: 1.5;">
                                            ${partner.adresse || partner.strasse || 'Keine Adresse hinterlegt'}<br>
                                            <span style="font-size: 14px;">${partner.plz || ''} ${partner.stadt || partner.ort || ''}</span><br>
                                            <span style="font-size: 13px; color: #22c55e;">${partner.land || 'Deutschland'}</span>
                                        </div>
                                    </div>
                                    <div style="background: white; border-radius: 8px; padding: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                        <div style="font-size: 11px; color: #3b82f6; text-transform: uppercase; margin-bottom: 4px; font-weight: 600;">ğŸ¢ Firma</div>
                                        <div style="font-weight: 600; color: #1a202c; font-size: 14px;">${partner.firma || '-'}</div>
                                    </div>
                                    <div style="background: white; border-radius: 8px; padding: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                        <div style="font-size: 11px; color: #3b82f6; text-transform: uppercase; margin-bottom: 4px; font-weight: 600;">ğŸŒ Land</div>
                                        <div style="font-weight: 600; color: #1a202c; font-size: 14px;">${partner.land || 'Deutschland'}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- GeschÃ¤ftsdaten -->
                    <div style="margin-bottom: 24px;">
                        <h4 style="font-size: 16px; font-weight: 600; color: #1a202c; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-briefcase" style="color: #8b5cf6;"></i> GeschÃ¤ftsdaten
                        </h4>
                        <div style="background: #f7fafc; border-radius: 10px; padding: 16px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
                                <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                                    <div style="font-size: 11px; color: #718096; text-transform: uppercase; margin-bottom: 4px;">Status</div>
                                    <div style="font-weight: 700; color: ${partner.status === 'aktiv' ? '#48bb78' : partner.status === 'neu' ? '#ed8936' : '#718096'}; text-transform: uppercase;">${partner.status || 'N/A'}</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                                    <div style="font-size: 11px; color: #718096; text-transform: uppercase; margin-bottom: 4px;">Modell</div>
                                    <div style="font-weight: 600; color: #1a202c;">${partner.modell || '-'}</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                                    <div style="font-size: 11px; color: #718096; text-transform: uppercase; margin-bottom: 4px;">Tarif</div>
                                    <div style="font-weight: 600; color: #8b5cf6;">${partner.tarif || 'Standard'}</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                                    <div style="font-size: 11px; color: #718096; text-transform: uppercase; margin-bottom: 4px;">Referral Code</div>
                                    <div style="font-weight: 600; color: #ec4899; font-family: monospace;">${partner.referral_code || '-'}</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: white; border-radius: 8px; grid-column: span 2;">
                                    <div style="font-size: 11px; color: #718096; text-transform: uppercase; margin-bottom: 4px;">Registriert am</div>
                                    <div style="font-weight: 600; color: #1a202c;">${partner.registriert_am ? new Date(partner.registriert_am).toLocaleDateString('de-DE', {weekday: 'long', day: '2-digit', month: 'long', year: 'numeric'}) : '-'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Affiliate-Daten (nur wenn Affiliate) -->
                    ${partner.ist_affiliate || partner.modell === 'affiliate' ? `
                    <div style="margin-bottom: 24px;">
                        <h4 style="font-size: 16px; font-weight: 600; color: #1a202c; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-link" style="color: #ec4899;"></i> Affiliate-Daten
                        </h4>
                        <div style="background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); border-radius: 10px; padding: 16px; border: 2px solid #f472b6;">
                            <div style="display: grid; gap: 12px;">
                                ${partner.referral_code ? `
                                <div>
                                    <div style="font-size: 11px; color: #be185d; text-transform: uppercase; margin-bottom: 2px;">Referral Code</div>
                                    <div style="font-weight: 700; color: #9d174d; font-family: monospace; font-size: 16px;">${partner.referral_code}</div>
                                </div>
                                ` : ''}
                                ${partner.standard_link ? `
                                <div>
                                    <div style="font-size: 11px; color: #be185d; text-transform: uppercase; margin-bottom: 2px;">Standard Link</div>
                                    <div style="font-size: 12px; color: #9d174d; word-break: break-all;"><a href="${partner.standard_link}" target="_blank" style="color: #3b82f6;">${partner.standard_link}</a></div>
                                </div>
                                ` : ''}
                                ${partner.parent_name || partner.parent_email ? `
                                <div>
                                    <div style="font-size: 11px; color: #be185d; text-transform: uppercase; margin-bottom: 2px;">Geworbener von (Parent)</div>
                                    <div style="font-weight: 600; color: #9d174d;">${partner.parent_name || ''} ${partner.parent_email ? `(${partner.parent_email})` : ''}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Social Media -->
                    ${partner.website || partner.facebook || partner.instagram || partner.youtube || partner.tiktok ? `
                    <div style="margin-bottom: 24px;">
                        <h4 style="font-size: 16px; font-weight: 600; color: #1a202c; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-globe" style="color: #6366f1;"></i> Online-PrÃ¤senz
                        </h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            ${partner.website ? `<a href="${partner.website}" target="_blank" style="display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: white; border: 2px solid #e2e8f0; border-radius: 8px; text-decoration: none; color: #1a202c; font-size: 13px; font-weight: 600;"><i class="fas fa-globe" style="color: #3b82f6;"></i> Website</a>` : ''}
                            ${partner.facebook ? `<a href="${partner.facebook}" target="_blank" style="display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: #1877f2; border-radius: 8px; text-decoration: none; color: white; font-size: 13px; font-weight: 600;"><i class="fab fa-facebook"></i> Facebook</a>` : ''}
                            ${partner.instagram ? `<a href="${partner.instagram}" target="_blank" style="display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); border-radius: 8px; text-decoration: none; color: white; font-size: 13px; font-weight: 600;"><i class="fab fa-instagram"></i> Instagram</a>` : ''}
                            ${partner.youtube ? `<a href="${partner.youtube}" target="_blank" style="display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: #ff0000; border-radius: 8px; text-decoration: none; color: white; font-size: 13px; font-weight: 600;"><i class="fab fa-youtube"></i> YouTube</a>` : ''}
                            ${partner.tiktok ? `<a href="${partner.tiktok}" target="_blank" style="display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: #000; border-radius: 8px; text-decoration: none; color: white; font-size: 13px; font-weight: 600;"><i class="fab fa-tiktok"></i> TikTok</a>` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Bankdaten -->
                    <div style="margin-bottom: 24px;">
                        <h4 style="font-size: 16px; font-weight: 600; color: #1a202c; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-university" style="color: #0d9488;"></i> Bankdaten
                        </h4>
                        ${partner.iban || partner.kontoinhaber ? `
                        <div style="background: linear-gradient(135deg, #e6fffa 0%, #b2f5ea 100%); border-radius: 10px; padding: 16px; border: 2px solid #81e6d9;">
                            <div style="display: grid; gap: 12px;">
                                <div>
                                    <div style="font-size: 11px; color: #0f766e; text-transform: uppercase; margin-bottom: 2px;">IBAN</div>
                                    <div style="font-weight: 700; color: #134e4a; font-family: monospace; font-size: 14px;">${partner.iban || 'Nicht hinterlegt'}</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: #0f766e; text-transform: uppercase; margin-bottom: 2px;">Kontoinhaber</div>
                                    <div style="font-weight: 600; color: #134e4a;">${partner.kontoinhaber || 'Nicht hinterlegt'}</div>
                                </div>
                            </div>
                            <div style="margin-top: 12px; padding: 8px 12px; background: #0d9488; color: white; border-radius: 6px; text-align: center; font-size: 12px; font-weight: 600;">
                                <i class="fas fa-check-circle"></i> Bankdaten vollstÃ¤ndig
                            </div>
                        </div>
                        ` : `
                        <div style="background: #fef2f2; border: 2px dashed #fca5a5; border-radius: 10px; padding: 20px; text-align: center;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 32px; color: #ef4444; margin-bottom: 8px;"></i>
                            <div style="font-weight: 600; color: #991b1b;">Keine Bankdaten hinterlegt</div>
                            <div style="font-size: 12px; color: #b91c1c; margin-top: 4px;">Partner muss IBAN in Einstellungen eingeben</div>
                        </div>
                        `}
                    </div>
                    
                    <!-- System-Flags -->
                    <div style="margin-bottom: 24px;">
                        <h4 style="font-size: 16px; font-weight: 600; color: #1a202c; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-cog" style="color: #64748b;"></i> System-Status
                        </h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <span style="padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${partner.aktiv ? '#dcfce7' : '#fee2e2'}; color: ${partner.aktiv ? '#166534' : '#991b1b'};">
                                ${partner.aktiv ? 'âœ… Aktiv' : 'âŒ Inaktiv'}
                            </span>
                            <span style="padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${partner.onboarding_abgeschlossen || partner.onboarding_completed ? '#dcfce7' : '#fef3c7'}; color: ${partner.onboarding_abgeschlossen || partner.onboarding_completed ? '#166534' : '#92400e'};">
                                ${partner.onboarding_abgeschlossen || partner.onboarding_completed ? 'âœ… Onboarding abgeschlossen' : 'â³ Onboarding lÃ¤uft'}
                            </span>
                            ${partner.ist_affiliate ? `<span style="padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: #fce7f3; color: #9d174d;">ğŸ”— Affiliate</span>` : ''}
                            ${partner.passwort_muss_geaendert_werden ? `<span style="padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: #fee2e2; color: #991b1b;">ğŸ” Passwort-Ã„nderung</span>` : ''}
                        </div>
                    </div>

                    <!-- ğŸ“„ DOKUMENTE SEKTION (NEU!) -->
                    <div style="margin-bottom: 24px;">
                        <h4 style="font-size: 16px; font-weight: 600; color: #1a202c; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-file-alt" style="color: #3b82f6;"></i>
                            Dokumente (${dokumente.length})
                        </h4>
                        ${dokumente.length > 0 ? `
                            <div style="background: linear-gradient(135deg, #3b82f610 0%, #60a5fa20 100%); border-radius: 12px; padding: 20px; border: 2px solid #e2e8f0;">
                                ${dokumente.map(dok => {
                                    const statusIcons = {
                                        'hochgeladen': 'âœ…',
                                        'geprueft': 'ğŸŸ¢',
                                        'abgelehnt': 'âŒ',
                                        'ausstehend': 'â³'
                                    };
                                    const statusColors = {
                                        'hochgeladen': '#48bb78',
                                        'geprueft': '#38a169',
                                        'abgelehnt': '#f56565',
                                        'ausstehend': '#ed8936'
                                    };
                                    const statusTexte = {
                                        'hochgeladen': 'Hochgeladen',
                                        'geprueft': 'GeprÃ¼ft & Genehmigt',
                                        'abgelehnt': 'Abgelehnt',
                                        'ausstehend': 'Ausstehend'
                                    };
                                    const typIcons = {
                                        'ausweis': 'ğŸªª',
                                        'gewerbeschein': 'ğŸ“‹',
                                        'vertrag': 'ğŸ“',
                                        'unterschrift': 'âœï¸',
                                        'sonstiges': 'ğŸ“„'
                                    };
                                    
                                    return `
                                        <div style="background: white; border-radius: 10px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid #e2e8f0;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px;">
                                                <!-- Dokument Info -->
                                                <div style="flex: 1;">
                                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                                        <span style="font-size: 24px;">${typIcons[dok.dokument_typ] || 'ğŸ“„'}</span>
                                                        <div>
                                                            <div style="font-weight: 600; color: #1a202c; font-size: 14px;">${dok.dokument_typ?.toUpperCase() || 'Dokument'}</div>
                                                            <div style="font-size: 11px; color: #718096; margin-top: 2px;">
                                                                ${dok.dateiname || 'Unbenannt'} â€¢ ${dok.hochgeladen_am ? new Date(dok.hochgeladen_am).toLocaleDateString('de-DE') : 'N/A'}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Status Badge -->
                                                <div style="text-align: center;">
                                                    <div style="background: ${statusColors[dok.status] || '#cbd5e0'}; color: white; border-radius: 8px; padding: 6px 12px; font-size: 11px; font-weight: 600; white-space: nowrap;">
                                                        ${statusIcons[dok.status] || 'â³'} ${statusTexte[dok.status] || dok.status}
                                                    </div>
                                                </div>
                                                
                                                <!-- Aktionen -->
                                                <div style="display: flex; gap: 8px;">
                                                    ${dok.cloudinary_url ? `
                                                        <a href="${dok.cloudinary_url}" target="_blank" onclick="event.stopPropagation();" style="padding: 8px 16px; background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); color: white; border-radius: 8px; text-decoration: none; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                                            <i class="fas fa-eye"></i> Ansehen
                                                        </a>
                                                    ` : `
                                                        <span style="padding: 8px 16px; background: #e2e8f0; color: #718096; border-radius: 8px; font-size: 12px; font-weight: 600;">
                                                            Keine Datei
                                                        </span>
                                                    `}
                                                </div>
                                            </div>
                                            ${dok.admin_notiz ? `
                                                <div style="margin-top: 12px; padding: 12px; background: #fef5e7; border-left: 4px solid #f39c12; border-radius: 6px;">
                                                    <div style="font-size: 11px; color: #d68910; font-weight: 600; margin-bottom: 4px;">ğŸ“ Admin-Notiz:</div>
                                                    <div style="font-size: 12px; color: #7d6608;">${dok.admin_notiz}</div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : `
                            <div style="background: #fef5e7; border: 2px dashed #f39c12; border-radius: 12px; padding: 32px; text-align: center;">
                                <i class="fas fa-folder-open" style="font-size: 48px; color: #d68910; margin-bottom: 12px;"></i>
                                <div style="font-size: 14px; color: #7d6608; font-weight: 600;">Noch keine Dokumente hochgeladen</div>
                                <div style="font-size: 12px; color: #a88734; margin-top: 4px;">Partner muss noch Dokumente einreichen</div>
                            </div>
                        `}
                    </div>

                    <!-- ğŸ“ VERTRÃ„GE SEKTION (ERWEITERT!) -->
                    ${vertraege.length > 0 ? `
                        <div style="margin-bottom: 24px;">
                            <h4 style="font-size: 16px; font-weight: 600; color: #1a202c; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-file-contract" style="color: #48bb78;"></i>
                                Alle VertrÃ¤ge (${vertraege.length})
                            </h4>
                            <div style="background: linear-gradient(135deg, #48bb7810 0%, #38a16920 100%); border-radius: 12px; padding: 20px; border: 2px solid #e2e8f0; max-height: 400px; overflow-y: auto;">
                                ${vertraege.map((v, idx) => `
                                    <div style="background: white; border-radius: 10px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid #e2e8f0; cursor: pointer; transition: all 0.2s;" 
                                         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.12)';" 
                                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.06)';"
                                         onclick="showVertragDetails('${v.id}')">
                                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 16px;">
                                            <!-- Vertrag Info -->
                                            <div style="flex: 1;">
                                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                                    <span style="font-size: 20px;">ğŸ“‘</span>
                                                    <div>
                                                        <div style="font-weight: 700; color: #1a202c; font-size: 15px;">${v.kategorie || 'Vertrag'} ${v.anbieter ? `â€¢ ${v.anbieter}` : ''}</div>
                                                        <div style="font-size: 12px; color: #718096; margin-top: 2px;">
                                                            ${v.tarif_name || 'N/A'} ${v.vertragsnummer ? `â€¢ Nr: ${v.vertragsnummer}` : ''}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Details Grid -->
                                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0;">
                                                    <div>
                                                        <div style="font-size: 10px; color: #718096; text-transform: uppercase; letter-spacing: 0.5px;">Kunde</div>
                                                        <div style="font-size: 12px; color: #1a202c; font-weight: 600; margin-top: 2px;">${v.kunde_name || 'N/A'}</div>
                                                    </div>
                                                    <div>
                                                        <div style="font-size: 10px; color: #718096; text-transform: uppercase; letter-spacing: 0.5px;">Datum</div>
                                                        <div style="font-size: 12px; color: #1a202c; font-weight: 600; margin-top: 2px;">
                                                            ${v.abschlussdatum ? new Date(v.abschlussdatum).toLocaleDateString('de-DE') : 'N/A'}
                                                        </div>
                                                    </div>
                                                    ${v.handy_modell ? `
                                                        <div>
                                                            <div style="font-size: 10px; color: #718096; text-transform: uppercase; letter-spacing: 0.5px;">ğŸ“± Handy</div>
                                                            <div style="font-size: 12px; color: #1a202c; font-weight: 600; margin-top: 2px;">${v.handy_modell}</div>
                                                        </div>
                                                    ` : ''}
                                                    ${v.portierung_von ? `
                                                        <div>
                                                            <div style="font-size: 10px; color: #718096; text-transform: uppercase; letter-spacing: 0.5px;">ğŸ”„ Portierung</div>
                                                            <div style="font-size: 12px; color: #1a202c; font-weight: 600; margin-top: 2px;">${v.portierung_von}</div>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                            
                                            <!-- Provision & Status -->
                                            <div style="text-align: right; min-width: 120px;">
                                                <div style="font-size: 20px; font-weight: 700; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 4px;">
                                                    ${(v.provision || 0).toFixed(2)}â‚¬
                                                </div>
                                                <div style="display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; 
                                                    ${v.status === 'aktiviert' ? 'background: #48bb78; color: white;' : 
                                                      v.status === 'neu' ? 'background: #4299e1; color: white;' : 
                                                      v.status === 'abgelehnt' ? 'background: #f56565; color: white;' : 
                                                      'background: #ed8936; color: white;'}">
                                                    ${v.status || 'offen'}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : `
                        <div style="margin-bottom: 24px;">
                            <h4 style="font-size: 16px; font-weight: 600; color: #1a202c; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-file-contract" style="color: #cbd5e0;"></i>
                                VertrÃ¤ge (0)
                            </h4>
                            <div style="background: #f7fafc; border: 2px dashed #cbd5e0; border-radius: 12px; padding: 32px; text-align: center;">
                                <i class="fas fa-file-invoice" style="font-size: 48px; color: #cbd5e0; margin-bottom: 12px;"></i>
                                <div style="font-size: 14px; color: #718096; font-weight: 600;">Noch keine VertrÃ¤ge vorhanden</div>
                                <div style="font-size: 12px; color: #a0aec0; margin-top: 4px;">Partner hat noch keine VertrÃ¤ge abgeschlossen</div>
                            </div>
                        </div>
                    `}

                    <!-- Aktionen -->
                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button onclick="alert('E-Mail-Funktion wird noch implementiert!')" style="flex: 1; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-envelope"></i> E-Mail senden
                        </button>
                        <button onclick="alert('Bearbeiten-Funktion wird noch implementiert!')" style="flex: 1; padding: 12px; background: white; color: var(--primary); border: 2px solid var(--primary); border-radius: 10px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-edit"></i> Bearbeiten
                        </button>
                    </div>
                `;

            } catch (error) {
                console.error('âŒ Fehler beim Laden der Partner-Details:', error);
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #e53e3e;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <p style="margin: 0; font-size: 18px; font-weight: 600;">Fehler beim Laden</p>
                        <p style="margin: 8px 0 0 0; font-size: 14px;">${error.message}</p>
                    </div>
                `;
            }
        }

        // âŒ ALTE FUNKTION ENTFERNT - das neue TODO-System verwendet die Funktion bei Zeile 5000!
        // (Die alte 'tables/projekte' Tabelle wird nicht mehr verwendet)

        // Projekt aktualisieren
        document.getElementById('projektForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('proj_email').value;
            const fortschritt = parseInt(document.getElementById('proj_fortschritt').value);
            const status = document.getElementById('proj_status').value;
            
            try {
                // Projekt finden
                const response = await fetch(`tables/projekte?search=${encodeURIComponent(email)}&limit=1`);
                const result = await response.json();
                
                if (result.data && result.data.length > 0) {
                    const projektId = result.data[0].id;
                    
                    await fetch(`tables/projekte/${projektId}`, {
                        method: 'PATCH',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            fortschritt_prozent: fortschritt,
                            status: status
                        })
                    });
                    
                    document.getElementById('projektSuccess').style.display = 'block';
                    setTimeout(() => {
                        document.getElementById('projektSuccess').style.display = 'none';
                    }, 3000);
                    
                    loadProjekte();
                }
            } catch (error) {
                console.error('Fehler:', error);
            }
        });

        // Dokumente laden
        async function loadDokumente() {
            try {
                const response = await fetch('tables/dokumente?limit=1000');
                const result = await response.json();
                
                // Stats berechnen
                const hochgeladen = result.data.filter(d => d.status === 'hochgeladen').length;
                const geprueft = result.data.filter(d => d.status === 'geprueft').length;
                const abgelehnt = result.data.filter(d => d.status === 'abgelehnt').length;
                
                document.getElementById('stat-dok-hochgeladen').textContent = hochgeladen;
                document.getElementById('stat-dok-geprueft').textContent = geprueft;
                document.getElementById('stat-dok-abgelehnt').textContent = abgelehnt;
                document.getElementById('stat-dok-gesamt').textContent = result.data.length;
                
                const tbody = document.getElementById('dokumenteTable');
                if (result.data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 30px; color: var(--text-light);">
                                <i class="fas fa-folder-open"></i><br><br>
                                Keine Dokumente vorhanden
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = result.data
                    .sort((a, b) => (b.hochgeladen_am || 0) - (a.hochgeladen_am || 0))
                    .map(dok => {
                        const statusColors = {
                            'hochgeladen': 'warning',
                            'geprueft': 'success',
                            'abgelehnt': 'danger'
                        };
                        const statusTexte = {
                            'hochgeladen': 'ğŸ“¤ Hochgeladen',
                            'geprueft': 'âœ… GeprÃ¼ft',
                            'abgelehnt': 'âŒ Abgelehnt'
                        };
                        const typIcons = {
                            'ausweis': '<i class="fas fa-id-card"></i>',
                            'gewerbeschein': '<i class="fas fa-certificate"></i>',
                            'vertrag': '<i class="fas fa-file-contract"></i>',
                            'sonstiges': '<i class="fas fa-file"></i>'
                        };
                        
                        return `
                            <tr style="cursor: pointer;" onclick="showDokumentDetails('${dok.id}')">
                                <td>
                                    <span class="badge badge-${statusColors[dok.status]}">
                                        ${statusTexte[dok.status]}
                                    </span>
                                </td>
                                <td>${new Date(dok.hochgeladen_am).toLocaleDateString('de-DE', {day: '2-digit', month: '2-digit', year: 'numeric'})}<br>
                                    <small style="color: var(--text-light);">${new Date(dok.hochgeladen_am).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'})}</small>
                                </td>
                                <td><strong>${dok.partner_id || '-'}</strong></td>
                                <td>${typIcons[dok.dokument_typ]} <strong>${dok.dokument_typ}</strong></td>
                                <td>${dok.dateiname || '-'}</td>
                                <td>
                                    <a href="${dok.cloudinary_url}" target="_blank" onclick="event.stopPropagation();" style="color: var(--primary); text-decoration: none;">
                                        <i class="fas fa-external-link-alt"></i> Ansehen
                                    </a>
                                </td>
                                <td>
                                    ${dok.status === 'hochgeladen' ? `
                                        <button class="btn btn-success" onclick="event.stopPropagation(); dokumentGenehmigen('${dok.id}');" style="padding: 5px 10px; font-size: 12px; margin-right: 5px;">
                                            <i class="fas fa-check"></i> Genehmigen
                                        </button>
                                        <button class="btn btn-danger" onclick="event.stopPropagation(); dokumentAblehnen('${dok.id}');" style="padding: 5px 10px; font-size: 12px;">
                                            <i class="fas fa-times"></i> Ablehnen
                                        </button>
                                    ` : `
                                        <span style="color: var(--text-light); font-size: 12px;">
                                            ${dok.admin_notiz || '-'}
                                        </span>
                                    `}
                                </td>
                            </tr>
                        `;
                    }).join('');
            } catch (error) {
                console.error('Fehler:', error);
                const tbody = document.getElementById('dokumenteTable');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px; color: var(--danger);">
                            <i class="fas fa-exclamation-triangle"></i><br><br>
                            Fehler beim Laden der Dokumente
                        </td>
                    </tr>
                `;
            }
        }

        // Dokument Details anzeigen
        async function showDokumentDetails(id) {
            try {
                const response = await fetch(`tables/dokumente/${id}`);
                const dok = await response.json();
                
                const details = `
ğŸ—‚ï¸ DOKUMENT-DETAILS

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Partner: ${dok.partner_id}
Typ: ${dok.dokument_typ}
Dateiname: ${dok.dateiname}
Status: ${dok.status}

Hochgeladen: ${new Date(dok.hochgeladen_am).toLocaleString('de-DE')}

Cloudinary URL: ${dok.cloudinary_url}
Cloudinary ID: ${dok.cloudinary_id}

Admin-Notiz: ${dok.admin_notiz || '-'}
                `;
                
                alert(details);
                
                if (confirm('Dokument im Browser Ã¶ffnen?')) {
                    window.open(dok.cloudinary_url, '_blank');
                }
            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler beim Laden der Details');
            }
        }

        // Dokument genehmigen
        async function dokumentGenehmigen(id) {
            const notiz = prompt('Notiz zur Genehmigung (optional):');
            if (notiz === null) return;
            
            try {
                await fetch(`tables/dokumente/${id}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        status: 'geprueft',
                        admin_notiz: notiz || 'Genehmigt durch Admin'
                    })
                });
                
                alert('âœ… Dokument wurde genehmigt!');
                loadDokumente();
            } catch (error) {
                console.error('Fehler:', error);
                alert('âŒ Fehler beim Genehmigen!');
            }
        }

        // Dokument ablehnen
        async function dokumentAblehnen(id) {
            const grund = prompt('Grund fÃ¼r Ablehnung:');
            if (!grund) {
                alert('Bitte einen Grund angeben!');
                return;
            }
            
            try {
                await fetch(`tables/dokumente/${id}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        status: 'abgelehnt',
                        admin_notiz: grund
                    })
                });
                
                alert('âŒ Dokument wurde abgelehnt!');
                loadDokumente();
            } catch (error) {
                console.error('Fehler:', error);
                alert('âŒ Fehler beim Ablehnen!');
            }
        }

        // âœ… AKADEMIE - KOMPLETT NEU UND EINFACH
        var allAkademieData = [];
        var filteredAkademieData = [];
        var akademieCurrentPage = 1;
        var akademieItemsPerPage = 10;
        
        // ğŸ“Š CHART INSTANCES SPEICHERN FÃœR UPDATES
        var akademieChartInstances = {};
        
        // ğŸ“Š AKADEMIE CHARTS RENDERN
        function renderAkademieCharts(partnerData, fortschrittData, zertifikateData) {
            console.log('ğŸ“Š Rendering Akademie Charts...');
            
            // Module-Definition
            var module = [
                { id: 'grundlagen', name: 'Grundlagen Mobilfunk', icon: 'ğŸ“±', color: '#3b82f6' },
                { id: 'verkaufspsychologie', name: 'Verkaufspsychologie', icon: 'ğŸ§ ', color: '#8b5cf6' },
                { id: 'einwandbehandlung', name: 'Einwandbehandlung', icon: 'ğŸ›¡ï¸', color: '#ec4899' },
                { id: 'abschlusstechniken', name: 'Abschlusstechniken', icon: 'ğŸ¯', color: '#f59e0b' },
                { id: 'produktwissen', name: 'Produktwissen', icon: 'ğŸ“š', color: '#10b981' },
                { id: 'akquise', name: 'Akquise', icon: 'ğŸ£', color: '#3b82f6' },
                { id: 'mindset', name: 'Mindset', icon: 'ğŸ’ª', color: '#ef4444' },
                { id: 'rechtliches', name: 'Rechtliche Grundlagen', icon: 'âš–ï¸', color: '#6366f1' }
            ];
            
            // === CHART 1: MODUL-ABSCHLÃœSSE (Balkendiagramm) ===
            var modulAbschluesse = module.map(function(m) {
                return fortschrittData.filter(function(f) {
                    return f.modul_id === m.id && (f.abgeschlossen === true || f.fortschritt_prozent >= 100);
                }).length;
            });
            
            var ctx1 = document.getElementById('chart-modul-abschluesse');
            if (ctx1) {
                if (akademieChartInstances['modul']) akademieChartInstances['modul'].destroy();
                akademieChartInstances['modul'] = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: module.map(function(m) { return m.icon + ' ' + m.name.substring(0, 12); }),
                        datasets: [{
                            label: 'AbschlÃ¼sse',
                            data: modulAbschluesse,
                            backgroundColor: module.map(function(m) { return m.color + 'CC'; }),
                            borderColor: module.map(function(m) { return m.color; }),
                            borderWidth: 2,
                            borderRadius: 8,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#1e293b',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                padding: 12,
                                borderRadius: 8,
                                callbacks: {
                                    title: function(items) {
                                        var idx = items[0].dataIndex;
                                        return module[idx].icon + ' ' + module[idx].name;
                                    },
                                    label: function(item) {
                                        return item.raw + ' Partner haben abgeschlossen';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: { 
                                    font: { size: 10 },
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: { color: '#f1f5f9' },
                                ticks: { 
                                    stepSize: 1,
                                    font: { size: 11 }
                                }
                            }
                        }
                    }
                });
            }
            
            // === CHART 2: ZERTIFIKATE-VERTEILUNG (Donut) ===
            var zertVerteilung = {};
            zertifikateData.forEach(function(z) {
                var modul = z.modul_name || z.modul_id || 'Unbekannt';
                zertVerteilung[modul] = (zertVerteilung[modul] || 0) + 1;
            });
            
            var zertLabels = Object.keys(zertVerteilung);
            var zertValues = Object.values(zertVerteilung);
            var zertColors = ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#ef4444', '#6366f1'];
            
            // Falls keine Zertifikate, Placeholder
            if (zertLabels.length === 0) {
                zertLabels = ['Noch keine Zertifikate'];
                zertValues = [1];
                zertColors = ['#e2e8f0'];
            }
            
            var ctx2 = document.getElementById('chart-zertifikate-verteilung');
            if (ctx2) {
                if (akademieChartInstances['zert']) akademieChartInstances['zert'].destroy();
                akademieChartInstances['zert'] = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: zertLabels,
                        datasets: [{
                            data: zertValues,
                            backgroundColor: zertColors.slice(0, zertLabels.length),
                            borderColor: '#ffffff',
                            borderWidth: 3,
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '65%',
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    padding: 15,
                                    font: { size: 11 }
                                }
                            },
                            tooltip: {
                                backgroundColor: '#1e293b',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                padding: 12,
                                borderRadius: 8,
                                callbacks: {
                                    label: function(item) {
                                        var total = item.dataset.data.reduce(function(a, b) { return a + b; }, 0);
                                        var percent = Math.round((item.raw / total) * 100);
                                        return item.label + ': ' + item.raw + ' (' + percent + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // === CHART 3: PARTNER-AKTIVITÃ„T (Fortschritts-Verteilung) ===
            var aktivitaetBereiche = {
                '0%': 0,
                '1-25%': 0,
                '26-50%': 0,
                '51-75%': 0,
                '76-99%': 0,
                '100%': 0
            };
            
            partnerData.forEach(function(d) {
                var f = d.gesamtFortschritt;
                if (f === 0) aktivitaetBereiche['0%']++;
                else if (f <= 25) aktivitaetBereiche['1-25%']++;
                else if (f <= 50) aktivitaetBereiche['26-50%']++;
                else if (f <= 75) aktivitaetBereiche['51-75%']++;
                else if (f < 100) aktivitaetBereiche['76-99%']++;
                else aktivitaetBereiche['100%']++;
            });
            
            var ctx3 = document.getElementById('chart-partner-aktivitaet');
            if (ctx3) {
                if (akademieChartInstances['aktivitaet']) akademieChartInstances['aktivitaet'].destroy();
                akademieChartInstances['aktivitaet'] = new Chart(ctx3, {
                    type: 'bar',
                    data: {
                        labels: ['â¸ï¸ Nicht gestartet', 'ğŸš€ Beginner (1-25%)', 'ğŸ“ˆ Fortgeschritten (26-50%)', 'ğŸ’ª Erfahren (51-75%)', 'ğŸ”¥ Fast fertig (76-99%)', 'ğŸ† Abgeschlossen (100%)'],
                        datasets: [{
                            label: 'Partner',
                            data: Object.values(aktivitaetBereiche),
                            backgroundColor: [
                                '#e2e8f0', // 0%
                                '#fcd34d', // 1-25%
                                '#fb923c', // 26-50%
                                '#38bdf8', // 51-75%
                                '#a78bfa', // 76-99%
                                '#4ade80'  // 100%
                            ],
                            borderColor: [
                                '#94a3b8',
                                '#f59e0b',
                                '#ea580c',
                                '#0284c7',
                                '#7c3aed',
                                '#16a34a'
                            ],
                            borderWidth: 2,
                            borderRadius: 6,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#1e293b',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                padding: 12,
                                borderRadius: 8,
                                callbacks: {
                                    label: function(item) {
                                        var total = partnerData.length;
                                        var percent = total > 0 ? Math.round((item.raw / total) * 100) : 0;
                                        return item.raw + ' Partner (' + percent + '% aller Partner)';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                grid: { color: '#f1f5f9' },
                                ticks: { 
                                    stepSize: Math.ceil(partnerData.length / 10),
                                    font: { size: 11 }
                                }
                            },
                            y: {
                                grid: { display: false },
                                ticks: { 
                                    font: { size: 11, weight: '500' }
                                }
                            }
                        }
                    }
                });
            }
            
            console.log('âœ… Akademie Charts gerendert!');
        }

        async function loadAkademie() {
            console.log('ğŸ“ loadAkademie() START');
            var container = document.getElementById('akademie-partner-list');
            container.innerHTML = '<div style="text-align:center;padding:40px;"><i class="fas fa-spinner fa-spin"></i> Lade...</div>';
            
            try {
                // Daten laden
                var [pRes, fRes, zRes] = await Promise.all([
                    fetch('tables/partners?limit=1000'),
                    fetch('tables/akademie_progress?limit=1000'),
                    fetch('tables/zertifikate?limit=1000')
                ]);
                
                var partners = (await pRes.json()).data || [];
                var fortschritt = (await fRes.json()).data || [];
                var zertifikate = (await zRes.json()).data || [];
                
                console.log('ğŸ“Š Geladen:', partners.length, 'Partner,', fortschritt.length, 'Fortschritt,', zertifikate.length, 'Zertifikate');
                
                // Stats aktualisieren
                document.getElementById('stat_onboarding').textContent = partners.filter(function(p){return p.onboarding_completed}).length;
                document.getElementById('stat_schulung').textContent = partners.filter(function(p){return p.status==='aktiv'}).length;
                document.getElementById('stat_zertifikate').textContent = zertifikate.length;
                
                // Partner-Liste erstellen
                allAkademieData = partners.map(function(partner) {
                    var email = (partner.email || '').toLowerCase();
                    var pFort = fortschritt.filter(function(f){ return (f.partner_email||'').toLowerCase() === email; });
                    var pZert = zertifikate.filter(function(z){ return (z.partner_email||'').toLowerCase() === email; });
                    
                    var total = 0;
                    ['grundlagen','verkaufspsychologie','einwandbehandlung','abschlusstechniken','produktwissen','akquise','mindset','rechtliches'].forEach(function(m){
                        var mod = pFort.find(function(f){ return f.modul_id === m; });
                        if(mod) total += (mod.fortschritt_prozent || 0);
                    });
                    
                    return {
                        partner: partner,
                        gesamtFortschritt: Math.round(total / 8),
                        zertifikateCount: pZert.length
                    };
                });
                
                // Sortieren nach Fortschritt
                allAkademieData.sort(function(a,b){ return b.gesamtFortschritt - a.gesamtFortschritt; });
                filteredAkademieData = allAkademieData;
                akademieCurrentPage = 1;
                
                console.log('âœ… Partner verarbeitet:', allAkademieData.length);
                
                // Direkt rendern
                renderAkademiePage();
                
                // ğŸ“Š DIAGRAMME RENDERN
                renderAkademieCharts(allAkademieData, fortschritt, zertifikate);
                
                // Durchschnitts-Fortschritt berechnen
                var avgFort = allAkademieData.length > 0 ? Math.round(allAkademieData.reduce(function(sum, d){ return sum + d.gesamtFortschritt; }, 0) / allAkademieData.length) : 0;
                document.getElementById('stat_avg_fortschritt').textContent = avgFort + '%';
                
                // Zertifikate-Tabelle
                var zertTable = document.getElementById('zertifikateTable');
                if(zertTable) {
                    zertTable.innerHTML = zertifikate.map(function(z){
                        return '<tr><td>'+z.partner_email+'</td><td>'+z.modul_name+'</td><td>'+z.zertifikat_nr+'</td><td>'+(z.ausgestellt_am ? new Date(z.ausgestellt_am).toLocaleDateString('de-DE') : '-')+'</td></tr>';
                    }).join('');
                }
                
            } catch(e) {
                console.error('âŒ loadAkademie Fehler:', e);
                container.innerHTML = '<div style="color:red;padding:20px;">Fehler: '+e.message+'</div>';
            }
        }
        
        function renderAkademiePage() {
            console.log('ğŸ¨ renderAkademiePage, Daten:', filteredAkademieData.length);
            var container = document.getElementById('akademie-partner-list');
            var start = (akademieCurrentPage - 1) * akademieItemsPerPage;
            var pageData = filteredAkademieData.slice(start, start + akademieItemsPerPage);
            
            if(pageData.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:60px;color:#666;"><p>Keine Partner gefunden</p><p style="font-size:12px;">Gesamt: '+allAkademieData.length+' Partner</p></div>';
                return;
            }
            
            var html = '';
            pageData.forEach(function(data, i) {
                var p = data.partner;
                var fort = data.gesamtFortschritt;
                var color = fort >= 100 ? '#10b981' : (fort > 0 ? '#f59e0b' : '#6b7280');
                html += '<div style="background:white;border-radius:12px;border:2px solid #e2e8f0;margin-bottom:10px;overflow:hidden;">';
                html += '<div style="padding:15px;background:'+color+';color:white;display:flex;justify-content:space-between;">';
                html += '<div><strong>'+(p.vorname||'')+' '+(p.nachname||'')+'</strong><br><small>'+p.email+'</small></div>';
                html += '<div style="text-align:right;"><span style="font-size:24px;font-weight:bold;">'+fort+'%</span><br><small>ğŸ† '+data.zertifikateCount+'</small></div>';
                html += '</div></div>';
            });
            
            container.innerHTML = html;
            
            // Pagination
            var totalPages = Math.ceil(filteredAkademieData.length / akademieItemsPerPage) || 1;
            document.getElementById('akademie-page-info').textContent = 'Seite '+akademieCurrentPage+' von '+totalPages+' ('+filteredAkademieData.length+' Partner)';
        }

        // âœ… NEUE Partner-Akkordeon Rendering-Funktion 
        function renderPartnerFortschritt(partners, fortschritt, zertifikate) {
            const container = document.getElementById('akademie-partner-list');
            
            console.log('ğŸ“Š renderPartnerFortschritt aufgerufen:', {
                partners: partners?.length || 0,
                fortschritt: fortschritt?.length || 0,
                zertifikate: zertifikate?.length || 0
            });
            
            // âœ… 8 MODULE - wie im Partner-Dashboard
            const module = {
                'grundlagen': { name: 'Grundlagen Mobilfunk', icon: 'ğŸ“±', lektionen: 8 },
                'verkaufspsychologie': { name: 'Verkaufspsychologie', icon: 'ğŸ§ ', lektionen: 8 },
                'einwandbehandlung': { name: 'Einwandbehandlung', icon: 'ğŸ›¡ï¸', lektionen: 8 },
                'abschlusstechniken': { name: 'Abschlusstechniken', icon: 'ğŸ¯', lektionen: 8 },
                'produktwissen': { name: 'Produktwissen', icon: 'ğŸ“¦', lektionen: 8 },
                'akquise': { name: 'Kundenakquise', icon: 'ğŸ”', lektionen: 8 },
                'mindset': { name: 'Erfolgs-Mindset', icon: 'ğŸ§ ', lektionen: 8 },
                'rechtliches': { name: 'Rechtliche Grundlagen', icon: 'âš–ï¸', lektionen: 8 }
            };
            const moduleCount = Object.keys(module).length; // 8

            // âœ… Finde alle Partner die Fortschritt haben
            const partnerMitFortschritt = new Set();
            (fortschritt || []).forEach(f => {
                if (f.partner_email) partnerMitFortschritt.add(f.partner_email.toLowerCase());
            });
            
            console.log('ğŸ“§ Partner mit Fortschritt:', partnerMitFortschritt.size);

            // âœ… Gruppiere Partner mit Fortschritt
            const partnerData = partners.map(partner => {
                const email = partner.email?.toLowerCase() || '';
                
                // Fortschritt fÃ¼r diesen Partner
                const partnerFortschritt = (fortschritt || []).filter(f => 
                    f.partner_email && f.partner_email.toLowerCase() === email
                );
                const partnerZertifikate = (zertifikate || []).filter(z => 
                    z.partner_email && z.partner_email.toLowerCase() === email
                );
                
                // Fortschritt pro Modul
                const modulFortschritt = {};
                let totalProzent = 0;
                
                Object.keys(module).forEach(modKey => {
                    const modulProgress = partnerFortschritt.find(f => f.modul_id === modKey);
                    const prozent = modulProgress ? (modulProgress.fortschritt_prozent || 0) : 0;
                    const abgeschlossen = modulProgress && (modulProgress.abgeschlossen === true || prozent >= 100);
                    
                    const hatZertifikat = partnerZertifikate.some(z => 
                        z.modul_id === modKey || (z.modul_name && z.modul_name.toLowerCase().includes(modKey))
                    );
                    
                    modulFortschritt[modKey] = {
                        lektionen: abgeschlossen ? module[modKey].lektionen : Math.floor(prozent / 100 * module[modKey].lektionen),
                        total: module[modKey].lektionen,
                        prozent: prozent,
                        zertifikat: hatZertifikat,
                        abgeschlossen: abgeschlossen
                    };
                    
                    totalProzent += prozent;
                });

                const gesamtFortschritt = Math.round(totalProzent / moduleCount);
                const hatAktivitaet = partnerFortschritt.length > 0 || partnerZertifikate.length > 0;

                return {
                    partner,
                    modulFortschritt,
                    gesamtFortschritt,
                    zertifikateCount: partnerZertifikate.length,
                    hatAktivitaet
                };
            })
            .sort((a, b) => b.gesamtFortschritt - a.gesamtFortschritt); // ALLE Partner zeigen, sortiert nach Fortschritt

            console.log('ğŸ“Š Alle Partner fÃ¼r Anzeige:', partnerData.length);
            console.log('ğŸ“Š Davon mit Fortschritt > 0:', partnerData.filter(p => p.gesamtFortschritt > 0).length);

            // âœ… Speichere fÃ¼r Filter
            allAkademieData = partnerData;
            filteredAkademieData = partnerData;
            
            console.log('ğŸ“Š filteredAkademieData LÃ¤nge:', filteredAkademieData.length);
            
            // âœ… Rendere erste Seite
            renderAkademiePage();
        }

        function filterAkademieByPartner() {
            const statusFilter = document.getElementById('akademie-filter-status')?.value || '';
            
            filteredAkademieData = allAkademieData.filter(data => {
                const fortschritt = data.gesamtFortschritt;
                if (statusFilter === 'fertig' && fortschritt < 100) return false;
                if (statusFilter === 'fortschritt' && (fortschritt === 0 || fortschritt >= 100)) return false;
                if (statusFilter === 'offen' && fortschritt > 0) return false;
                return true;
            });
            
            akademieCurrentPage = 1;
            renderAkademiePage();
        }

        function akademiePrevPage() {
            if (akademieCurrentPage > 1) {
                akademieCurrentPage--;
                renderAkademiePage();
            }
        }

        function akademieNextPage() {
            const totalPages = Math.ceil(filteredAkademieData.length / akademieItemsPerPage);
            if (akademieCurrentPage < totalPages) {
                akademieCurrentPage++;
                renderAkademiePage();
            }
        }

        function resetAkademieFilter() {
            document.getElementById('akademie-filter-status').value = '';
            filterAkademieByPartner();
        }

        // âœ… MLM PARTNER-PROGRAMM LADEN
        async function loadMLM() {
            try {
                console.log('ğŸ¤ Lade Partner-Programm...');
                
                // Partner mit Referral-Codes laden
                const partnerRes = await fetch('tables/partners?limit=1000');
                const partners = (await partnerRes.json()).data || [];
                
                // VertrÃ¤ge laden
                const vertraegeRes = await fetch('tables/vertragsabschluesse?limit=5000');
                const vertraege = (await vertraegeRes.json()).data || [];
                
                // Partner mit Referrals finden
                const mlmData = [];
                partners.forEach(werber => {
                    const geworbene = partners.filter(p => p.geworben_von && p.geworben_von.toLowerCase() === werber.email.toLowerCase());
                    geworbene.forEach(geworben => {
                        const vertraegeCount = vertraege.filter(v => v.partner_email && v.partner_email.toLowerCase() === geworben.email.toLowerCase()).length;
                        const provision = vertraege
                            .filter(v => v.partner_email && v.partner_email.toLowerCase() === geworben.email.toLowerCase())
                            .reduce((sum, v) => sum + (parseFloat(v.gesamt_provision) || 0), 0) * 0.05; // 5% vom Werber
                        
                        mlmData.push({
                            werber,
                            geworben,
                            vertraegeCount,
                            provision
                        });
                    });
                });
                
                // Statistiken
                document.getElementById('mlm-gesamt').textContent = partners.length;
                document.getElementById('mlm-aktiv').textContent = mlmData.length;
                const gesamtProvision = mlmData.reduce((sum, m) => sum + m.provision, 0);
                document.getElementById('mlm-provision').textContent = gesamtProvision.toLocaleString('de-DE') + 'â‚¬';
                
                // Tabelle
                const tbody = document.getElementById('mlm-table-body');
                if (mlmData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #a0aec0;">Keine geworbenen Partner gefunden</td></tr>';
                    return;
                }
                
                tbody.innerHTML = mlmData.map(m => `
                    <tr>
                        <td>${m.werber.vorname} ${m.werber.nachname}<br><small style="color: #718096;">${m.werber.email}</small></td>
                        <td>${m.geworben.vorname} ${m.geworben.nachname}<br><small style="color: #718096;">${m.geworben.email}</small></td>
                        <td>${new Date(m.geworben.registriert_am).toLocaleDateString('de-DE')}</td>
                        <td><span class="badge badge-${m.geworben.status === 'aktiv' ? 'success' : 'warning'}">${m.geworben.status || 'neu'}</span></td>
                        <td>${m.vertraegeCount}</td>
                        <td><strong>${m.provision.toLocaleString('de-DE')}â‚¬</strong></td>
                    </tr>
                `).join('');
                
                console.log('âœ… Partner-Programm geladen:', mlmData.length, 'Werbungen');
                
            } catch (error) {
                console.error('âŒ Fehler beim Laden MLM:', error);
                document.getElementById('mlm-table-body').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #f56565;">Fehler beim Laden: ' + error.message + '</td></tr>';
            }
        }

        function logout() {
            localStorage.removeItem('adminEmail');
            localStorage.removeItem('adminData');
            localStorage.removeItem('userRole');
            window.location.href = 'admin-login.html';
        }

        // Login-Check
        const adminEmail = localStorage.getItem('adminEmail');
        const userRole = localStorage.getItem('userRole');
        
        if (!adminEmail || userRole !== 'admin') {
            window.location.href = 'admin-login.html';
        }

        // ==========================================
        // BENACHRICHTIGUNGEN SYSTEM
        // ==========================================
        
        let benachrichtigungDropdownOpen = false;
        
        async function loadBenachrichtigungen() {
            try {
                const response = await fetch('tables/benachrichtigungen?limit=50&sort=-erstellt_am');
                const result = await response.json();
                
                const ungelesen = result.data.filter(b => !b.gelesen);
                const badge = document.getElementById('benachrichtigungBadge');
                
                if (ungelesen.length > 0) {
                    badge.style.display = 'flex';
                    badge.textContent = ungelesen.length > 9 ? '9+' : ungelesen.length;
                } else {
                    badge.style.display = 'none';
                }
                
                renderBenachrichtigungen(result.data);
                
            } catch (error) {
                console.error('Fehler beim Laden der Benachrichtigungen:', error);
            }
        }
        
        function renderBenachrichtigungen(benachrichtigungen) {
            const liste = document.getElementById('benachrichtigungListe');
            
            if (benachrichtigungen.length === 0) {
                liste.innerHTML = `
                    <div style="padding: 30px; text-align: center; color: #718096;">
                        <i class="fas fa-check-circle" style="font-size: 32px; color: #48bb78; margin-bottom: 10px;"></i><br>
                        Keine neuen Benachrichtigungen
                    </div>
                `;
                return;
            }
            
            liste.innerHTML = benachrichtigungen.map(ben => {
                const datum = new Date(ben.erstellt_am).toLocaleString('de-DE', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Typ-basierte Styling
                const isStornierung = ben.typ === 'stornierung';
                const isWiderruf = ben.prioritaet === 'hoch';
                
                const bgColor = ben.gelesen ? '#f7fafc' : (isStornierung ? '#fef2f2' : '#edf2f7');
                const borderColor = ben.gelesen ? '#e2e8f0' : (isStornierung ? (isWiderruf ? '#ef4444' : '#f59e0b') : '#3b82f6');
                
                return `
                    <div onclick="benachrichtigungKlick('${ben.id}', '${ben.vertrag_id || ''}')" 
                         style="padding: 15px; border-bottom: 1px solid #e2e8f0; cursor: pointer; background: ${bgColor}; border-left: 4px solid ${borderColor}; transition: all 0.2s;"
                         onmouseover="this.style.background='#f7fafc'" 
                         onmouseout="this.style.background='${bgColor}'">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
                            <strong style="font-size: 14px; color: ${isStornierung ? '#dc2626' : '#2d3748'};">${ben.titel || 'Benachrichtigung'}</strong>
                            <span style="font-size: 11px; color: #718096;">${datum}</span>
                        </div>
                        <div style="font-size: 13px; color: #4a5568; margin-bottom: 8px;">${ben.nachricht || ''}</div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 11px; color: #718096;">
                                ${ben.partner_email ? `<strong>${ben.partner_email}</strong>` : ''}
                                ${ben.kategorie ? ` â€¢ ${ben.kategorie}` : ''}
                            </div>
                            ${!isStornierung && ben.provision ? `
                                <div style="font-size: 13px; font-weight: 700; color: #48bb78;">
                                    +${parseFloat(ben.provision).toFixed(2)}â‚¬
                                </div>
                            ` : ''}
                            ${isStornierung ? `
                                <span style="background: ${isWiderruf ? '#fee2e2' : '#fef3c7'}; color: ${isWiderruf ? '#dc2626' : '#d97706'}; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                    ${isWiderruf ? 'âš ï¸ WIDERRUF' : 'ğŸš« Storniert'}
                                </span>
                            ` : ''}
                        </div>
                        ${!ben.gelesen ? '<div style="font-size: 11px; color: #3b82f6; font-weight: 600; margin-top: 5px;">â— Neu</div>' : ''}
                    </div>
                `;
            }).join('');
        }
        
        function toggleBenachrichtigungen() {
            const dropdown = document.getElementById('benachrichtigungDropdown');
            benachrichtigungDropdownOpen = !benachrichtigungDropdownOpen;
            dropdown.style.display = benachrichtigungDropdownOpen ? 'block' : 'none';
            
            if (benachrichtigungDropdownOpen) {
                loadBenachrichtigungen();
            }
        }
        
        async function benachrichtigungKlick(benachrichtigungId, vertragId) {
            try {
                // Als gelesen markieren
                await fetch(`tables/benachrichtigungen/${benachrichtigungId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ gelesen: true })
                });
                
                // Dropdown schlieÃŸen
                toggleBenachrichtigungen();
                
                // Zur VertrÃ¤ge-Seite wechseln
                window.location.href = 'admin-vertraege-uebersicht.html';
                
            } catch (error) {
                console.error('Fehler:', error);
            }
        }
        
        async function alleAlsGelesenMarkieren() {
            try {
                console.log('ğŸ“¬ Markiere alle Benachrichtigungen als gelesen...');
                
                const response = await fetch('tables/benachrichtigungen?limit=1000');
                const result = await response.json();
                
                const ungelesen = result.data.filter(b => !b.gelesen);
                
                console.log(`ğŸ“ ${ungelesen.length} ungelesene Benachrichtigungen gefunden`);
                
                // Alle ungelesenen markieren
                const promises = ungelesen.map(ben => 
                    fetch(`tables/benachrichtigungen/${ben.id}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ gelesen: true })
                    })
                );
                
                await Promise.all(promises);
                
                console.log('âœ… Alle Benachrichtigungen wurden als gelesen markiert');
                
                // Benachrichtigungen neu laden
                await loadBenachrichtigungen();
                
            } catch (error) {
                console.error('âŒ Fehler beim Markieren:', error);
                alert('Fehler beim Markieren der Benachrichtigungen');
            }
        }
        
        // Benachrichtigungen alle 30 Sekunden aktualisieren
        setInterval(loadBenachrichtigungen, 30000);
        
        // Klick auÃŸerhalb schlieÃŸt Dropdown
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('benachrichtigungDropdown');
            const button = event.target.closest('button');
            
            if (benachrichtigungDropdownOpen && !dropdown.contains(event.target) && !button) {
                toggleBenachrichtigungen();
            }
        });

        // Initial laden - DEAKTIVIERT (wird Ã¼ber switchTab geladen)
        // loadInteressenten();
        // loadPartner();
        // loadBenachrichtigungen();

        // ========================================================================
        // UMSATZ-TRACKING: LÃ¤dt VertrÃ¤ge aus vertragsabschluesse Tabelle
        // ========================================================================
        async function loadUmsatzData() {
            try {
                console.log('ğŸ“Š Lade Umsatz-Daten...');
                
                // Visuelles Feedback: Button zeigt "LÃ¤dt..."
                const buttons = document.querySelectorAll('button[onclick="loadUmsatzData()"]');
                buttons.forEach(btn => {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> LÃ¤dt...';
                });
                
                // ğŸ”„ Cache-Busting: Verhindert gecachte Daten
                const response = await fetch(`tables/vertragsabschluesse?limit=1000&sort=-erstellt_am&_t=${Date.now()}`, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    }
                });
                const result = await response.json();
                const vertraege = result.data || [];
                
                // Button zurÃ¼cksetzen
                buttons.forEach(btn => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-sync"></i> Aktualisieren';
                });
                
                console.log(`âœ… ${vertraege.length} VertrÃ¤ge geladen`);
                
                // Zeitraum-Filter anwenden
                const zeitraumFilter = document.getElementById('zeitraum-filter')?.value || 'monat';
                const kategorieFilter = document.getElementById('kategorie-filter')?.value || 'alle';
                const partnerFilter = document.getElementById('partner-filter')?.value || 'alle';
                const statusFilter = document.getElementById('status-filter')?.value || 'alle';
                
                // Zeitraum berechnen
                const now = new Date();
                const heute = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const wochenStart = new Date(heute);
                wochenStart.setDate(heute.getDate() - heute.getDay());
                const monatsStart = new Date(now.getFullYear(), now.getMonth(), 1);
                
                // Filtern
                let gefiltert = vertraege;
                
                // Nach Partner filtern
                if (partnerFilter !== 'alle') {
                    gefiltert = gefiltert.filter(v => v.partner_email === partnerFilter);
                }
                
                // Nach Kategorie filtern (Mapping beachten!)
                if (kategorieFilter !== 'alle') {
                    const kategorieMap = {
                        'mobilfunk': ['sim-only', 'handyTarif'],
                        'dsl': ['internet'],
                        'strom': ['strom']
                    };
                    const erlaubteKategorien = kategorieMap[kategorieFilter] || [kategorieFilter];
                    gefiltert = gefiltert.filter(v => erlaubteKategorien.includes(v.kategorie));
                }
                
                // Nach Status filtern (Mapping: vertrag_status â†’ umsatz status)
                if (statusFilter !== 'alle') {
                    const statusMap = {
                        'offen': ['neu', 'in_bearbeitung'],
                        'bestaetigt': ['aktiviert'],
                        'ausgezahlt': ['ausgezahlt'],
                        'storniert': ['storniert', 'abgelehnt']
                    };
                    const erlaubteStatus = statusMap[statusFilter] || [statusFilter];
                    gefiltert = gefiltert.filter(v => erlaubteStatus.includes(v.vertrag_status));
                }
                
                // STATISTIKEN BERECHNEN (nur PROVISIONEN, nicht Kundenpreise!)
                
                // ğŸ”§ Helper: Provision aus Vertrag extrahieren (verschiedene Feldnamen unterstÃ¼tzen)
                const getProvision = (v) => {
                    // Wert extrahieren und â‚¬-Zeichen entfernen
                    const cleanValue = (val) => {
                        if (!val) return 0;
                        const str = String(val).replace(/[â‚¬\s]/g, '').replace(',', '.');
                        return parseFloat(str) || 0;
                    };
                    
                    return cleanValue(v.gesamt_provision) || 
                           cleanValue(v.provision) || 
                           cleanValue(v.provision_betrag) || 
                           cleanValue(v.tarif_provision) || 
                           0;
                };
                
                // ğŸ”§ Helper: Datum sicher konvertieren
                const parseDatum = (v) => {
                    const raw = v.erstellt_am || v.created_at || v.datum;
                    if (!raw) return null;
                    
                    // Unix timestamp
                    if (typeof raw === 'number') {
                        // Wenn < 10 Milliarden, ist es in Sekunden (nicht ms)
                        if (raw < 10000000000) {
                            return new Date(raw * 1000);
                        }
                        return new Date(raw);
                    }
                    
                    // String-Datum
                    const parsed = new Date(raw);
                    if (isNaN(parsed.getTime())) {
                        console.warn('âš ï¸ UngÃ¼ltiges Datum:', raw);
                        return null;
                    }
                    return parsed;
                };
                
                // ğŸ› DEBUG: Erstes Vertrag-Objekt anzeigen um Feldnamen zu sehen
                if (gefiltert.length > 0) {
                    console.log('ğŸ” ERSTER VERTRAG (Feldnamen):', Object.keys(gefiltert[0]));
                    console.log('ğŸ” ERSTER VERTRAG (Daten):', gefiltert[0]);
                    console.log('ğŸ” PROVISION-WERT:', gefiltert[0].gesamt_provision, 'â†’ parsed:', getProvision(gefiltert[0]));
                    console.log('ğŸ” DATUM-WERT:', gefiltert[0].erstellt_am || gefiltert[0].created_at, 'â†’ parsed:', parseDatum(gefiltert[0]));
                }
                
                // Heute
                const vertraegeHeute = gefiltert.filter(v => {
                    const vertragDatum = parseDatum(v);
                    return vertragDatum && vertragDatum >= heute;
                });
                const provisionHeute = vertraegeHeute.reduce((sum, v) => sum + getProvision(v), 0);
                const umsatzHeute = vertraegeHeute.reduce((sum, v) => sum + (parseFloat(v.tarif_preis) || 0), 0);
                
                // Diese Woche
                const vertraegeWoche = gefiltert.filter(v => {
                    const vertragDatum = parseDatum(v);
                    return vertragDatum && vertragDatum >= wochenStart;
                });
                const provisionWoche = vertraegeWoche.reduce((sum, v) => sum + getProvision(v), 0);
                const umsatzWoche = vertraegeWoche.reduce((sum, v) => sum + (parseFloat(v.tarif_preis) || 0), 0);
                
                // Dieser Monat
                const vertraegeMonat = gefiltert.filter(v => {
                    const vertragDatum = parseDatum(v);
                    return vertragDatum && vertragDatum >= monatsStart;
                });
                const provisionMonat = vertraegeMonat.reduce((sum, v) => sum + getProvision(v), 0);
                const umsatzMonat = vertraegeMonat.reduce((sum, v) => sum + (parseFloat(v.tarif_preis) || 0), 0);
                
                // ğŸ› DEBUG: Berechnete Werte
                console.log('ğŸ’° PROVISION-BERECHNUNG:');
                console.log('   VertrÃ¤ge gesamt:', vertraege.length);
                console.log('   Gefiltert:', gefiltert.length);
                console.log('   Heute:', vertraegeHeute.length, 'VertrÃ¤ge â†’', provisionHeute.toFixed(2) + 'â‚¬');
                console.log('   Woche:', vertraegeWoche.length, 'VertrÃ¤ge â†’', provisionWoche.toFixed(2) + 'â‚¬');
                console.log('   Monat:', vertraegeMonat.length, 'VertrÃ¤ge â†’', provisionMonat.toFixed(2) + 'â‚¬');
                
                // ğŸ› DEBUG: Einzelne Provisionen im Monat anzeigen
                if (vertraegeMonat.length > 0) {
                    console.log('ğŸ“‹ PROVISIONEN IM MONAT:');
                    vertraegeMonat.forEach((v, i) => {
                        console.log(`   ${i+1}. ${v.kunde_vorname || 'N/A'} ${v.kunde_nachname || ''}: gesamt_provision=${v.gesamt_provision}, provision=${v.provision}, provision_betrag=${v.provision_betrag} â†’ ${getProvision(v).toFixed(2)}â‚¬`);
                    });
                }
                
                // Statistik-Karten aktualisieren (mit Fehlerbehandlung)
                const safeSetText = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.textContent = value;
                        console.log(`   âœ… ${id} = ${value}`);
                    } else {
                        console.warn(`   âš ï¸ Element nicht gefunden: ${id}`);
                    }
                };
                
                safeSetText('provision-heute', provisionHeute.toFixed(2) + ' â‚¬');
                safeSetText('provision-woche', provisionWoche.toFixed(2) + ' â‚¬');
                safeSetText('provision-monat', provisionMonat.toFixed(2) + ' â‚¬');
                safeSetText('vertraege-monat', vertraegeMonat.length);
                
                // ğŸ†• HOCHRECHNUNGEN & PROGNOSEN
                const currentDay = now.getDate();
                const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                const daysRemaining = daysInMonth - currentDay;
                
                // ğŸ› Debug: Datum-Berechnung
                console.log('ğŸ“… DATUM-BERECHNUNG:');
                console.log('   Heute:', now.toLocaleDateString('de-DE'));
                console.log('   Aktueller Tag:', currentDay);
                console.log('   Tage im Monat:', daysInMonth);
                console.log('   Verbleibende Tage:', daysRemaining);
                
                // Durchschnitt pro Tag (aktueller Monat)
                const avgPerDay = currentDay > 0 ? provisionMonat / currentDay : 0;
                
                // Monats-Hochrechnung
                const prognoseMonat = avgPerDay * daysInMonth;
                
                // Jahres-Hochrechnung (basierend auf Monats-Durchschnitt)
                const avgPerMonth = provisionMonat; // Aktueller Monat als Basis
                const prognoseJahr = avgPerMonth * 12;
                
                // Bis Monatsende noch zu erwarten
                const prognoseRestMonat = avgPerDay * daysRemaining;
                
                // Wachstum vs. Vormonat (wenn Daten verfÃ¼gbar)
                const vormonatStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const vormonatEnde = new Date(now.getFullYear(), now.getMonth(), 0);
                const vertraegeVormonat = gefiltert.filter(v => {
                    const vertragDatum = parseDatum(v);
                    return vertragDatum && vertragDatum >= vormonatStart && vertragDatum <= vormonatEnde;
                });
                const provisionVormonat = vertraegeVormonat.reduce((sum, v) => sum + getProvision(v), 0);
                
                let growthPercentage = 0;
                let growthTrend = 'ğŸ“Š Stabil';
                if (provisionVormonat > 0) {
                    growthPercentage = ((prognoseMonat - provisionVormonat) / provisionVormonat) * 100;
                    if (growthPercentage > 5) growthTrend = 'ğŸ“ˆ Steigend';
                    else if (growthPercentage < -5) growthTrend = 'ğŸ“‰ Sinkend';
                    else growthTrend = 'ğŸ“Š Stabil';
                }
                
                // Hochrechnungs-UI aktualisieren
                const updateElement = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value;
                };
                
                // ğŸ› DEBUG: Hochrechnung-Elemente
                console.log('ğŸ“Š HOCHRECHNUNG UPDATE:');
                
                const safeUpdate = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.textContent = value;
                        console.log(`   âœ… ${id} = ${value}`);
                    } else {
                        console.warn(`   âš ï¸ ELEMENT NICHT GEFUNDEN: ${id}`);
                    }
                };
                
                safeUpdate('current-day-of-month', currentDay);
                safeUpdate('total-days-in-month', daysInMonth);
                safeUpdate('prognose-monat', prognoseMonat.toFixed(2) + ' â‚¬');
                safeUpdate('avg-per-day', avgPerDay.toFixed(2) + ' â‚¬');
                safeUpdate('prognose-jahr', prognoseJahr.toFixed(2) + ' â‚¬');
                safeUpdate('avg-per-month', avgPerMonth.toFixed(2) + ' â‚¬');
                safeUpdate('prognose-rest-monat', prognoseRestMonat.toFixed(2) + ' â‚¬');
                safeUpdate('days-remaining', daysRemaining);
                safeUpdate('growth-percentage', (growthPercentage >= 0 ? '+' : '') + growthPercentage.toFixed(1) + '%');
                updateElement('growth-trend', growthTrend);
                
                console.log('ğŸ“Š HOCHRECHNUNG AKTUALISIERT:', {
                    currentDay, daysInMonth, daysRemaining,
                    provisionMonat: provisionMonat.toFixed(2),
                    avgPerDay: avgPerDay.toFixed(2),
                    prognoseMonat: prognoseMonat.toFixed(2),
                    prognoseJahr: prognoseJahr.toFixed(2)
                });
                
                // Partner-Filter-Dropdown fÃ¼llen
                const partnerSelect = document.getElementById('partner-filter');
                if (partnerSelect && partnerSelect.options.length === 1) {
                    const uniquePartners = [...new Set(vertraege.map(v => v.partner_email))];
                    uniquePartners.forEach(email => {
                        const option = document.createElement('option');
                        option.value = email;
                        option.textContent = email;
                        partnerSelect.appendChild(option);
                    });
                }
                
                // Tabelle rendern mit ALLEN Kundendaten
                const tbody = document.getElementById('umsatzTable');
                
                // Zeitraum-gefilterte Daten anzeigen
                let anzuzeigen = gefiltert;
                if (zeitraumFilter === 'heute') anzuzeigen = vertraegeHeute;
                else if (zeitraumFilter === 'woche') anzuzeigen = vertraegeWoche;
                else if (zeitraumFilter === 'monat') anzuzeigen = vertraegeMonat;
                
                if (anzuzeigen.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 30px; color: var(--text-light);">
                                <i class="fas fa-inbox"></i><br><br>
                                Keine VertrÃ¤ge fÃ¼r diesen Zeitraum vorhanden
                            </td>
                        </tr>
                    `;
                } else {
                    tbody.innerHTML = anzuzeigen.map(vertrag => {
                        const datum = new Date(vertrag.erstellt_am).toLocaleDateString('de-DE', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                        });
                        
                        const kategorieIcons = {
                            'sim-only': 'ğŸ“±',
                            'handyTarif': 'ğŸ“±ğŸ“¦',
                            'internet': 'ğŸŒ',
                            'strom': 'âš¡'
                        };
                        
                        const statusColors = {
                            'neu': 'primary',
                            'in_bearbeitung': 'warning',
                            'aktiviert': 'success',
                            'abgelehnt': 'danger',
                            'storniert': 'danger'
                        };
                        
                        const statusTexte = {
                            'neu': 'Neu',
                            'in_bearbeitung': 'In Bearbeitung',
                            'aktiviert': 'Aktiviert',
                            'abgelehnt': 'Abgelehnt',
                            'storniert': 'Storniert'
                        };
                        
                        return `
                            <tr>
                                <td>${datum}</td>
                                <td>
                                    <strong>${vertrag.partner_name || 'N/A'}</strong><br>
                                    <small style="color: var(--text-light);">${vertrag.partner_email}</small>
                                </td>
                                <td>
                                    ${kategorieIcons[vertrag.kategorie] || 'ğŸ“„'} 
                                    ${vertrag.kategorie}
                                </td>
                                <td>
                                    <strong>${vertrag.anbieter}</strong><br>
                                    ${vertrag.tarif_name}
                                </td>
                                <td>
                                    <strong>${vertrag.kunde_vorname} ${vertrag.kunde_nachname}</strong><br>
                                    <small style="color: var(--text-light);">
                                        ğŸ“§ ${vertrag.kunde_email}<br>
                                        ğŸ“ ${vertrag.kunde_telefon}
                                    </small>
                                </td>
                                <td><strong style="color: var(--success); font-size: 1.1em;">${parseFloat(vertrag.gesamt_provision).toFixed(2)}â‚¬</strong></td>
                                <td>${parseFloat(vertrag.tarif_preis).toFixed(2)}â‚¬</td>
                                <td>
                                    <span class="badge badge-${statusColors[vertrag.vertrag_status] || 'primary'}">
                                        ${statusTexte[vertrag.vertrag_status] || vertrag.vertrag_status}
                                    </span>
                                </td>
                                <td>
                                    <button onclick="showVertragsDetails('${vertrag.id}')" class="btn btn-primary" style="padding: 5px 15px; font-size: 0.9rem;">
                                        <i class="fas fa-eye"></i> Details
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // ğŸ“Š CHARTS RENDERN
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                
                // 1. PARTNER-RANKING (Top 10)
                const partnerStats = {};
                
                // Lade Partner-Namen aus Partners-Tabelle
                let partnerNamesMap = {};
                try {
                    const partnersRes = await fetch('tables/partners?limit=1000');
                    const partnersData = await partnersRes.json();
                    partnersData.data.forEach(p => {
                        const fullName = `${p.vorname || ''} ${p.nachname || ''}`.trim() || p.email;
                        partnerNamesMap[p.email] = fullName;
                    });
                    console.log('âœ… Partner-Namen geladen:', Object.keys(partnerNamesMap).length);
                } catch (err) {
                    console.error('âŒ Fehler beim Laden der Partner-Namen:', err);
                }
                
                gefiltert.forEach(v => {
                    const email = v.partner_email || 'Unbekannt';
                    // Verwende Namen aus Partners-Tabelle (nicht aus VertrÃ¤gen!)
                    const name = partnerNamesMap[email] || v.partner_name || email;
                    if (!partnerStats[email]) {
                        partnerStats[email] = { name, provision: 0, vertraege: 0 };
                    }
                    partnerStats[email].provision += parseFloat(v.gesamt_provision) || 0;
                    partnerStats[email].vertraege += 1;
                });
                
                const topPartner = Object.values(partnerStats)
                    .sort((a, b) => b.provision - a.provision)
                    .slice(0, 10);
                
                document.getElementById('partner-ranking').innerHTML = topPartner.length > 0 ? topPartner.map((p, i) => `
                    <div style="display: flex; align-items: center; gap: 15px; padding: 12px; border-bottom: 1px solid #e2e8f0;">
                        <div style="width: 35px; height: 35px; background: ${i < 3 ? '#FFD700' : '#3b82f6'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 14px;">
                            ${i + 1}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #2d3748;">${p.name}</div>
                            <div style="font-size: 12px; color: #718096;">${p.vertraege} VertrÃ¤ge</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 700; color: #48bb78; font-size: 16px;">${p.provision.toFixed(2)}â‚¬</div>
                        </div>
                    </div>
                `).join('') : '<div style="text-align: center; padding: 40px; color: #a0aec0;">Keine Daten verfÃ¼gbar</div>';
                
                // 2. UMSATZ NACH KATEGORIE (Pie Chart)
                const kategorieStats = {};
                gefiltert.forEach(v => {
                    const kat = v.kategorie || 'Sonstiges';
                    kategorieStats[kat] = (kategorieStats[kat] || 0) + (parseFloat(v.gesamt_provision) || 0);
                });
                
                const kategorieChartCanvas = document.getElementById('kategorieChart');
                if (kategorieChartCanvas) {
                    // ZerstÃ¶re alten Chart falls vorhanden
                    if (window.kategorieChartInstance) {
                        window.kategorieChartInstance.destroy();
                    }
                    
                    window.kategorieChartInstance = new Chart(kategorieChartCanvas, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(kategorieStats),
                            datasets: [{
                                data: Object.values(kategorieStats),
                                backgroundColor: ['#3b82f6', '#48bb78', '#ed8936', '#4299e1', '#f56565', '#9f7aea'],
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: true, position: 'bottom' },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => `${context.label}: ${context.parsed.toFixed(2)}â‚¬`
                                    }
                                }
                            }
                        }
                    });
                }
                
                // 3. TÃ„GLICHER UMSATZ-VERLAUF (Bar Chart - Letzte 30 Tage)
                const last30Days = {};
                for (let i = 29; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    const key = d.toISOString().split('T')[0];
                    last30Days[key] = 0;
                }
                
                gefiltert.forEach(v => {
                    const datum = new Date(v.erstellt_am).toISOString().split('T')[0];
                    if (last30Days.hasOwnProperty(datum)) {
                        last30Days[datum] += parseFloat(v.gesamt_provision) || 0;
                    }
                });
                
                const tagesChartCanvas = document.getElementById('tagesChart');
                if (tagesChartCanvas) {
                    // ZerstÃ¶re alten Chart falls vorhanden
                    if (window.tagesChartInstance) {
                        window.tagesChartInstance.destroy();
                    }
                    
                    window.tagesChartInstance = new Chart(tagesChartCanvas, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(last30Days).map(d => {
                                const date = new Date(d);
                                return `${date.getDate()}.${date.getMonth() + 1}`;
                            }),
                            datasets: [{
                                label: 'Provision (â‚¬)',
                                data: Object.values(last30Days),
                                backgroundColor: '#3b82f6',
                                borderColor: '#5568d3',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => `${context.parsed.y.toFixed(2)}â‚¬`
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: (value) => value + 'â‚¬'
                                    }
                                }
                            }
                        }
                    });
                }
                
                console.log('âœ… Umsatz-Daten geladen');
                
            } catch (error) {
                console.error('âŒ Fehler beim Laden der Umsatz-Daten:', error);
                document.getElementById('umsatzTable').innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 30px; color: var(--danger);">
                            <i class="fas fa-exclamation-triangle"></i><br><br>
                            Fehler beim Laden der Daten: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // Vertrags-Details anzeigen
        let currentVertrag = null;
        
        async function showVertragsDetails(vertragsId) {
            try {
                // Lade Vertrags-Details
                const response = await fetch(`tables/vertragsabschluesse/${vertragsId}`);
                if (!response.ok) throw new Error('Vertrag nicht gefunden');
                
                currentVertrag = await response.json();
                
                // Modal HTML erstellen
                const modal = document.getElementById('vertragsDetailModal');
                const modalBody = document.getElementById('vertragsDetailBody');
                
                // Formatiere Datum
                const erstelltAm = new Date(currentVertrag.erstellt_am).toLocaleString('de-DE');
                const aktiviertAm = currentVertrag.aktiviert_am ? new Date(currentVertrag.aktiviert_am).toLocaleString('de-DE') : '-';
                
                // Cross-Sells parsen
                let crossSells = [];
                try {
                    crossSells = JSON.parse(currentVertrag.cross_sells || '[]');
                } catch (e) {
                    crossSells = [];
                }
                
                modalBody.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        <!-- Vertrags-Informationen -->
                        <div class="detail-section">
                            <h3 style="color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid var(--primary); padding-bottom: 10px;">
                                ğŸ“„ Vertrags-Informationen
                            </h3>
                            <div class="detail-item">
                                <label>Vertragsnummer:</label>
                                <strong>${currentVertrag.vertragsnummer}</strong>
                            </div>
                            <div class="detail-item">
                                <label>Erstellt am:</label>
                                <span>${erstelltAm}</span>
                            </div>
                            <div class="detail-item">
                                <label>Kategorie:</label>
                                <span>${currentVertrag.kategorie}</span>
                            </div>
                            <div class="detail-item">
                                <label>Status:</label>
                                <span class="badge badge-${currentVertrag.vertrag_status === 'aktiviert' ? 'success' : 'warning'}">
                                    ${currentVertrag.vertrag_status}
                                </span>
                            </div>
                            ${currentVertrag.aktiviert_am ? `
                            <div class="detail-item">
                                <label>Aktiviert am:</label>
                                <span>${aktiviertAm}</span>
                            </div>
                            ` : ''}
                        </div>
                        
                        <!-- Partner-Informationen -->
                        <div class="detail-section">
                            <h3 style="color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid var(--primary); padding-bottom: 10px;">
                                ğŸ‘¤ Partner-Informationen
                            </h3>
                            <div class="detail-item">
                                <label>Partner:</label>
                                <strong>${currentVertrag.partner_name || 'N/A'}</strong>
                            </div>
                            <div class="detail-item">
                                <label>E-Mail:</label>
                                <span>${currentVertrag.partner_email}</span>
                            </div>
                            <div class="detail-item">
                                <label>Provision:</label>
                                <strong style="color: var(--success); font-size: 1.2em;">${parseFloat(currentVertrag.gesamt_provision || 0).toFixed(2)}â‚¬</strong>
                            </div>
                            <div class="detail-item">
                                <label>Provisions-Status:</label>
                                <span class="badge badge-${currentVertrag.provision_status === 'ausgezahlt' ? 'success' : currentVertrag.provision_status === 'freigegeben' ? 'info' : 'warning'}">
                                    ${currentVertrag.provision_status || 'ausstehend'}
                                </span>
                            </div>
                        </div>
                        
                        <!-- Tarif-Informationen -->
                        <div class="detail-section">
                            <h3 style="color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid var(--primary); padding-bottom: 10px;">
                                ğŸ“± Tarif-Informationen
                            </h3>
                            <div class="detail-item">
                                <label>Anbieter:</label>
                                <strong>${currentVertrag.anbieter}</strong>
                            </div>
                            <div class="detail-item">
                                <label>Tarif:</label>
                                <strong>${currentVertrag.tarif_name}</strong>
                            </div>
                            <div class="detail-item">
                                <label>Monatspreis:</label>
                                <span>${parseFloat(currentVertrag.tarif_preis || 0).toFixed(2)}â‚¬</span>
                            </div>
                            <div class="detail-item">
                                <label>Basis-Provision:</label>
                                <span>${parseFloat(currentVertrag.provision_betrag || 0).toFixed(2)}â‚¬</span>
                            </div>
                            ${currentVertrag.handy_modell ? `
                            <div class="detail-item">
                                <label>Handy:</label>
                                <span>${currentVertrag.handy_modell} (+${parseFloat(currentVertrag.handy_preis || 0).toFixed(2)}â‚¬)</span>
                            </div>
                            ` : ''}
                            ${currentVertrag.portierung ? `
                            <div class="detail-item">
                                <label>Rufnummernportierung:</label>
                                <span>âœ… Ja - ${currentVertrag.alte_rufnummer || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Alter Anbieter:</label>
                                <span>${currentVertrag.alter_anbieter || 'N/A'}</span>
                            </div>
                            ` : ''}
                        </div>
                        
                        <!-- Cross-Sells -->
                        ${crossSells.length > 0 ? `
                        <div class="detail-section">
                            <h3 style="color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid var(--primary); padding-bottom: 10px;">
                                ğŸ Cross-Sell Produkte
                            </h3>
                            ${crossSells.map(cs => `
                                <div class="detail-item">
                                    <label>${cs.name}:</label>
                                    <span>${cs.price}â‚¬/Monat â†’ +${cs.provision}â‚¬ Provision</span>
                                </div>
                            `).join('')}
                            <div class="detail-item" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
                                <label>Cross-Sell Provision gesamt:</label>
                                <strong style="color: var(--success);">${parseFloat(currentVertrag.cross_sell_provision || 0).toFixed(2)}â‚¬</strong>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Kundendaten - VOLLE BREITE & ÃœBERSICHTLICH -->
                    <div style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 15px; border: 3px solid var(--primary);">
                        <h3 style="color: var(--primary); margin-bottom: 25px; font-size: 1.5rem; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-user-circle" style="font-size: 2rem;"></i>
                            KUNDENDATEN - VOLLSTÃ„NDIGE ÃœBERSICHT
                        </h3>
                        
                        <!-- PersÃ¶nliche Daten Sektion -->
                        <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h4 style="color: #333; margin-bottom: 15px; font-size: 1.1rem; border-bottom: 2px solid var(--primary); padding-bottom: 8px;">
                                ğŸ‘¤ PersÃ¶nliche Daten
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
                                <div style="padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
                                    <label style="display: block; font-size: 0.85rem; color: #1565c0; margin-bottom: 5px; font-weight: 600;">Anrede</label>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: #333;">${currentVertrag.kunde_anrede || 'N/A'}</div>
                                </div>
                                <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                    <label style="display: block; font-size: 0.85rem; color: #666; margin-bottom: 5px; font-weight: 600;">Vorname</label>
                                    <div style="font-size: 1.2rem; font-weight: 700; color: #333;">${currentVertrag.kunde_vorname || 'N/A'}</div>
                                </div>
                                <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                    <label style="display: block; font-size: 0.85rem; color: #666; margin-bottom: 5px; font-weight: 600;">Nachname</label>
                                    <div style="font-size: 1.2rem; font-weight: 700; color: #333;">${currentVertrag.kunde_nachname || 'N/A'}</div>
                                </div>
                                <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                    <label style="display: block; font-size: 0.85rem; color: #666; margin-bottom: 5px; font-weight: 600;">Geburtsdatum</label>
                                    <div style="font-size: 1.2rem; font-weight: 700; color: #333;">${currentVertrag.kunde_geburtsdatum || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ausweis-Daten Sektion (NEU) -->
                        <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h4 style="color: #333; margin-bottom: 15px; font-size: 1.1rem; border-bottom: 2px solid #ff5722; padding-bottom: 8px;">
                                ğŸªª Ausweis-Daten
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                                <div style="padding: 15px; background: #fbe9e7; border-radius: 8px; border-left: 4px solid #ff5722;">
                                    <label style="display: block; font-size: 0.85rem; color: #d84315; margin-bottom: 5px; font-weight: 600;">ğŸ“‡ Ausweisnummer</label>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: #333; font-family: 'Courier New', monospace;">${currentVertrag.ausweisnummer || 'Nicht angegeben'}</div>
                                </div>
                                <div style="padding: 15px; background: #fbe9e7; border-radius: 8px; border-left: 4px solid #ff5722;">
                                    <label style="display: block; font-size: 0.85rem; color: #d84315; margin-bottom: 5px; font-weight: 600;">ğŸ“… GÃ¼ltigkeitsdatum</label>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: #333;">${currentVertrag.ausweis_gueltig_bis || 'Nicht angegeben'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Kontaktdaten Sektion -->
                        <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h4 style="color: #333; margin-bottom: 15px; font-size: 1.1rem; border-bottom: 2px solid var(--primary); padding-bottom: 8px;">
                                ğŸ“ Kontaktdaten
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                                <div style="padding: 15px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50;">
                                    <label style="display: block; font-size: 0.85rem; color: #2e7d32; margin-bottom: 5px; font-weight: 600;">ğŸ“§ E-Mail</label>
                                    <a href="mailto:${currentVertrag.kunde_email}" style="font-size: 1.1rem; font-weight: 600; color: #1565c0; text-decoration: none;">
                                        ${currentVertrag.kunde_email}
                                    </a>
                                </div>
                                <div style="padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
                                    <label style="display: block; font-size: 0.85rem; color: #1565c0; margin-bottom: 5px; font-weight: 600;">ğŸ“± Telefon</label>
                                    <a href="tel:${currentVertrag.kunde_telefon}" style="font-size: 1.1rem; font-weight: 600; color: #1565c0; text-decoration: none;">
                                        ${currentVertrag.kunde_telefon}
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Adresse Sektion -->
                        <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h4 style="color: #333; margin-bottom: 15px; font-size: 1.1rem; border-bottom: 2px solid var(--primary); padding-bottom: 8px;">
                                ğŸ  Adresse
                            </h4>
                            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 20px;">
                                <div style="padding: 15px; background: #fff3e0; border-radius: 8px; border-left: 4px solid #ff9800;">
                                    <label style="display: block; font-size: 0.85rem; color: #e65100; margin-bottom: 5px; font-weight: 600;">StraÃŸe & Hausnummer</label>
                                    <div style="font-size: 1.1rem; font-weight: 600; color: #333;">${currentVertrag.kunde_strasse}</div>
                                </div>
                                <div style="padding: 15px; background: #fff3e0; border-radius: 8px; border-left: 4px solid #ff9800;">
                                    <label style="display: block; font-size: 0.85rem; color: #e65100; margin-bottom: 5px; font-weight: 600;">PLZ</label>
                                    <div style="font-size: 1.1rem; font-weight: 600; color: #333;">${currentVertrag.kunde_plz}</div>
                                </div>
                                <div style="padding: 15px; background: #fff3e0; border-radius: 8px; border-left: 4px solid #ff9800;">
                                    <label style="display: block; font-size: 0.85rem; color: #e65100; margin-bottom: 5px; font-weight: 600;">Ort</label>
                                    <div style="font-size: 1.1rem; font-weight: 600; color: #333;">${currentVertrag.kunde_ort}</div>
                                </div>
                            </div>
                            <div style="margin-top: 15px; padding: 15px; background: #f5f5f5; border-radius: 8px; text-align: center;">
                                <i class="fas fa-map-marker-alt" style="color: #f44336; margin-right: 8px;"></i>
                                <strong style="font-size: 1.1rem;">${currentVertrag.kunde_strasse}, ${currentVertrag.kunde_plz} ${currentVertrag.kunde_ort}</strong>
                            </div>
                        </div>
                        
                        <!-- Bankdaten Sektion -->
                        <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h4 style="color: #333; margin-bottom: 15px; font-size: 1.1rem; border-bottom: 2px solid var(--primary); padding-bottom: 8px;">
                                ğŸ¦ Bankverbindung
                            </h4>
                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                                <div style="padding: 20px; background: #f1f8e9; border-radius: 8px; border-left: 4px solid #8bc34a;">
                                    <label style="display: block; font-size: 0.85rem; color: #558b2f; margin-bottom: 8px; font-weight: 600;">IBAN</label>
                                    <code style="background: white; padding: 12px 15px; border-radius: 6px; display: block; font-size: 1.1rem; font-weight: 600; color: #333; letter-spacing: 1px; border: 2px solid #8bc34a;">
                                        ${currentVertrag.iban}
                                    </code>
                                </div>
                                <div style="padding: 20px; background: #f1f8e9; border-radius: 8px; border-left: 4px solid #8bc34a;">
                                    <label style="display: block; font-size: 0.85rem; color: #558b2f; margin-bottom: 8px; font-weight: 600;">Kontoinhaber</label>
                                    <div style="font-size: 1.1rem; font-weight: 600; color: #333;">${currentVertrag.kontoinhaber}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Besondere WÃ¼nsche & Notizen (NEU) -->
                        ${currentVertrag.besondere_wuensche ? `
                        <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h4 style="color: #333; margin-bottom: 15px; font-size: 1.1rem; border-bottom: 2px solid #9c27b0; padding-bottom: 8px;">
                                ğŸ’¬ Besondere WÃ¼nsche des Kunden
                            </h4>
                            <div style="padding: 20px; background: #f3e5f5; border-radius: 8px; border-left: 4px solid #9c27b0;">
                                <p style="font-size: 1rem; line-height: 1.6; color: #333; white-space: pre-wrap;">${currentVertrag.besondere_wuensche}</p>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Rufnummern-Mitnahme Details (erweitert) -->
                        ${currentVertrag.portierung ? `
                        <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h4 style="color: #333; margin-bottom: 15px; font-size: 1.1rem; border-bottom: 2px solid #00bcd4; padding-bottom: 8px;">
                                ğŸ“ Rufnummern-Mitnahme (Portierung)
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                                <div style="padding: 15px; background: #e0f7fa; border-radius: 8px; border-left: 4px solid #00bcd4;">
                                    <label style="display: block; font-size: 0.85rem; color: #00838f; margin-bottom: 5px; font-weight: 600;">Zu portierende Rufnummer</label>
                                    <div style="font-size: 1.2rem; font-weight: 700; color: #333; font-family: 'Courier New', monospace;">${currentVertrag.alte_rufnummer || 'N/A'}</div>
                                </div>
                                <div style="padding: 15px; background: #e0f7fa; border-radius: 8px; border-left: 4px solid #00bcd4;">
                                    <label style="display: block; font-size: 0.85rem; color: #00838f; margin-bottom: 5px; font-weight: 600;">Aktueller Anbieter</label>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: #333;">${currentVertrag.alter_anbieter || 'N/A'}</div>
                                </div>
                            </div>
                            <div style="margin-top: 15px; padding: 15px; background: #b2ebf2; border-radius: 8px; text-align: center;">
                                <i class="fas fa-exchange-alt" style="color: #00838f; font-size: 1.5rem; margin-right: 10px;"></i>
                                <strong style="font-size: 1rem; color: #00838f;">âœ… Rufnummern-Mitnahme gewÃ¼nscht</strong>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Unterschrift -->
                        ${currentVertrag.unterschrift_data ? `
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h4 style="color: #333; margin-bottom: 15px; font-size: 1.1rem; border-bottom: 2px solid var(--primary); padding-bottom: 8px;">
                                âœï¸ Digitale Unterschrift des Kunden
                            </h4>
                            <div style="text-align: center; padding: 20px; background: #fafafa; border-radius: 8px; border: 2px dashed #ccc;">
                                <img src="${currentVertrag.unterschrift_data}" 
                                     style="max-width: 500px; height: auto; border: 2px solid #333; border-radius: 8px; background: white; padding: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);"
                                     alt="Kundenunterschrift">
                                <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">
                                    <i class="fas fa-check-circle" style="color: #4caf50;"></i> Unterschrift digital erfasst
                                </p>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Admin-Notizen -->
                    <div style="margin-top: 20px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">ğŸ“ Admin-Notizen</h3>
                        <textarea id="adminNotizInput" 
                                  style="width: 100%; min-height: 100px; padding: 10px; border: 2px solid var(--border); border-radius: 8px; font-family: inherit;"
                                  placeholder="Interne Notizen hier eingeben...">${currentVertrag.admin_notiz || ''}</textarea>
                    </div>
                    
                    <!-- Status-Ã„nderung -->
                    <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Vertrag Status:</label>
                            <select id="vertragsStatusSelect" style="width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 8px;">
                                <option value="neu" ${currentVertrag.vertrag_status === 'neu' ? 'selected' : ''}>Neu</option>
                                <option value="in_bearbeitung" ${currentVertrag.vertrag_status === 'in_bearbeitung' ? 'selected' : ''}>In Bearbeitung</option>
                                <option value="aktiviert" ${currentVertrag.vertrag_status === 'aktiviert' ? 'selected' : ''}>Aktiviert</option>
                                <option value="abgelehnt" ${currentVertrag.vertrag_status === 'abgelehnt' ? 'selected' : ''}>Abgelehnt</option>
                                <option value="storniert" ${currentVertrag.vertrag_status === 'storniert' ? 'selected' : ''}>Storniert</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Provisions-Status:</label>
                            <select id="provisionStatusSelect" style="width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 8px;">
                                <option value="ausstehend" ${currentVertrag.provision_status === 'ausstehend' ? 'selected' : ''}>Ausstehend</option>
                                <option value="freigegeben" ${currentVertrag.provision_status === 'freigegeben' ? 'selected' : ''}>Freigegeben</option>
                                <option value="ausgezahlt" ${currentVertrag.provision_status === 'ausgezahlt' ? 'selected' : ''}>Ausgezahlt</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button onclick="updateVertragsStatus()" class="btn btn-success" style="width: 100%;">
                                <i class="fas fa-save"></i> Speichern
                            </button>
                        </div>
                    </div>
                `;
                
                // Modal anzeigen
                modal.style.display = 'flex';
                
            } catch (error) {
                console.error('âŒ Fehler beim Laden der Vertrags-Details:', error);
                alert('Fehler beim Laden der Vertrags-Details: ' + error.message);
            }
        }
        
        // Vertrags-Status aktualisieren
        async function updateVertragsStatus() {
            try {
                const vertragsStatus = document.getElementById('vertragsStatusSelect').value;
                const provisionStatus = document.getElementById('provisionStatusSelect').value;
                const adminNotiz = document.getElementById('adminNotizInput').value;
                
                const updateData = {
                    vertrag_status: vertragsStatus,
                    provision_status: provisionStatus,
                    admin_notiz: adminNotiz
                };
                
                // Wenn aktiviert â†’ Datum setzen
                if (vertragsStatus === 'aktiviert' && currentVertrag.vertrag_status !== 'aktiviert') {
                    updateData.aktiviert_am = Date.now();
                    if (provisionStatus === 'ausstehend') {
                        updateData.provision_status = 'freigegeben';
                    }
                }
                
                // Wenn ausgezahlt â†’ Datum setzen
                if (provisionStatus === 'ausgezahlt' && currentVertrag.provision_status !== 'ausgezahlt') {
                    updateData.ausgezahlt_am = Date.now();
                }
                
                const response = await fetch(`tables/vertragsabschluesse/${currentVertrag.id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (!response.ok) throw new Error('Update fehlgeschlagen');
                
                alert('âœ… Vertrag erfolgreich aktualisiert!');
                closeVertragsDetailModal();
                loadUmsatzData(); // Tabelle neu laden
                
            } catch (error) {
                console.error('âŒ Fehler beim Aktualisieren:', error);
                alert('Fehler beim Aktualisieren: ' + error.message);
            }
        }
        
        function closeVertragsDetailModal() {
            document.getElementById('vertragsDetailModal').style.display = 'none';
            currentVertrag = null;
        }

        // CSV Export
        async function exportUmsatzCSV() {
            try {
                console.log('ğŸ“Š Starte CSV-Export...');
                
                // Hole ALLE VertrÃ¤ge aus der Datenbank
                const response = await fetch('tables/vertragsabschluesse?limit=5000&sort=-erstellt_am');
                const result = await response.json();
                const vertraege = result.data || [];
                
                // CSV-Header
                const csvHeader = [
                    'Vertragsnummer',
                    'Datum',
                    'Partner Email',
                    'Partner Name',
                    'Kategorie',
                    'Anbieter',
                    'Tarif',
                    'Kunde Name',
                    'Kunde Email',
                    'Monatspreis (â‚¬)',
                    'Basis-Provision (â‚¬)',
                    'Cross-Sell Provision (â‚¬)',
                    'Gesamt-Provision (â‚¬)',
                    'Vertrag Status',
                    'Provisions Status',
                    'Erstellt am',
                    'Aktiviert am',
                    'Ausgezahlt am'
                ].join(';');
                
                // CSV-Zeilen
                const csvRows = vertraege.map(v => {
                    const erstelltAm = new Date(v.erstellt_am).toLocaleString('de-DE');
                    const aktiviertAm = v.aktiviert_am ? new Date(v.aktiviert_am).toLocaleString('de-DE') : '-';
                    const ausgezahltAm = v.ausgezahlt_am ? new Date(v.ausgezahlt_am).toLocaleString('de-DE') : '-';
                    
                    return [
                        v.vertragsnummer || '',
                        new Date(v.erstellt_am).toLocaleDateString('de-DE'),
                        v.partner_email || '',
                        v.partner_name || '',
                        v.kategorie || '',
                        v.anbieter || '',
                        v.tarif_name || '',
                        `${v.kunde_vorname || ''} ${v.kunde_nachname || ''}`.trim(),
                        v.kunde_email || '',
                        parseFloat(v.tarif_preis || 0).toFixed(2),
                        parseFloat(v.provision_betrag || 0).toFixed(2),
                        parseFloat(v.cross_sell_provision || 0).toFixed(2),
                        parseFloat(v.gesamt_provision || 0).toFixed(2),
                        v.vertrag_status || '',
                        v.provision_status || '',
                        erstelltAm,
                        aktiviertAm,
                        ausgezahltAm
                    ].join(';');
                }).join('\n');
                
                // CSV zusammensetzen
                const csvContent = csvHeader + '\n' + csvRows;
                
                // BOM fÃ¼r Excel-KompatibilitÃ¤t (UTF-8)
                const BOM = '\uFEFF';
                const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
                
                // Download erstellen
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                const timestamp = new Date().toISOString().slice(0,10);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `Buchhaltung_Provisionen_${timestamp}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log('âœ… CSV-Export erfolgreich!');
                alert(`âœ… CSV-Datei wurde heruntergeladen!\n\n${vertraege.length} VertrÃ¤ge exportiert.\n\nDateiname: Buchhaltung_Provisionen_${timestamp}.csv`);
                
            } catch (error) {
                console.error('âŒ Fehler beim CSV-Export:', error);
                alert('âŒ Fehler beim Erstellen der CSV-Datei: ' + error.message);
            }
        }

        // ====================================
        // ğŸ“„ VERTRÃ„GE MANAGEMENT
        // ====================================
        
        // allVertraege bereits oben deklariert (Zeile 3471)
        // currentVertrag already declared above

        async function loadVertraege() {
            try {
                // 1. Klassische VertrÃ¤ge laden (Partner-Tool)
                const response = await fetch('tables/vertragsabschluesse?limit=1000');
                const data = await response.json();
                let alleVertraege = data.data || [];
                console.log('ğŸ“Š VertrÃ¤ge aus Partner-Tool:', alleVertraege.length);
                
                // 2. ğŸ†• Partner-Shop Bestellungen laden (VertragsHero etc.)
                try {
                    const shopRes = await fetch('tables/partner_bestellungen?limit=1000');
                    const shopData = await shopRes.json();
                    let shopBestellungen = (shopData.data || []);
                    console.log('ğŸ›’ Partner-Shop Bestellungen:', shopBestellungen.length);
                    
                    // Shop-Bestellungen in Vertrags-Format konvertieren
                    const shopAlsVertraege = shopBestellungen.map(b => ({
                        id: b.id,
                        vertragsnummer: b.bestellnummer || b.id,
                        created_at: b.erstellt_am || b.created_at,
                        erstellt_am: b.erstellt_am || b.created_at,
                        kunde_anrede: b.anrede,
                        kunde_vorname: b.vorname,
                        kunde_nachname: b.nachname,
                        kunde_name: `${b.vorname || ''} ${b.nachname || ''}`.trim(),
                        kunde_email: b.email,
                        kunde_telefon: b.telefon,
                        kunde_strasse: b.strasse,
                        kunde_plz: b.plz,
                        kunde_ort: b.ort,
                        kunde_geburtsdatum: b.geburtsdatum,
                        // Ausweisdaten
                        ausweis_typ: b.ausweis_typ,
                        ausweisnummer: b.ausweisnummer,
                        ausweis_behoerde: b.ausweis_behoerde,
                        ausweis_gueltig_bis: b.ausweis_gueltig,
                        // Bankverbindung
                        kontoinhaber: b.kontoinhaber,
                        iban: b.iban,
                        bic: b.bic,
                        // Rufnummernmitnahme
                        portierung: b.portierung_gewuenscht ? 'Ja' : 'Nein',
                        portierung_daten: b.portierung_daten,
                        // Partner
                        partner_email: b.partner_email,
                        partner_name: b.partner_name,
                        partner_id: b.partner_id,
                        shop_name: b.shop_name,
                        // Tarif
                        kategorie: b.tarif_kategorie,
                        tarif_name: b.tarif_name,
                        tarif_preis: b.tarif_preis,
                        tarif_details: b.tarif_details,
                        cross_sells: b.extras,
                        provision: 0, // Shop-Bestellungen haben noch keine Provision zugewiesen
                        status: b.status === 'neu' ? 'Neu eingegangen' : 
                               b.status === 'in_bearbeitung' ? 'In Bearbeitung' :
                               b.status === 'abgeschlossen' ? 'Aktiviert' : 
                               b.status === 'storniert' ? 'Abgelehnt' : 'Neu eingegangen',
                        quelle: 'Partner-Shop: ' + (b.shop_name || 'Unbekannt'),
                        anmerkungen: b.anmerkungen,
                        ist_shop_bestellung: true
                    }));
                    
                    alleVertraege = [...alleVertraege, ...shopAlsVertraege];
                    console.log('ğŸ“Š Gesamt (Tool + Shop):', alleVertraege.length);
                } catch (shopError) {
                    console.warn('âš ï¸ Partner-Shop-Bestellungen konnten nicht geladen werden:', shopError);
                }
                
                allVertraege = alleVertraege;
                
                // Shop-Counter aktualisieren
                updateShopCount();

                // Update stats
                const gesamt = allVertraege.length;
                const aktiviert = allVertraege.filter(v => v.status === 'Aktiviert').length;
                const bearbeitung = allVertraege.filter(v => v.status === 'In Bearbeitung' || v.status === 'Neu eingegangen' || v.status === 'In PrÃ¼fung').length;
                const abgelehnt = allVertraege.filter(v => v.status === 'Abgelehnt').length;

                document.getElementById('stat-vertraege-gesamt').textContent = gesamt;
                document.getElementById('stat-vertraege-aktiviert').textContent = aktiviert;
                document.getElementById('stat-vertraege-bearbeitung').textContent = bearbeitung;
                document.getElementById('stat-vertraege-abgelehnt').textContent = abgelehnt;

                renderVertraege(allVertraege);
            } catch (error) {
                console.error('Error loading vertraege:', error);
            }
        }

        function renderVertraege(vertraege) {
            const tbody = document.getElementById('vertraegeTable');

            if (vertraege.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--text-light);">Keine VertrÃ¤ge gefunden</td></tr>';
                return;
            }

            tbody.innerHTML = vertraege.map(v => {
                const statusColor = 
                    v.status === 'Aktiviert' ? 'var(--success)' :
                    v.status === 'Abgelehnt' ? 'var(--danger)' :
                    'var(--warning)';

                const statusBg = 
                    v.status === 'Aktiviert' ? '#d1fae5' :
                    v.status === 'Abgelehnt' ? '#fee2e2' :
                    '#fef3c7';

                // Shop-Bestellung Badge
                const shopBadge = v.ist_shop_bestellung 
                    ? `<span style="background: linear-gradient(135deg, #d4a528, #b8860b); color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; margin-left: 6px;">ğŸ›’ SHOP</span>` 
                    : '';
                
                // Vertragsnummer: Bei Shop-Bestellungen die Bestellnummer verwenden
                const displayNr = v.vertragsnummer || (v.id ? v.id.substring(0, 8) : 'N/A');

                return `
                    <tr style="cursor: pointer;${v.ist_shop_bestellung ? ' background: linear-gradient(90deg, rgba(212,165,40,0.05), transparent);' : ''}" onclick="showVertragDetails('${v.id}')">
                        <td><strong>#${displayNr}</strong>${shopBadge}</td>
                        <td>${new Date(v.created_at).toLocaleDateString('de-DE')}</td>
                        <td>${v.kunde_vorname || 'N/A'} ${v.kunde_nachname || ''}</td>
                        <td>${v.partner_name || v.partner_email || 'N/A'}${v.shop_name ? `<br><small style="color: #718096;">${v.shop_name}</small>` : ''}</td>
                        <td>${v.kategorie || 'N/A'}</td>
                        <td><strong>${parseFloat(v.provision || 0).toFixed(2)}â‚¬</strong></td>
                        <td><span style="padding: 6px 12px; background: ${statusBg}; color: ${statusColor}; border-radius: 20px; font-weight: 600; font-size: 12px;">${v.status || 'N/A'}</span></td>
                        <td><button class="btn btn-primary" onclick="event.stopPropagation(); showVertragDetails('${v.id}')" style="padding: 6px 12px; font-size: 12px;"><i class="fas fa-eye"></i></button></td>
                    </tr>
                `;
            }).join('');
        }

        let currentVertraegeFilter = 'all';
        
        function filterVertraegeByType(type) {
            currentVertraegeFilter = type;
            
            // Button-Styles aktualisieren
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.style.background = 'white';
                btn.style.borderColor = '#e2e8f0';
                btn.style.color = '#4a5568';
            });
            const activeBtn = document.getElementById('filter-' + type);
            if (activeBtn) {
                activeBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                activeBtn.style.borderColor = '#667eea';
                activeBtn.style.color = 'white';
            }
            
            filterVertraege();
        }
        
        function filterVertraege() {
            const search = document.getElementById('vertraegeSearch').value.toLowerCase();
            let filtered = allVertraege;
            
            // Typ-Filter anwenden
            if (currentVertraegeFilter === 'shop') {
                filtered = filtered.filter(v => v.ist_shop_bestellung === true);
            } else if (currentVertraegeFilter === 'tool') {
                filtered = filtered.filter(v => !v.ist_shop_bestellung);
            }
            
            // Such-Filter anwenden
            if (search) {
                filtered = filtered.filter(v => {
                    const kunde = `${v.kunde_vorname || ''} ${v.kunde_nachname || ''}`.toLowerCase();
                    const partner = `${v.partner_name || ''} ${v.partner_email || ''}`.toLowerCase();
                    const vertragsnr = (v.vertragsnummer || v.id || '').toLowerCase();
                    const shopName = (v.shop_name || '').toLowerCase();
                    return kunde.includes(search) || partner.includes(search) || vertragsnr.includes(search) || shopName.includes(search);
                });
            }
            
            renderVertraege(filtered);
        }
        
        function updateShopCount() {
            const shopCount = allVertraege.filter(v => v.ist_shop_bestellung === true).length;
            const countEl = document.getElementById('shop-count');
            if (countEl) countEl.textContent = shopCount;
        }

        async function showVertragDetails(vertragId) {
            // Versuche zuerst in allVertraege zu finden
            let currentVertrag = allVertraege.find(v => v.id === vertragId);
            
            // Falls nicht gefunden, lade von API
            if (!currentVertrag) {
                try {
                    const res = await fetch(`tables/vertragsabschluesse/${vertragId}`);
                    if (res.ok) {
                        currentVertrag = await res.json();
                    } else {
                        alert('Vertrag nicht gefunden!');
                        return;
                    }
                } catch (error) {
                    alert('Fehler beim Laden: ' + error.message);
                    return;
                }
            }
            
            // ğŸ” TARIF-DATEN LADEN (falls tarif_name vorhanden)
            let tarifDetails = null;
            if (currentVertrag.tarif_name || currentVertrag.tarif) {
                try {
                    const tarifName = currentVertrag.tarif_name || currentVertrag.tarif;
                    console.log('ğŸ” Lade Tarif-Details fÃ¼r:', tarifName);
                    const tarifRes = await fetch(`tables/tarife?search=${encodeURIComponent(tarifName)}&limit=1`);
                    if (tarifRes.ok) {
                        const tarifData = await tarifRes.json();
                        if (tarifData.data && tarifData.data.length > 0) {
                            tarifDetails = tarifData.data[0];
                            console.log('âœ… Tarif-Details gefunden:', tarifDetails);
                            
                            // Ãœberschreibe Vertragsdaten mit korrekten Tarifdaten
                            currentVertrag.anbieter = tarifDetails.anbieter || currentVertrag.anbieter;
                            currentVertrag.tarif_preis = parseFloat(tarifDetails.preis_monatlich || currentVertrag.tarif_preis || 0);
                            currentVertrag.tarif_preis_ab_monat_10 = parseFloat(tarifDetails.preis_ab_monat || 0);
                        } else {
                            console.warn('âš ï¸ Tarif nicht gefunden:', tarifName);
                        }
                    }
                } catch (error) {
                    console.error('âŒ Fehler beim Laden der Tarif-Details:', error);
                }
            }
            
            // FÃ¼r nachfolgende Funktionen speichern
            window.currentVertrag = currentVertrag;

            const content = document.getElementById('vertragDetailsContent');
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <!-- Kundendaten -->
                    <div style="background: var(--bg); padding: 20px; border-radius: 10px;">
                        <h3 style="margin-bottom: 15px; color: var(--primary);"><i class="fas fa-user"></i> Kundendaten</h3>
                        <div style="display: grid; gap: 10px; font-size: 14px;">
                            <div><strong>Anrede:</strong> ${currentVertrag.kunde_anrede || 'N/A'}</div>
                            <div><strong>Name:</strong> ${currentVertrag.kunde_vorname || 'N/A'} ${currentVertrag.kunde_nachname || ''}</div>
                            <div><strong>E-Mail:</strong> ${currentVertrag.kunde_email || 'N/A'}</div>
                            <div><strong>Telefon:</strong> ${currentVertrag.kunde_telefon || 'N/A'}</div>
                            <div><strong>Adresse:</strong> ${currentVertrag.kunde_strasse || 'N/A'}, ${currentVertrag.kunde_plz || 'N/A'} ${currentVertrag.kunde_ort || 'N/A'}</div>
                            <div><strong>Geburtsdatum:</strong> ${currentVertrag.kunde_geburtsdatum || 'N/A'}</div>
                            ${currentVertrag.ausweis_typ ? `<div><strong>Ausweis-Typ:</strong> ${currentVertrag.ausweis_typ}</div>` : ''}
                            <div><strong>Ausweis-Nr.:</strong> ${currentVertrag.ausweisnummer || 'N/A'}</div>
                            ${currentVertrag.ausweis_behoerde ? `<div><strong>AusstellungsbehÃ¶rde:</strong> ${currentVertrag.ausweis_behoerde}</div>` : ''}
                            <div><strong>Ausweis gÃ¼ltig bis:</strong> ${currentVertrag.ausweis_gueltig_bis || 'N/A'}</div>
                            <div><strong>IBAN:</strong> ${currentVertrag.iban || 'N/A'}</div>
                            <div><strong>Kontoinhaber:</strong> ${currentVertrag.kontoinhaber || 'N/A'}</div>
                            ${currentVertrag.bic ? `<div><strong>BIC:</strong> ${currentVertrag.bic}</div>` : ''}
                            <div><strong>Besondere WÃ¼nsche:</strong> ${currentVertrag.besondere_wuensche || 'Keine'}</div>
                        </div>
                    </div>

                    <!-- Vertragsdaten -->
                    <div style="background: var(--bg); padding: 20px; border-radius: 10px;">
                        <h3 style="margin-bottom: 15px; color: var(--primary);"><i class="fas fa-file-contract"></i> Vertragsdaten</h3>
                        <div style="display: grid; gap: 10px; font-size: 14px;">
                            <div><strong>Vertragsnr.:</strong> ${currentVertrag.vertragsnummer || 'N/A'} ${currentVertrag.ist_shop_bestellung ? '<span style="background: linear-gradient(135deg, #d4a528, #b8860b); color: white; padding: 2px 10px; border-radius: 10px; font-size: 11px; font-weight: 600; margin-left: 8px;">ğŸ›’ SHOP-BESTELLUNG</span>' : ''}</div>
                            ${currentVertrag.shop_name ? `<div><strong>Shop:</strong> ${currentVertrag.shop_name}</div>` : ''}
                            <div><strong>Datum:</strong> ${currentVertrag.erstellt_am ? new Date(currentVertrag.erstellt_am).toLocaleDateString('de-DE') : 'N/A'}</div>
                            <div><strong>Kategorie:</strong> ${currentVertrag.kategorie || 'N/A'}</div>
                            <div><strong>Anbieter:</strong> ${currentVertrag.anbieter || 'N/A'}</div>
                            <div><strong>Tarif:</strong> ${currentVertrag.tarif_name || currentVertrag.tarif || 'N/A'}</div>
                            <div><strong>Tarif-Preis:</strong> ${currentVertrag.tarif_preis ? currentVertrag.tarif_preis.toFixed(2) + 'â‚¬/Monat' : 'N/A'}${currentVertrag.tarif_preis_ab_monat_10 && currentVertrag.tarif_preis_ab_monat_10 > 0 ? ` <span style="color: #f59e0b; font-size: 12px;">(ab 10. Monat: ${currentVertrag.tarif_preis_ab_monat_10.toFixed(2)}â‚¬/Monat)</span>` : ''}</div>
                            ${currentVertrag.handy_modell ? `<div><strong>ğŸ“± Handy:</strong> ${currentVertrag.handy_modell} (${currentVertrag.handy_preis ? currentVertrag.handy_preis.toFixed(2) + 'â‚¬' : 'N/A'})</div>` : ''}
                            ${currentVertrag.portierung === 'Ja' || currentVertrag.portierung === true ? `<div><strong>ğŸ“ Portierung:</strong> ${currentVertrag.alte_rufnummer || (currentVertrag.portierung_daten ? JSON.parse(currentVertrag.portierung_daten).rufnummer : 'N/A')} (von ${currentVertrag.alter_anbieter || (currentVertrag.portierung_daten ? JSON.parse(currentVertrag.portierung_daten).anbieter : 'N/A')})</div>` : ''}
                            <div><strong>Cross-Sells:</strong> ${currentVertrag.cross_sells && currentVertrag.cross_sells !== '[]' ? JSON.parse(currentVertrag.cross_sells).map(cs => cs.name).join(', ') : 'Keine'}</div>
                            <div><strong>Tarif-Provision:</strong> <strong style="color: var(--success);">${parseFloat(currentVertrag.provision_betrag || 0).toFixed(2)}â‚¬</strong></div>
                            <div><strong>Cross-Sell-Provision:</strong> <strong style="color: var(--success);">${parseFloat(currentVertrag.cross_sell_provision || 0).toFixed(2)}â‚¬</strong></div>
                            <div><strong>GESAMT-PROVISION:</strong> <strong style="color: var(--success); font-size: 18px;">${parseFloat(currentVertrag.gesamt_provision || 0).toFixed(2)}â‚¬</strong></div>
                            <div><strong>Provisions-Status:</strong> <span style="padding: 4px 12px; background: ${currentVertrag.provision_status === 'ausgezahlt' ? '#d1fae5' : '#fef3c7'}; color: ${currentVertrag.provision_status === 'ausgezahlt' ? '#065f46' : '#92400e'}; border-radius: 12px; font-weight: 600;">${currentVertrag.provision_status || 'ausstehend'}</span></div>
                        </div>
                    </div>

                    <!-- Partnerdaten -->
                    <div style="background: var(--bg); padding: 20px; border-radius: 10px;">
                        <h3 style="margin-bottom: 15px; color: var(--primary);"><i class="fas fa-handshake"></i> Partnerdaten</h3>
                        <div style="display: grid; gap: 10px; font-size: 14px;">
                            <div><strong>Partner:</strong> ${currentVertrag.partner_name || 'N/A'}</div>
                            <div><strong>E-Mail:</strong> ${currentVertrag.partner_email || 'N/A'}</div>
                        </div>
                        <div style="margin-top: 15px; padding: 12px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <div style="font-size: 12px; color: #92400e; font-weight: 600; margin-bottom: 4px;">â„¹ï¸ HINWEIS</div>
                            <div style="font-size: 13px; color: #78350f;">VollstÃ¤ndige Partner-Daten (Telefon, Firma, IBAN) sind in der <strong>Partner-Verwaltung</strong> einsehbar.</div>
                        </div>
                    </div>

                    <!-- Unterschrift -->
                    ${currentVertrag.unterschrift_data ? `
                    <div style="background: var(--bg); padding: 20px; border-radius: 10px; grid-column: 1 / -1;">
                        <h3 style="margin-bottom: 15px; color: var(--primary);"><i class="fas fa-signature"></i> Unterschrift des Kunden</h3>
                        <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid var(--border); max-width: 500px;">
                            <img src="${currentVertrag.unterschrift_data}" style="max-width: 100%; display: block;">
                        </div>
                    </div>
                    ` : '<div style="background: var(--bg); padding: 20px; border-radius: 10px; grid-column: 1 / -1;"><h3 style="margin-bottom: 15px; color: var(--primary);"><i class="fas fa-signature"></i> Unterschrift</h3><p style="color: var(--text-light);">Keine Unterschrift vorhanden</p></div>'}

                    <!-- Status, Auszahlung & Notizen -->
                    <div style="background: var(--bg); padding: 20px; border-radius: 10px; grid-column: 1 / -1;">
                        <h3 style="margin-bottom: 15px; color: var(--primary);"><i class="fas fa-info-circle"></i> Status, Auszahlung & Notizen</h3>
                        <div style="display: grid; gap: 15px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <strong>Status:</strong>
                                    <select id="vertragStatusSelect" style="margin-left: 10px; padding: 8px 15px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px; font-weight: 600;">
                                        <option value="Eingegangen" ${currentVertrag.vertrag_status === 'Eingegangen' || currentVertrag.status === 'Eingegangen' ? 'selected' : ''}>ğŸ“¥ Eingegangen</option>
                                        <option value="In Bearbeitung" ${currentVertrag.vertrag_status === 'In Bearbeitung' || currentVertrag.status === 'In Bearbeitung' ? 'selected' : ''}>ğŸ”„ In Bearbeitung</option>
                                        <option value="RÃ¼ckfragen offen" ${currentVertrag.vertrag_status === 'RÃ¼ckfragen offen' || currentVertrag.status === 'RÃ¼ckfragen offen' ? 'selected' : ''}>â“ RÃ¼ckfragen offen</option>
                                        <option value="Akzeptiert" ${currentVertrag.vertrag_status === 'Akzeptiert' || currentVertrag.status === 'Akzeptiert' ? 'selected' : ''}>âœ… Akzeptiert</option>
                                        <option value="Abgelehnt" ${currentVertrag.vertrag_status === 'Abgelehnt' || currentVertrag.status === 'Abgelehnt' ? 'selected' : ''}>âŒ Abgelehnt</option>
                                        <option value="Storniert" ${currentVertrag.vertrag_status === 'Storniert' || currentVertrag.status === 'Storniert' ? 'selected' : ''}>ğŸš« Storniert (vom Kunden)</option>
                                    </select>
                                </div>
                                <div>
                                    <strong>Auszahlung:</strong>
                                    <select id="vertragAuszahlungSelect" style="margin-left: 10px; padding: 8px 15px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px; font-weight: 600;">
                                        <option value="Noch offen" ${(currentVertrag.auszahlung_status === 'Noch offen' || !currentVertrag.auszahlung_status) ? 'selected' : ''}>â³ Noch offen</option>
                                        <option value="Ausgezahlt" ${currentVertrag.auszahlung_status === 'Ausgezahlt' ? 'selected' : ''}>âœ… Ausgezahlt</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <strong>Notizen:</strong>
                                <textarea id="vertragNotizen" rows="4" style="width: 100%; margin-top: 10px; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px; font-family: inherit;">${currentVertrag.notizen || ''}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('vertragDetailModal').style.display = 'block';
        }

        function closeVertragDetailModal() {
            document.getElementById('vertragDetailModal').style.display = 'none';
            currentVertrag = null;
        }

        async function saveVertragChanges() {
            if (!currentVertrag) return;

            const newStatus = document.getElementById('vertragStatusSelect').value;
            const newAuszahlungStatus = document.getElementById('vertragAuszahlungSelect').value;
            const notizen = document.getElementById('vertragNotizen').value;

            try {
                const response = await fetch(`tables/vertragsabschluesse/${currentVertrag.id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        vertrag_status: newStatus,
                        auszahlung_status: newAuszahlungStatus,
                        notizen: notizen
                    })
                });

                if (response.ok) {
                    alert('âœ… Ã„nderungen erfolgreich gespeichert!');
                    
                    // Update currentVertrag with new values
                    currentVertrag.vertrag_status = newStatus;
                    currentVertrag.auszahlung_status = newAuszahlungStatus;
                    currentVertrag.notizen = notizen;
                    
                    // TODO: Bei Status "aktiviert" â†’ Partner benachrichtigen
                    if ((newStatus === 'aktiviert' || newStatus === 'akzeptiert') && 
                        currentVertrag.vertrag_status !== 'aktiviert' && 
                        currentVertrag.vertrag_status !== 'akzeptiert') {
                        console.log('ğŸ“§ Partner-Benachrichtigung fÃ¼r:', currentVertrag.partner_email);
                        // Create notification in benachrichtigungen table
                    }

                    closeVertragDetailModal();
                    
                    // Reload alle relevanten Bereiche
                    if (typeof loadVertraege === 'function') loadVertraege();
                    if (typeof loadSchnellzugriffVertraege === 'function') loadSchnellzugriffVertraege();
                    if (typeof loadAllInOneData === 'function') loadAllInOneData();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to update');
                }
            } catch (error) {
                console.error('Error saving changes:', error);
                alert('âŒ Fehler beim Speichern');
            }
        }

        // Close modal on outside click
        document.getElementById('vertragDetailModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeVertragDetailModal();
            }
        });

        // ====================================
        // ğŸ†• NEWS & AKTIONEN SYSTEM
        // ====================================
        
        function toggleZielgruppeInputs() {
            const zielgruppe = document.getElementById('news-zielgruppe').value;
            const modellGroup = document.getElementById('news-modell-group');
            const partnerGroup = document.getElementById('news-partner-group');
            
            modellGroup.style.display = zielgruppe === 'modell' ? 'block' : 'none';
            partnerGroup.style.display = zielgruppe === 'partner' ? 'block' : 'none';
        }

        // ğŸ†• Partner-Tabelle rendern (mit ALLEN Infos)
        function renderPartnerTable(partners, vertraege = [], dokumente = []) {
            const tbody = document.getElementById('partner-table-body');
            
            if (partners.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" style="padding: 60px; text-align: center; color: #718096;"><i class="fas fa-user-slash" style="font-size: 32px; display: block; margin-bottom: 16px; opacity: 0.3;"></i><p>Keine Partner gefunden</p></td></tr>`;
                return;
            }
            
            // Pagination
            const start = (currentPage - 1) * partnersPerPage;
            const end = start + partnersPerPage;
            const paginatedPartners = partners.slice(start, end);
            
            tbody.innerHTML = '';
            paginatedPartners.forEach(partner => {
                // Status Farbe
                const statusColors = { 'aktiv': '#48bb78', 'neu': '#ed8936', 'inaktiv': '#718096' };
                const statusColor = statusColors[partner.status] || '#718096';
                
                // VertrÃ¤ge zÃ¤hlen
                const partnerVertraege = vertraege.filter(v => v.partner_email === partner.email);
                
                // Dokumente zÃ¤hlen
                const partnerDokumente = dokumente.filter(d => d.partner_id === partner.id);
                const dokumenteStatus = partnerDokumente.length > 0 ? 'âœ…' : 'âŒ';
                
                // IBAN anzeigen
                const iban = partner.iban ? partner.iban.substring(0, 8) + '****' : 'âŒ Nicht hinterlegt';
                
                // Akademie Status
                const akademieStatus = partner.onboarding_akademie ? 'âœ…' : 'âŒ';
                
                // Onboarding Fortschritt
                const onboardingSteps = [
                    partner.onboarding_termin,
                    partner.onboarding_dokumente,
                    partner.onboarding_ausweis,
                    partner.onboarding_bank,
                    partner.onboarding_akademie
                ];
                const completed = onboardingSteps.filter(Boolean).length;
                const progress = Math.round((completed / 5) * 100);
                
                // âœ… NEU-Badge (Partner < 4 Tage)
                const registriertDatum = partner.created_at || partner.registriert_am;
                const daysSinceRegistration = registriertDatum ? Math.floor((Date.now() - new Date(registriertDatum).getTime()) / (1000 * 60 * 60 * 24)) : 999;
                const isNew = daysSinceRegistration <= 4;
                const beitrittsDatum = registriertDatum ? new Date(registriertDatum).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' }) : 'Unbekannt';
                
                // ğŸ†• BESTANDS-PARTNER ERKENNUNG
                const istBestandsPartner = partner.ist_bestandspartner === true || partner.ist_affiliate === true;
                const erstLoginDatum = partner.erst_login ? new Date(partner.erst_login).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : null;
                
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #e2e8f0';
                row.style.transition = 'background 0.2s';
                row.onmouseover = () => row.style.background = '#f7fafc';
                row.onmouseout = () => row.style.background = 'white';
                
                // Bestands-Partner Badge
                let partnerBadges = '';
                if (istBestandsPartner) {
                    partnerBadges += '<span style="background: linear-gradient(135deg, #9f7aea, #805ad5); color: white; padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; letter-spacing: 0.5px;">BESTAND</span> ';
                }
                if (isNew && !istBestandsPartner) {
                    partnerBadges += '<span style="background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; letter-spacing: 0.5px;">NEU</span>';
                }
                if (erstLoginDatum) {
                    partnerBadges += '<span style="background: linear-gradient(135deg, #48bb78, #38a169); color: white; padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; margin-left: 4px;">âœ“ LOGIN</span>';
                }
                // ğŸ” Passwort-Status fÃ¼r Bestands-Partner
                if (istBestandsPartner && partner.passwort_muss_geaendert_werden !== false) {
                    partnerBadges += '<span style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; margin-left: 4px;">âš ï¸ PW</span>';
                }
                
                row.innerHTML = `
                    <td style="padding: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: ${istBestandsPartner ? '#9f7aea' : statusColor}; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; flex-shrink: 0;">
                                ${(partner.vorname || 'P').charAt(0)}${(partner.nachname || '').charAt(0) || ''}
                            </div>
                            <div>
                                <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                                    <span style="font-weight: 600; color: #1a202c; font-size: 14px;">${partner.vorname || ''} ${partner.nachname || ''}</span>
                                    ${partnerBadges}
                                </div>
                                <div style="color: #718096; font-size: 12px;">${partner.email}</div>
                                <div style="color: #a0aec0; font-size: 11px; margin-top: 2px;">
                                    ${istBestandsPartner && erstLoginDatum ? 'ğŸ”‘ Erst-Login: ' + erstLoginDatum : 'ğŸ“… ' + beitrittsDatum}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td style="padding: 12px;">
                        <span style="background: ${statusColor}22; color: ${statusColor}; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;">${(partner.status || 'Aktiv').toUpperCase()}</span>
                    </td>
                    <td style="padding: 12px; font-size: 13px; color: #4a5568;">${partner.modell || '-'}</td>
                    <td style="padding: 12px; font-size: 13px; color: #4a5568; font-family: monospace;">${iban}</td>
                    <td style="padding: 12px; text-align: center; font-size: 18px;">${dokumenteStatus} <span style="font-size: 12px; color: #718096;">(${partnerDokumente.length})</span></td>
                    <td style="padding: 12px; text-align: center; font-size: 18px;">ğŸ“„ <span style="font-size: 12px; color: #718096;">${partnerVertraege.length}</span></td>
                    <td style="padding: 12px; text-align: center; font-size: 18px;">${akademieStatus}</td>
                    <td style="padding: 12px; text-align: center;">
                        <div style="display: flex; align-items: center; gap: 8px; justify-content: center;">
                            <div style="width: 50px; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden;">
                                <div style="width: ${progress}%; height: 100%; background: ${progress === 100 ? '#48bb78' : '#3b82f6'}; transition: width 0.3s;"></div>
                            </div>
                            <span style="font-size: 12px; color: #718096; font-weight: 600;">${progress}%</span>
                        </div>
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <div style="display: flex; gap: 6px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="viewPartnerDetailsComplete('${partner.id}', '${partner.email}')" style="padding: 8px 14px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#5568d3'" onmouseout="this.style.background='#3b82f6'" title="Alle Details anzeigen">
                                <i class="fas fa-eye"></i> Details
                            </button>
                            <button onclick="deletePartner('${partner.id}', '${partner.vorname} ${partner.nachname}')" style="padding: 8px 12px; background: #f56565; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#e53e3e'" onmouseout="this.style.background='#f56565'" title="Partner lÃ¶schen">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Pagination Info
            const infoEl = document.getElementById('partner-pagination-info');
            infoEl.textContent = `Zeige ${start + 1}-${Math.min(end, partners.length)} von ${partners.length} Partnern`;
            
            // Pagination Controls
            const totalPages = Math.ceil(partners.length / partnersPerPage);
            const controlsEl = document.getElementById('partner-pagination-controls');
            controlsEl.innerHTML = '';
            
            if (totalPages > 1) {
                // Previous Button
                const prevBtn = document.createElement('button');
                prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                prevBtn.disabled = currentPage === 1;
                prevBtn.onclick = () => { currentPage--; renderPartnerTable(partners, vertraege, dokumente); };
                prevBtn.style.cssText = `padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 6px; cursor: pointer; background: white; ${currentPage === 1 ? 'opacity: 0.5; cursor: not-allowed;' : ''}`;
                controlsEl.appendChild(prevBtn);
                
                // Page Numbers (nur 5 zeigen)
                const startPage = Math.max(1, currentPage - 2);
                const endPage = Math.min(totalPages, startPage + 4);
                
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.textContent = i;
                    pageBtn.onclick = () => { currentPage = i; renderPartnerTable(partners, vertraege, dokumente); };
                    pageBtn.style.cssText = `padding: 8px 12px; border: 2px solid ${i === currentPage ? '#3b82f6' : '#e2e8f0'}; border-radius: 6px; cursor: pointer; background: ${i === currentPage ? '#3b82f6' : 'white'}; color: ${i === currentPage ? 'white' : '#4a5568'}; font-weight: 600;`;
                    controlsEl.appendChild(pageBtn);
                }
                
                // Next Button
                const nextBtn = document.createElement('button');
                nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                nextBtn.disabled = currentPage === totalPages;
                nextBtn.onclick = () => { currentPage++; renderPartnerTable(partners, vertraege, dokumente); };
                nextBtn.style.cssText = `padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 6px; cursor: pointer; background: white; ${currentPage === totalPages ? 'opacity: 0.5; cursor: not-allowed;' : ''}`;
                controlsEl.appendChild(nextBtn);
            }
        }
        
        // ğŸ†• Filter-Funktion
        function filterPartner() {
            const statusFilter = document.getElementById('filter-status').value;
            const modellFilter = document.getElementById('filter-modell').value;
            const onboardingFilter = document.getElementById('filter-onboarding').value;
            const sortierung = document.getElementById('filter-sortierung')?.value || 'name';
            const searchTerm = document.getElementById('search-partner').value.toLowerCase();
            const vonDatum = document.getElementById('partner-von-datum')?.value;
            const bisDatum = document.getElementById('partner-bis-datum')?.value;
            
            let filtered = allPartners;
            
            // Datum-Filter
            if (vonDatum || bisDatum) {
                filtered = filtered.filter(p => {
                    const pDatum = new Date(p.registriert_am || p.created_at);
                    if (vonDatum && pDatum < new Date(vonDatum)) return false;
                    if (bisDatum && pDatum > new Date(bisDatum)) return false;
                    return true;
                });
            }
            
            // Status, Modell, Onboarding Filter
            if (statusFilter) filtered = filtered.filter(p => p.status === statusFilter);
            if (modellFilter) filtered = filtered.filter(p => p.modell === modellFilter);
            if (onboardingFilter === 'completed') filtered = filtered.filter(p => p.onboarding_completed);
            if (onboardingFilter === 'incomplete') filtered = filtered.filter(p => !p.onboarding_completed);
            
            // Suche
            if (searchTerm) {
                filtered = filtered.filter(p => 
                    p.vorname.toLowerCase().includes(searchTerm) ||
                    p.nachname.toLowerCase().includes(searchTerm) ||
                    p.email.toLowerCase().includes(searchTerm) ||
                    (p.iban && p.iban.toLowerCase().includes(searchTerm))
                );
            }
            
            // ğŸ†• SORTIERUNG
            if (sortierung === 'vertraege') {
                // Nach Anzahl VertrÃ¤ge sortieren (absteigend)
                filtered = filtered.map(p => {
                    const vertraegeCount = allVertraege.filter(v => 
                        v.partner_email && v.partner_email.toLowerCase() === p.email.toLowerCase()
                    ).length;
                    return { ...p, vertraegeCount };
                }).sort((a, b) => b.vertraegeCount - a.vertraegeCount);
            } else if (sortierung === 'provision') {
                // Nach Provision sortieren (absteigend)
                filtered = filtered.map(p => {
                    const provision = allVertraege
                        .filter(v => v.partner_email && v.partner_email.toLowerCase() === p.email.toLowerCase())
                        .reduce((sum, v) => sum + parseFloat(v.gesamt_provision || v.provision || 0), 0);
                    return { ...p, provision };
                }).sort((a, b) => b.provision - a.provision);
            } else if (sortierung === 'datum') {
                // Nach Datum sortieren (neueste zuerst)
                filtered = filtered.sort((a, b) => 
                    new Date(b.registriert_am || b.created_at) - new Date(a.registriert_am || a.created_at)
                );
            } else {
                // Nach Name sortieren (A-Z)
                filtered = filtered.sort((a, b) => 
                    (a.vorname + ' ' + a.nachname).localeCompare(b.vorname + ' ' + b.nachname)
                );
            }
            
            currentPage = 1; // Reset to first page
            renderPartnerTable(filtered, allVertraege, allDokumente); // âœ… Global verwenden
        }
        
        // ğŸ† ZIEL-ERREICHUNG & STATISTIK LADEN
        let allZielData = [];
        async function loadZielErreichung() {
            console.log('ğŸ† Lade Ziel-Erreichung...');
            const tbody = document.getElementById('ziel-table-body');
            if (!tbody) return;
            
            // Loading State
            tbody.innerHTML = `<tr><td colspan="8" style="padding: 60px; text-align: center; color: #718096;"><i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 16px; display: block;"></i><p style="margin: 0;">Lade Ziel-Erreichung...</p></td></tr>`;
            
            try {
                // Lade Partner & VertrÃ¤ge
                const [partnerRes, vertraegeRes] = await Promise.all([
                    fetch('tables/partners?limit=1000', { cache: 'no-store' }),
                    fetch('tables/vertragsabschluesse?limit=5000', { cache: 'no-store' })
                ]);
                
                const partners = (await partnerRes.json()).data || [];
                const vertraege = (await vertraegeRes.json()).data || [];
                
                console.log('âœ… Ziel-Erreichung: Partner geladen:', partners.length);
                console.log('âœ… Ziel-Erreichung: VertrÃ¤ge geladen:', vertraege.length);
                
                // Berechne Fortschritt pro Partner
                allZielData = partners.map(partner => {
                    const partnerVertraege = Array.isArray(vertraege) ? vertraege.filter(v => 
                        v.partner_email && v.partner_email.toLowerCase() === partner.email.toLowerCase()
                    ) : [];
                    
                    // ZÃ¤hle pro Kategorie
                    let mobilfunk = 0, internet = 0, strom = 0;
                    partnerVertraege.forEach(v => {
                        const product = (v.produkt || v.anbieter || v.kategorie || '').toUpperCase();
                        if (product.includes('MOBILFUNK') || product.includes('HANDY') || product.includes('FREENET') || product.includes('AYILDIZ') || product.includes('VODAFONE') || product.includes('TELEKOM') || product.includes('O2')) {
                            mobilfunk++;
                        } else if (product.includes('DSL') || product.includes('INTERNET') || product.includes('KABEL') || product.includes('GLASFASER')) {
                            internet++;
                        } else if (product.includes('STROM') || product.includes('ENERGIE') || product.includes('POWER')) {
                            strom++;
                        } else {
                            mobilfunk++; // Fallback
                        }
                    });
                    
                    // Staffeln prÃ¼fen
                    let staffel = 'Keine';
                    let bonus = 0;
                    let progress = 0;
                    
                    if (mobilfunk >= 10 && internet >= 10 && strom >= 5) {
                        staffel = 'Staffel 2';
                        bonus = 750;
                        progress = 100;
                    } else if (mobilfunk >= 10) {
                        staffel = 'Staffel 1';
                        bonus = 300;
                        progress = 50;
                    } else {
                        progress = Math.min(Math.round((mobilfunk / 10) * 50), 49);
                    }
                    
                    return {
                        partner,
                        mobilfunk,
                        internet,
                        strom,
                        gesamt: mobilfunk + internet + strom,
                        staffel,
                        bonus,
                        progress
                    };
                });
                
                // Sortiere nach Gesamt-VertrÃ¤gen (absteigend)
                allZielData.sort((a, b) => b.gesamt - a.gesamt);
                
                // Berechne Statistiken
                const staffel1Count = allZielData.filter(d => d.staffel === 'Staffel 1' || d.staffel === 'Staffel 2').length;
                const staffel2Count = allZielData.filter(d => d.staffel === 'Staffel 2').length;
                const avgProgress = allZielData.length > 0 
                    ? Math.round(allZielData.reduce((sum, d) => sum + d.progress, 0) / allZielData.length) 
                    : 0;
                const totalBonus = allZielData.reduce((sum, d) => sum + d.bonus, 0);
                
                // âœ… Beide Sets von IDs aktualisieren (tab-ziel-erreichung UND all-in-one Tab)
                const setTextContent = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value;
                };
                
                // Original IDs (tab-ziel-erreichung)
                setTextContent('stat-staffel1', staffel1Count);
                setTextContent('stat-staffel2', staffel2Count);
                setTextContent('stat-avg-progress', avgProgress + '%');
                setTextContent('stat-total-bonus', totalBonus.toLocaleString('de-DE') + 'â‚¬');
                
                // Alternative IDs mit -all Suffix (all-in-one Tab)
                setTextContent('stat-staffel1-all', staffel1Count);
                setTextContent('stat-staffel2-all', staffel2Count);
                setTextContent('stat-avg-progress-all', avgProgress + '%');
                setTextContent('stat-total-bonus-all', totalBonus.toLocaleString('de-DE') + 'â‚¬');
                
                // Tabelle rendern (mit Pagination)
                filteredZielData = allZielData;
                zielCurrentPage = 1;
                renderZielPage();
                
                // âœ… Auch die alternative Tabelle aktualisieren (all-in-one Tab)
                renderZielTableAll(allZielData);
                
                console.log('âœ… Ziel-Erreichung geladen:', allZielData.length, 'Partner');
            } catch (error) {
                console.error('âŒ Fehler beim Laden der Ziel-Erreichung:', error);
                tbody.innerHTML = `<tr><td colspan="8" style="padding: 40px; text-align: center; color: #f56565;">Fehler beim Laden: ${error.message}</td></tr>`;
            }
        }
        
        function renderZielTable(data) {
            const tbody = document.getElementById('ziel-table-body');
            if (!tbody || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="padding: 40px; text-align: center; color: #718096;">Keine Partner gefunden</td></tr>`;
                return;
            }
            
            tbody.innerHTML = data.map(d => {
                const p = d.partner;
                const progressColor = d.progress >= 100 ? '#10b981' : d.progress >= 50 ? '#ff9500' : '#3b82f6';
                const staffelBadge = d.staffel === 'Staffel 2' 
                    ? `<span style="background: linear-gradient(135deg, #ff9500, #ff5e3a); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700;">ğŸ† Staffel 2</span>`
                    : d.staffel === 'Staffel 1'
                    ? `<span style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700;">âœ… Staffel 1</span>`
                    : `<span style="background: #e2e8f0; color: #718096; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">â³ In Arbeit</span>`;
                
                return `
                    <tr style="border-bottom: 1px solid #e2e8f0; transition: background 0.2s;" onmouseover="this.style.background='#f7fafc'" onmouseout="this.style.background='white'">
                        <td style="padding: 16px 12px;">
                            <div style="font-weight: 600; color: #1a202c;">${p.vorname} ${p.nachname}</div>
                            <div style="font-size: 12px; color: #718096; margin-top: 2px;">${p.email}</div>
                        </td>
                        <td style="padding: 16px 12px; text-align: center;">
                            <span style="background: #f7fafc; padding: 4px 10px; border-radius: 6px; font-size: 13px; font-weight: 500;">${p.modell || 'N/A'}</span>
                        </td>
                        <td style="padding: 16px 12px; text-align: center;">
                            <span style="font-weight: 700; color: ${d.mobilfunk >= 10 ? '#10b981' : '#3b82f6'}; font-size: 18px;">${d.mobilfunk}</span>
                        </td>
                        <td style="padding: 16px 12px; text-align: center;">
                            <span style="font-weight: 700; color: ${d.internet >= 10 ? '#10b981' : '#3b82f6'}; font-size: 18px;">${d.internet}</span>
                        </td>
                        <td style="padding: 16px 12px; text-align: center;">
                            <span style="font-weight: 700; color: ${d.strom >= 5 ? '#10b981' : '#3b82f6'}; font-size: 18px;">${d.strom}</span>
                        </td>
                        <td style="padding: 16px 12px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="flex: 1; background: #e2e8f0; border-radius: 8px; height: 8px; overflow: hidden;">
                                    <div style="background: ${progressColor}; height: 100%; width: ${d.progress}%; transition: width 0.3s;"></div>
                                </div>
                                <span style="font-weight: 700; color: ${progressColor}; font-size: 14px; min-width: 45px;">${d.progress}%</span>
                            </div>
                        </td>
                        <td style="padding: 16px 12px; text-align: center;">
                            ${staffelBadge}
                        </td>
                        <td style="padding: 16px 12px; text-align: center;">
                            <span style="font-weight: 700; color: ${d.bonus > 0 ? '#ffa500' : '#718096'}; font-size: 16px;">${d.bonus}â‚¬</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // âœ… Tabelle fÃ¼r all-in-one Tab rendern (mit ID: ziel-table-body-all)
        function renderZielTableAll(data) {
            const tbody = document.getElementById('ziel-table-body-all');
            if (!tbody) {
                console.log('âš ï¸ ziel-table-body-all nicht gefunden');
                return;
            }
            
            if (!data || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="padding: 40px; text-align: center; color: #718096;">Keine Partner gefunden</td></tr>`;
                return;
            }
            
            // Zeige max. 10 Partner in der all-in-one Ãœbersicht
            const limitedData = data.slice(0, 10);
            
            tbody.innerHTML = limitedData.map(d => {
                const p = d.partner;
                const progressColor = d.progress >= 100 ? '#10b981' : d.progress >= 50 ? '#ff9500' : '#3b82f6';
                const staffelBadge = d.staffel === 'Staffel 2' 
                    ? `<span style="background: linear-gradient(135deg, #ff9500, #ff5e3a); color: white; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700;">ğŸ† Staffel 2</span>`
                    : d.staffel === 'Staffel 1'
                    ? `<span style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700;">âœ… Staffel 1</span>`
                    : `<span style="background: #e2e8f0; color: #718096; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;">â³ In Arbeit</span>`;
                
                return `
                    <tr>
                        <td style="padding: 12px 10px;">
                            <div style="font-weight: 600; color: #1a202c; font-size: 14px;">${p.vorname || ''} ${p.nachname || ''}</div>
                            <div style="font-size: 11px; color: #718096;">${p.email || 'N/A'}</div>
                        </td>
                        <td style="padding: 12px 10px; text-align: center;">
                            <span style="font-size: 12px;">${p.modell || 'N/A'}</span>
                        </td>
                        <td style="padding: 12px 10px; text-align: center;">
                            <span style="font-weight: 700; color: ${d.mobilfunk >= 10 ? '#10b981' : '#3b82f6'};">${d.mobilfunk}</span>
                        </td>
                        <td style="padding: 12px 10px; text-align: center;">
                            <span style="font-weight: 700; color: ${d.internet >= 10 ? '#10b981' : '#3b82f6'};">${d.internet}</span>
                        </td>
                        <td style="padding: 12px 10px; text-align: center;">
                            <span style="font-weight: 700; color: ${d.strom >= 5 ? '#10b981' : '#3b82f6'};">${d.strom}</span>
                        </td>
                        <td style="padding: 12px 10px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="flex: 1; background: #e2e8f0; border-radius: 6px; height: 6px; overflow: hidden; min-width: 80px;">
                                    <div style="background: ${progressColor}; height: 100%; width: ${d.progress}%;"></div>
                                </div>
                                <span style="font-weight: 600; color: ${progressColor}; font-size: 12px;">${d.progress}%</span>
                            </div>
                        </td>
                        <td style="padding: 12px 10px; text-align: center;">${staffelBadge}</td>
                        <td style="padding: 12px 10px; text-align: center;">
                            <span style="font-weight: 700; color: ${d.bonus > 0 ? '#ffa500' : '#718096'};">${d.bonus}â‚¬</span>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Hinweis wenn mehr als 10 Partner
            if (data.length > 10) {
                tbody.innerHTML += `
                    <tr>
                        <td colspan="8" style="padding: 12px; text-align: center; color: #718096; font-size: 13px; background: #f7fafc;">
                            ... und ${data.length - 10} weitere Partner
                        </td>
                    </tr>
                `;
            }
            
            console.log('âœ… Ziel-Tabelle (all-in-one) gerendert:', limitedData.length, 'von', data.length, 'Partnern');
        }
        
        // âœ… PAGINATION FÃœR ZIEL-ERREICHUNG
        let filteredZielData = [];
        let zielCurrentPage = 1;
        const zielItemsPerPage = 20; // 20 Partner pro Seite
        
        function filterZielErreichung() {
            const staffelFilter = document.getElementById('filter-staffel').value;
            const searchTerm = document.getElementById('search-ziel').value.toLowerCase();
            
            let filtered = allZielData;
            
            if (staffelFilter === 'staffel1') {
                filtered = filtered.filter(d => d.staffel === 'Staffel 1' || d.staffel === 'Staffel 2');
            } else if (staffelFilter === 'staffel2') {
                filtered = filtered.filter(d => d.staffel === 'Staffel 2');
            } else if (staffelFilter === 'none') {
                filtered = filtered.filter(d => d.staffel === 'Keine');
            }
            
            if (searchTerm) {
                filtered = filtered.filter(d => 
                    d.partner.vorname.toLowerCase().includes(searchTerm) ||
                    d.partner.nachname.toLowerCase().includes(searchTerm) ||
                    d.partner.email.toLowerCase().includes(searchTerm)
                );
            }
            
            filteredZielData = filtered;
            zielCurrentPage = 1; // Reset zu Seite 1
            renderZielPage();
        }
        
        function renderZielPage() {
            const start = (zielCurrentPage - 1) * zielItemsPerPage;
            const end = start + zielItemsPerPage;
            const pageData = filteredZielData.slice(start, end);
            
            renderZielTable(pageData);
            
            // Pagination Info
            const totalPages = Math.ceil(filteredZielData.length / zielItemsPerPage);
            document.getElementById('ziel-page-info').textContent = `Seite ${zielCurrentPage} von ${totalPages} (${filteredZielData.length} Partner)`;
        }
        
        function zielPrevPage() {
            if (zielCurrentPage > 1) {
                zielCurrentPage--;
                renderZielPage();
            }
        }
        
        function zielNextPage() {
            const totalPages = Math.ceil(filteredZielData.length / zielItemsPerPage);
            if (zielCurrentPage < totalPages) {
                zielCurrentPage++;
                renderZielPage();
            }
        }
        
        // ğŸ†• Partner Details anzeigen (simple Version)
        // âœ… NEUE FUNKTION: Kompletter Detail-View (VertrÃ¤ge + Provisionen + Onboarding + Bank + ALLES)
        async function viewPartnerDetailsComplete(partnerIdOrObject, partnerEmail) {
            // Flexibel: Akzeptiere entweder ID oder komplettes Partner-Objekt
            let partner;
            if (typeof partnerIdOrObject === 'object') {
                // Partner-Objekt wurde Ã¼bergeben
                partner = partnerIdOrObject;
            } else {
                // Partner-ID wurde Ã¼bergeben
                partner = allPartners.find(p => p.id === partnerIdOrObject);
            }
            
            if (!partner) {
                showToast('âŒ Fehler', 'Partner nicht gefunden', 'error');
                return;
            }
            
            // Modal erstellen
            const modal = document.createElement('div');
            modal.id = 'complete-partner-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); padding: 20px;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            const content = document.createElement('div');
            content.style.cssText = 'background: white; border-radius: 16px; max-width: 1000px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);';
            
            // Loading State
            content.innerHTML = `
                <div style="padding: 40px; text-align: center;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #3b82f6; margin-bottom: 20px;"></i>
                    <p style="font-size: 18px; color: #718096;">Lade vollstÃ¤ndige Partner-Daten...</p>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            try {
                // Parallel: Alle Daten laden
                const [vertraegeRes, provisionenRes, dokumenteRes] = await Promise.all([
                    fetch(`tables/vertragsabschluesse?limit=500`).then(r => r.json()).catch(() => ({data: []})),
                    fetch(`tables/provisionen?limit=500`).then(r => r.json()).catch(() => ({data: []})),
                    fetch(`tables/dokumente?limit=500`).then(r => r.json()).catch(() => ({data: []}))
                ]);
                
                const vertraege = vertraegeRes.data.filter(v => v.partner_email === partnerEmail);
                const provisionen = provisionenRes.data.filter(p => p.partner_email === partnerEmail);
                const dokumente = dokumenteRes.data.filter(d => d.partner_email === partnerEmail);
                
                // Berechnungen
                const gesamtProvision = provisionen.reduce((sum, p) => sum + (parseFloat(p.betrag) || 0), 0);
                const ausgezahlt = provisionen.filter(p => p.status === 'ausgezahlt').reduce((sum, p) => sum + (parseFloat(p.betrag) || 0), 0);
                const ausstehend = gesamtProvision - ausgezahlt;
                
                // Onboarding-Status
                const onboardingSteps = {
                    'Termin vereinbart': partner.onboarding_termin || false,
                    'Dokumente hochgeladen': partner.onboarding_dokumente || false,
                    'Ausweis verifiziert': partner.onboarding_ausweis || false,
                    'Bankverbindung': partner.onboarding_bank || false,
                    'Akademie abgeschlossen': partner.onboarding_akademie || false,
                    'Vertrag unterschrieben': partner.onboarding_abschluss || false
                };
                const completedSteps = Object.values(onboardingSteps).filter(Boolean).length;
                const totalSteps = Object.keys(onboardingSteps).length;
                const onboardingProgress = Math.round((completedSteps / totalSteps) * 100);
                
                // NEU-Badge
                const registriertDatum = partner.created_at || partner.registriert_am;
                const daysSinceReg = registriertDatum ? Math.floor((Date.now() - new Date(registriertDatum).getTime()) / (1000 * 60 * 60 * 24)) : 999;
                const isNew = daysSinceReg <= 4;
                
                // Render Complete View
                content.innerHTML = `
                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); padding: 32px; color: white; border-radius: 16px 16px 0 0; position: relative;">
                        <button onclick="document.getElementById('complete-partner-modal').remove()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                            <i class="fas fa-times"></i>
                        </button>
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div style="width: 80px; height: 80px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 700; border: 4px solid rgba(255,255,255,0.3);">
                                ${(partner.vorname || 'P').charAt(0)}${(partner.nachname || '').charAt(0) || ''}
                            </div>
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                    <h2 style="margin: 0; font-size: 28px; font-weight: 700;">${partner.vorname || ''} ${partner.nachname || ''}</h2>
                                    ${isNew ? '<span style="background: rgba(255,255,255,0.3); padding: 4px 12px; border-radius: 8px; font-size: 12px; font-weight: 700; letter-spacing: 0.5px;">ğŸ†• NEU</span>' : ''}
                                </div>
                                <div style="font-size: 16px; opacity: 0.9; margin-bottom: 4px;">${partner.email}</div>
                                <div style="font-size: 14px; opacity: 0.8;">Beigetreten: ${registriertDatum ? new Date(registriertDatum).toLocaleDateString('de-DE', {day: '2-digit', month: 'long', year: 'numeric'}) : 'Unbekannt'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="padding: 32px;">
                        <!-- Stats Grid -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px;">
                            <div style="background: linear-gradient(135deg, #3b82f615, #3b82f605); border: 2px solid #3b82f630; border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #3b82f6; margin-bottom: 8px;">${vertraege.length}</div>
                                <div style="font-size: 13px; color: #718096; font-weight: 600;">VertrÃ¤ge</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #48bb7815, #48bb7805); border: 2px solid #48bb7830; border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #48bb78; margin-bottom: 8px;">${gesamtProvision.toFixed(2)}â‚¬</div>
                                <div style="font-size: 13px; color: #718096; font-weight: 600;">Gesamt Provision</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #ed893615, #ed893605); border: 2px solid #ed893630; border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #ed8936; margin-bottom: 8px;">${ausstehend.toFixed(2)}â‚¬</div>
                                <div style="font-size: 13px; color: #718096; font-weight: 600;">Ausstehend</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #4299e115, #4299e105); border: 2px solid #4299e130; border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #4299e1; margin-bottom: 8px;">${onboardingProgress}%</div>
                                <div style="font-size: 13px; color: #718096; font-weight: 600;">Onboarding</div>
                            </div>
                        </div>
                        
                        <!-- Tabs -->
                        <div style="border-bottom: 2px solid #e2e8f0; margin-bottom: 24px;">
                            <div style="display: flex; gap: 8px;">
                                <button onclick="switchPartnerTab('info')" class="partner-tab-btn active" data-tab="info" style="padding: 12px 24px; background: none; border: none; border-bottom: 3px solid #3b82f6; color: #3b82f6; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                    <i class="fas fa-user"></i> Info
                                </button>
                                <button onclick="switchPartnerTab('vertraege')" class="partner-tab-btn" data-tab="vertraege" style="padding: 12px 24px; background: none; border: none; border-bottom: 3px solid transparent; color: #718096; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                    <i class="fas fa-file-contract"></i> VertrÃ¤ge (${vertraege.length})
                                </button>
                                <button onclick="switchPartnerTab('onboarding')" class="partner-tab-btn" data-tab="onboarding" style="padding: 12px 24px; background: none; border: none; border-bottom: 3px solid transparent; color: #718096; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                    <i class="fas fa-tasks"></i> Onboarding
                                </button>
                                <button onclick="switchPartnerTab('bank')" class="partner-tab-btn" data-tab="bank" style="padding: 12px 24px; background: none; border: none; border-bottom: 3px solid transparent; color: #718096; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                    <i class="fas fa-university"></i> Bank
                                </button>
                                <button onclick="switchPartnerTab('akademie')" class="partner-tab-btn" data-tab="akademie" style="padding: 12px 24px; background: none; border: none; border-bottom: 3px solid transparent; color: #718096; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                    <i class="fas fa-graduation-cap"></i> Akademie
                                </button>
                                <button onclick="switchPartnerTab('dokumente')" class="partner-tab-btn" data-tab="dokumente" style="padding: 12px 24px; background: none; border: none; border-bottom: 3px solid transparent; color: #718096; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                    <i class="fas fa-file-alt"></i> Dokumente (${dokumente.length})
                                </button>
                            </div>
                        </div>
                        
                        <!-- Tab Content -->
                        <div id="partner-tab-content">
                            <!-- Info Tab (Default) - ALLE GRUNDLEGENDEN INFORMATIONEN -->
                            <div class="partner-tab-content" data-content="info">
                                <div style="display: grid; gap: 20px;">
                                    <!-- PersÃ¶nliche Daten -->
                                    <div style="background: #f7fafc; border-radius: 12px; padding: 24px;">
                                        <h3 style="font-size: 18px; font-weight: 700; color: #1a202c; margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
                                            <i class="fas fa-user" style="color: #3b82f6;"></i> PersÃ¶nliche Daten
                                        </h3>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                            <div style="background: white; padding: 16px; border-radius: 10px; border: 2px solid #e2e8f0;">
                                                <div style="font-size: 11px; color: #718096; text-transform: uppercase; margin-bottom: 6px;">Vorname</div>
                                                <div style="font-size: 16px; font-weight: 700; color: #1a202c;">${partner.vorname || '-'}</div>
                                            </div>
                                            <div style="background: white; padding: 16px; border-radius: 10px; border: 2px solid #e2e8f0;">
                                                <div style="font-size: 11px; color: #718096; text-transform: uppercase; margin-bottom: 6px;">Nachname</div>
                                                <div style="font-size: 16px; font-weight: 700; color: #1a202c;">${partner.nachname || '-'}</div>
                                            </div>
                                            <div style="background: white; padding: 16px; border-radius: 10px; border: 2px solid #e2e8f0;">
                                                <div style="font-size: 11px; color: #718096; text-transform: uppercase; margin-bottom: 6px;">E-Mail</div>
                                                <div style="font-size: 15px; font-weight: 700; color: #3b82f6;"><a href="mailto:${partner.email}" style="color: #3b82f6; text-decoration: none;">${partner.email || '-'}</a></div>
                                            </div>
                                            <div style="background: white; padding: 16px; border-radius: 10px; border: 2px solid #e2e8f0;">
                                                <div style="font-size: 11px; color: #718096; text-transform: uppercase; margin-bottom: 6px;">Telefon</div>
                                                <div style="font-size: 16px; font-weight: 700; color: #1a202c;">${partner.phone || partner.telefon || 'âŒ Nicht hinterlegt'}</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Adresse -->
                                    <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-radius: 12px; padding: 24px; border: 2px solid #6ee7b7;">
                                        <h3 style="font-size: 18px; font-weight: 700; color: #065f46; margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
                                            <i class="fas fa-map-marker-alt" style="color: #10b981;"></i> Adresse
                                        </h3>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                                            <div style="background: white; padding: 16px; border-radius: 10px; grid-column: span 2;">
                                                <div style="font-size: 11px; color: #718096; text-transform: uppercase; margin-bottom: 6px;">StraÃŸe</div>
                                                <div style="font-size: 16px; font-weight: 700; color: #1a202c;">${partner.adresse || partner.strasse || '-'}</div>
                                            </div>
                                            <div style="background: white; padding: 16px; border-radius: 10px;">
                                                <div style="font-size: 11px; color: #718096; text-transform: uppercase; margin-bottom: 6px;">PLZ</div>
                                                <div style="font-size: 16px; font-weight: 700; color: #1a202c;">${partner.plz || '-'}</div>
                                            </div>
                                            <div style="background: white; padding: 16px; border-radius: 10px;">
                                                <div style="font-size: 11px; color: #718096; text-transform: uppercase; margin-bottom: 6px;">Stadt</div>
                                                <div style="font-size: 16px; font-weight: 700; color: #1a202c;">${partner.stadt || partner.ort || '-'}</div>
                                            </div>
                                            <div style="background: white; padding: 16px; border-radius: 10px;">
                                                <div style="font-size: 11px; color: #718096; text-transform: uppercase; margin-bottom: 6px;">Land</div>
                                                <div style="font-size: 16px; font-weight: 700; color: #1a202c;">${partner.land || 'DE'}</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- GeschÃ¤ftsdaten -->
                                    <div style="background: #f7fafc; border-radius: 12px; padding: 24px;">
                                        <h3 style="font-size: 18px; font-weight: 700; color: #1a202c; margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
                                            <i class="fas fa-briefcase" style="color: #f59e0b;"></i> GeschÃ¤ftsdaten
                                        </h3>
                                        <div style="display: grid; gap: 12px;">
                                            <div style="display: flex; justify-content: space-between; padding: 12px 16px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                                                <span style="color: #718096; font-weight: 600;">Status:</span>
                                                <span style="font-weight: 700; color: ${partner.status === 'aktiv' ? '#48bb78' : '#ed8936'}; text-transform: uppercase;">${partner.status || '-'}</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 12px 16px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                                                <span style="color: #718096; font-weight: 600;">Partner-Modell:</span>
                                                <span style="font-weight: 700; color: #1a202c; text-transform: capitalize;">${partner.modell || 'Nicht festgelegt'}</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 12px 16px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                                                <span style="color: #718096; font-weight: 600;">Firma:</span>
                                                <span style="font-weight: 700; color: #1a202c;">${partner.firma || '-'}</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 12px 16px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                                                <span style="color: #718096; font-weight: 600;">Tarif:</span>
                                                <span style="font-weight: 700; color: #1a202c;">${partner.tarif || 'Standard'}</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 12px 16px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                                                <span style="color: #718096; font-weight: 600;">Referral Code:</span>
                                                <span style="font-weight: 700; color: #8b5cf6; font-family: monospace;">${partner.referral_code || '-'}</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 12px 16px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                                                <span style="color: #718096; font-weight: 600;">Registriert am:</span>
                                                <span style="font-weight: 700; color: #1a202c;">${registriertDatum ? new Date(registriertDatum).toLocaleDateString('de-DE', {weekday: 'long', day: '2-digit', month: 'long', year: 'numeric'}) : 'Unbekannt'}</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Affiliate-Daten (nur wenn Affiliate) -->
                                    ${partner.ist_affiliate || partner.modell === 'affiliate' ? `
                                    <div style="background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%); border-radius: 12px; padding: 24px; border: 2px solid #f9a8d4;">
                                        <h3 style="font-size: 18px; font-weight: 700; color: #9d174d; margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
                                            <i class="fas fa-link" style="color: #ec4899;"></i> Affiliate-Daten
                                        </h3>
                                        <div style="display: grid; gap: 12px;">
                                            ${partner.referral_code ? `
                                            <div style="display: flex; justify-content: space-between; padding: 12px 16px; background: white; border-radius: 8px;">
                                                <span style="color: #9d174d; font-weight: 600;">Referral Code:</span>
                                                <span style="font-weight: 700; color: #9d174d; font-family: monospace; font-size: 16px;">${partner.referral_code}</span>
                                            </div>
                                            ` : ''}
                                            ${partner.standard_link ? `
                                            <div style="padding: 12px 16px; background: white; border-radius: 8px;">
                                                <div style="color: #9d174d; font-weight: 600; margin-bottom: 6px;">Standard Link:</div>
                                                <a href="${partner.standard_link}" target="_blank" style="color: #3b82f6; word-break: break-all; font-size: 13px;">${partner.standard_link}</a>
                                            </div>
                                            ` : ''}
                                            ${partner.parent_name || partner.parent_email ? `
                                            <div style="display: flex; justify-content: space-between; padding: 12px 16px; background: white; border-radius: 8px;">
                                                <span style="color: #9d174d; font-weight: 600;">Geworbener von:</span>
                                                <span style="font-weight: 700; color: #9d174d;">${partner.parent_name || ''} ${partner.parent_email ? '(' + partner.parent_email + ')' : ''}</span>
                                            </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    ` : ''}
                                    
                                    <!-- Social Media (wenn vorhanden) -->
                                    ${partner.website || partner.facebook || partner.instagram || partner.youtube || partner.tiktok ? `
                                    <div style="background: #f7fafc; border-radius: 12px; padding: 24px;">
                                        <h3 style="font-size: 18px; font-weight: 700; color: #1a202c; margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
                                            <i class="fas fa-globe" style="color: #6366f1;"></i> Online-PrÃ¤senz
                                        </h3>
                                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                            ${partner.website ? `<a href="${partner.website}" target="_blank" style="display: flex; align-items: center; gap: 6px; padding: 10px 16px; background: white; border: 2px solid #e2e8f0; border-radius: 8px; text-decoration: none; color: #1a202c; font-size: 14px; font-weight: 600;"><i class="fas fa-globe" style="color: #3b82f6;"></i> Website</a>` : ''}
                                            ${partner.facebook ? `<a href="${partner.facebook}" target="_blank" style="display: flex; align-items: center; gap: 6px; padding: 10px 16px; background: #1877f2; border-radius: 8px; text-decoration: none; color: white; font-size: 14px; font-weight: 600;"><i class="fab fa-facebook"></i> Facebook</a>` : ''}
                                            ${partner.instagram ? `<a href="${partner.instagram}" target="_blank" style="display: flex; align-items: center; gap: 6px; padding: 10px 16px; background: linear-gradient(45deg, #f09433, #dc2743, #bc1888); border-radius: 8px; text-decoration: none; color: white; font-size: 14px; font-weight: 600;"><i class="fab fa-instagram"></i> Instagram</a>` : ''}
                                            ${partner.youtube ? `<a href="${partner.youtube}" target="_blank" style="display: flex; align-items: center; gap: 6px; padding: 10px 16px; background: #ff0000; border-radius: 8px; text-decoration: none; color: white; font-size: 14px; font-weight: 600;"><i class="fab fa-youtube"></i> YouTube</a>` : ''}
                                            ${partner.tiktok ? `<a href="${partner.tiktok}" target="_blank" style="display: flex; align-items: center; gap: 6px; padding: 10px 16px; background: #000; border-radius: 8px; text-decoration: none; color: white; font-size: 14px; font-weight: 600;"><i class="fab fa-tiktok"></i> TikTok</a>` : ''}
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- VertrÃ¤ge Tab (ERWEITERT!) -->
                            <div class="partner-tab-content" data-content="vertraege" style="display: none;">
                                ${vertraege.length > 0 ? `
                                    <div style="display: grid; gap: 16px;">
                                        ${vertraege.map((v, idx) => `
                                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); border: 2px solid #e2e8f0; transition: all 0.2s; cursor: pointer;" 
                                                 onclick="showVertragDetails('${v.id}')"
                                                 onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 20px rgba(0,0,0,0.12)'; this.style.borderColor='#3b82f6';" 
                                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 12px rgba(0,0,0,0.08)'; this.style.borderColor='#e2e8f0';">
                                                
                                                <!-- Header -->
                                                <div style="display: flex; justify-content: space-between; align-items: start; gap: 20px; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 2px solid #f7fafc;">
                                                    <div style="flex: 1;">
                                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                                            <span style="font-size: 24px;">ğŸ“‘</span>
                                                            <div>
                                                                <div style="font-weight: 700; color: #1a202c; font-size: 17px;">${v.kategorie || 'Vertrag'} ${v.anbieter ? `â€¢ ${v.anbieter}` : ''}</div>
                                                                <div style="font-size: 13px; color: #718096; margin-top: 2px;">
                                                                    ${v.tarif_name || 'N/A'} ${v.vertragsnummer ? `â€¢ Nr: ${v.vertragsnummer}` : ''}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Provision & Status -->
                                                    <div style="text-align: right; min-width: 140px;">
                                                        <div style="font-size: 24px; font-weight: 700; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 6px;">
                                                            ${(v.provision || 0).toFixed(2)}â‚¬
                                                        </div>
                                                        <div style="display: inline-block; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 700; 
                                                            ${v.vertrag_status === 'aktiviert' ? 'background: #48bb78; color: white;' : 
                                                              v.vertrag_status === 'neu' ? 'background: #4299e1; color: white;' : 
                                                              v.vertrag_status === 'abgelehnt' ? 'background: #f56565; color: white;' : 
                                                              'background: #ed8936; color: white;'}">
                                                            ${v.vertrag_status || 'OFFEN'}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Details Grid -->
                                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                                    <div style="background: #f7fafc; border-radius: 8px; padding: 12px;">
                                                        <div style="font-size: 11px; color: #718096; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">ğŸ‘¤ Kunde</div>
                                                        <div style="font-size: 14px; color: #1a202c; font-weight: 600;">${v.kunde_vorname || ''} ${v.kunde_nachname || 'N/A'}</div>
                                                        ${v.kunde_email ? `<div style="font-size: 11px; color: #a0aec0; margin-top: 2px;">${v.kunde_email}</div>` : ''}
                                                    </div>
                                                    
                                                    <div style="background: #f7fafc; border-radius: 8px; padding: 12px;">
                                                        <div style="font-size: 11px; color: #718096; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">ğŸ“… Datum</div>
                                                        <div style="font-size: 14px; color: #1a202c; font-weight: 600;">
                                                            ${v.abschlussdatum ? new Date(v.abschlussdatum).toLocaleDateString('de-DE', {day: '2-digit', month: 'long', year: 'numeric'}) : 'Unbekannt'}
                                                        </div>
                                                    </div>
                                                    
                                                    ${v.handy_modell ? `
                                                        <div style="background: #f7fafc; border-radius: 8px; padding: 12px;">
                                                            <div style="font-size: 11px; color: #718096; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">ğŸ“± Handy</div>
                                                            <div style="font-size: 14px; color: #1a202c; font-weight: 600;">${v.handy_modell}</div>
                                                            ${v.handy_preis ? `<div style="font-size: 11px; color: #48bb78; margin-top: 2px; font-weight: 700;">+${v.handy_preis}â‚¬</div>` : ''}
                                                        </div>
                                                    ` : ''}
                                                    
                                                    ${v.portierung_von ? `
                                                        <div style="background: #f7fafc; border-radius: 8px; padding: 12px;">
                                                            <div style="font-size: 11px; color: #718096; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">ğŸ”„ Portierung</div>
                                                            <div style="font-size: 14px; color: #1a202c; font-weight: 600;">${v.portierung_von}</div>
                                                        </div>
                                                    ` : ''}
                                                    
                                                    ${v.kunde_telefon ? `
                                                        <div style="background: #f7fafc; border-radius: 8px; padding: 12px;">
                                                            <div style="font-size: 11px; color: #718096; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">ğŸ“ Telefon</div>
                                                            <div style="font-size: 14px; color: #1a202c; font-weight: 600;">${v.kunde_telefon}</div>
                                                        </div>
                                                    ` : ''}
                                                    
                                                    ${v.tarif_preis ? `
                                                        <div style="background: #f7fafc; border-radius: 8px; padding: 12px;">
                                                            <div style="font-size: 11px; color: #718096; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">ğŸ’° Tarif-Preis</div>
                                                            <div style="font-size: 14px; color: #1a202c; font-weight: 600;">${v.tarif_preis}â‚¬/Monat</div>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                                
                                                <!-- Klick-Hinweis -->
                                                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e2e8f0; text-align: center; font-size: 12px; color: #a0aec0;">
                                                    <i class="fas fa-hand-pointer"></i> Klicken fÃ¼r vollstÃ¤ndige Details
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<div style="text-align: center; padding: 60px; color: #a0aec0;"><i class="fas fa-file-contract" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3; display: block;"></i><p style="font-size: 16px;">Noch keine VertrÃ¤ge vorhanden</p></div>'}
                            </div>
                            
                            <!-- Onboarding Tab -->
                            <div class="partner-tab-content" data-content="onboarding" style="display: none;">
                                <div style="background: #f7fafc; border-radius: 12px; padding: 24px;">
                                    <h3 style="font-size: 18px; font-weight: 700; color: #1a202c; margin: 0 0 20px 0;">Onboarding-Status (${completedSteps}/${totalSteps})</h3>
                                    <div style="margin-bottom: 24px;">
                                        <div style="background: #e2e8f0; height: 10px; border-radius: 10px; overflow: hidden;">
                                            <div style="height: 100%; background: linear-gradient(90deg, #3b82f6, #60a5fa); width: ${onboardingProgress}%; transition: width 0.5s;"></div>
                                        </div>
                                        <div style="text-align: center; margin-top: 8px; font-weight: 700; color: #3b82f6;">${onboardingProgress}% abgeschlossen</div>
                                    </div>
                                    <div style="display: grid; gap: 12px;">
                                        ${Object.entries(onboardingSteps).map(([label, status]) => `
                                            <div style="display: flex; align-items: center; gap: 16px; padding: 16px; background: white; border: 2px solid ${status ? '#48bb7830' : '#e2e8f0'}; border-radius: 10px;">
                                                <div style="width: 40px; height: 40px; border-radius: 50%; background: ${status ? '#48bb78' : '#e2e8f0'}; color: white; display: flex; align-items: center; justify-content: center; font-size: 18px;">
                                                    <i class="fas ${status ? 'fa-check' : 'fa-times'}"></i>
                                                </div>
                                                <div style="flex: 1;">
                                                    <div style="font-weight: 600; color: #1a202c;">${label}</div>
                                                    <div style="font-size: 12px; color: ${status ? '#48bb78' : '#a0aec0'}; margin-top: 4px;">${status ? 'Abgeschlossen' : 'Ausstehend'}</div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Bank Tab -->
                            <div class="partner-tab-content" data-content="bank" style="display: none;">
                                <div style="background: #f7fafc; border-radius: 12px; padding: 24px;">
                                    <h3 style="font-size: 18px; font-weight: 700; color: #1a202c; margin: 0 0 20px 0;">Bankverbindung</h3>
                                    <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 24px;">
                                        <div style="display: grid; gap: 16px;">
                                            <div>
                                                <div style="font-size: 12px; color: #718096; font-weight: 600; margin-bottom: 6px; text-transform: uppercase;">IBAN</div>
                                                <div style="font-size: 18px; font-weight: 700; color: ${partner.iban ? '#1a202c' : '#f56565'}; font-family: monospace;">
                                                    ${partner.iban || 'âŒ Nicht hinterlegt'}
                                                </div>
                                            </div>
                                            <div>
                                                <div style="font-size: 12px; color: #718096; font-weight: 600; margin-bottom: 6px; text-transform: uppercase;">Kontoinhaber</div>
                                                <div style="font-size: 16px; font-weight: 600; color: ${partner.kontoinhaber ? '#1a202c' : '#a0aec0'};">
                                                    ${partner.kontoinhaber || partner.vorname + ' ' + partner.nachname || '-'}
                                                </div>
                                            </div>
                                            ${partner.bic ? `
                                                <div>
                                                    <div style="font-size: 12px; color: #718096; font-weight: 600; margin-bottom: 6px; text-transform: uppercase;">BIC</div>
                                                    <div style="font-size: 16px; font-weight: 700; color: #1a202c; font-family: monospace;">${partner.bic}</div>
                                                </div>
                                            ` : ''}
                                        </div>
                                        ${!partner.iban ? `
                                            <div style="margin-top: 20px; padding: 16px; background: #fff5f5; border: 2px solid #feb2b2; border-radius: 10px; color: #c53030; font-size: 14px;">
                                                <i class="fas fa-exclamation-triangle"></i> <strong>Hinweis:</strong> Bankverbindung fehlt - Provisionsauszahlung nicht mÃ¶glich!
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ğŸ“ AKADEMIE TAB -->
                            <div class="partner-tab-content" data-content="akademie" style="display: none;">
                                <div style="background: #f7fafc; border-radius: 12px; padding: 24px;">
                                    <h3 style="font-size: 18px; font-weight: 700; color: #1a202c; margin: 0 0 20px 0;">ğŸ“š Akademie Fortschritt</h3>
                                    <div id="akademie-progress-container">
                                        <p style="color: #a0aec0; text-align: center; padding: 40px;">Lade Fortschritt...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ğŸ“„ Dokumente Tab (NEU!) -->
                            <div class="partner-tab-content" data-content="dokumente" style="display: none;">
                                ${dokumente.length > 0 ? `
                                    <div style="display: grid; gap: 16px;">
                                        ${dokumente.map(dok => {
                                            const statusIcons = {
                                                'hochgeladen': 'âœ…',
                                                'geprueft': 'ğŸŸ¢',
                                                'abgelehnt': 'âŒ',
                                                'ausstehend': 'â³'
                                            };
                                            const statusColors = {
                                                'hochgeladen': '#48bb78',
                                                'geprueft': '#38a169',
                                                'abgelehnt': '#f56565',
                                                'ausstehend': '#ed8936'
                                            };
                                            const statusTexte = {
                                                'hochgeladen': 'Hochgeladen',
                                                'geprueft': 'GeprÃ¼ft & Genehmigt',
                                                'abgelehnt': 'Abgelehnt',
                                                'ausstehend': 'Ausstehend'
                                            };
                                            const typIcons = {
                                                'ausweis': 'ğŸªª',
                                                'gewerbeschein': 'ğŸ“‹',
                                                'vertrag': 'ğŸ“',
                                                'unterschrift': 'âœï¸',
                                                'sonstiges': 'ğŸ“„'
                                            };
                                            
                                            return `
                                                <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); border: 2px solid #e2e8f0; transition: all 0.2s;" 
                                                     onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 20px rgba(0,0,0,0.12)';" 
                                                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 12px rgba(0,0,0,0.08)';">
                                                    <div style="display: flex; justify-content: space-between; align-items: start; gap: 20px;">
                                                        <!-- Dokument Info -->
                                                        <div style="flex: 1;">
                                                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                                                <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #3b82f615, #3b82f605); border: 2px solid #3b82f630; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px;">
                                                                    ${typIcons[dok.dokument_typ] || 'ğŸ“„'}
                                                                </div>
                                                                <div style="flex: 1;">
                                                                    <div style="font-weight: 700; color: #1a202c; font-size: 16px; margin-bottom: 4px;">${dok.dokument_typ?.toUpperCase() || 'Dokument'}</div>
                                                                    <div style="font-size: 12px; color: #718096;">
                                                                        ğŸ“… ${dok.hochgeladen_am ? new Date(dok.hochgeladen_am).toLocaleDateString('de-DE', {day: '2-digit', month: 'long', year: 'numeric'}) : 'Unbekannt'}
                                                                    </div>
                                                                    <div style="font-size: 11px; color: #a0aec0; margin-top: 2px;">
                                                                        ğŸ“ ${dok.dateiname || 'Unbenannt'}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            ${dok.admin_notiz ? `
                                                                <div style="margin-top: 12px; padding: 12px; background: #fef5e7; border-left: 4px solid #f39c12; border-radius: 8px;">
                                                                    <div style="font-size: 11px; color: #d68910; font-weight: 700; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">
                                                                        ğŸ“ Admin-Notiz
                                                                    </div>
                                                                    <div style="font-size: 13px; color: #7d6608; line-height: 1.5;">${dok.admin_notiz}</div>
                                                                </div>
                                                            ` : ''}
                                                        </div>
                                                        
                                                        <!-- Status & Aktion -->
                                                        <div style="text-align: center; min-width: 140px;">
                                                            <div style="background: ${statusColors[dok.status] || '#cbd5e0'}; color: white; border-radius: 10px; padding: 10px 16px; font-size: 13px; font-weight: 700; white-space: nowrap; margin-bottom: 12px;">
                                                                ${statusIcons[dok.status] || 'â³'} ${statusTexte[dok.status] || dok.status}
                                                            </div>
                                                            ${dok.cloudinary_url ? `
                                                                <a href="${dok.cloudinary_url}" target="_blank" onclick="event.stopPropagation();" 
                                                                   style="display: inline-block; width: 100%; padding: 12px 20px; background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); color: white; border-radius: 10px; text-decoration: none; font-size: 13px; font-weight: 700; transition: all 0.2s;" 
                                                                   onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 16px rgba(102,126,234,0.4)';" 
                                                                   onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                                                                    <i class="fas fa-eye"></i> Ansehen
                                                                </a>
                                                            ` : `
                                                                <div style="padding: 12px 20px; background: #e2e8f0; color: #718096; border-radius: 10px; font-size: 13px; font-weight: 700;">
                                                                    <i class="fas fa-ban"></i> Keine Datei
                                                                </div>
                                                            `}
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : `
                                    <div style="background: #fef5e7; border: 3px dashed #f39c12; border-radius: 16px; padding: 60px; text-align: center;">
                                        <i class="fas fa-folder-open" style="font-size: 80px; color: #d68910; margin-bottom: 20px; opacity: 0.5;"></i>
                                        <h3 style="font-size: 22px; color: #7d6608; font-weight: 700; margin: 0 0 12px 0;">Noch keine Dokumente hochgeladen</h3>
                                        <p style="font-size: 15px; color: #a88734; margin: 0;">Partner muss noch Dokumente einreichen (Ausweis, Gewerbeschein, etc.)</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
                
                // Akademie-Fortschritt laden
                loadAkademieProgress(partner.email);
                
            } catch (error) {
                console.error('âŒ Fehler:', error);
                content.innerHTML = `
                    <div style="padding: 60px; text-align: center;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 64px; color: #f56565; margin-bottom: 20px;"></i>
                        <h3 style="color: #1a202c; margin: 0 0 12px 0;">Fehler beim Laden</h3>
                        <p style="color: #718096; margin: 0;">${error.message}</p>
                        <button onclick="document.getElementById('complete-partner-modal').remove()" style="margin-top: 24px; padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">SchlieÃŸen</button>
                    </div>
                `;
            }
        }
        
        // Tab-Switching-Funktion
        function switchPartnerTab(tabName) {
            // Alle Tab-Buttons zurÃ¼cksetzen
            document.querySelectorAll('.partner-tab-btn').forEach(btn => {
                btn.style.borderBottomColor = 'transparent';
                btn.style.color = '#718096';
                btn.classList.remove('active');
            });
            
            // Aktiven Tab-Button highlighten
            const activeBtn = document.querySelector(`.partner-tab-btn[data-tab="${tabName}"]`);
            if (activeBtn) {
                activeBtn.style.borderBottomColor = '#3b82f6';
                activeBtn.style.color = '#3b82f6';
                activeBtn.classList.add('active');
            }
            
            // Alle Tab-Contents verstecken
            document.querySelectorAll('.partner-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Aktiven Tab-Content anzeigen
            const activeContent = document.querySelector(`.partner-tab-content[data-content="${tabName}"]`);
            if (activeContent) {
                activeContent.style.display = 'block';
            }
        }
        
        // Akademie-Fortschritt laden
        async function loadAkademieProgress(partnerEmail) {
            const container = document.getElementById('akademie-progress-container');
            if (!container) return;
            
            try {
                console.log('ğŸ“š Lade Akademie-Fortschritt fÃ¼r:', partnerEmail);
                
                // Fortschritt aus Datenbank laden
                const response = await fetch(`tables/akademie_progress?search=${encodeURIComponent(partnerEmail)}`);
                const data = await response.json();
                
                console.log('ğŸ“Š Akademie-Daten:', data);
                
                if (data.data && data.data.length > 0) {
                    const progress = data.data.filter(p => p.partner_email === partnerEmail);
                    
                    if (progress.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #a0aec0;">
                                <i class="fas fa-graduation-cap" style="font-size: 48px; margin-bottom: 16px;"></i>
                                <p style="font-size: 16px; font-weight: 600;">Noch keine Akademie-AktivitÃ¤t</p>
                                <p style="font-size: 14px;">Partner hat noch kein Modul gestartet.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Module mit Fortschritt anzeigen
                    let html = '<div style="display: grid; gap: 16px;">';
                    
                    progress.forEach(modul => {
                        const prozent = modul.fortschritt_prozent || 0;
                        const abgeschlossen = modul.abgeschlossen || false;
                        const datum = new Date(modul.letzter_zugriff).toLocaleDateString('de-DE', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        html += `
                            <div style="background: white; border: 2px solid ${abgeschlossen ? '#48bb78' : '#e2e8f0'}; border-radius: 12px; padding: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <h4 style="margin: 0; font-size: 16px; font-weight: 700; color: #1a202c;">
                                        ${modul.modul_name}
                                    </h4>
                                    ${abgeschlossen ? `
                                        <span style="padding: 6px 12px; background: #48bb78; color: white; border-radius: 6px; font-size: 12px; font-weight: 700;">
                                            âœ“ Abgeschlossen
                                        </span>
                                    ` : `
                                        <span style="padding: 6px 12px; background: #edf2f7; color: #718096; border-radius: 6px; font-size: 12px; font-weight: 700;">
                                            ${prozent}%
                                        </span>
                                    `}
                                </div>
                                
                                <!-- Fortschrittsbalken -->
                                <div style="background: #e2e8f0; border-radius: 8px; height: 10px; overflow: hidden; margin-bottom: 12px;">
                                    <div style="background: ${abgeschlossen ? '#48bb78' : 'linear-gradient(90deg, #3b82f6, #60a5fa)'}; height: 100%; width: ${prozent}%; transition: width 0.3s;"></div>
                                </div>
                                
                                <div style="display: flex; align-items: center; gap: 8px; color: #718096; font-size: 13px;">
                                    <i class="fas fa-clock"></i>
                                    Zuletzt: ${datum}
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    container.innerHTML = html;
                    
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #a0aec0;">
                            <i class="fas fa-graduation-cap" style="font-size: 48px; margin-bottom: 16px;"></i>
                            <p style="font-size: 16px; font-weight: 600;">Noch keine Akademie-AktivitÃ¤t</p>
                            <p style="font-size: 14px;">Partner hat noch kein Modul gestartet.</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('âŒ Fehler beim Laden des Akademie-Fortschritts:', error);
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #f56565;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 12px;"></i>
                        <p>Fehler beim Laden: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        // âŒ ALTE viewPartnerDetails ENTFERNT - viewPartnerDetailsComplete ersetzt sie!
        function viewPartnerDetails(partnerId) {
            // Redirect zu neuer Funktion
            const partner = allPartners.find(p => p.id === partnerId);
            if (partner) {
                viewPartnerDetailsComplete(partnerId, partner.email);
            }
        }
        
        // ğŸ†• Partner-VertrÃ¤ge anzeigen
        async function viewPartnerVertraege(partnerId, partnerEmail) {
            try {
                console.log('ğŸ“„ Lade VertrÃ¤ge fÃ¼r Partner:', partnerEmail);
                
                // VertrÃ¤ge laden
                const response = await fetch(`tables/vertragsabschluesse?limit=1000`);
                const result = await response.json();
                const vertraegeData = result.data || [];
                
                // Nur VertrÃ¤ge dieses Partners
                const partnerVertraege = vertraegeData.filter(v => v.partner_email === partnerEmail);
                
                if (partnerVertraege.length === 0) {
                    showToast('â„¹ï¸ Keine VertrÃ¤ge', `Dieser Partner hat noch keine VertrÃ¤ge abgeschlossen.`, 'info');
                    return;
                }
                
                // Modal erstellen
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 10000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px);';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                
                const content = document.createElement('div');
                content.style.cssText = 'background: white; border-radius: 16px; padding: 0; max-width: 900px; width: 90%; max-height: 85vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);';
                
                // Gesamtsumme berechnen
                const gesamtProvision = partnerVertraege.reduce((sum, v) => sum + (parseFloat(v.gesamt_provision) || 0), 0);
                
                content.innerHTML = `
                    <div style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); padding: 24px; color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 700;"><i class="fas fa-file-contract"></i> Partner-VertrÃ¤ge</h3>
                                <p style="margin: 0; opacity: 0.9;">${partnerEmail}</p>
                            </div>
                            <button onclick="this.closest('[style*=\\'position: fixed\\']').remove()" style="background: rgba(255,255,255,0.2); border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; color: white; font-size: 20px;">Ã—</button>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 20px;">
                            <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; backdrop-filter: blur(10px);">
                                <div style="font-size: 12px; opacity: 0.9;">VertrÃ¤ge gesamt</div>
                                <div style="font-size: 24px; font-weight: 700;">${partnerVertraege.length}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; backdrop-filter: blur(10px);">
                                <div style="font-size: 12px; opacity: 0.9;">Gesamt-Provision</div>
                                <div style="font-size: 24px; font-weight: 700;">${gesamtProvision.toFixed(2)} â‚¬</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; backdrop-filter: blur(10px);">
                                <div style="font-size: 12px; opacity: 0.9;">Ã˜ pro Vertrag</div>
                                <div style="font-size: 24px; font-weight: 700;">${(gesamtProvision / partnerVertraege.length).toFixed(2)} â‚¬</div>
                            </div>
                        </div>
                    </div>
                    <div style="padding: 24px; max-height: 500px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid #e2e8f0;">
                                    <th style="padding: 12px; text-align: left; font-size: 12px; color: #718096; font-weight: 600;">DATUM</th>
                                    <th style="padding: 12px; text-align: left; font-size: 12px; color: #718096; font-weight: 600;">KATEGORIE</th>
                                    <th style="padding: 12px; text-align: left; font-size: 12px; color: #718096; font-weight: 600;">TARIF</th>
                                    <th style="padding: 12px; text-align: left; font-size: 12px; color: #718096; font-weight: 600;">KUNDE</th>
                                    <th style="padding: 12px; text-align: right; font-size: 12px; color: #718096; font-weight: 600;">PROVISION</th>
                                    <th style="padding: 12px; text-align: center; font-size: 12px; color: #718096; font-weight: 600;">STATUS</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${partnerVertraege.map(v => {
                                    const statusColors = {
                                        'neu': '#ed8936',
                                        'in_bearbeitung': '#4299e1',
                                        'aktiviert': '#48bb78',
                                        'ausgezahlt': '#38a169',
                                        'storniert': '#f56565',
                                        'abgelehnt': '#e53e3e'
                                    };
                                    const statusColor = statusColors[v.vertrag_status] || '#718096';
                                    
                                    return `
                                        <tr style="border-bottom: 1px solid #e2e8f0;">
                                            <td style="padding: 12px; font-size: 13px; color: #4a5568;">${new Date(v.erstellt_am).toLocaleDateString('de-DE')}</td>
                                            <td style="padding: 12px; font-size: 13px; color: #4a5568;">${v.kategorie || '-'}</td>
                                            <td style="padding: 12px; font-size: 13px; color: #4a5568;">${v.tarif_name || '-'}</td>
                                            <td style="padding: 12px; font-size: 13px; color: #4a5568;">
                                                <a href="javascript:void(0)" onclick="showKundenDetails(${JSON.stringify(v).replace(/"/g, '&quot;')})" style="color: #3b82f6; text-decoration: none; font-weight: 600; cursor: pointer; transition: color 0.2s;" onmouseover="this.style.color='#5568d3'" onmouseout="this.style.color='#3b82f6'">
                                                    ${v.kunde_vorname} ${v.kunde_nachname} <i class="fas fa-external-link-alt" style="font-size: 10px; opacity: 0.6;"></i>
                                                </a>
                                            </td>
                                            <td style="padding: 12px; font-size: 13px; color: #4a5568; text-align: right; font-weight: 600;">${(parseFloat(v.gesamt_provision) || 0).toFixed(2)} â‚¬</td>
                                            <td style="padding: 12px; text-align: center;"><span style="background: ${statusColor}22; color: ${statusColor}; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">${v.vertrag_status || 'neu'}</span></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('âŒ Fehler beim Laden der VertrÃ¤ge:', error);
                showToast('âŒ Fehler', 'VertrÃ¤ge konnten nicht geladen werden', 'error');
            }
        }
        
        // ğŸ†• Kundendaten anzeigen
        function showKundenDetails(vertrag) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10001; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(6px);';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            const content = document.createElement('div');
            content.style.cssText = 'background: white; border-radius: 16px; padding: 0; max-width: 700px; width: 90%; max-height: 85vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);';
            
            content.innerHTML = `
                <div style="background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); padding: 24px; color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 700;"><i class="fas fa-user-circle"></i> Kundendaten</h3>
                            <p style="margin: 0; opacity: 0.9;">${vertrag.kunde_vorname} ${vertrag.kunde_nachname}</p>
                        </div>
                        <button onclick="this.closest('[style*=\\'position: fixed\\']').remove()" style="background: rgba(255,255,255,0.2); border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; color: white; font-size: 20px;">Ã—</button>
                    </div>
                </div>
                <div style="padding: 24px; max-height: 500px; overflow-y: auto;">
                    <!-- PersÃ¶nliche Daten -->
                    <div style="background: #f7fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 16px 0; color: #1a202c; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-user" style="color: #3b82f6;"></i> PersÃ¶nliche Daten
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                            <div>
                                <div style="font-size: 12px; color: #718096; margin-bottom: 4px;">Anrede</div>
                                <div style="font-weight: 600; color: #1a202c;">${vertrag.kunde_anrede || '-'}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #718096; margin-bottom: 4px;">Name</div>
                                <div style="font-weight: 600; color: #1a202c;">${vertrag.kunde_vorname} ${vertrag.kunde_nachname}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #718096; margin-bottom: 4px;">Geburtsdatum</div>
                                <div style="font-weight: 600; color: #1a202c;">${vertrag.kunde_geburtsdatum ? new Date(vertrag.kunde_geburtsdatum).toLocaleDateString('de-DE') : '-'}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #718096; margin-bottom: 4px;">Ausweis-Nr.</div>
                                <div style="font-weight: 600; color: #1a202c; font-family: monospace;">${vertrag.ausweisnummer || '-'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Kontaktdaten -->
                    <div style="background: #f7fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 16px 0; color: #1a202c; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-phone" style="color: #48bb78;"></i> Kontaktdaten
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                            <div>
                                <div style="font-size: 12px; color: #718096; margin-bottom: 4px;">E-Mail</div>
                                <div style="font-weight: 600; color: #1a202c;">
                                    <a href="mailto:${vertrag.kunde_email}" style="color: #3b82f6; text-decoration: none;">${vertrag.kunde_email || '-'}</a>
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #718096; margin-bottom: 4px;">Telefon</div>
                                <div style="font-weight: 600; color: #1a202c;">
                                    <a href="tel:${vertrag.kunde_telefon}" style="color: #3b82f6; text-decoration: none;">${vertrag.kunde_telefon || '-'}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Adresse -->
                    <div style="background: #f7fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 16px 0; color: #1a202c; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-map-marker-alt" style="color: #ed8936;"></i> Adresse
                        </h4>
                        <div style="display: grid; grid-template-columns: 2fr 1fr 2fr; gap: 16px;">
                            <div style="grid-column: 1 / -1;">
                                <div style="font-size: 12px; color: #718096; margin-bottom: 4px;">StraÃŸe</div>
                                <div style="font-weight: 600; color: #1a202c;">${vertrag.kunde_strasse || '-'}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #718096; margin-bottom: 4px;">PLZ</div>
                                <div style="font-weight: 600; color: #1a202c;">${vertrag.kunde_plz || '-'}</div>
                            </div>
                            <div style="grid-column: 2 / -1;">
                                <div style="font-size: 12px; color: #718096; margin-bottom: 4px;">Ort</div>
                                <div style="font-weight: 600; color: #1a202c;">${vertrag.kunde_ort || '-'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bankdaten -->
                    <div style="background: #f7fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 16px 0; color: #1a202c; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-university" style="color: #4299e1;"></i> Bankdaten
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                            <div>
                                <div style="font-size: 12px; color: #718096; margin-bottom: 4px;">IBAN</div>
                                <div style="font-weight: 600; color: #1a202c; font-family: monospace;">${vertrag.iban || '-'}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #718096; margin-bottom: 4px;">Kontoinhaber</div>
                                <div style="font-weight: 600; color: #1a202c;">${vertrag.kontoinhaber || '-'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Vertragsdaten -->
                    <div style="background: #f7fafc; padding: 20px; border-radius: 12px;">
                        <h4 style="margin: 0 0 16px 0; color: #1a202c; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-file-contract" style="color: #f56565;"></i> Vertragsdaten
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                            <div>
                                <div style="font-size: 12px; color: #718096; margin-bottom: 4px;">Kategorie</div>
                                <div style="font-weight: 600; color: #1a202c;">${vertrag.kategorie || '-'}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #718096; margin-bottom: 4px;">Tarif</div>
                                <div style="font-weight: 600; color: #1a202c;">${vertrag.tarif_name || '-'}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #718096; margin-bottom: 4px;">Tarif-Preis</div>
                                <div style="font-weight: 600; color: #1a202c;">${(parseFloat(vertrag.tarif_preis) || 0).toFixed(2)} â‚¬ / Monat</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #718096; margin-bottom: 4px;">Provision</div>
                                <div style="font-weight: 600; color: #48bb78; font-size: 18px;">${(parseFloat(vertrag.gesamt_provision) || 0).toFixed(2)} â‚¬</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #718096; margin-bottom: 4px;">Vertragsnummer</div>
                                <div style="font-weight: 600; color: #1a202c; font-family: monospace;">${vertrag.vertragsnummer || '-'}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #718096; margin-bottom: 4px;">Status</div>
                                <div style="display: inline-block; background: ${vertrag.vertrag_status === 'aktiviert' ? '#48bb78' : '#ed8936'}22; color: ${vertrag.vertrag_status === 'aktiviert' ? '#48bb78' : '#ed8936'}; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">${vertrag.vertrag_status || 'neu'}</div>
                            </div>
                            ${vertrag.besondere_wuensche ? `
                            <div style="grid-column: 1 / -1;">
                                <div style="font-size: 12px; color: #718096; margin-bottom: 4px;">Besondere WÃ¼nsche</div>
                                <div style="font-weight: 400; color: #4a5568; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">${vertrag.besondere_wuensche}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }
        
        // ğŸ†• Partner lÃ¶schen (mit BestÃ¤tigung)
        async function deletePartner(partnerId, partnerName) {
            const confirmed = confirm(`âš ï¸ Partner wirklich lÃ¶schen?\n\nPartner: ${partnerName}\n\nDieser Vorgang kann NICHT rÃ¼ckgÃ¤ngig gemacht werden!`);
            
            if (!confirmed) return;
            
            try {
                console.log('ğŸ—‘ï¸ LÃ¶sche Partner:', partnerId);
                
                const response = await fetch(`tables/partners/${partnerId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok || response.status === 204) {
                    showToast('âœ… Partner gelÃ¶scht', `${partnerName} wurde erfolgreich gelÃ¶scht`, 'success');
                    
                    // ğŸ”„ SOFORT aus lokaler Liste entfernen fÃ¼r schnelle UI-Aktualisierung
                    allPartners = allPartners.filter(p => p.id !== partnerId);
                    
                    // ğŸ“Š Statistiken SOFORT aktualisieren
                    document.getElementById('partner-stat-gesamt').textContent = allPartners.length;
                    document.getElementById('partner-stat-aktiv').textContent = allPartners.filter(p => p.status === 'aktiv').length;
                    document.getElementById('partner-stat-neu').textContent = allPartners.filter(p => p.status === 'neu').length;
                    document.getElementById('partner-stat-onboarding').textContent = allPartners.filter(p => !p.onboarding_completed).length;
                    
                    console.log('ğŸ“Š Neue Partner-Anzahl:', allPartners.length);
                    
                    // ğŸ”„ Tabelle neu rendern mit aktuellen Daten
                    renderPartnerTable(allPartners, allVertraege, allDokumente);
                    
                    // ğŸ”„ ZusÃ¤tzlich: Komplettes Neu-Laden vom Server (fÃ¼r Konsistenz)
                    setTimeout(() => {
                        loadPartnerVerwaltung();
                    }, 500);
                } else {
                    throw new Error('DELETE fehlgeschlagen');
                }
            } catch (error) {
                console.error('âŒ Fehler beim LÃ¶schen:', error);
                showToast('âŒ Fehler beim LÃ¶schen', 'Partner konnte nicht gelÃ¶scht werden', 'error');
            }
        }

        async function loadNews() {
            console.log('ğŸ“° Lade News...');
            try {
                const res = await fetch('tables/news?limit=100&_t=' + Date.now());
                console.log('ğŸ“¦ Response Status:', res.status, res.statusText);
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                
                const data = await res.json();
                console.log('âœ… News geladen:', data.data.length, 'News');
                
                const tbody = document.querySelector('#newsTable tbody');
                if (!tbody) {
                    console.error('âŒ newsTable tbody nicht gefunden!');
                    return;
                }
                
                if (data.data.length === 0) {
                    console.log('â„¹ï¸ Keine News vorhanden');
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #a0aec0; padding: 40px;"><i class="fas fa-inbox" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px; display: block;"></i><strong>Noch keine News erstellt</strong><br><small style="margin-top: 8px; display: block;">Erstelle deine erste News oben!</small></td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.data.map(news => `
                    <tr>
                        <td><strong>${news.titel}</strong></td>
                        <td><span style="padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; background: ${news.typ === 'info' ? '#bee3f8' : news.typ === 'warnung' ? '#feebc8' : news.typ === 'erfolg' ? '#c6f6d5' : '#fed7d7'}; color: ${news.typ === 'info' ? '#2c5282' : news.typ === 'warnung' ? '#7c2d12' : news.typ === 'erfolg' ? '#22543d' : '#742a2a'};">${news.typ === 'info' ? 'â„¹ï¸ Info' : news.typ === 'warnung' ? 'âš ï¸ Warnung' : news.typ === 'erfolg' ? 'âœ… Erfolg' : 'ğŸ”¥ Aktion'}</span></td>
                        <td>${news.zielgruppe === 'alle' ? 'Alle Partner' : news.zielgruppe === 'modell' ? `Modell: ${news.modell_filter || '-'}` : `Partner: ${(news.partner_emails || '').split(',').length}`}</td>
                        <td>${new Date(news.erstellt_am).toLocaleDateString('de-DE')}</td>
                        <td><span style="padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; background: ${news.aktiv ? '#c6f6d5' : '#fed7d7'}; color: ${news.aktiv ? '#22543d' : '#742a2a'};">${news.aktiv ? 'âœ… Aktiv' : 'âŒ Inaktiv'}</span></td>
                        <td>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="editNews('${news.id}')" style="padding: 6px 12px; background: #4299e1; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.2s;" onmouseover="this.style.background='#3182ce'" onmouseout="this.style.background='#4299e1'">
                                    <i class="fas fa-edit"></i> Bearbeiten
                                </button>
                                <button onclick="deleteNews('${news.id}')" style="padding: 6px 12px; background: #f56565; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.2s;" onmouseover="this.style.background='#e53e3e'" onmouseout="this.style.background='#f56565'">
                                    <i class="fas fa-trash"></i> LÃ¶schen
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('âŒ FEHLER beim Laden der News:', error);
                const tbody = document.querySelector('#newsTable tbody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; color: #e53e3e; padding: 40px;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                                <strong>Fehler beim Laden der News</strong><br>
                                <small style="margin-top: 8px; display: block;">${error.message}</small><br>
                                <button onclick="loadNews()" style="margin-top: 16px; padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    <i class="fas fa-redo"></i> Erneut versuchen
                                </button>
                            </td>
                        </tr>
                    `;
                }
                showToast('âŒ Fehler beim Laden', error.message, 'error');
            }
        }

        // âœ… Toast Notification System
        function showToast(title, message, type = 'info') {
            const toast = document.createElement('div');
            const colors = {
                'success': { bg: '#48bb78', icon: 'check-circle' },
                'error': { bg: '#f56565', icon: 'exclamation-circle' },
                'warning': { bg: '#ed8936', icon: 'exclamation-triangle' },
                'info': { bg: '#4299e1', icon: 'info-circle' }
            };
            const color = colors[type] || colors.info;
            
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${color.bg};
                color: white;
                padding: 16px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                min-width: 300px;
                max-width: 400px;
                animation: slideIn 0.3s ease-out;
            `;
            
            toast.innerHTML = `
                <div style="display: flex; align-items: start; gap: 12px;">
                    <i class="fas fa-${color.icon}" style="font-size: 20px; margin-top: 2px;"></i>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px;">${title}</div>
                        <div style="font-size: 13px; opacity: 0.9;">${message}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer; opacity: 0.7; padding: 0; margin-left: 8px;">Ã—</button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto-remove nach 5 Sekunden
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }
        
        document.getElementById('newsForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            console.log('ğŸ“ News-Form submitted!');
            
            const titel = document.getElementById('news-titel').value;
            const nachricht = document.getElementById('news-inhalt').value;
            const typ = document.getElementById('news-typ').value;
            const zielgruppe = document.getElementById('news-zielgruppe').value;
            const aktiv = document.getElementById('news-aktiv').checked;
            
            console.log('ğŸ“‹ Form-Daten:', { titel, nachricht, typ, zielgruppe, aktiv });
            
            let modell_filter = null;
            let partner_emails = null;
            
            if (zielgruppe === 'modell') {
                modell_filter = document.getElementById('news-modell-filter').value;
            } else if (zielgruppe === 'partner') {
                partner_emails = document.getElementById('news-partner-emails').value;
            }
            
            try {
                const prioritaet = document.getElementById('news-prioritaet').value;
                const icon = document.getElementById('news-icon').value;
                const gueltig_bis = document.getElementById('news-gueltig').value;
                
                const newsData = {
                    titel,
                    inhalt: nachricht,
                    typ,
                    icon,
                    prioritaet,
                    aktiv,
                    gueltig_bis: gueltig_bis ? new Date(gueltig_bis).toISOString() : null,
                    zielgruppe: zielgruppe === 'alle' ? 'alle' : (zielgruppe === 'modell' ? modell_filter : partner_emails),
                    modell_filter: zielgruppe === 'modell' ? modell_filter : null,
                    partner_emails: zielgruppe === 'partner' ? partner_emails : null
                };
                
                // âœ… UPDATE oder CREATE
                let res;
                if (currentEditingNewsId) {
                    // UPDATE (PATCH)
                    console.log('ğŸ“ Updating News:', currentEditingNewsId);
                    res = await fetch(`tables/news/${currentEditingNewsId}`, {
                        method: 'PATCH',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(newsData)
                    });
                } else {
                    // CREATE (POST)
                    console.log('â• Creating new News');
                    newsData.erstellt_am = new Date().toISOString();
                    newsData.erstellt_von = 'admin@deincheck.de';
                    res = await fetch('tables/news', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(newsData)
                    });
                }
                
                if (res.ok) {
                    // Toast statt Alert
                    showToast(
                        currentEditingNewsId ? 'âœ… News aktualisiert' : 'âœ… News erstellt',
                        currentEditingNewsId ? 'Die News wurde erfolgreich aktualisiert' : 'Die News wurde erfolgreich erstellt',
                        'success'
                    );
                    
                    // Form zurÃ¼cksetzen
                    document.getElementById('newsForm').reset();
                    cancelEditNews(); // Edit-Modus beenden
                    loadNews(); // Liste neu laden
                } else {
                    showToast('âŒ Fehler beim Speichern', 'Bitte versuche es erneut', 'error');
                }
            } catch (error) {
                console.error('Fehler:', error);
                showToast('âŒ Fehler beim Speichern', error.message, 'error');
            }
        });

        // âœ… NEWS BEARBEITEN
        let currentEditingNewsId = null;

        async function editNews(id) {
            try {
                console.log('ğŸ“ Bearbeite News:', id);
                
                // News-Daten laden
                const res = await fetch(`tables/news/${id}`);
                const news = await res.json();
                
                console.log('âœ… News geladen:', news);
                
                // Formular mit Daten fÃ¼llen
                document.getElementById('news-titel').value = news.titel || '';
                document.getElementById('news-inhalt').value = news.inhalt || '';
                document.getElementById('news-typ').value = news.typ || 'info';
                document.getElementById('news-prioritaet').value = news.prioritaet || 'mittel';
                document.getElementById('news-icon').value = news.icon || 'fa-bell';
                document.getElementById('news-aktiv').checked = news.aktiv !== false;
                
                // Zielgruppe
                if (news.zielgruppe === 'alle') {
                    document.getElementById('news-zielgruppe').value = 'alle';
                } else if (news.modell_filter) {
                    document.getElementById('news-zielgruppe').value = 'modell';
                    document.getElementById('news-modell-filter').value = news.modell_filter;
                } else if (news.partner_emails) {
                    document.getElementById('news-zielgruppe').value = 'partner';
                    document.getElementById('news-partner-emails').value = news.partner_emails;
                }
                
                toggleZielgruppeInputs();
                
                // GÃ¼ltig bis
                if (news.gueltig_bis) {
                    const date = new Date(news.gueltig_bis);
                    document.getElementById('news-gueltig').value = date.toISOString().split('T')[0];
                }
                
                // Edit-Modus aktivieren
                currentEditingNewsId = id;
                
                // Button-Text Ã¤ndern
                const submitBtn = document.querySelector('#newsForm button[type="submit"]');
                submitBtn.innerHTML = '<i class="fas fa-save"></i> News aktualisieren';
                submitBtn.style.background = '#ed8936';
                
                // Abbrechen-Button hinzufÃ¼gen
                let cancelBtn = document.getElementById('cancel-edit-btn');
                if (!cancelBtn) {
                    cancelBtn = document.createElement('button');
                    cancelBtn.id = 'cancel-edit-btn';
                    cancelBtn.type = 'button';
                    cancelBtn.innerHTML = '<i class="fas fa-times"></i> Abbrechen';
                    cancelBtn.style.cssText = 'padding: 12px 24px; background: #718096; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-left: 12px;';
                    cancelBtn.onclick = cancelEditNews;
                    submitBtn.parentElement.appendChild(cancelBtn);
                }
                
                // Zum Formular scrollen
                document.getElementById('newsForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                showToast('ğŸ“ Bearbeiten-Modus', 'News-Daten wurden geladen', 'info');
                
            } catch (error) {
                console.error('Fehler beim Laden der News:', error);
                showToast('âŒ Fehler', 'News konnte nicht geladen werden', 'error');
            }
        }

        function cancelEditNews() {
            currentEditingNewsId = null;
            document.getElementById('newsForm').reset();
            
            const submitBtn = document.querySelector('#newsForm button[type="submit"]');
            submitBtn.innerHTML = '<i class="fas fa-save"></i> News speichern';
            submitBtn.style.background = '';
            
            const cancelBtn = document.getElementById('cancel-edit-btn');
            if (cancelBtn) cancelBtn.remove();
            
            showToast('â„¹ï¸ Abgebrochen', 'Bearbeiten-Modus beendet', 'info');
        }

        async function deleteNews(id) {
            if (!confirm('âš ï¸ News wirklich lÃ¶schen?\n\nDiese Aktion kann nicht rÃ¼ckgÃ¤ngig gemacht werden.')) return;
            
            try {
                const res = await fetch(`tables/news/${id}`, {
                    method: 'DELETE'
                });
                
                if (res.ok) {
                    showToast('âœ… News gelÃ¶scht', 'Die News wurde erfolgreich entfernt', 'success');
                    loadNews();
                } else {
                    showToast('âŒ Fehler beim LÃ¶schen', 'Bitte versuche es erneut', 'error');
                }
            } catch (error) {
                console.error('Fehler:', error);
                showToast('âŒ Fehler beim LÃ¶schen', error.message, 'error');
            }
        }

        // ====================================
        // ğŸ  DASHBOARD OVERVIEW LADEN
        // ====================================
        // âœ… Zu erledigende Aufgaben laden
        async function loadPendingTasks() {
            const container = document.getElementById('pending-tasks-container');
            if (!container) return;
            
            try {
                // VertrÃ¤ge mit Status "pending" oder "in_bearbeitung" laden
                const vertraegeRes = await fetch('tables/vertragsabschluesse?limit=1000');
                const vertraegeData = await vertraegeRes.json();
                const pendingVertraege = vertraegeData.data.filter(v => 
                    v.status === 'pending' || v.status === 'in_bearbeitung' || v.status === 'wartend'
                );
                
                if (pendingVertraege.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #48bb78;">
                            <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 12px; display: block;"></i>
                            <p style="margin: 0; font-size: 16px; font-weight: 600;">Keine offenen Aufgaben</p>
                            <p style="margin: 8px 0 0 0; font-size: 14px; opacity: 0.8;">Alle Bestellungen sind bearbeitet</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = pendingVertraege.map(v => `
                    <div style="background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; transition: all 0.2s; cursor: pointer;" onmouseover="this.style.borderColor='#3b82f6'; this.style.background='white'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.background='#f7fafc'">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <span style="background: #3b82f6; color: white; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 700;">
                                        ${pendingVertraege.indexOf(v) + 1}
                                    </span>
                                    <h4 style="margin: 0; font-size: 16px; font-weight: 700; color: #1a202c;">
                                        ${v.kategorie || 'Neue Bestellung'}
                                    </h4>
                                </div>
                                <div style="font-size: 14px; color: #718096; margin-bottom: 8px;">
                                    Partner: <strong>${v.partner_email || 'Unbekannt'}</strong>
                                </div>
                                <div style="font-size: 13px; color: #a0aec0;">
                                    Erstellt: ${v.created_at ? new Date(v.created_at).toLocaleDateString('de-DE') : 'Unbekannt'}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 20px; font-weight: 700; color: #48bb78; margin-bottom: 8px;">
                                    ${(v.provision || 0).toFixed(2)}â‚¬
                                </div>
                                <button onclick="event.stopPropagation(); approveTask('${v.id}')" style="padding: 8px 16px; background: #48bb78; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; margin-right: 6px; transition: all 0.2s;" onmouseover="this.style.background='#38a169'" onmouseout="this.style.background='#48bb78'">
                                    <i class="fas fa-check"></i> Genehmigen
                                </button>
                                <button onclick="event.stopPropagation(); rejectTask('${v.id}')" style="padding: 8px 16px; background: #f56565; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#e53e3e'" onmouseout="this.style.background='#f56565'">
                                    <i class="fas fa-times"></i> Ablehnen
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('âŒ Fehler beim Laden der Aufgaben:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #f56565;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 12px; display: block;"></i>
                        <p style="margin: 0; font-size: 16px; font-weight: 600;">Fehler beim Laden</p>
                        <p style="margin: 8px 0 0 0; font-size: 14px;">${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Aufgabe genehmigen
        async function approveTask(taskId) {
            try {
                await fetch(`tables/vertragsabschluesse/${taskId}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ status: 'aktiviert' })
                });
                showToast('âœ… Genehmigt', 'Vertrag wurde aktiviert', 'success');
                loadPendingTasks(); // Neu laden
            } catch (error) {
                showToast('âŒ Fehler', error.message, 'error');
            }
        }
        
        // Aufgabe ablehnen
        async function rejectTask(taskId) {
            if (!confirm('MÃ¶chten Sie diese Bestellung wirklich ablehnen?')) return;
            try {
                await fetch(`tables/vertragsabschluesse/${taskId}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ status: 'abgelehnt' })
                });
                showToast('âœ… Abgelehnt', 'Vertrag wurde abgelehnt', 'success');
                loadPendingTasks(); // Neu laden
            } catch (error) {
                showToast('âŒ Fehler', error.message, 'error');
            }
        }
        
        async function loadDashboardOverview() {
            console.log('ğŸ  Lade Dashboard Ãœbersicht...');
            try {
                // Anfragen zÃ¤hlen
                const interessentenRes = await fetch('tables/interessenten?limit=1000');
                const interessentenData = await interessentenRes.json();
                console.log('âœ… Interessenten geladen:', interessentenData.data.length);
                // Heute-Filter (created_at ist Timestamp in Millisekunden)
                const todayStart = new Date().setHours(0, 0, 0, 0);
                const neueAnfragen = interessentenData.data.filter(i => i.created_at && i.created_at >= todayStart).length;
                const anfragenEl = document.getElementById('dash-anfragen');
                if (anfragenEl) anfragenEl.textContent = neueAnfragen;

                // Partner zÃ¤hlen
                const partnerRes = await fetch('tables/partners?limit=1000');
                const partnerData = await partnerRes.json();
                const partnerEl = document.getElementById('dash-partner');
                if (partnerEl) partnerEl.textContent = partnerData.data.length;

                // VertrÃ¤ge & Umsatz
                const vertraegeRes = await fetch('tables/vertragsabschluesse?limit=1000');
                
                // Fehlerbehandlung fÃ¼r 422 Error
                if (!vertraegeRes.ok) {
                    console.warn('âš ï¸ VertrÃ¤ge API Error:', vertraegeRes.status);
                    throw new Error(`VertrÃ¤ge API Error: ${vertraegeRes.status}`);
                }
                
                const vertraegeData = await vertraegeRes.json();
                
                const now = new Date();
                
                // ğŸ†• HEUTE
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const todayVertraege = vertraegeData.data.filter(v => new Date(v.erstellt_am || v.created_at) >= today);
                const todayProvision = todayVertraege.reduce((sum, v) => sum + (parseFloat(v.gesamt_provision) || parseFloat(v.provision) || 0), 0);
                const todayEl = document.getElementById('dash-today');
                const todayCountEl = document.getElementById('dash-today-count');
                if (todayEl) todayEl.textContent = `${todayProvision.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}â‚¬`;
                if (todayCountEl) todayCountEl.textContent = `${todayVertraege.length} ${todayVertraege.length === 1 ? 'Vertrag' : 'VertrÃ¤ge'}`;
                
                // ğŸ†• GESTERN
                const yesterday = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
                const yesterdayEnd = today;
                const yesterdayVertraege = vertraegeData.data.filter(v => {
                    const created = new Date(v.erstellt_am || v.created_at);
                    return created >= yesterday && created < yesterdayEnd;
                });
                const yesterdayProvision = yesterdayVertraege.reduce((sum, v) => sum + (parseFloat(v.gesamt_provision) || parseFloat(v.provision) || 0), 0);
                const yesterdayEl = document.getElementById('dash-yesterday');
                const yesterdayCountEl = document.getElementById('dash-yesterday-count');
                if (yesterdayEl) yesterdayEl.textContent = `${yesterdayProvision.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}â‚¬`;
                if (yesterdayCountEl) yesterdayCountEl.textContent = `${yesterdayVertraege.length} ${yesterdayVertraege.length === 1 ? 'Vertrag' : 'VertrÃ¤ge'}`;
                
                // ğŸ†• WOCHE
                const dayOfWeek = now.getDay();
                const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                const weekStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() + mondayOffset);
                weekStart.setHours(0, 0, 0, 0);
                const weekVertraege = vertraegeData.data.filter(v => new Date(v.erstellt_am || v.created_at) >= weekStart);
                const weekProvision = weekVertraege.reduce((sum, v) => sum + (parseFloat(v.gesamt_provision) || parseFloat(v.provision) || 0), 0);
                const weekEl = document.getElementById('dash-week');
                const weekCountEl = document.getElementById('dash-week-count');
                if (weekEl) weekEl.textContent = `${weekProvision.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}â‚¬`;
                if (weekCountEl) weekCountEl.textContent = `${weekVertraege.length} ${weekVertraege.length === 1 ? 'Vertrag' : 'VertrÃ¤ge'}`;
                
                // MONAT
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                const monthVertraege = vertraegeData.data.filter(v => new Date(v.erstellt_am || v.created_at) >= monthStart);
                const monthUmsatz = monthVertraege.reduce((sum, v) => sum + (parseFloat(v.gesamt_provision) || parseFloat(v.provision) || 0), 0);
                const umsatzEl = document.getElementById('dash-umsatz');
                const vertraegeEl = document.getElementById('dash-vertraege');
                if (umsatzEl) umsatzEl.textContent = `${monthUmsatz.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}â‚¬`;
                if (vertraegeEl) vertraegeEl.textContent = monthVertraege.length;
                
                // ğŸ†• HOCHRECHNUNG & PROGNOSEN fÃ¼r Dashboard
                const currentDay = now.getDate();
                const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                const daysRemaining = daysInMonth - currentDay;
                const avgPerDayDash = currentDay > 0 ? monthUmsatz / currentDay : 0;
                const prognoseMonatDash = avgPerDayDash * daysInMonth;
                const prognoseJahrDash = prognoseMonatDash * 12;
                
                // Dashboard Hochrechnung Elemente aktualisieren (falls vorhanden)
                const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
                setEl('dash-prognose-monat', `${prognoseMonatDash.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}â‚¬`);
                setEl('dash-prognose-jahr', `${prognoseJahrDash.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}â‚¬`);
                setEl('dash-avg-per-day', `${avgPerDayDash.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}â‚¬`);
                setEl('dash-current-day', currentDay);
                setEl('dash-days-in-month', daysInMonth);
                setEl('dash-days-remaining', daysRemaining);
                
                console.log('ğŸ“Š Dashboard Hochrechnung:', { 
                    currentDay, daysInMonth, monthUmsatz: monthUmsatz.toFixed(2),
                    avgPerDay: avgPerDayDash.toFixed(2), prognoseMonat: prognoseMonatDash.toFixed(2)
                });

                // AktivitÃ¤ten anzeigen
                const activities = [];
                
                // Neueste VertrÃ¤ge
                vertraegeData.data.slice(0, 5).forEach(v => {
                    activities.push({
                        time: new Date(v.created_at),
                        icon: 'fa-file-contract',
                        color: '#3b82f6',
                        text: `Neuer Vertrag: ${v.kunde_vorname} ${v.kunde_nachname} (${v.produkt || 'N/A'})`
                    });
                });

                // Neue Partner
                partnerData.data.slice(0, 3).forEach(p => {
                    activities.push({
                        time: new Date(p.registriert_am || p.created_at),
                        icon: 'fa-user-plus',
                        color: '#48bb78',
                        text: `Neuer Partner: ${p.vorname} ${p.nachname}`
                    });
                });

                // Sortieren nach Zeit
                activities.sort((a, b) => b.time - a.time);

                const activityHtml = activities.slice(0, 10).map(a => `
                    <div style="display: flex; align-items: center; gap: 15px; padding: 12px; border-bottom: 1px solid #e2e8f0;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: ${a.color}15; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="fas ${a.icon}" style="color: ${a.color}; font-size: 16px;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #2d3748; font-size: 14px;">${a.text}</div>
                            <div style="font-size: 12px; color: #a0aec0; margin-top: 2px;">${a.time.toLocaleString('de-DE')}</div>
                        </div>
                    </div>
                `).join('');

                document.getElementById('dashboard-activity').innerHTML = activityHtml || '<div style="text-align: center; color: #a0aec0; padding: 40px;">Keine AktivitÃ¤ten</div>';
                console.log('âœ… Dashboard Ãœbersicht geladen!');
                
                // ğŸ”” PARTNER-AKTIVITÃ„TEN LADEN
                loadPartnerAktivitaeten();
            } catch (error) {
                console.error('âŒ Fehler beim Laden der Dashboard-Ãœbersicht:', error);
                const activityEl = document.getElementById('dashboard-activity');
                if (activityEl) {
                    activityEl.innerHTML = `
                        <div style="text-align: center; color: #f56565; padding: 40px;">
                            <i class="fas fa-exclamation-circle" style="font-size: 32px; margin-bottom: 15px;"></i>
                            <p style="font-weight: 600; margin-bottom: 8px;">Fehler beim Laden</p>
                            <p style="font-size: 12px; color: #718096;">${error.message}</p>
                            <button onclick="loadDashboardOverview()" style="margin-top: 15px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-redo"></i> Erneut versuchen
                            </button>
                        </div>
                    `;
                }
            }
        }
        
        // ğŸ”” PARTNER-AKTIVITÃ„TEN LADEN
        async function loadPartnerAktivitaeten() {
            try {
                console.log('ğŸ“Š Lade Partner-AktivitÃ¤ten...');
                const res = await fetch('tables/admin_aktivitaeten?limit=50');
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                
                const data = await res.json();
                console.log('âœ… Partner-AktivitÃ¤ten API Response:', data);
                
                const aktivitaeten = (data.data || []).sort((a, b) => b.erstellt_am - a.erstellt_am);
                console.log(`ğŸ“‹ ${aktivitaeten.length} AktivitÃ¤ten geladen`);
                
                // Counter fÃ¼r ungelesene
                const ungelesen = aktivitaeten.filter(a => !a.gelesen).length;
                const countEl = document.getElementById('aktivitaeten-count');
                if (countEl) {
                    countEl.textContent = ungelesen;
                    countEl.style.display = ungelesen > 0 ? 'block' : 'none';
                }
                
                const listEl = document.getElementById('partner-aktivitaeten-list');
                if (!listEl) {
                    console.error('âŒ Element "partner-aktivitaeten-list" nicht gefunden!');
                    return;
                }
                
                if (aktivitaeten.length === 0) {
                    listEl.innerHTML = '<div style="text-align: center; padding: 30px; color: white;"><i class="fas fa-inbox" style="font-size: 32px; margin-bottom: 10px; opacity: 0.7;"></i><p style="opacity: 0.9;">Noch keine Partner-AktivitÃ¤ten</p></div>';
                    return;
                }
                
                // Icons und Farben pro Kategorie
                const kategorieIcons = {
                    'vertrag': { icon: 'fa-file-contract', color: '#3b82f6' },
                    'provision': { icon: 'fa-euro-sign', color: '#48bb78' },
                    'akademie': { icon: 'fa-graduation-cap', color: '#ed8936' },
                    'dokument': { icon: 'fa-file-upload', color: '#4299e1' },
                    'ticket': { icon: 'fa-ticket-alt', color: '#f093fb' },
                    'profil': { icon: 'fa-user-edit', color: '#38a169' }
                };
                
                const html = aktivitaeten.slice(0, 20).map(a => {
                    const kategorie = kategorieIcons[a.kategorie] || kategorieIcons.vertrag;
                    const bgColor = a.gelesen ? 'rgba(255,255,255,0.12)' : 'rgba(255,255,255,0.25)';
                    const borderColor = a.gelesen ? 'rgba(255,255,255,0.1)' : 'rgba(255,255,255,0.3)';
                    
                    return `
                        <div style="padding: 15px; border-bottom: 1px solid ${borderColor}; background: ${bgColor}; transition: all 0.2s; backdrop-filter: blur(10px);">
                            <div style="display: flex; align-items: start; gap: 15px;">
                                <div style="width: 45px; height: 45px; min-width: 45px; border-radius: 12px; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                                    <i class="fas ${kategorie.icon}" style="color: white; font-size: 18px;"></i>
                                </div>
                                <div style="flex: 1;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                        <div>
                                            <strong style="color: white; font-size: 14px;">${a.partner_name}</strong>
                                            ${!a.gelesen ? '<span style="display: inline-block; width: 10px; height: 10px; background: #f56565; border-radius: 50%; margin-left: 8px; box-shadow: 0 0 10px #f56565; animation: pulse 2s ease-in-out infinite;"></span>' : ''}
                                        </div>
                                        <span style="font-size: 11px; color: rgba(255,255,255,0.7);">${new Date(a.erstellt_am).toLocaleString('de-DE', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' })}</span>
                                    </div>
                                    <div style="font-size: 13px; color: rgba(255,255,255,0.95); margin-bottom: 4px;">
                                        <strong>${a.aktion}</strong>
                                    </div>
                                    ${a.details ? `<div style="font-size: 12px; color: rgba(255,255,255,0.8);">${a.details}</div>` : ''}
                                    ${a.betrag ? `<div style="font-size: 13px; color: #48bb78; font-weight: 600; margin-top: 4px; background: rgba(72, 187, 120, 0.2); display: inline-block; padding: 4px 10px; border-radius: 8px;"><i class="fas fa-euro-sign"></i> ${a.betrag}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')
                + '<style>@keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); }}</style>';
                
                listEl.innerHTML = html;
                console.log('âœ… Partner-AktivitÃ¤ten erfolgreich angezeigt');
            } catch (error) {
                console.error('âŒ Fehler beim Laden der Partner-AktivitÃ¤ten:', error);
                const listEl = document.getElementById('partner-aktivitaeten-list');
                if (listEl) {
                    listEl.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: white;">
                            <i class="fas fa-exclamation-circle" style="font-size: 32px; margin-bottom: 10px; opacity: 0.7; color: #f56565;"></i>
                            <p style="opacity: 0.9; margin-bottom: 10px;">Fehler beim Laden</p>
                            <p style="font-size: 12px; opacity: 0.7; margin-bottom: 15px;">${error.message}</p>
                            <button onclick="loadPartnerAktivitaeten()" style="padding: 8px 16px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; color: white; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-redo"></i> Erneut versuchen
                            </button>
                        </div>
                    `;
                }
            }
        }
        
        // Alle AktivitÃ¤ten als gelesen markieren
        async function markAlleAktivitaetenGelesen() {
            try {
                const res = await fetch('tables/admin_aktivitaeten?limit=50');
                const data = await res.json();
                const ungelesen = data.data.filter(a => !a.gelesen);
                
                for (const a of ungelesen) {
                    await fetch(`tables/admin_aktivitaeten/${a.id}`, {
                        method: 'PATCH',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ gelesen: true })
                    });
                }
                
                loadPartnerAktivitaeten(); // Reload
            } catch (error) {
                console.error('Fehler beim Markieren als gelesen:', error);
            }
        }
        
        // âš¡ SCHNELLZUGRIFF: NEUE VERTRÃ„GE
        async function loadSchnellzugriffVertraege() {
            try {
                console.log('âš¡ Lade neue VertrÃ¤ge fÃ¼r Schnellzugriff...');
                const res = await fetch('tables/vertragsabschluesse?limit=1000&sort=-created_at');
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                
                const data = await res.json();
                let alleVertraege = data.data || [];
                
                // ğŸ” FILTER ANWENDEN
                const vonDatum = document.getElementById('schnell-von-datum')?.value;
                const bisDatum = document.getElementById('schnell-bis-datum')?.value;
                const statusFilter = document.getElementById('schnell-status-filter')?.value || 'alle';
                const kategorieFilter = document.getElementById('schnell-kategorie-filter')?.value || 'alle';
                
                console.log('ğŸ” Filter:', { vonDatum, bisDatum, statusFilter, kategorieFilter });
                
                // Filter nach Datum
                if (vonDatum || bisDatum) {
                    alleVertraege = alleVertraege.filter(v => {
                        const vertragDatum = v.datum || v.created_at || v.erstellt_am || v.abschlussdatum;
                        if (!vertragDatum) return true; // Falls kein Datum vorhanden, anzeigen
                        
                        const vDatum = new Date(Number(vertragDatum) || vertragDatum);
                        const von = vonDatum ? new Date(vonDatum) : null;
                        const bis = bisDatum ? new Date(bisDatum) : null;
                        
                        if (von && vDatum < von) return false;
                        if (bis && vDatum > bis) return false;
                        return true;
                    });
                }
                
                // âš¡ AUTOMATISCHER STATUS-FILTER: Nur "neu_eingegangen" & "in_pruefung"
                alleVertraege = alleVertraege.filter(v => {
                    const status = v.vertrag_status || 'neu';
                    return status === 'neu' || status === 'neu_eingegangen' || status === 'in_pruefung';
                });
                
                // Filter nach Kategorie
                if (kategorieFilter !== 'alle') {
                    alleVertraege = alleVertraege.filter(v => {
                        const kategorie = (v.kategorie || '').toLowerCase();
                        return kategorie === kategorieFilter.toLowerCase() || kategorie.includes(kategorieFilter.toLowerCase());
                    });
                }
                
                const neueVertraege = alleVertraege.slice(0, 50); // Max 50 zeigen (statt 10)
                
                console.log(`âœ… ${neueVertraege.length} neue VertrÃ¤ge gefunden`);
                
                // Counter aktualisieren
                const countEl = document.getElementById('neue-vertraege-count');
                if (countEl) countEl.textContent = neueVertraege.length;
                
                const listEl = document.getElementById('schnellzugriff-vertraege-list');
                if (!listEl) return;
                
                if (neueVertraege.length === 0) {
                    listEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #a0aec0;"><i class="fas fa-check-circle" style="font-size: 32px; margin-bottom: 10px; color: #48bb78;"></i><p>Keine neuen VertrÃ¤ge zur PrÃ¼fung</p></div>';
                    return;
                }
                
                const html = neueVertraege.map(v => {
                    const datum = new Date(v.created_at || v.erstellt_am);
                    const datumStr = datum.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const uhrzeitStr = datum.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    
                    // ğŸ¨ EINHEITLICHES BADGE-SYSTEM
                    let statusBadge = '';
                    const status = v.vertrag_status || 'neu';
                    
                    // Status-Badge mit Klick-Funktion zur Weiterleitung
                    if (status === 'neu_eingegangen' || status === 'neu') {
                        statusBadge = `<span class="badge badge-neu-eingegangan" onclick="window.springZuVertraege('neu_eingegangen')" style="cursor: pointer;" title="ğŸ”— Klick: Alle neuen VertrÃ¤ge im Tab 'Provisionen - VertrÃ¤ge - Sonstiges' anzeigen"><i class="fas fa-star"></i> NEU EINGEGANGEN</span>`;
                    } else if (status === 'in_pruefung') {
                        statusBadge = `<span class="badge badge-in-pruefung" onclick="window.springZuVertraege('in_pruefung')" style="cursor: pointer;" title="ğŸ”— Klick: VertrÃ¤ge in PrÃ¼fung im Tab 'Provisionen - VertrÃ¤ge - Sonstiges' anzeigen"><i class="fas fa-hourglass-half"></i> IN PRÃœFUNG</span>`;
                    } else if (status === 'aktiviert' || status === 'akzeptiert') {
                        statusBadge = `<span class="badge badge-aktiviert" onclick="window.springZuVertraege('aktiviert')" style="cursor: pointer;" title="ğŸ”— Klick: Aktivierte VertrÃ¤ge im Tab 'Provisionen - VertrÃ¤ge - Sonstiges' anzeigen"><i class="fas fa-check-circle"></i> AKTIVIERT</span>`;
                    } else if (status === 'abgelehnt') {
                        statusBadge = `<span class="badge badge-abgelehnt" onclick="window.springZuVertraege('abgelehnt')" style="cursor: pointer;" title="ğŸ”— Klick: Abgelehnte VertrÃ¤ge im Tab 'Provisionen - VertrÃ¤ge - Sonstiges' anzeigen"><i class="fas fa-times-circle"></i> ABGELEHNT</span>`;
                    }
                    
                    return `
                        <div style="padding: 16px; border-bottom: 1px solid #e2e8f0; transition: all 0.2s; hover: background: #f7fafc;" onmouseover="this.style.background='#f7fafc'" onmouseout="this.style.background='white'">
                            <div style="display: flex; gap: 15px; align-items: start;">
                                <div style="flex: 1;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <i class="fas fa-file-contract" style="color: #48bb78; font-size: 18px;"></i>
                                            <strong style="color: #2d3748; font-size: 15px;">${v.kunde_vorname} ${v.kunde_nachname}</strong>
                                            ${statusBadge}
                                        </div>
                                        <span style="font-size: 12px; color: #718096;">
                                            <i class="fas fa-clock"></i> ${datumStr}, ${uhrzeitStr} Uhr
                                        </span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 12px; font-size: 13px; color: #4a5568;">
                                        <div><i class="fas fa-user" style="color: #3b82f6; margin-right: 6px;"></i> Partner: <strong>${v.partner_email || 'N/A'}</strong></div>
                                        <div><i class="fas fa-box" style="color: #ed8936; margin-right: 6px;"></i> Produkt: <strong>${v.produkt || v.tarif || 'N/A'}</strong></div>
                                        <div><i class="fas fa-tag" style="color: #48bb78; margin-right: 6px;"></i> Kategorie: <strong>${v.kategorie || 'N/A'}</strong></div>
                                        <div><i class="fas fa-euro-sign" style="color: #f093fb; margin-right: 6px;"></i> Provision: <strong>${v.gesamt_provision || v.provision || '0'}â‚¬</strong></div>
                                    </div>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <button onclick="schnellAktivieren('${v.id}')" style="padding: 8px 16px; background: linear-gradient(135deg, #48bb78, #38a169); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s; box-shadow: 0 2px 6px rgba(72, 187, 120, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 10px rgba(72, 187, 120, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(72, 187, 120, 0.3)'">
                                            <i class="fas fa-check-circle"></i> Aktivieren
                                        </button>
                                        <button onclick="schnellInPruefung('${v.id}')" style="padding: 8px 16px; background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s; box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 10px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(102, 126, 234, 0.3)'">
                                            <i class="fas fa-hourglass-half"></i> In PrÃ¼fung
                                        </button>
                                        <button onclick="schnellAblehnen('${v.id}')" style="padding: 8px 16px; background: linear-gradient(135deg, #f56565, #e53e3e); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s; box-shadow: 0 2px 6px rgba(245, 101, 101, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 10px rgba(245, 101, 101, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(245, 101, 101, 0.3)'">
                                            <i class="fas fa-times-circle"></i> Ablehnen
                                        </button>
                                        <button onclick="showVertragDetails('${v.id}')" style="padding: 8px 16px; background: white; color: #3b82f6; border: 2px solid #3b82f6; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s;" onmouseover="this.style.background='#3b82f6'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='#3b82f6'">
                                            <i class="fas fa-eye"></i> Details
                                        </button>
                                        <button onclick="schnellZuPartner('${v.partner_email}')" style="padding: 8px 16px; background: white; color: #60a5fa; border: 2px solid #60a5fa; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s;" onmouseover="this.style.background='#60a5fa'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='#60a5fa'">
                                            <i class="fas fa-user"></i> Partner-Info
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                listEl.innerHTML = html;
                console.log('âœ… Schnellzugriff-VertrÃ¤ge erfolgreich angezeigt');
            } catch (error) {
                console.error('âŒ Fehler beim Laden der Schnellzugriff-VertrÃ¤ge:', error);
                const listEl = document.getElementById('schnellzugriff-vertraege-list');
                if (listEl) {
                    listEl.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #f56565;">
                            <i class="fas fa-exclamation-circle" style="font-size: 32px; margin-bottom: 10px;"></i>
                            <p style="font-weight: 600; margin-bottom: 8px;">Fehler beim Laden</p>
                            <p style="font-size: 12px; color: #718096;">${error.message}</p>
                            <button onclick="loadSchnellzugriffVertraege()" style="margin-top: 15px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-redo"></i> Erneut versuchen
                            </button>
                        </div>
                    `;
                }
            }
        }
        
        // Schnell-Aktionen fÃ¼r VertrÃ¤ge (MIT FEEDBACK)
        async function schnellAktivieren(vertragId) {
            if (!confirm('Vertrag wirklich aktivieren?')) return;
            
            // Loading-Anzeige
            const button = event.target.closest('button');
            const originalHTML = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Aktiviere...';
            
            try {
                const res = await fetch(`tables/vertragsabschluesse/${vertragId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vertrag_status: 'aktiviert' })
                });
                if (!res.ok) throw new Error('Fehler beim Aktivieren');
                
                // Success-Toast
                showToast('âœ… Erfolg', 'Vertrag wurde aktiviert!', 'success');
                
                // âœ… NEU: Status-Badge aktualisieren (Vertrag bleibt sichtbar!)
                const card = button.closest('[style*="padding: 16px"]');
                if (card) {
                    const badge = card.querySelector('span[style*="background"]');
                    if (badge) {
                        badge.style.background = '#48bb78';
                        badge.textContent = 'AKTIVIERT';
                    }
                    // Buttons deaktivieren nach Aktion
                    card.querySelectorAll('button').forEach(btn => {
                        if (btn.textContent.includes('Aktivieren') || btn.textContent.includes('Ablehnen')) {
                            btn.disabled = true;
                            btn.style.opacity = '0.5';
                            btn.style.cursor = 'not-allowed';
                        }
                    });
                    // Animation: Kurzes Highlight
                    card.style.transition = 'all 0.3s ease';
                    card.style.background = '#f0fff4';
                    setTimeout(() => { card.style.background = 'white'; }, 1000);
                }
                
                // Liste neu laden um Counter zu aktualisieren
                setTimeout(() => {
                    loadSchnellzugriffVertraege();
                    // âœ… SYNCHRONISATION: All-in-One Tab-Daten auch aktualisieren
                    if (typeof loadAllInOneData === 'function') {
                        loadAllInOneData();
                        console.log('ğŸ”„ All-in-One Daten synchronisiert nach Schnellzugriff-Aktion');
                    }
                }, 1500);
            } catch (error) {
                button.disabled = false;
                button.innerHTML = originalHTML;
                showToast('âŒ Fehler', error.message, 'error');
            }
        }
        
        async function schnellAblehnen(vertragId) {
            const grund = prompt('Grund fÃ¼r Ablehnung (optional):');
            if (grund === null) return; // User hat abgebrochen
            
            // Loading-Anzeige
            const button = event.target.closest('button');
            const originalHTML = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Lehne ab...';
            
            try {
                const res = await fetch(`tables/vertragsabschluesse/${vertragId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        vertrag_status: 'abgelehnt',
                        ablehnungsgrund: grund || 'Keine Angabe'
                    })
                });
                if (!res.ok) throw new Error('Fehler beim Ablehnen');
                
                // Success-Toast
                showToast('âœ… Erfolg', 'Vertrag wurde abgelehnt!', 'success');
                
                // âœ… NEU: Status-Badge aktualisieren (Vertrag bleibt sichtbar!)
                const card = button.closest('[style*="padding: 16px"]');
                if (card) {
                    const badge = card.querySelector('span[style*="background"]');
                    if (badge) {
                        badge.style.background = '#f56565';
                        badge.textContent = 'ABGELEHNT';
                    }
                    // Buttons deaktivieren nach Aktion
                    card.querySelectorAll('button').forEach(btn => {
                        if (btn.textContent.includes('Aktivieren') || btn.textContent.includes('Ablehnen')) {
                            btn.disabled = true;
                            btn.style.opacity = '0.5';
                            btn.style.cursor = 'not-allowed';
                        }
                    });
                    // Animation: Kurzes Highlight
                    card.style.transition = 'all 0.3s ease';
                    card.style.background = '#fff5f5';
                    setTimeout(() => { card.style.background = 'white'; }, 1000);
                }
                
                // Liste neu laden um Counter zu aktualisieren
                setTimeout(() => {
                    loadSchnellzugriffVertraege();
                    // âœ… SYNCHRONISATION: All-in-One Tab-Daten auch aktualisieren
                    if (typeof loadAllInOneData === 'function') {
                        loadAllInOneData();
                        console.log('ğŸ”„ All-in-One Daten synchronisiert nach Schnellzugriff-Aktion');
                    }
                }, 1500);
            } catch (error) {
                button.disabled = false;
                button.innerHTML = originalHTML;
                showToast('âŒ Fehler', error.message, 'error');
            }
        }
        
        async function schnellInPruefung(vertragId) {
            if (!confirm('Vertrag auf "In PrÃ¼fung" setzen?')) return;
            
            // Loading-Anzeige
            const button = event.target.closest('button');
            const originalHTML = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> PrÃ¼fe...';
            
            try {
                const res = await fetch(`tables/vertragsabschluesse/${vertragId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vertrag_status: 'in_pruefung' })
                });
                if (!res.ok) throw new Error('Fehler beim Status-Update');
                
                // Success-Toast
                showToast('âœ… Erfolg', 'Vertrag wurde auf "In PrÃ¼fung" gesetzt!', 'success');
                
                // âœ… Status-Badge aktualisieren (Vertrag bleibt sichtbar!)
                const card = button.closest('[style*="padding: 16px"]');
                if (card) {
                    const badge = card.querySelector('span[style*="background"]');
                    if (badge) {
                        badge.style.background = '#3b82f6';
                        badge.textContent = 'IN PRÃœFUNG';
                    }
                    // Buttons deaktivieren nach Aktion
                    card.querySelectorAll('button').forEach(btn => {
                        if (btn.textContent.includes('Aktivieren') || btn.textContent.includes('Ablehnen') || btn.textContent.includes('PrÃ¼fung')) {
                            btn.disabled = true;
                            btn.style.opacity = '0.5';
                            btn.style.cursor = 'not-allowed';
                        }
                    });
                    // Animation: Kurzes Highlight
                    card.style.transition = 'all 0.3s ease';
                    card.style.background = '#f0f4ff';
                    setTimeout(() => { card.style.background = 'white'; }, 1000);
                }
                
                // Liste neu laden um Counter zu aktualisieren
                setTimeout(() => {
                    loadSchnellzugriffVertraege();
                    // âœ… SYNCHRONISATION: All-in-One Tab-Daten auch aktualisieren
                    if (typeof loadAllInOneData === 'function') {
                        loadAllInOneData();
                        console.log('ğŸ”„ All-in-One Daten synchronisiert nach Schnellzugriff-Aktion');
                    }
                }, 1500);
            } catch (error) {
                button.disabled = false;
                button.innerHTML = originalHTML;
                showToast('âŒ Fehler', error.message, 'error');
            }
        }
        
        function schnellZuPartner(partnerEmail) {
            // Suche Partner in der Liste und Ã¶ffne Details
            if (typeof viewPartnerDetailsComplete === 'function') {
                // Hole Partner-Daten
                fetch(`tables/partners?limit=1000`)
                    .then(r => r.json())
                    .then(data => {
                        const partner = data.data.find(p => p.email === partnerEmail);
                        if (partner) {
                            viewPartnerDetailsComplete(partner);
                        } else {
                            alert('Partner nicht gefunden!');
                        }
                    })
                    .catch(err => alert('Fehler: ' + err.message));
            } else {
                alert('Partner-Details-Funktion nicht verfÃ¼gbar!');
            }
        }
        
        // âœ… INNOVATIVES PROJEKTE & TASKS SYSTEM
        let selectedColor = '#3b82f6';
        let currentFilter = 'all';
        
        async function loadProjekte() {
            console.log('ğŸ“‹ Lade Projekte... START!');
            const grid = document.getElementById('projekte-grid');
            if (!grid) {
                console.error('âŒ FATAL: projekte-grid Element nicht gefunden!');
                alert('FEHLER: projekte-grid Element nicht gefunden! Bitte Hard Refresh machen!');
                return;
            }
            console.log('âœ… projekte-grid Element gefunden:', grid);
            
            // Loading-State anzeigen
            grid.innerHTML = `
                <div style="text-align: center; padding: 60px; color: #718096; grid-column: 1 / -1;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 16px;"></i>
                    <p style="margin: 0; font-size: 16px;">Lade Projekte...</p>
                </div>
            `;
            
            try {
                console.log('ğŸŒ Fetching task_projekte... URL:', 'tables/task_projekte?limit=100');
                const res = await fetch('tables/task_projekte?limit=100');
                console.log('ğŸ“¦ Response erhalten:', res.status, res.statusText);
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                
                const data = await res.json();
                console.log('âœ… Projekte Data erfolgreich geladen:', data.data.length, 'Projekte');
                let projekte = data.data.sort((a, b) => b.erstellt_am - a.erstellt_am);
                
                if (projekte.length === 0) {
                    grid.innerHTML = `
                        <div style="text-align: center; padding: 60px; color: #718096; grid-column: 1 / -1;">
                            <i class="fas fa-folder-open" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                            <p style="margin: 0; font-size: 18px; font-weight: 600;">Noch keine Projekte</p>
                            <p style="margin: 8px 0 0 0; font-size: 14px;">Erstelle dein erstes Projekt!</p>
                        </div>
                    `;
                    return;
                }
                
                // Tasks parallel laden (mit Timeout fÃ¼r Performance)
                console.log('ğŸŒ Fetching tasks...');
                const tasksRes = await fetch('tables/tasks?limit=500'); // Reduziert von 1000 auf 500
                const tasksData = await tasksRes.json();
                const allTasks = tasksData.data;
                console.log('âœ… Tasks geladen:', allTasks.length);
                
                // Filter anwenden
                if (currentFilter === 'active') {
                    projekte = projekte.filter(p => p.status === 'aktiv');
                } else if (currentFilter === 'completed') {
                    projekte = projekte.filter(p => p.status === 'abgeschlossen');
                }
                
                // Stats berechnen
                const totalProjects = projekte.length;
                const totalActiveTasks = allTasks.filter(t => t.status === 'todo' || t.status === 'in_progress').length;
                const totalCompletedTasks = allTasks.filter(t => t.status === 'done').length;
                
                document.getElementById('stats-total-projects').textContent = totalProjects;
                document.getElementById('stats-active-tasks').textContent = totalActiveTasks;
                document.getElementById('stats-completed-tasks').textContent = totalCompletedTasks;
                
                // âœ… VEREINFACHTES DESIGN (wie Screenshot)
                grid.innerHTML = '';
                projekte.forEach(projekt => {
                    const projektTasks = allTasks.filter(t => t.projekt_id === projekt.id);
                    const activeTasks = projektTasks.filter(t => t.status === 'todo' || t.status === 'in_progress');
                    const completedTasks = projektTasks.filter(t => t.status === 'done');
                    
                    const card = document.createElement('div');
                    card.style.cssText = `
                        background: white;
                        border: 1px solid #e2e8f0;
                        border-radius: 8px;
                        padding: 20px;
                        transition: box-shadow 0.2s;
                        cursor: pointer;
                    `;
                    
                    card.onmouseover = () => card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                    card.onmouseout = () => card.style.boxShadow = 'none';
                    
                    card.innerHTML = `
                        <!-- Header -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: #1a202c;">${projekt.name}</h3>
                            <button onclick="event.stopPropagation(); deleteProjekt('${projekt.id}')" style="background: none; border: none; color: #a0aec0; cursor: pointer; padding: 4px; font-size: 14px;" onmouseover="this.style.color='#f56565'" onmouseout="this.style.color='#a0aec0'">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                        </div>
                        
                        <!-- Tasks Status -->
                        <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;">
                            ${activeTasks.slice(0, 3).map(task => `
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" onclick="event.stopPropagation(); toggleTask('${task.id}')" style="cursor: pointer; width: 16px; height: 16px;">
                                    <span style="color: #4a5568; font-size: 14px; flex: 1;">${task.titel}</span>
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- Bottom Info -->
                        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid #e2e8f0;">
                            <div style="font-size: 13px; color: #718096;">
                                <span style="font-weight: 500;">Tasks</span>
                                <span style="margin-left: 8px;">${activeTasks.length} active</span>
                            </div>
                            <button onclick="event.stopPropagation(); addTaskToProjekt('${projekt.id}')" style="background: none; border: none; color: #3b82f6; cursor: pointer; font-size: 13px; font-weight: 500; padding: 4px 8px;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">
                                + Add Task
                            </button>
                        </div>
                        
                        ${completedTasks.length > 0 ? `
                            <div style="margin-top: 8px; text-align: right;">
                                <a href="#" onclick="event.stopPropagation(); event.preventDefault(); openProjektDetail('${projekt.id}')" style="font-size: 13px; color: #718096; text-decoration: none;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">
                                    View completed (${completedTasks.length})
                                </a>
                            </div>
                        ` : ''}
                    `;
                    
                    card.onclick = () => openProjektDetail(projekt.id);
                    grid.appendChild(card);
                });
                
                console.log('âœ… Projekte geladen:', projekte.length);
            } catch (error) {
                console.error('âŒ FATAL ERROR beim Laden der Projekte:', error);
                console.error('âŒ Error Message:', error.message);
                console.error('âŒ Error Stack:', error.stack);
                
                const grid = document.getElementById('projekte-grid');
                if (grid) {
                    grid.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #f56565; grid-column: 1 / -1;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
                            <h3 style="margin: 0 0 8px 0; color: #e53e3e;">Fehler beim Laden der Projekte</h3>
                            <p style="margin: 0 0 16px 0; color: #718096; font-size: 14px;">${error.message}</p>
                            <button onclick="loadProjekte()" style="padding: 12px 24px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-redo"></i> Erneut versuchen
                            </button>
                        </div>
                    `;
                }
                
                // User-Alert
                alert(`FEHLER beim Laden der Projekte:\n\n${error.message}\n\nBitte:\n1. Hard Refresh (Ctrl+Shift+R)\n2. Inkognito-Modus testen\n3. Konsole (F12) Screenshot senden`);
            }
        }
        
        // MODALS & INTERAKTIONEN
        function createNewProjekt() {
            document.getElementById('modal-new-projekt').style.display = 'flex';
            document.getElementById('new-projekt-name').focus();
            selectedColor = '#3b82f6';
            document.querySelectorAll('.color-option').forEach(el => el.style.borderColor = 'transparent');
            document.querySelector(`[data-color="${selectedColor}"]`).style.borderColor = selectedColor;
        }
        
        function selectColor(color) {
            selectedColor = color;
            document.querySelectorAll('.color-option').forEach(el => el.style.borderColor = 'transparent');
            document.querySelector(`[data-color="${color}"]`).style.borderColor = color;
        }
        
        function saveProjekt() {
            const name = document.getElementById('new-projekt-name').value.trim();
            if (!name) {
                alert('Bitte einen Projekt-Namen eingeben!');
                return;
            }
            
            // âœ… Alle Felder sammeln
            const beschreibung = document.getElementById('new-projekt-beschreibung').value.trim();
            const prioritaet = document.getElementById('new-projekt-prioritaet').value;
            const kategorie = document.getElementById('new-projekt-kategorie').value;
            const zugewiesen = document.getElementById('new-projekt-zugewiesen').value.trim();
            const status = document.getElementById('new-projekt-status').value;
            const deadline = document.getElementById('new-projekt-deadline').value;
            const kommentar = document.getElementById('new-projekt-kommentar').value.trim();
            
            // âœ… Automatische Farb-Auswahl (zufÃ¤llig aus schÃ¶nen Farben)
            const colors = ['#3b82f6', '#48bb78', '#ed8936', '#4299e1', '#9f7aea', '#f56565'];
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            
            console.log('ğŸ“¤ Erstelle Projekt mit allen Daten:', {
                name, beschreibung, prioritaet, kategorie, zugewiesen, status, deadline, kommentar
            });
            
            fetch('tables/task_projekte', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: name,
                    beschreibung: beschreibung,
                    prioritaet: prioritaet,
                    kategorie: kategorie,
                    zugewiesen_an: zugewiesen,
                    status: status,
                    deadline: deadline,
                    kommentar: kommentar,
                    farbe: randomColor,
                    erstellt_von: 'Admin'
                })
            }).then(() => {
                closeModal('modal-new-projekt');
                // âœ… Alle Felder leeren
                document.getElementById('new-projekt-name').value = '';
                document.getElementById('new-projekt-beschreibung').value = '';
                document.getElementById('new-projekt-prioritaet').value = 'medium';
                document.getElementById('new-projekt-kategorie').value = '';
                document.getElementById('new-projekt-zugewiesen').value = '';
                document.getElementById('new-projekt-status').value = 'todo';
                document.getElementById('new-projekt-deadline').value = '';
                document.getElementById('new-projekt-kommentar').value = '';
                loadProjekte();
                alert('âœ… Projekt erfolgreich erstellt!');
            }).catch(error => {
                console.error('Fehler beim Erstellen:', error);
                alert('Fehler beim Erstellen des Projekts!');
            });
        }
        
        function addTaskToProjekt(projektId) {
            document.getElementById('modal-add-task').style.display = 'flex';
            document.getElementById('task-projekt-id').value = projektId;
            document.getElementById('new-task-titel').focus();
        }
        
        function showQuickAddTask() {
            alert('Bitte wÃ¤hle zuerst ein Projekt und klicke auf "+ Task hinzufÃ¼gen"');
        }
        
        async function saveTask() {
            const projektId = document.getElementById('task-projekt-id').value;
            const titel = document.getElementById('new-task-titel').value.trim();
            
            if (!titel) {
                alert('Bitte einen Task-Titel eingeben!');
                return;
            }
            
            const beschreibung = document.getElementById('new-task-beschreibung').value.trim();
            const prioritaet = document.getElementById('new-task-prioritaet').value;
            const kategorie = document.getElementById('new-task-kategorie').value;
            const zugewiesen = document.getElementById('new-task-zugewiesen').value.trim();
            const status = document.getElementById('new-task-status').value;
            const deadline = document.getElementById('new-task-deadline').value;
            const notiz = document.getElementById('new-task-notiz').value.trim();
            
            try {
                // Task erstellen
                const taskRes = await fetch('tables/tasks', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        projekt_id: projektId,
                        titel: titel,
                        beschreibung: `${kategorie ? `[${kategorie}] ` : ''}${beschreibung}`,
                        status: status,
                        prioritaet: prioritaet,
                        zugewiesen_an: zugewiesen || null,
                        faellig_am: deadline ? new Date(deadline).getTime() : null,
                        erstellt_von: 'Admin'
                    })
                });
                
                const taskData = await taskRes.json();
                
                // Wenn Notiz vorhanden, als Kommentar speichern
                if (notiz) {
                    await fetch('tables/task_kommentare', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            task_id: taskData.id,
                            kommentar: notiz,
                            erstellt_von: 'Admin'
                        })
                    });
                }
                
                closeModal('modal-add-task');
                document.getElementById('new-task-titel').value = '';
                document.getElementById('new-task-beschreibung').value = '';
                document.getElementById('new-task-deadline').value = '';
                document.getElementById('new-task-prioritaet').value = 'medium';
                document.getElementById('new-task-kategorie').value = '';
                document.getElementById('new-task-zugewiesen').value = '';
                document.getElementById('new-task-status').value = 'todo';
                document.getElementById('new-task-notiz').value = '';
                loadProjekte();
            } catch (error) {
                console.error('Fehler beim Erstellen:', error);
                alert('Fehler beim Erstellen des Tasks!');
            }
        }
        
        async function openTaskDetail(taskId) {
            try {
                // Task laden
                const taskRes = await fetch(`tables/tasks/${taskId}`);
                const task = await taskRes.json();
                
                // Kommentare laden
                const commentsRes = await fetch(`tables/task_kommentare?limit=100`);
                const commentsData = await commentsRes.json();
                const comments = commentsData.data.filter(c => c.task_id === taskId);
                
                const prioColor = task.prioritaet === 'high' ? '#f56565' : task.prioritaet === 'medium' ? '#ed8936' : '#48bb78';
                const prioIcon = task.prioritaet === 'high' ? 'ğŸ”´' : task.prioritaet === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
                const statusColor = task.status === 'done' ? '#48bb78' : task.status === 'in_progress' ? '#ed8936' : '#718096';
                const statusText = task.status === 'done' ? 'âœ… Erledigt' : task.status === 'in_progress' ? 'ğŸ”„ In Bearbeitung' : 'ğŸ“‹ Todo';
                
                const content = `
                    <div style="background: ${prioColor}10; padding: 16px; border-radius: 10px; border-left: 4px solid ${prioColor}; margin-bottom: 20px;">
                        <h2 style="margin: 0 0 8px 0; font-size: 20px; color: #2d3748;">${task.titel}</h2>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; font-size: 13px;">
                            <span style="background: ${prioColor}20; color: ${prioColor}; padding: 4px 12px; border-radius: 6px; font-weight: 600;">
                                ${prioIcon} ${task.prioritaet === 'high' ? 'Hoch' : task.prioritaet === 'medium' ? 'Mittel' : 'Niedrig'}
                            </span>
                            <span style="background: ${statusColor}20; color: ${statusColor}; padding: 4px 12px; border-radius: 6px; font-weight: 600;">
                                ${statusText}
                            </span>
                            ${task.zugewiesen_an ? `<span style="background: #3b82f620; color: #3b82f6; padding: 4px 12px; border-radius: 6px; font-weight: 600;">
                                ğŸ‘¤ ${task.zugewiesen_an}
                            </span>` : ''}
                            ${task.faellig_am ? `<span style="background: #ed893620; color: #ed8936; padding: 4px 12px; border-radius: 6px; font-weight: 600;">
                                ğŸ“… ${new Date(task.faellig_am).toLocaleDateString('de-DE')}
                            </span>` : ''}
                        </div>
                    </div>
                    
                    ${task.beschreibung ? `
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin: 0 0 8px 0; color: #4a5568;">Beschreibung</h4>
                            <p style="margin: 0; color: #718096; line-height: 1.6;">${task.beschreibung}</p>
                        </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 12px 0; color: #4a5568;">Status Ã¤ndern</h4>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="updateTaskStatus('${task.id}', 'todo')" style="flex: 1; padding: 10px; background: ${task.status === 'todo' ? '#718096' : '#f7fafc'}; color: ${task.status === 'todo' ? 'white' : '#718096'}; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;">
                                ğŸ“‹ Todo
                            </button>
                            <button onclick="updateTaskStatus('${task.id}', 'in_progress')" style="flex: 1; padding: 10px; background: ${task.status === 'in_progress' ? '#ed8936' : '#f7fafc'}; color: ${task.status === 'in_progress' ? 'white' : '#718096'}; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;">
                                ğŸ”„ In Arbeit
                            </button>
                            <button onclick="updateTaskStatus('${task.id}', 'done')" style="flex: 1; padding: 10px; background: ${task.status === 'done' ? '#48bb78' : '#f7fafc'}; color: ${task.status === 'done' ? 'white' : '#718096'}; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;">
                                âœ… Erledigt
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 12px 0; color: #4a5568;">Kommentare (${comments.length})</h4>
                        <div style="max-height: 200px; overflow-y: auto; margin-bottom: 12px;">
                            ${comments.length > 0 ? comments.map(c => `
                                <div style="background: #f7fafc; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                        <span style="font-size: 12px; font-weight: 600; color: #3b82f6;">${c.erstellt_von || 'Unbekannt'}</span>
                                        <span style="font-size: 11px; color: #a0aec0;">${new Date(c.erstellt_am).toLocaleString('de-DE')}</span>
                                    </div>
                                    <p style="margin: 0; font-size: 13px; color: #2d3748;">${c.kommentar}</p>
                                </div>
                            `).join('') : '<p style="text-align: center; color: #a0aec0; padding: 20px;">Noch keine Kommentare</p>'}
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="new-comment-text" placeholder="Kommentar hinzufÃ¼gen..." style="flex: 1; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                            <button onclick="addTaskComment('${task.id}')" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div style="border-top: 1px solid #e2e8f0; padding-top: 16px; margin-top: 20px;">
                        <button onclick="deleteTask('${task.id}')" style="width: 100%; padding: 12px; background: #fee; color: #f56565; border: 2px solid #f56565; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-trash"></i> Task lÃ¶schen
                        </button>
                    </div>
                `;
                
                document.getElementById('task-detail-content').innerHTML = content;
                document.getElementById('modal-task-detail').style.display = 'flex';
            } catch (error) {
                console.error('Fehler beim Laden:', error);
                alert('Fehler beim Laden des Tasks!');
            }
        }
        
        async function updateTaskStatus(taskId, newStatus) {
            try {
                await fetch(`tables/tasks/${taskId}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        status: newStatus,
                        abgeschlossen_am: newStatus === 'done' ? Date.now() : null
                    })
                });
                closeModal('modal-task-detail');
                loadProjekte();
            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler beim Aktualisieren!');
            }
        }
        
        async function addTaskComment(taskId) {
            const text = document.getElementById('new-comment-text').value.trim();
            if (!text) return;
            
            try {
                await fetch('tables/task_kommentare', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        task_id: taskId,
                        kommentar: text,
                        erstellt_von: 'Admin'
                    })
                });
                document.getElementById('new-comment-text').value = '';
                openTaskDetail(taskId); // Reload
            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler beim Speichern!');
            }
        }
        
        async function deleteTask(taskId) {
            if (!confirm('âš ï¸ Task wirklich lÃ¶schen?')) return;
            
            try {
                await fetch(`tables/tasks/${taskId}`, {
                    method: 'DELETE'
                });
                closeModal('modal-task-detail');
                loadProjekte();
            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler beim LÃ¶schen!');
            }
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // ğŸ APPLE-STYLE: Neuer Partner Modal Ã¶ffnen
        function openModalNeuerPartner() {
            document.getElementById('modal-neuer-partner').style.display = 'flex';
            // Felder zurÃ¼cksetzen
            document.getElementById('neu-partner-vorname').value = '';
            document.getElementById('neu-partner-nachname').value = '';
            document.getElementById('neu-partner-email').value = '';
            document.getElementById('neu-partner-telefon').value = '';
            document.getElementById('neu-partner-firma').value = '';
            document.getElementById('neu-partner-passwort').value = '';
        }
        
        // ================================
        // ğŸ“¤ CSV IMPORT FUNKTIONEN
        // ================================
        
        let csvImportData = [];
        let existingPartnerEmails = [];
        
        function openCSVImportModal() {
            document.getElementById('modal-csv-import').style.display = 'flex';
            // Reset
            csvImportData = [];
            document.getElementById('csv-options').style.display = 'none';
            document.getElementById('csv-progress').style.display = 'none';
            document.getElementById('csv-file-input').value = '';
            // Load existing partners
            loadExistingPartnerEmails();
        }
        
        async function loadExistingPartnerEmails() {
            try {
                const res = await fetch('tables/partners?limit=10000');
                const data = await res.json();
                existingPartnerEmails = (data.data || []).map(p => p.email?.toLowerCase());
                console.log(`ğŸ“Š ${existingPartnerEmails.length} existierende Partner-E-Mails geladen`);
            } catch (e) {
                existingPartnerEmails = [];
            }
        }
        
        function handleCSVDrop(event) {
            event.preventDefault();
            document.getElementById('csv-upload-area').style.borderColor = '#e2e8f0';
            document.getElementById('csv-upload-area').style.background = 'white';
            const file = event.dataTransfer.files[0];
            if (file && file.name.endsWith('.csv')) {
                processCSVFile(file);
            } else {
                alert('Bitte eine CSV-Datei hochladen.');
            }
        }
        
        function handleCSVSelect(event) {
            const file = event.target.files[0];
            if (file) processCSVFile(file);
        }
        
        function processCSVFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                csvImportData = parseCSV(text);
                if (csvImportData.length > 0) {
                    showCSVPreview();
                } else {
                    alert('Die CSV-Datei enthÃ¤lt keine gÃ¼ltigen Daten.');
                }
            };
            reader.readAsText(file, 'UTF-8');
        }
        
        function parseCSV(text) {
            const lines = text.split('\n');
            if (lines.length < 2) return [];
            const headers = parseCSVLine(lines[0]);
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const values = parseCSVLine(line);
                const row = {};
                headers.forEach((h, idx) => {
                    row[h.trim()] = values[idx] ? values[idx].trim() : '';
                });
                if (row['Email'] && row['Email'].includes('@')) {
                    data.push(row);
                }
            }
            return data;
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { result.push(current); current = ''; }
                else current += char;
            }
            result.push(current);
            return result;
        }
        
        function showCSVPreview() {
            document.getElementById('csv-options').style.display = 'block';
            document.getElementById('csv-count').textContent = csvImportData.length;
            
            const tbody = document.getElementById('csv-preview-body');
            tbody.innerHTML = csvImportData.slice(0, 50).map((row, idx) => {
                const isDuplicate = existingPartnerEmails.includes(row['Email']?.toLowerCase());
                return `
                    <tr style="${isDuplicate ? 'background: #fef3c7;' : ''}">
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">${idx + 1}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">${row['Email']} ${isDuplicate ? '<span style="color: #d97706; font-size: 11px;">(Duplikat)</span>' : ''}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">${row['First Name'] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">${row['Last Name'] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">${row['Company'] || '-'}</td>
                    </tr>
                `;
            }).join('');
            
            if (csvImportData.length > 50) {
                tbody.innerHTML += `<tr><td colspan="5" style="padding: 16px; text-align: center; color: #718096;">... und ${csvImportData.length - 50} weitere</td></tr>`;
            }
        }
        
        async function startCSVImport() {
            const isAffiliate = document.getElementById('csv-is-affiliate').value === 'yes';
            const defaultPassword = document.getElementById('csv-default-password').value || 'Partner2026!';
            const mustChangePassword = document.getElementById('csv-must-change-password').value === 'yes';
            const partnerStatus = document.getElementById('csv-partner-status').value;
            
            // Filter duplicates
            const toImport = csvImportData.filter(row => !existingPartnerEmails.includes(row['Email']?.toLowerCase()));
            
            if (toImport.length === 0) {
                alert('Keine neuen Partner zum Importieren. Alle E-Mail-Adressen existieren bereits.');
                return;
            }
            
            if (!confirm(`ğŸ“¥ Import bestÃ¤tigen\n\n${toImport.length} neue Partner importieren?\n\nAffiliate: ${isAffiliate ? 'Ja' : 'Nein'}\nPasswort: ${defaultPassword}\nÃ„nderung erforderlich: ${mustChangePassword ? 'Ja' : 'Nein'}`)) {
                return;
            }
            
            document.getElementById('csv-import-btn').disabled = true;
            document.getElementById('csv-progress').style.display = 'block';
            
            let imported = 0;
            const total = toImport.length;
            const batchSize = 40;
            
            for (let i = 0; i < toImport.length; i += batchSize) {
                const batch = toImport.slice(i, i + batchSize);
                const rows = batch.map(row => ({
                    email: row['Email'].toLowerCase().trim(),
                    vorname: row['First Name'] || '',
                    nachname: row['Last Name'] || '',
                    firma: row['Company'] || '',
                    phone: row['Phone'] || '',
                    adresse: row['Address'] || '',
                    stadt: row['City'] || '',
                    plz: row['Zipcode'] || '',
                    land: row['Country'] || 'DE',
                    website: row['Website'] || '',
                    facebook: row['Facebook'] || '',
                    youtube: row['Youtube'] || '',
                    instagram: row['Instagram'] || '',
                    tiktok: row['Tiktok'] || '',
                    referral_code: row['Referral code'] || '',
                    standard_link: row['Standard link'] || '',
                    parent_name: row['Parent name'] || '',
                    parent_email: row['Parent email'] || '',
                    passwort_hash: defaultPassword,
                    passwort_muss_geaendert_werden: mustChangePassword,
                    ist_affiliate: isAffiliate,
                    modell: isAffiliate ? 'affiliate' : 'ladenlokal',
                    status: partnerStatus,
                    tarif: 'silber',
                    aktiv: true,
                    onboarding_abgeschlossen: isAffiliate,
                    registriert_am: Date.now()
                }));
                
                try {
                    await fetch('tables/partners', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(rows)
                    });
                    imported += batch.length;
                } catch (e) {
                    console.error('Batch-Import fehlgeschlagen:', e);
                }
                
                const progress = Math.round(((i + batch.length) / total) * 100);
                document.getElementById('csv-progress-bar').style.width = progress + '%';
                document.getElementById('csv-progress-text').textContent = `${i + batch.length} / ${total} importiert`;
                
                await new Promise(r => setTimeout(r, 200));
            }
            
            alert(`âœ… Import abgeschlossen!\n\n${imported} Partner wurden erfolgreich importiert.`);
            closeModal('modal-csv-import');
            loadPartnerVerwaltung(); // Reload partner list
        }
        
        // ğŸ APPLE-STYLE: Neuer Partner erstellen
        async function createNeuerPartner() {
            console.log('ğŸ†• createNeuerPartner() aufgerufen...');
            
            try {
                // Felder auslesen mit Fallback
                const vornameEl = document.getElementById('neu-partner-vorname');
                const nachnameEl = document.getElementById('neu-partner-nachname');
                const emailEl = document.getElementById('neu-partner-email');
                const telefonEl = document.getElementById('neu-partner-telefon');
                const firmaEl = document.getElementById('neu-partner-firma');
                const modellEl = document.getElementById('neu-partner-modell');
                const statusEl = document.getElementById('neu-partner-status');
                const passwortEl = document.getElementById('neu-partner-passwort');
                
                // Debug: PrÃ¼fe ob alle Elemente gefunden wurden
                console.log('ğŸ“‹ Form-Elemente:', {
                    vorname: !!vornameEl,
                    nachname: !!nachnameEl,
                    email: !!emailEl,
                    telefon: !!telefonEl,
                    firma: !!firmaEl,
                    modell: !!modellEl,
                    status: !!statusEl,
                    passwort: !!passwortEl
                });
                
                const vorname = vornameEl ? vornameEl.value.trim() : '';
                const nachname = nachnameEl ? nachnameEl.value.trim() : '';
                const email = emailEl ? emailEl.value.trim() : '';
                const telefon = telefonEl ? telefonEl.value.trim() : '';
                const firma = firmaEl ? firmaEl.value.trim() : '';
                const modell = modellEl ? modellEl.value : 'affiliate';
                const status = statusEl ? statusEl.value : 'neu';
                const passwort = passwortEl ? passwortEl.value : '';
                
                console.log('ğŸ“ Werte:', { vorname, nachname, email, telefon, firma, modell, status, passwort: passwort ? '****' : 'LEER' });
                
                // Validierung
                if (!vorname || !nachname || !email || !passwort) {
                    alert('âŒ Bitte fÃ¼lle alle Pflichtfelder (*) aus!\n\nVorname: ' + (vorname || 'FEHLT') + '\nNachname: ' + (nachname || 'FEHLT') + '\nE-Mail: ' + (email || 'FEHLT') + '\nPasswort: ' + (passwort ? 'OK' : 'FEHLT'));
                    return;
                }
                
                if (passwort.length < 6) {
                    alert('âŒ Das Passwort muss mindestens 6 Zeichen lang sein!');
                    return;
                }
                
                if (!email.includes('@')) {
                    alert('âŒ Bitte gib eine gÃ¼ltige E-Mail-Adresse ein!');
                    return;
                }
                
                // PrÃ¼fen, ob E-Mail bereits existiert
                console.log('ğŸ” PrÃ¼fe ob E-Mail existiert:', email);
                const checkRes = await fetch(`tables/partners?limit=5000&_t=${Date.now()}`);
                const checkData = await checkRes.json();
                const existingPartner = checkData.data.find(p => 
                    p.email && p.email.toLowerCase() === email.toLowerCase()
                );
                
                if (existingPartner) {
                    alert('âŒ Diese E-Mail-Adresse wird bereits verwendet!\n\nBitte verwende eine andere E-Mail-Adresse.');
                    return;
                }
                
                // Partner erstellen
                console.log('ğŸ“¤ Erstelle Partner...');
                const partnerData = {
                    email: email,
                    passwort: passwort,
                    vorname: vorname,
                    nachname: nachname,
                    phone: telefon,
                    firma: firma,
                    modell: modell,
                    status: status,
                    tarif: 'basic',
                    registriert_am: Date.now(),
                    onboarding_completed: false,
                    vertrag_unterschrieben: false,
                    dokumente_hochgeladen: false,
                    schulung_absolviert: false,
                    bankdaten_hinterlegt: false,
                    erster_vertrag_abgeschlossen: false
                };
                
                console.log('ğŸ“¦ Partner-Daten:', partnerData);
                
                const response = await fetch('tables/partners', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(partnerData)
                });
                
                console.log('ğŸ“¥ Response Status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ Server-Fehler:', errorText);
                    throw new Error('Server-Fehler: ' + response.status + ' - ' + errorText);
                }
                
                const newPartner = await response.json();
                console.log('âœ… Partner erstellt:', newPartner);
                
                // Erfolgsmeldung
                alert(`âœ… Partner erfolgreich angelegt!\n\n${vorname} ${nachname} wurde als neuer Partner registriert.\n\nE-Mail: ${email}\nModell: ${modell}`);
                
                // Formular zurÃ¼cksetzen
                if (vornameEl) vornameEl.value = '';
                if (nachnameEl) nachnameEl.value = '';
                if (emailEl) emailEl.value = '';
                if (telefonEl) telefonEl.value = '';
                if (firmaEl) firmaEl.value = '';
                if (passwortEl) passwortEl.value = '';
                
                // Modal schlieÃŸen
                closeModal('modal-neuer-partner');
                
                // ğŸ”„ Partner-Verwaltung (Tabelle + Statistiken) neu laden!
                await loadPartnerVerwaltung();
                
            } catch (error) {
                console.error('âŒ Fehler beim Erstellen des Partners:', error);
                alert('âŒ Fehler beim Anlegen des Partners!\n\n' + error.message);
            }
        }
        
        async function toggleTask(taskId) {
            try {
                await fetch(`tables/tasks/${taskId}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        status: 'done',
                        abgeschlossen_am: Date.now()
                    })
                });
                loadProjekte();
            } catch (error) {
                console.error('Fehler:', error);
            }
        }
        
        function editProjekt(projektId) {
            alert('Edit-Funktion kommt bald!\n\nDann kannst du Name, Beschreibung und Farbe Ã¤ndern.');
        }
        
        function deleteProjekt(projektId) {
            if (confirm('âš ï¸ Projekt wirklich lÃ¶schen?\n\nAlle Tasks in diesem Projekt werden ebenfalls gelÃ¶scht!')) {
                fetch(`tables/task_projekte/${projektId}`, {
                    method: 'DELETE'
                }).then(() => {
                    loadProjekte();
                }).catch(error => {
                    console.error('Fehler beim LÃ¶schen:', error);
                    alert('Fehler beim LÃ¶schen!');
                });
            }
        }
        
        function filterProjekte(filter) {
            currentFilter = filter;
            
            // Buttons aktualisieren
            ['all', 'active', 'completed'].forEach(f => {
                const btn = document.getElementById(`filter-btn-${f}`);
                if (f === filter) {
                    btn.style.background = 'var(--primary)';
                    btn.style.color = 'white';
                    btn.style.border = 'none';
                } else {
                    btn.style.background = 'white';
                    btn.style.color = '#718096';
                    btn.style.border = '2px solid #e2e8f0';
                }
            });
            
            loadProjekte();
        }
        
        async function openProjektDetail(projektId) {
            // Modal erstellen
            const modal = document.createElement('div');
            modal.id = 'projekt-detail-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); padding: 20px;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            const content = document.createElement('div');
            content.style.cssText = 'background: white; border-radius: 16px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);';
            
            // Loading
            content.innerHTML = `
                <div style="padding: 60px; text-align: center;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #3b82f6; margin-bottom: 20px;"></i>
                    <p style="font-size: 18px; color: #718096;">Lade Projekt-Details...</p>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            try {
                // Projekt laden
                const projektRes = await fetch(`tables/task_projekte/${projektId}`);
                const projekt = await projektRes.json();
                
                // Tasks laden
                const tasksRes = await fetch('tables/tasks?limit=500');
                const tasksData = await tasksRes.json();
                const projektTasks = tasksData.data.filter(t => t.projekt_id === projektId);
                
                const activeTasks = projektTasks.filter(t => t.status === 'todo' || t.status === 'in_progress');
                const completedTasks = projektTasks.filter(t => t.status === 'done');
                const progress = projektTasks.length > 0 ? Math.round((completedTasks.length / projektTasks.length) * 100) : 0;
                
                content.innerHTML = `
                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, ${projekt.farbe || '#3b82f6'}, ${projekt.farbe || '#3b82f6'}dd); padding: 32px; color: white; border-radius: 16px 16px 0 0; position: relative;">
                        <button onclick="document.getElementById('projekt-detail-modal').remove()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 20px;">
                            <i class="fas fa-times"></i>
                        </button>
                        <h2 style="margin: 0 0 12px 0; font-size: 28px; font-weight: 700;">${projekt.name}</h2>
                        <p style="margin: 0; opacity: 0.9; font-size: 16px;">${projekt.beschreibung || 'Keine Beschreibung'}</p>
                    </div>
                    
                    <div style="padding: 32px;">
                        <!-- Stats -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 32px;">
                            <div style="background: #f7fafc; border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: ${projekt.farbe || '#3b82f6'};">${projektTasks.length}</div>
                                <div style="font-size: 13px; color: #718096; margin-top: 4px;">Gesamt Tasks</div>
                            </div>
                            <div style="background: #f7fafc; border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #48bb78;">${completedTasks.length}</div>
                                <div style="font-size: 13px; color: #718096; margin-top: 4px;">Erledigt</div>
                            </div>
                            <div style="background: #f7fafc; border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #ed8936;">${activeTasks.length}</div>
                                <div style="font-size: 13px; color: #718096; margin-top: 4px;">Offen</div>
                            </div>
                            <div style="background: #f7fafc; border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: ${projekt.farbe || '#3b82f6'};">${progress}%</div>
                                <div style="font-size: 13px; color: #718096; margin-top: 4px;">Fortschritt</div>
                            </div>
                        </div>
                        
                        <!-- Aktive Tasks -->
                        <div style="margin-bottom: 32px;">
                            <h3 style="font-size: 18px; font-weight: 700; color: #1a202c; margin: 0 0 16px 0;">
                                <i class="fas fa-tasks"></i> Aktive Tasks (${activeTasks.length})
                            </h3>
                            ${activeTasks.length > 0 ? `
                                <div style="display: grid; gap: 12px;">
                                    ${activeTasks.map(task => {
                                        const prioColors = {high: '#f56565', medium: '#ed8936', low: '#48bb78'};
                                        const prioLabels = {high: 'Hoch', medium: 'Mittel', low: 'Niedrig'};
                                        return `
                                            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 10px; padding: 16px; transition: all 0.2s;" onmouseover="this.style.borderColor='${projekt.farbe || '#3b82f6'}'" onmouseout="this.style.borderColor='#e2e8f0'">
                                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                                    <div style="flex: 1;">
                                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                                            <input type="checkbox" onclick="toggleTask('${task.id}')" style="cursor: pointer; width: 18px; height: 18px;">
                                                            <h4 style="margin: 0; font-size: 15px; font-weight: 600; color: #1a202c;">${task.titel}</h4>
                                                        </div>
                                                        ${task.beschreibung ? `<p style="margin: 0 0 8px 26px; font-size: 13px; color: #718096;">${task.beschreibung}</p>` : ''}
                                                        <div style="display: flex; gap: 8px; margin-left: 26px; flex-wrap: wrap;">
                                                            ${task.prioritaet ? `<span style="background: ${prioColors[task.prioritaet]}20; color: ${prioColors[task.prioritaet]}; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">${prioLabels[task.prioritaet]}</span>` : ''}
                                                            ${task.kategorie ? `<span style="background: #3b82f620; color: #3b82f6; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">${task.kategorie}</span>` : ''}
                                                            ${task.deadline ? `<span style="background: #f7fafc; color: #718096; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;"><i class="fas fa-calendar"></i> ${new Date(task.deadline).toLocaleDateString('de-DE')}</span>` : ''}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : '<div style="text-align: center; padding: 40px; color: #a0aec0;"><i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 12px; opacity: 0.3; display: block;"></i><p>Keine offenen Tasks</p></div>'}
                        </div>
                        
                        <!-- Erledigte Tasks -->
                        ${completedTasks.length > 0 ? `
                            <div>
                                <h3 style="font-size: 18px; font-weight: 700; color: #1a202c; margin: 0 0 16px 0;">
                                    <i class="fas fa-check-circle"></i> Erledigte Tasks (${completedTasks.length})
                                </h3>
                                <div style="display: grid; gap: 12px;">
                                    ${completedTasks.map(task => `
                                        <div style="background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 10px; padding: 16px; opacity: 0.7;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <i class="fas fa-check-circle" style="color: #48bb78; font-size: 18px;"></i>
                                                <span style="font-size: 15px; color: #718096; text-decoration: line-through;">${task.titel}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
                
            } catch (error) {
                console.error('âŒ Fehler:', error);
                content.innerHTML = `
                    <div style="padding: 60px; text-align: center;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 64px; color: #f56565; margin-bottom: 20px;"></i>
                        <h3 style="color: #1a202c; margin: 0 0 12px 0;">Fehler beim Laden</h3>
                        <p style="color: #718096; margin: 0;">${error.message}</p>
                        <button onclick="document.getElementById('projekt-detail-modal').remove()" style="margin-top: 24px; padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">SchlieÃŸen</button>
                    </div>
                `;
            }
        }

        // Dashboard beim Tab-Wechsel laden (bereits in switchTab Funktion oben integriert)

        // Initial laden wenn Dashboard Tab aktiv ist
        // âŒ NICHT mehr beim Load aufrufen - nur wenn Tab geklickt wird!
        // (Wird in switchTab() aufgerufen wenn tabName === 'dashboard')

        // ====================================
        // ğŸ’¬ LIVE CHAT LADEN
        // ====================================
        async function loadChatMessages() {
            try {
                const res = await fetch('tables/chat_nachrichten?limit=100');
                const data = await res.json();
                
                const chatList = document.getElementById('chat-list');
                
                if (data.data.length === 0) {
                    chatList.innerHTML = '<div style="text-align: center; padding: 60px; color: #a0aec0;"><i class="fas fa-comments" style="font-size: 48px; margin-bottom: 20px; opacity: 0.3;"></i><p style="font-size: 18px; font-weight: 600;">Noch keine Chat-Nachrichten</p></div>';
                    return;
                }
                
                // Gruppiere nach Partner
                const byPartner = {};
                data.data.forEach(msg => {
                    if (!byPartner[msg.partner_email]) {
                        byPartner[msg.partner_email] = [];
                    }
                    byPartner[msg.partner_email].push(msg);
                });
                
                let html = '';
                Object.keys(byPartner).forEach(email => {
                    const messages = byPartner[email].sort((a, b) => new Date(b.gesendet_am) - new Date(a.gesendet_am));
                    const lastMsg = messages[0];
                    const unread = messages.filter(m => !m.gelesen && m.absender_typ === 'partner').length;
                    
                    html += `
                        <div onclick="openChatModal('${email}')" style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 15px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#3b82f6'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(102,126,234,0.15)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div style="font-weight: 700; font-size: 16px; color: #2d3748;">
                                    <i class="fas fa-user-circle" style="color: #3b82f6; margin-right: 8px;"></i>${lastMsg.absender_name || email}
                                </div>
                                ${unread > 0 ? `<span style="background: linear-gradient(135deg, #fc8181, #f56565); color: white; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 700; box-shadow: 0 2px 8px rgba(252,129,129,0.3);">${unread} neu</span>` : ''}
                            </div>
                            <div style="color: #718096; font-size: 14px; margin-bottom: 8px; line-height: 1.5;">
                                <i class="fas fa-comment-dots" style="margin-right: 6px; color: #a0aec0;"></i>${lastMsg.nachricht.substring(0, 100)}${lastMsg.nachricht.length > 100 ? '...' : ''}
                            </div>
                            <div style="font-size: 12px; color: #a0aec0;">
                                <i class="far fa-clock" style="margin-right: 6px;"></i>${new Date(lastMsg.gesendet_am).toLocaleString('de-DE')}
                            </div>
                        </div>
                    `;
                });
                
                chatList.innerHTML = html;
            } catch (error) {
                console.error('Fehler beim Laden der Chat-Nachrichten:', error);
                document.getElementById('chat-list').innerHTML = '<div style="text-align: center; padding: 40px; color: #f56565;"><i class="fas fa-exclamation-circle" style="font-size: 40px; margin-bottom: 15px;"></i><p>Fehler beim Laden der Nachrichten</p></div>';
            }
        }

        // ====================================
        // ğŸ« TICKETS LADEN
        // ====================================
        async function loadTickets() {
            try {
                const res = await fetch('tables/tickets?limit=100');
                const data = await res.json();
                
                // Stats berechnen
                const offen = data.data.filter(t => t.status === 'offen').length;
                const bearbeitung = data.data.filter(t => t.status === 'in_bearbeitung').length;
                const geloest = data.data.filter(t => t.status === 'geloest').length;
                
                document.getElementById('tickets-offen').textContent = offen;
                document.getElementById('tickets-bearbeitung').textContent = bearbeitung;
                document.getElementById('tickets-geloest').textContent = geloest;
                document.getElementById('tickets-gesamt').textContent = data.data.length;
                
                const tbody = document.getElementById('ticketsTable');
                
                if (data.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #a0aec0;">Keine Tickets vorhanden</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.data.map(ticket => {
                    const statusColors = {
                        'offen': 'badge-warning',
                        'in_bearbeitung': 'badge-info',
                        'geloest': 'badge-success'
                    };
                    const priorityColors = {
                        'hoch': '#f56565',
                        'mittel': '#ed8936',
                        'niedrig': '#48bb78'
                    };
                    
                    return `
                        <tr onclick="openTicketModal('${ticket.id}')" style="cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f7fafc'" onmouseout="this.style.background='white'">
                            <td><strong>#${ticket.ticket_nr}</strong></td>
                            <td>${ticket.partner_name || 'N/A'}</td>
                            <td>${ticket.betreff}</td>
                            <td><span class="badge badge-info">${ticket.kategorie || 'Allgemein'}</span></td>
                            <td><span style="color: ${priorityColors[ticket.prioritaet] || '#a0aec0'}; font-weight: 600;">${ticket.prioritaet || 'mittel'}</span></td>
                            <td><span class="badge ${statusColors[ticket.status] || 'badge-secondary'}">${ticket.status}</span></td>
                            <td>${new Date(ticket.erstellt_am).toLocaleDateString('de-DE')}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Fehler beim Laden der Tickets:', error);
                document.getElementById('ticketsTable').innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #f56565;">Fehler beim Laden der Tickets</td></tr>';
            }
        }

        // ====================================
        // ğŸ“… TERMINE & KALENDER
        // ====================================
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let allTermine = [];

        async function loadTermine() {
            try {
                console.log('ğŸ“… Lade Termine...');
                const res = await fetch('tables/termine?limit=100&sort=-datum');
                const data = await res.json();
                allTermine = data.data;
                
                console.log('âœ… Termine geladen:', allTermine.length);
                
                // Kalender rendern
                renderCalendar();
                
                // Termine-Liste rendern (nÃ¤chste 5)
                renderTermineListe();
                
                // Tabelle rendern
                renderTermineTabelle();
                
            } catch (error) {
                console.error('âŒ Fehler beim Laden der Termine:', error);
                document.getElementById('termineTable').innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #f56565;">Fehler beim Laden der Termine</td></tr>';
            }
        }

        function renderCalendar() {
            const monthNames = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            const dayNames = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
            
            // Header aktualisieren
            document.getElementById('calendar-header').textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            // Kalender Grid
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            // Wochentage
            dayNames.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.style.cssText = 'text-align: center; font-weight: 700; color: #3b82f6; padding: 8px; font-size: 12px;';
                dayHeader.textContent = day;
                grid.appendChild(dayHeader);
            });
            
            // Erster Tag des Monats
            const firstDay = new Date(currentYear, currentMonth, 1);
            let startDay = firstDay.getDay();
            if (startDay === 0) startDay = 7; // Sonntag = 7
            startDay -= 1; // Mo = 0
            
            // Leere Zellen am Anfang
            for (let i = 0; i < startDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.style.cssText = 'padding: 12px; text-align: center;';
                grid.appendChild(emptyDay);
            }
            
            // Tage des Monats
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const today = new Date();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                const cellDate = new Date(currentYear, currentMonth, day);
                
                // Termine an diesem Tag
                const termineToday = allTermine.filter(t => {
                    const tDate = new Date(t.datum);
                    return tDate.getDate() === day && 
                           tDate.getMonth() === currentMonth && 
                           tDate.getFullYear() === currentYear;
                });
                
                // Style
                const isToday = today.getDate() === day && 
                               today.getMonth() === currentMonth && 
                               today.getFullYear() === currentYear;
                
                dayCell.style.cssText = `
                    padding: 12px 8px;
                    text-align: center;
                    border-radius: 8px;
                    cursor: pointer;
                    transition: all 0.2s;
                    background: ${isToday ? '#3b82f6' : (termineToday.length > 0 ? '#f7fafc' : 'white')};
                    color: ${isToday ? 'white' : '#1a202c'};
                    border: ${termineToday.length > 0 ? '2px solid #3b82f6' : '1px solid #e2e8f0'};
                    font-weight: ${isToday || termineToday.length > 0 ? '700' : '400'};
                `;
                
                dayCell.onmouseover = () => {
                    if (!isToday) {
                        dayCell.style.background = '#f7fafc';
                        dayCell.style.borderColor = '#3b82f6';
                    }
                };
                dayCell.onmouseout = () => {
                    if (!isToday) {
                        dayCell.style.background = termineToday.length > 0 ? '#f7fafc' : 'white';
                        dayCell.style.borderColor = termineToday.length > 0 ? '#3b82f6' : '#e2e8f0';
                    }
                };
                
                dayCell.innerHTML = `
                    <div style="font-size: 14px; margin-bottom: 4px;">${day}</div>
                    ${termineToday.length > 0 ? `<div style="font-size: 10px; color: ${isToday ? 'white' : '#3b82f6'};">${termineToday.length} Termin${termineToday.length > 1 ? 'e' : ''}</div>` : ''}
                `;
                
                dayCell.onclick = () => showTermineForDay(cellDate);
                
                grid.appendChild(dayCell);
            }
        }

        function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }

        function renderTermineListe() {
            const liste = document.getElementById('termine-liste');
            
            // Nur zukÃ¼nftige Termine
            const now = new Date();
            const zukunftige = allTermine
                .filter(t => new Date(t.datum) >= now)
                .sort((a, b) => new Date(a.datum) - new Date(b.datum))
                .slice(0, 5);
            
            if (zukunftige.length === 0) {
                liste.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #a0aec0;">
                        <i class="fas fa-calendar-check" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
                        <p>Keine kommenden Termine</p>
                    </div>
                `;
                return;
            }
            
            liste.innerHTML = zukunftige.map(termin => {
                const date = new Date(termin.datum);
                const statusColors = {
                    'geplant': '#3b82f6',
                    'bestaetigt': '#48bb78',
                    'abgesagt': '#f56565'
                };
                const color = statusColors[termin.status] || '#718096';
                
                return `
                    <div style="padding: 16px; background: white; border: 2px solid #e2e8f0; border-radius: 10px; cursor: pointer; transition: all 0.2s;" 
                         onmouseover="this.style.borderColor='${color}'" 
                         onmouseout="this.style.borderColor='#e2e8f0'"
                         onclick="openTerminDetail('${termin.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div style="font-weight: 700; color: #1a202c; font-size: 15px;">${termin.titel || 'Ohne Titel'}</div>
                            <div style="background: ${color}20; color: ${color}; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">
                                ${termin.status || 'geplant'}
                            </div>
                        </div>
                        <div style="display: flex; gap: 16px; font-size: 13px; color: #718096;">
                            <span><i class="fas fa-calendar"></i> ${date.toLocaleDateString('de-DE')}</span>
                            <span><i class="fas fa-clock"></i> ${termin.uhrzeit || 'â€”'}</span>
                            ${termin.partner_email ? `<span><i class="fas fa-user"></i> ${termin.partner_email}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderTermineTabelle() {
            const tbody = document.getElementById('termineTable');
            
            if (allTermine.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #a0aec0;">Keine Termine vorhanden</td></tr>';
                return;
            }
            
            tbody.innerHTML = allTermine.map(termin => {
                const date = new Date(termin.datum);
                const statusColors = {
                    'geplant': 'badge-info',
                    'bestaetigt': 'badge-success',
                    'abgesagt': 'badge-danger'
                };
                
                return `
                    <tr onclick="openTerminDetail('${termin.id}')" style="cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f7fafc'" onmouseout="this.style.background='white'">
                        <td>${date.toLocaleDateString('de-DE')}</td>
                        <td>${termin.uhrzeit || 'â€”'}</td>
                        <td><strong>${termin.titel || 'Ohne Titel'}</strong></td>
                        <td>${termin.partner_email || 'â€”'}</td>
                        <td><span class="badge badge-info">${termin.typ || 'Meeting'}</span></td>
                        <td><span class="badge ${statusColors[termin.status] || 'badge-secondary'}">${termin.status || 'geplant'}</span></td>
                        <td>
                            <button onclick="event.stopPropagation(); deleteTermin('${termin.id}')" style="padding: 6px 12px; background: #fee; color: #f56565; border: 1px solid #f56565; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function openNeuerTerminModal() {
            // âœ… APPLE-STYLE MODAL Ã–FFNEN
            document.getElementById('modal-neuer-termin').style.display = 'flex';
            
            // Felder zurÃ¼cksetzen
            document.getElementById('admin-termin-titel').value = '';
            document.getElementById('admin-termin-datum').value = '';
            document.getElementById('admin-termin-uhrzeit').value = '';
            document.getElementById('admin-termin-partner').value = '';
            document.getElementById('admin-termin-typ').value = 'Meeting';
            document.getElementById('admin-termin-beschreibung').value = '';
            
            // Heutiges Datum als Standard
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('admin-termin-datum').value = today;
        }

        function openTerminDetail(terminId) {
            alert(`Detail-View fÃ¼r Termin ${terminId} (wird noch implementiert)`);
        }

        function showTermineForDay(date) {
            alert(`Termine fÃ¼r ${date.toLocaleDateString('de-DE')} (wird noch implementiert)`);
        }

        async function deleteTermin(terminId) {
            if (!confirm('Termin wirklich lÃ¶schen?')) return;
            
            try {
                await fetch(`tables/termine/${terminId}`, {
                    method: 'DELETE'
                });
                alert('âœ… Termin gelÃ¶scht!');
                loadTermine();
            } catch (error) {
                alert('âŒ Fehler beim LÃ¶schen: ' + error.message);
            }
        }

        // Auto-Load bei Tab-Wechsel
        const originalSwitchTab2 = window.switchTab;
        window.switchTab = function(tabName) {
            originalSwitchTab2(tabName);
            if (tabName === 'kommunikation') {
                loadChatMessages();
                loadTickets();
                loadTermine();
            }
        };
        
        // ========================================
        // ğŸ“Š CHARTS FUNKTION (muss VOR Auto-Init definiert werden!)
        window.initCharts = function() {
            console.log('ğŸ“Š initCharts() wird aufgerufen...');
            // Warten bis loadDashboardData definiert ist
            let attempts = 0;
            const maxAttempts = 20;
            const checkInterval = setInterval(() => {
                attempts++;
                console.log(`ğŸ”„ Versuch ${attempts}/${maxAttempts} - PrÃ¼fe ob loadDashboardData definiert ist...`);
                
                if (typeof window.loadDashboardData === 'function') {
                    console.log('âœ… loadDashboardData gefunden - Charts mit echten Daten laden...');
                    clearInterval(checkInterval);
                    window.loadDashboardData();
                } else if (attempts >= maxAttempts) {
                    console.error('âŒ loadDashboardData ist nach 20 Versuchen noch nicht definiert!');
                    clearInterval(checkInterval);
                }
            }, 200);
        };
        
        // AUTO-INITIALISIERUNG
        // ========================================
        (function initDashboard() {
            console.log('ğŸš€ Admin-Dashboard AUTO-Initialisierung...');
            
            // Dashboard als ersten Tab aktivieren
            const dashboardTab = document.getElementById('tab-dashboard');
            if (dashboardTab) {
                dashboardTab.style.display = 'block';
                dashboardTab.classList.add('active');
                console.log('âœ… Dashboard-Tab aktiviert');
            } else {
                console.error('âŒ tab-dashboard Element nicht gefunden!');
            }
            
            // Dashboard-Daten laden (nach DOMContentLoaded)
            // ğŸ”— SCHNITTSTELLEN-FUNKTIONEN: Tab-Wechsel mit automatischen Filtern
            // âœ… GLOBAL EXPORTIERT fÃ¼r onclick-Handler in Badge-Elementen
            
            /**
             * Springt zum VertrÃ¤ge-Tab und setzt den Status-Filter
             * âœ… GLOBAL VERFÃœGBAR via window.springZuVertraege
             */
            window.springZuVertraege = function(status) {
                console.log('ğŸ”— Spring zu VertrÃ¤ge mit Status:', status);
                
                // Zum All-in-One Tab wechseln
                switchTab('all-in-one');
                
                // âœ… Daten laden falls noch nicht geladen
                setTimeout(() => {
                    if (typeof loadAllInOneData === 'function') {
                        loadAllInOneData();
                    }
                    
                    // Zum VertrÃ¤ge-Bereich scrollen (mit Icon-Klasse statt style)
                    setTimeout(() => {
                        const vertraegeSection = document.querySelector('#tab-all-in-one .fa-file-contract')?.closest('h2');
                        if (vertraegeSection) {
                            vertraegeSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                        
                        // Status-Filter setzen
                        const statusFilter = document.getElementById('vertraege-status-filter');
                        if (statusFilter) {
                            statusFilter.value = status;
                            console.log('âœ… Status-Filter gesetzt:', status);
                            
                            // Filter anwenden
                            if (typeof filterVertraegeByPartner === 'function') {
                                filterVertraegeByPartner();
                            }
                        }
                        
                        // Toast-Benachrichtigung
                        showToast(`ğŸ“Š Zeige VertrÃ¤ge mit Status: ${status.replace('_', ' ').toUpperCase()}`, 'info');
                    }, 400);
                }, 200);
            };
            
            /**
             * Springt zum Provisionen-Tab und setzt den Status-Filter
             * âœ… GLOBAL VERFÃœGBAR via window.springZuProvisionen
             */
            window.springZuProvisionen = function(status) {
                console.log('ğŸ”— Spring zu Provisionen mit Status:', status);
                
                // Zum All-in-One Tab wechseln
                switchTab('all-in-one');
                
                // âœ… Daten laden falls noch nicht geladen
                setTimeout(() => {
                    if (typeof loadAllInOneData === 'function') {
                        loadAllInOneData();
                    }
                    
                    // Zum Provisionen-Bereich scrollen
                    setTimeout(() => {
                        const provisionenSection = document.querySelector('#tab-all-in-one .fa-euro-sign')?.closest('h2');
                        if (provisionenSection) {
                            provisionenSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                        
                        // Status-Filter setzen
                        const statusFilter = document.getElementById('provisionen-status-filter');
                        if (statusFilter) {
                            statusFilter.value = status;
                            console.log('âœ… Status-Filter gesetzt:', status);
                            
                            // Filter anwenden
                            if (typeof filterProvisionenByPartner === 'function') {
                                filterProvisionenByPartner();
                            }
                        }
                        
                        // Toast-Benachrichtigung
                        showToast(`ğŸ’° Zeige Provisionen mit Status: ${status.toUpperCase()}`, 'info');
                    }, 400);
                }, 200);
            };
            
            /**
             * Springt zum Auszahlungen-Tab und setzt den Status-Filter
             * âœ… GLOBAL VERFÃœGBAR via window.springZuAuszahlungen
             */
            window.springZuAuszahlungen = function(status) {
                console.log('ğŸ”— Spring zu Auszahlungen mit Status:', status);
                
                // Zum All-in-One Tab wechseln
                switchTab('all-in-one');
                
                // âœ… Daten laden falls noch nicht geladen
                setTimeout(() => {
                    if (typeof loadAllInOneData === 'function') {
                        loadAllInOneData();
                    }
                    
                    // Zum Auszahlungen-Bereich scrollen
                    setTimeout(() => {
                        const auszahlungenSection = document.querySelector('#tab-all-in-one .fa-money-bill-wave')?.closest('h2');
                        if (auszahlungenSection) {
                            auszahlungenSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                        
                        // Status-Filter setzen
                        const statusFilter = document.getElementById('auszahlungen-status-filter');
                        if (statusFilter) {
                            statusFilter.value = status;
                            console.log('âœ… Status-Filter gesetzt:', status);
                            
                            // Filter anwenden
                            if (typeof filterAuszahlungenByPartner === 'function') {
                                filterAuszahlungenByPartner();
                            }
                        }
                        
                        // Toast-Benachrichtigung
                        showToast(`ğŸ’³ Zeige Auszahlungen mit Status: ${status.toUpperCase()}`, 'info');
                    }, 400);
                }, 200);
            };
            
            document.addEventListener('DOMContentLoaded', async () => {
                console.log('ğŸ”„ DOM geladen - Lade Dashboard-Daten...');
                
                // âœ… AUTO-RESTORE: PrÃ¼fen ob DB leer und Cache vorhanden
                if (window.LocalPersistence) {
                    console.log('ğŸ”„ [Admin] PrÃ¼fe Auto-Restore...');
                    const restoreResult = await LocalPersistence.autoRestore();
                    if (restoreResult) {
                        console.log('âœ… [Admin] Auto-Restore abgeschlossen:', restoreResult);
                    }
                    
                    // Cache-Stats anzeigen
                    const stats = LocalPersistence.getStats();
                    console.log('ğŸ“Š [Admin] LocalPersistence Stats:', stats);
                }
                
                // â„¹ï¸ INFO: Datums-Filter wurden entfernt - Stat-Cards zeigen automatisch alle ZeitrÃ¤ume
                
                if (typeof window.loadDashboardData === 'function') {
                    window.loadDashboardData();  // â­ CHARTS LADEN!
                }
                if (typeof loadDashboardOverview === 'function') {
                    loadDashboardOverview();
                }
                if (typeof loadPartnerAktivitaeten === 'function') {
                    loadPartnerAktivitaeten();
                }
                if (typeof loadSchnellzugriffVertraege === 'function') {
                    loadSchnellzugriffVertraege(); // âš¡ NEUE VERTRÃ„GE LADEN
                }
                if (typeof loadPendingTasks === 'function') {
                    loadPendingTasks();
                }
            });
            
            // Benachrichtigungen laden
            setTimeout(() => {
                if (typeof loadBenachrichtigungen === 'function') {
                    loadBenachrichtigungen();
                }
            }, 1000);
            
            console.log('âœ… Auto-Initialisierung abgeschlossen!');
            
            // â„¹ï¸ INFO: Datums-Filter wurden entfernt - Stat-Cards zeigen automatisch alle ZeitrÃ¤ume
            
            // âš ï¸ HINWEIS: initCharts() wird NICHT automatisch aufgerufen!
            // Charts werden nur geladen, wenn der "all-in-one" Tab aktiv ist
            // (siehe switchTab Funktion)
        })();
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ“ AKADEMIE-FORTSCHRITT LADEN (FÃœR ADMIN)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        window.loadAkademieFortschritt = async function() {
            try {
                console.log('ğŸ“ Lade Akademie-Fortschritt...');
                
                const container = document.getElementById('akademie-fortschritt');
                if (!container) return;
                
                // Loading State
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #a0aec0;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i><p>Lade Daten...</p></div>';
                
                // Lade Fortschritt aus DB - RICHTIGE TABELLE
                const response = await fetch('tables/akademie_progress?limit=1000');
                const data = await response.json();
                
                console.log('ğŸ“Š Akademie-Daten geladen:', data.data.length, 'EintrÃ¤ge');
                
                // Gruppiere nach Partner
                const partnerProgress = {};
                data.data.forEach(p => {
                    if (!partnerProgress[p.partner_email]) {
                        partnerProgress[p.partner_email] = {
                            email: p.partner_email,
                            module: []
                        };
                    }
                    partnerProgress[p.partner_email].module.push(p);
                });
                
                // Sortiere nach Fortschritt (abgeschlossene Module)
                const sortedPartners = Object.values(partnerProgress).sort((a, b) => {
                    const aCompleted = a.module.filter(m => m.status === 'abgeschlossen').length;
                    const bCompleted = b.module.filter(m => m.status === 'abgeschlossen').length;
                    return bCompleted - aCompleted;
                });
                
                // Render UI
                if (sortedPartners.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #a0aec0;"><i class="fas fa-graduation-cap" style="font-size: 2rem; margin-bottom: 1rem;"></i><p>Noch keine Akademie-Daten vorhanden</p></div>';
                    return;
                }
                
                container.innerHTML = sortedPartners.map(partner => {
                    const completed = partner.module.filter(m => m.status === 'abgeschlossen').length;
                    const inProgress = partner.module.filter(m => m.status === 'in_bearbeitung').length;
                    const total = 8; // Anzahl Module
                    const progressPercent = Math.round((completed / total) * 100);
                    
                    return `
                        <div style="padding: 16px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 16px; transition: background 0.2s;" onmouseover="this.style.background='#f7fafc'" onmouseout="this.style.background='transparent'">
                            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #3b82f6, #60a5fa); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 18px;">
                                ${partner.email.substring(0, 2).toUpperCase()}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #2d3748; margin-bottom: 4px;">${partner.email}</div>
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                    <span style="font-size: 13px; color: #48bb78; font-weight: 600;">
                                        <i class="fas fa-check-circle"></i> ${completed} abgeschlossen
                                    </span>
                                    <span style="font-size: 13px; color: #3b82f6; font-weight: 600;">
                                        <i class="fas fa-spinner"></i> ${inProgress} in Bearbeitung
                                    </span>
                                    <span style="font-size: 13px; color: #a0aec0; font-weight: 600;">
                                        <i class="fas fa-hourglass-start"></i> ${total - completed - inProgress} offen
                                    </span>
                                </div>
                                <div style="background: #e2e8f0; height: 8px; border-radius: 10px; overflow: hidden;">
                                    <div style="background: linear-gradient(90deg, #48bb78, #38a169); height: 100%; width: ${progressPercent}%; transition: width 0.5s;"></div>
                                </div>
                            </div>
                            <div style="text-align: right; min-width: 60px;">
                                <div style="font-size: 20px; font-weight: 800; color: ${progressPercent >= 100 ? '#48bb78' : '#3b82f6'};">${progressPercent}%</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                console.log('âœ… Akademie-Fortschritt angezeigt:', sortedPartners.length, 'Partner');
                
            } catch (error) {
                console.error('âŒ Fehler beim Laden des Akademie-Fortschritts:', error);
                const container = document.getElementById('akademie-fortschritt');
                if (container) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #f56565;"><i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i><p>Fehler beim Laden!</p></div>';
                }
            }
        };
        
        // Auto-Load beim Seitenwechsel
        if (typeof window.loadAkademieFortschritt === 'function') {
            const originalShowPage = window.showPage;
            window.showPage = function(pageId) {
                originalShowPage(pageId);
                if (pageId === 'analytics') {
                    setTimeout(() => loadAkademieFortschritt(), 500);
                }
            };
        }

        // ğŸ“Š HOCHRECHNUNG BERECHNEN - KORRIGIERT fÃ¼r VertrÃ¤ge
        // Nimmt jetzt VertrÃ¤ge entgegen und nutzt gesamt_provision statt betrag
        function calculateHochrechnung(vertraege) {
            console.log('ğŸ“Š Berechne Hochrechnung aus VertrÃ¤gen...');
            console.log('ğŸ“Š Anzahl VertrÃ¤ge fÃ¼r Hochrechnung:', vertraege.length);
            
            const heute = new Date();
            const tagDesMonats = heute.getDate(); // z.B. 29 (29. Januar)
            const monatStart = new Date(heute.getFullYear(), heute.getMonth(), 1);
            const daysInMonth = new Date(heute.getFullYear(), heute.getMonth() + 1, 0).getDate();
            
            // âœ… KORRIGIERT: VertrÃ¤ge des aktuellen Monats filtern (nicht storniert)
            const vertraegeMonat = vertraege.filter(v => {
                const datum = new Date(v.erstellt_am || v.created_at);
                const isValidDate = !isNaN(datum.getTime());
                const isInMonth = datum >= monatStart && datum <= heute;
                const isNotStorniert = v.vertrag_status !== 'storniert';
                return isValidDate && isInMonth && isNotStorniert;
            });
            
            console.log('ğŸ“Š VertrÃ¤ge diesen Monat:', vertraegeMonat.length);
            
            // âœ… KORRIGIERT: gesamt_provision aus VertrÃ¤gen verwenden
            const provisionMonat = vertraegeMonat.reduce((sum, v) => {
                const provision = parseFloat(v.gesamt_provision || v.provision || v.provision_betrag || 0);
                return sum + provision;
            }, 0);
            
            console.log('ğŸ“Š Provision diesen Monat:', provisionMonat.toFixed(2), 'â‚¬');
            
            // âœ… HOCHRECHNUNGS-FORMEL: (Provision bisher / Tage vergangen) * Tage im Monat
            const hochrechnungMonat = tagDesMonats > 0 ? (provisionMonat / tagDesMonats) * daysInMonth : 0;
            const avgProTag = tagDesMonats > 0 ? provisionMonat / tagDesMonats : 0;
            
            // Jahres-Hochrechnung (12 Monate basierend auf aktuellem Monat)
            const hochrechnungJahr = hochrechnungMonat * 12;
            const avgProMonat = hochrechnungMonat;
            
            // Wachstumsprognose (Optional: +10% Bonus)
            const prognoseBestCase = hochrechnungMonat * 1.1;
            
            // Zielerreichung (Beispiel: Ziel 5000â‚¬/Monat)
            const zielMonat = 5000;
            const zielerreichung = hochrechnungMonat > 0 ? Math.round((hochrechnungMonat / zielMonat) * 100) : 0;
            
            console.log(`ğŸ“Š Hochrechnung: ${provisionMonat.toFixed(2)}â‚¬ / ${tagDesMonats} Tage * ${daysInMonth} Tage = ${hochrechnungMonat.toFixed(2)}â‚¬`);
            
            // UI aktualisieren
            const elAktuellerTag = document.getElementById('hochrechnung-aktueller-tag');
            const elMonat = document.getElementById('hochrechnung-monat');
            const elMonatSub = document.getElementById('hochrechnung-monat-sub');
            const elJahr = document.getElementById('hochrechnung-jahr');
            const elJahrSub = document.getElementById('hochrechnung-jahr-sub');
            const elPrognose = document.getElementById('hochrechnung-prognose');
            const elPrognoseSub = document.getElementById('hochrechnung-prognose-sub');
            const elZielerreichung = document.getElementById('hochrechnung-zielerreichung');
            const elZielerreichungSub = document.getElementById('hochrechnung-zielerreichung-sub');
            
            if (elAktuellerTag) elAktuellerTag.textContent = tagDesMonats;
            if (elMonat) elMonat.textContent = `${hochrechnungMonat.toFixed(2).replace('.', ',')} â‚¬`;
            if (elMonatSub) elMonatSub.textContent = `Ã˜ pro Tag: ${avgProTag.toFixed(2).replace('.', ',')} â‚¬`;
            if (elJahr) elJahr.textContent = `${hochrechnungJahr.toFixed(2).replace('.', ',')} â‚¬`;
            if (elJahrSub) elJahrSub.textContent = `Ã˜ pro Monat: ${avgProMonat.toFixed(2).replace('.', ',')} â‚¬`;
            if (elPrognose) elPrognose.textContent = `${prognoseBestCase.toFixed(2).replace('.', ',')} â‚¬`;
            if (elPrognoseSub) elPrognoseSub.textContent = `+10% Wachstum`;
            if (elZielerreichung) elZielerreichung.textContent = `${zielerreichung}%`;
            if (elZielerreichungSub) elZielerreichungSub.textContent = `Ziel: ${zielMonat.toFixed(0)} â‚¬`;
            
            console.log('âœ… Hochrechnung erfolgreich berechnet!');
        }

        // ğŸ“„ VERTRÃ„GE: Partner-basierte Ansicht mit Pagination (MUSS VOR loadAllInOneData sein!)
        let vertraegeCurrentPage = 1;
        const vertraegePerPage = 10;
        let allPartnerGroups = [];
        let filteredPartnerGroups = [];
        
        // ğŸ’° PROVISIONEN & AUSZAHLUNGEN: Rohdaten fÃ¼r Filter
        let allProvisionenData = [];
        let allAuszahlungenData = [];
        
        // ğŸ“‹ ALLE VERTRÃ„GE TABELLE
        let alleVertraegeData = [];
        let alleVertraegeCurrentPage = 1;
        const alleVertraegePerPage = 20;
        
        // ğŸ’° PROVISIONEN: Partner-Akkordeon
        let provisionenCurrentPage = 1;
        const provisionenPerPage = 10;
        let allProvisionenPartnerGroups = [];
        let filteredProvisionenPartnerGroups = [];
        
        // ğŸ’³ AUSZAHLUNGEN: Partner-Akkordeon
        let auszahlungenCurrentPage = 1;
        const auszahlungenPerPage = 10;
        let allAuszahlungenPartnerGroups = [];
        let filteredAuszahlungenPartnerGroups = [];
        
        // ğŸ’° ALL-IN-ONE: Alle Daten auf einmal laden
        async function loadAllInOneData() {
            console.log('ğŸ”„ loadAllInOneData() gestartet...');
            
            try {
                // â­ FILTER-WERTE AUS INPUTS HOLEN
                // â„¹ï¸ INFO: Filter wurden entfernt - Stat-Cards zeigen automatisch ALLE Daten
                const vonDatum = null;
                const bisDatum = null;
                const kategorie = 'alle';
                
                console.log('ğŸ” Filter-Status: Alle Daten werden angezeigt (Filter entfernt)');
                
                // 1ï¸âƒ£ UMSATZ-TRACKING STATS laden
                console.log('ğŸ“¥ Lade Provisionen aus Datenbank...');
                const provResponse = await fetch('tables/provisionen?limit=1000');
                if (!provResponse.ok) {
                    console.error('âŒ Fehler beim Laden der Provisionen:', provResponse.status);
                }
                const provResult = await provResponse.json();
                let provisionen = provResult.data || [];
                console.log('âœ… Provisionen geladen:', provisionen.length, 'EintrÃ¤ge');

                // VertrÃ¤ge laden
                console.log('ğŸ“¥ Lade VertrÃ¤ge aus Datenbank...');
                const vertraegeResponse = await fetch('tables/vertragsabschluesse?limit=1000');
                if (!vertraegeResponse.ok) {
                    console.error('âŒ Fehler beim Laden der VertrÃ¤ge:', vertraegeResponse.status);
                }
                const vertraegeResult = await vertraegeResponse.json();
                let vertraege = vertraegeResult.data || [];
                console.log('âœ… VertrÃ¤ge geladen:', vertraege.length, 'EintrÃ¤ge');
                
                // Sortieren nach Datum (neueste zuerst)
                provisionen.sort((a, b) => new Date(b.datum || b.created_at) - new Date(a.datum || a.created_at));
                vertraege.sort((a, b) => new Date(b.erstellt_am || b.created_at) - new Date(a.erstellt_am || a.created_at));
                
                console.log('ğŸ“Š Ungefilterte Daten:', { 
                    provisionen: provisionen.length, 
                    vertraege: vertraege.length 
                });
                
                // DEBUG: Zeige erste EintrÃ¤ge
                if (provisionen.length > 0) {
                    console.log('ğŸ“‹ Erste Provision:', provisionen[0]);
                }
                if (vertraege.length > 0) {
                    console.log('ğŸ“‹ Erster Vertrag:', vertraege[0]);
                }
                
                // âš ï¸ HINWEIS: Diese Filter betreffen NUR die STATS und CHARTS oben,
                // NICHT die Listen (VertrÃ¤ge, Provisionen, Auszahlungen) unten!
                
                // Kategorie-Filter
                if (kategorie && kategorie !== 'alle') {
                    vertraege = vertraege.filter(v => v.kategorie && v.kategorie.toLowerCase() === kategorie.toLowerCase());
                    provisionen = provisionen.filter(p => p.typ && p.typ.toLowerCase() === kategorie.toLowerCase());
                    console.log('ğŸ“Š Nach Kategorie-Filter:', { vertraege: vertraege.length, provisionen: provisionen.length });
                }
                
                // Datum-Filter (fÃ¼r Stats & Charts)
                if (vonDatum || bisDatum) {
                    if (vonDatum) {
                        const vonDate = new Date(vonDatum);
                        vertraege = vertraege.filter(v => new Date(v.erstellt_am || v.created_at) >= vonDate);
                        provisionen = provisionen.filter(p => new Date(p.datum || p.created_at) >= vonDate);
                    }
                    if (bisDatum) {
                        const bisDate = new Date(bisDatum);
                        bisDate.setHours(23, 59, 59, 999); // Ende des Tages
                        vertraege = vertraege.filter(v => new Date(v.erstellt_am || v.created_at) <= bisDate);
                        provisionen = provisionen.filter(p => new Date(p.datum || p.created_at) <= bisDate);
                    }
                    console.log('ğŸ“Š Nach Datum-Filter:', { vertraege: vertraege.length, provisionen: provisionen.length });
                }
                
                console.log('âœ… Nach Filter:', { provisionen: provisionen.length, vertraege: vertraege.length });

                // âœ… KORRIGIERT: Berechnung: Heute, Woche, Monat aus VERTRÃ„GEN (nicht aus provisionen Tabelle)
                const heute = new Date();
                heute.setHours(0, 0, 0, 0);
                
                // âœ… KORRIGIERT: Woche = Aktuelle Kalenderwoche (Montag-Sonntag)
                const wocheStart = new Date(heute);
                const tagDerWoche = wocheStart.getDay(); // 0 = Sonntag, 1 = Montag, ..., 6 = Samstag
                const tageSeitMontag = (tagDerWoche === 0) ? 6 : tagDerWoche - 1;
                wocheStart.setDate(wocheStart.getDate() - tageSeitMontag);
                
                const monatStart = new Date(heute.getFullYear(), heute.getMonth(), 1);

                // âœ… KORRIGIERT: Provision aus VERTRÃ„GEN berechnen (gesamt_provision Feld)
                // Hilfsfunktion fÃ¼r Provision aus Vertrag
                const getVertragProvision = (v) => parseFloat(v.gesamt_provision || v.provision || v.provision_betrag || 0);
                
                const provHeute = vertraege.filter(v => {
                    if (!v.erstellt_am && !v.created_at) return false;
                    const datum = new Date(v.erstellt_am || v.created_at);
                    if (isNaN(datum.getTime())) return false;
                    const datumNorm = new Date(datum);
                    datumNorm.setHours(0, 0, 0, 0);
                    return datumNorm.toDateString() === heute.toDateString() && v.vertrag_status !== 'storniert';
                }).reduce((sum, v) => sum + getVertragProvision(v), 0);
                
                const provWoche = vertraege.filter(v => {
                    if (!v.erstellt_am && !v.created_at) return false;
                    const datum = new Date(v.erstellt_am || v.created_at);
                    if (isNaN(datum.getTime())) return false;
                    const datumNorm = new Date(datum);
                    datumNorm.setHours(0, 0, 0, 0);
                    return datumNorm >= wocheStart && datumNorm <= heute && v.vertrag_status !== 'storniert';
                }).reduce((sum, v) => sum + getVertragProvision(v), 0);
                
                const provMonat = vertraege.filter(v => {
                    if (!v.erstellt_am && !v.created_at) return false;
                    const datum = new Date(v.erstellt_am || v.created_at);
                    if (isNaN(datum.getTime())) return false;
                    const datumNorm = new Date(datum);
                    datumNorm.setHours(0, 0, 0, 0);
                    return datumNorm >= monatStart && datumNorm <= heute && v.vertrag_status !== 'storniert';
                }).reduce((sum, v) => sum + getVertragProvision(v), 0);
                
                console.log('ğŸ“Š Statistiken berechnet (aus VertrÃ¤gen):', {
                    heute: provHeute,
                    woche: provWoche,
                    monat: provMonat,
                    vertraegeGesamt: vertraege.length
                });

                // âœ… Mit deutschem Zahlenformat anzeigen
                document.getElementById('provision-heute-all').textContent = `${provHeute.toFixed(2).replace('.', ',')} â‚¬`;
                document.getElementById('provision-woche-all').textContent = `${provWoche.toFixed(2).replace('.', ',')} â‚¬`;
                document.getElementById('provision-monat-all').textContent = `${provMonat.toFixed(2).replace('.', ',')} â‚¬`;
                
                // ğŸ“… Datums-Labels aktualisieren
                const formatDate = (date) => date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
                const formatMonth = (date) => date.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
                
                document.getElementById('datum-heute').textContent = heute.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
                
                const wocheEnde = new Date(heute);
                wocheEnde.setDate(wocheStart.getDate() + 6);
                document.getElementById('datum-woche').textContent = `Mo ${formatDate(wocheStart)} - So ${formatDate(wocheEnde)}`;
                
                document.getElementById('datum-monat').textContent = formatMonth(monatStart);
                document.getElementById('datum-vertraege-monat').textContent = formatMonth(monatStart);

                // VertrÃ¤ge (Monat) - GEFILTERT
                const vertraegeMonatCount = vertraege.filter(v => {
                    const datum = new Date(v.erstellt_am || v.created_at);
                    if (isNaN(datum.getTime())) return false;
                    datum.setHours(0, 0, 0, 0);
                    return datum >= monatStart && datum <= heute;
                }).length;
                const vertraegeMonatEl = document.getElementById('vertraege-monat-all') || document.getElementById('provision-vertraege-monat-all');
                if (vertraegeMonatEl) vertraegeMonatEl.textContent = vertraegeMonatCount;

                // ğŸ“Š HOCHRECHNUNG & PROGNOSEN berechnen - âœ… KORRIGIERT: vertraege statt provisionen
                calculateHochrechnung(vertraege);

                // ğŸ“‹ ALLE VERTRÃ„GE TABELLE rendern
                renderAlleVertraegeTable(vertraege);

                // 2ï¸âƒ£ PROVISIONEN nach Partner gruppieren
                // ACHTUNG: Hier speichern wir die UNGEFILTERTEN Daten fÃ¼r alle Ansichten
                allProvisionenData = provResult.data || [];
                allAuszahlungenData = provResult.data || [];
                renderProvisionenByPartner(provisionen); // Gefilterte Anzeige

                // 3ï¸âƒ£ AUSZAHLUNGEN Stats
                const ausgezahlt = provisionen.filter(p => p.status === 'ausgezahlt')
                    .reduce((sum, p) => sum + parseFloat(p.betrag || 0), 0);
                const ausstehend = provisionen.filter(p => p.status === 'ausstehend')
                    .reduce((sum, p) => sum + parseFloat(p.betrag || 0), 0);
                const storniert = provisionen.filter(p => p.status === 'storniert')
                    .reduce((sum, p) => sum + parseFloat(p.betrag || 0), 0);
                const anzahl = provisionen.filter(p => p.status === 'ausgezahlt').length;

                document.getElementById('stat_auszahlungen_gesamt-all').textContent = `${ausgezahlt.toFixed(2)} â‚¬`;
                document.getElementById('stat_auszahlungen_ausstehend-all').textContent = `${ausstehend.toFixed(2)} â‚¬`;
                document.getElementById('stat_auszahlungen_storniert-all').textContent = `${storniert.toFixed(2)} â‚¬`;
                document.getElementById('stat_auszahlungen_anzahl-all').textContent = anzahl;

                // Auszahlungen nach Partner gruppieren (gefilterte Daten)
                renderAuszahlungenByPartner(provisionen);

                // 4ï¸âƒ£ VERTRÃ„GE Stats & Tabelle
                // âœ… WICHTIG: allVertraege global speichern fÃ¼r showVertragDetails()
                // ACHTUNG: Hier speichern wir die UNGEFILTERTEN Daten fÃ¼r Details-Ansicht
                allVertraege = vertraegeResult.data || [];
                
                const vertraegeAktiviert = vertraege.filter(v => v.vertrag_status === 'aktiviert').length;
                const vertraegeBearbeitung = vertraege.filter(v => v.vertrag_status === 'in_pruefung' || v.vertrag_status === 'neu_eingegangen' || v.vertrag_status === 'neu').length;
                const vertraegeAbgelehnt = vertraege.filter(v => v.vertrag_status === 'abgelehnt').length;

                console.log('ğŸ“Š VertrÃ¤ge-Statistiken:', {
                    gesamt: vertraege.length,
                    aktiviert: vertraegeAktiviert,
                    bearbeitung: vertraegeBearbeitung,
                    abgelehnt: vertraegeAbgelehnt
                });

                // UI Update mit Null-Check
                const statGesamt = document.getElementById('stat-vertraege-gesamt-all');
                const statAktiviert = document.getElementById('stat-vertraege-aktiviert-all');
                const statBearbeitung = document.getElementById('stat-vertraege-bearbeitung-all');
                const statAbgelehnt = document.getElementById('stat-vertraege-abgelehnt-all');
                
                if (statGesamt) statGesamt.textContent = vertraege.length;
                if (statAktiviert) statAktiviert.textContent = vertraegeAktiviert;
                if (statBearbeitung) statBearbeitung.textContent = vertraegeBearbeitung;
                if (statAbgelehnt) statAbgelehnt.textContent = vertraegeAbgelehnt;

                // VertrÃ¤ge nach Partner gruppieren
                console.log('ğŸ”„ Rufe renderVertraegeByPartner() auf...');
                renderVertraegeByPartner(vertraege);

                // ğŸ“Š GRAFIKEN RENDERN (mit gefilterten Daten!)
                console.log('ğŸ”„ Rufe renderCharts() auf...');
                renderCharts(provisionen, vertraege);

                // 5ï¸âƒ£ ZIEL-ERREICHUNG (simplified)
                const stat1 = document.getElementById('stat-staffel1-all');
                const stat2 = document.getElementById('stat-staffel2-all');
                const statAvg = document.getElementById('stat-avg-progress-all');
                const statBonus = document.getElementById('stat-total-bonus-all');
                
                if (stat1) stat1.textContent = '0';
                if (stat2) stat2.textContent = '0';
                if (statAvg) statAvg.textContent = '0%';
                if (statBonus) statBonus.textContent = '0â‚¬';

                const zielTbody = document.getElementById('ziel-table-body-all');
                if (zielTbody) {
                    zielTbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #718096;">Lade Ziel-Erreichung...</td></tr>';
                }

                console.log('âœ… loadAllInOneData() abgeschlossen!');
            } catch (error) {
                console.error('âŒ Fehler in loadAllInOneData():', error);
            }
        }

        // (Variablen wurden bereits oben deklariert)
        
        function renderAlleVertraegeTable(vertraege) {
            console.log('ğŸ”„ renderAlleVertraegeTable() aufgerufen mit', vertraege.length, 'VertrÃ¤gen');
            alleVertraegeData = vertraege.sort((a, b) => new Date(b.erstellt_am || b.created_at) - new Date(a.erstellt_am || a.created_at));
            alleVertraegeCurrentPage = 1;
            displayAlleVertraegePage();
        }
        
        // ğŸ†• SORTIERUNGS-FUNKTION fÃ¼r "Alle VertrÃ¤ge"
        function sortAlleVertraege() {
            const sortValue = document.getElementById('alle-vertraege-sortierung').value;
            console.log('ğŸ”€ Sortiere Alle VertrÃ¤ge:', sortValue);
            
            if (!alleVertraegeData || alleVertraegeData.length === 0) {
                console.warn('âš ï¸ Keine VertrÃ¤ge zum Sortieren vorhanden');
                return;
            }
            
            switch(sortValue) {
                case 'name-az':
                    alleVertraegeData.sort((a, b) => {
                        const nameA = (a.partner_name || a.partner_email || '').toLowerCase();
                        const nameB = (b.partner_name || b.partner_email || '').toLowerCase();
                        return nameA.localeCompare(nameB);
                    });
                    break;
                case 'datum-neueste':
                    alleVertraegeData.sort((a, b) => new Date(b.erstellt_am || b.created_at) - new Date(a.erstellt_am || a.created_at));
                    break;
                case 'provision-hoch':
                    alleVertraegeData.sort((a, b) => parseFloat(b.gesamt_provision || 0) - parseFloat(a.gesamt_provision || 0));
                    break;
                default:
                    // Default: Datum (Neueste)
                    alleVertraegeData.sort((a, b) => new Date(b.erstellt_am || b.created_at) - new Date(a.erstellt_am || a.created_at));
            }
            
            alleVertraegeCurrentPage = 1;
            displayAlleVertraegePage();
        }
        
        function displayAlleVertraegePage() {
            const tbody = document.getElementById('alle-vertraege-tbody');
            const startIndex = (alleVertraegeCurrentPage - 1) * alleVertraegePerPage;
            const endIndex = startIndex + alleVertraegePerPage;
            const pageData = alleVertraegeData.slice(startIndex, endIndex);
            
            if (pageData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="padding: 40px; text-align: center; color: #a0aec0;">
                            <i class="fas fa-inbox" style="font-size: 48px; opacity: 0.3;"></i>
                            <div style="margin-top: 10px; font-size: 16px;">Keine VertrÃ¤ge gefunden</div>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = pageData.map(v => {
                    const datum = new Date(v.erstellt_am || v.created_at).toLocaleDateString('de-DE');
                    const kategorie = v.kategorie || 'Unbekannt';
                    const kategorieIcon = kategorie === 'mobilfunk' ? 'ğŸ“±' : kategorie === 'dsl' ? 'ğŸŒ' : kategorie === 'strom' ? 'âš¡' : kategorie === 'versicherung' ? 'ğŸ›¡ï¸' : 'ğŸ”¥';
                    
                    let statusBadge = '';
                    if (v.vertrag_status === 'aktiviert' || v.vertrag_status === 'akzeptiert') {
                        statusBadge = '<span class="badge badge-aktiviert"><i class="fas fa-check-circle"></i> Aktiviert</span>';
                    } else if (v.vertrag_status === 'in_pruefung') {
                        statusBadge = '<span class="badge badge-in-pruefung"><i class="fas fa-hourglass-half"></i> In PrÃ¼fung</span>';
                    } else if (v.vertrag_status === 'neu_eingegangen' || v.vertrag_status === 'neu') {
                        statusBadge = '<span class="badge badge-neu-eingegangen"><i class="fas fa-fire"></i> NEU</span>';
                    } else if (v.vertrag_status === 'abgelehnt') {
                        statusBadge = '<span class="badge badge-abgelehnt"><i class="fas fa-times-circle"></i> Abgelehnt</span>';
                    } else {
                        statusBadge = `<span class="badge" style="background: #a0aec0;">${v.vertrag_status || 'Unbekannt'}</span>`;
                    }
                    
                    return `
                        <tr style="border-bottom: 1px solid #e2e8f0;">
                            <td style="padding: 12px;">${datum}</td>
                            <td style="padding: 12px;">${v.partner_name || v.partner_email || 'Unbekannt'}</td>
                            <td style="padding: 12px;">${kategorieIcon} ${kategorie}</td>
                            <td style="padding: 12px;">${v.tarif || v.tarif_name || 'Unbekannt'}</td>
                            <td style="padding: 12px;">${v.kunde_name || ((v.kunde_vorname || '') + ' ' + (v.kunde_nachname || '')).trim() || 'Unbekannt'}</td>
                            <td style="padding: 12px; text-align: right; font-weight: 600; color: #3b82f6;">${parseFloat(v.gesamt_provision || v.provision || v.provision_betrag || 0).toFixed(2)} â‚¬</td>
                            <td style="padding: 12px; text-align: right; color: #4a5568;">${parseFloat(v.kunde_monatspreis || v.tarif_preis || 0).toFixed(2)} â‚¬</td>
                            <td style="padding: 12px; text-align: center;">${statusBadge}</td>
                            <td style="padding: 12px; text-align: center;">
                                <button class="btn btn-primary" onclick="showVertragDetails('${v.id}')" style="padding: 6px 12px; font-size: 12px;">
                                    <i class="fas fa-eye"></i> Details
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            // Pagination
            const totalPages = Math.ceil(alleVertraegeData.length / alleVertraegePerPage);
            document.getElementById('alle-vertraege-page-info').textContent = `Seite ${alleVertraegeCurrentPage} von ${totalPages} (${alleVertraegeData.length} VertrÃ¤ge)`;
            document.getElementById('alle-vertraege-prev-btn').disabled = alleVertraegeCurrentPage === 1;
            document.getElementById('alle-vertraege-next-btn').disabled = alleVertraegeCurrentPage === totalPages || totalPages === 0;
        }
        
        function alleVertraegePrevPage() {
            if (alleVertraegeCurrentPage > 1) {
                alleVertraegeCurrentPage--;
                displayAlleVertraegePage();
            }
        }
        
        function alleVertraegeNextPage() {
            const totalPages = Math.ceil(alleVertraegeData.length / alleVertraegePerPage);
            if (alleVertraegeCurrentPage < totalPages) {
                alleVertraegeCurrentPage++;
                displayAlleVertraegePage();
            }
        }
        
        // CSV EXPORT
        function exportVertraegeToCSV() {
            if (alleVertraegeData.length === 0) {
                alert('Keine VertrÃ¤ge zum Exportieren vorhanden!');
                return;
            }
            
            // CSV Header
            const headers = ['Datum', 'Partner', 'Kategorie', 'Produkt', 'Kunde', 'Partner-Provision', 'Kundenpreis (Monat)', 'Status'];
            
            // CSV Rows
            const rows = alleVertraegeData.map(v => {
                const datum = new Date(v.erstellt_am || v.created_at).toLocaleDateString('de-DE');
                const partner = v.partner_name || v.partner_email || 'Unbekannt';
                const kategorie = v.kategorie || 'Unbekannt';
                const produkt = v.tarif || 'Unbekannt';
                const kunde = v.kunde_name || 'Unbekannt';
                const provision = parseFloat(v.gesamt_provision || 0).toFixed(2);
                const kundenpreis = parseFloat(v.kunde_monatspreis || v.tarif_preis || 0).toFixed(2);
                const status = v.vertrag_status || 'Unbekannt';
                
                return [datum, partner, kategorie, produkt, kunde, provision, kundenpreis, status].map(field => `"${field}"`).join(',');
            });
            
            // CSV Content
            const csvContent = [headers.join(','), ...rows].join('\n');
            
            // Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `vertraege_export_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('âœ… CSV Export erfolgreich:', alleVertraegeData.length, 'VertrÃ¤ge');
        }

        // ğŸ“Š HOCHRECHNUNG: Doppelte Definition entfernt - Funktion existiert bereits bei Zeile 11872

        // â„¹ï¸ INFO: handleUmsatzZeitraumChange() wurde entfernt - Filter nicht mehr benÃ¶tigt
        // Stat-Cards zeigen automatisch alle ZeitrÃ¤ume (Heute/Woche/Monat)
        
        // (Variablen fÃ¼r Provisionen und Auszahlungen wurden bereits oben deklariert)

        function renderVertraegeByPartner(vertraege) {
            console.log('ğŸ”„ renderVertraegeByPartner() aufgerufen mit', vertraege.length, 'VertrÃ¤gen');
            
            // Gruppiere VertrÃ¤ge nach Partner
            const partnerMap = {};
            vertraege.forEach(v => {
                const email = v.partner_email || 'Unbekannt';
                if (!partnerMap[email]) {
                    partnerMap[email] = {
                        email: email,
                        name: v.partner_name || email,
                        vertraege: [],
                        anzahl: 0,
                        gesamtProvision: 0
                    };
                }
                partnerMap[email].vertraege.push(v);
                partnerMap[email].anzahl++;
                partnerMap[email].gesamtProvision += parseFloat(v.gesamt_provision || v.provision || v.provision_betrag || 0);
            });

            // In Array konvertieren und sortieren (meiste VertrÃ¤ge oben)
            allPartnerGroups = Object.values(partnerMap).sort((a, b) => b.anzahl - a.anzahl);
            filteredPartnerGroups = [...allPartnerGroups];
            vertraegeCurrentPage = 1;
            
            console.log('âœ… Partner-Gruppen erstellt:', allPartnerGroups.length);
            if (allPartnerGroups.length > 0) {
                console.log('ğŸ“‹ Erste Gruppe:', allPartnerGroups[0]);
            }
            
            renderVertraegePage();
        }
        
        // ğŸ†• SORTIERUNGS-FUNKTION fÃ¼r "Partner-VertrÃ¤ge"
        function sortPartnerVertraege() {
            const sortValue = document.getElementById('partner-vertraege-sortierung').value;
            console.log('ğŸ”€ Sortiere Partner-VertrÃ¤ge:', sortValue);
            
            if (!filteredPartnerGroups || filteredPartnerGroups.length === 0) {
                console.warn('âš ï¸ Keine Partner-Gruppen zum Sortieren vorhanden');
                return;
            }
            
            switch(sortValue) {
                case 'anzahl':
                    // Meiste VertrÃ¤ge
                    filteredPartnerGroups.sort((a, b) => b.anzahl - a.anzahl);
                    break;
                case 'name-az':
                    // Name (A-Z)
                    filteredPartnerGroups.sort((a, b) => a.name.toLowerCase().localeCompare(b.name.toLowerCase()));
                    break;
                case 'datum-neueste':
                    // Datum (Neueste) - nutze erstes Vertrags-Datum
                    filteredPartnerGroups.sort((a, b) => {
                        const dateA = a.vertraege[0] ? new Date(a.vertraege[0].erstellt_am || a.vertraege[0].created_at) : 0;
                        const dateB = b.vertraege[0] ? new Date(b.vertraege[0].erstellt_am || b.vertraege[0].created_at) : 0;
                        return dateB - dateA;
                    });
                    break;
                case 'provision-hoch':
                    // HÃ¶chste Provision
                    filteredPartnerGroups.sort((a, b) => b.gesamtProvision - a.gesamtProvision);
                    break;
                default:
                    // Default: Meiste VertrÃ¤ge
                    filteredPartnerGroups.sort((a, b) => b.anzahl - a.anzahl);
            }
            
            vertraegeCurrentPage = 1;
            renderVertraegePage();
        }

        function renderVertraegePage() {
            console.log('ğŸ¨ renderVertraegePage() aufgerufen');
            console.log('   filteredPartnerGroups:', filteredPartnerGroups ? filteredPartnerGroups.length : 'undefined');
            
            const container = document.getElementById('vertraege-partner-list-all');
            if (!container) {
                console.error('âŒ Container vertraege-partner-list-all nicht gefunden!');
                return;
            }

            const startIndex = (vertraegeCurrentPage - 1) * vertraegePerPage;
            const endIndex = startIndex + vertraegePerPage;
            const pageGroups = filteredPartnerGroups.slice(startIndex, endIndex);
            
            console.log('   pageGroups:', pageGroups.length);

            if (pageGroups.length === 0) {
                console.warn('âš ï¸ Keine Partner-Gruppen zum Anzeigen!');
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #718096;">Keine VertrÃ¤ge gefunden. Klicke auf "Aktualisieren" um Daten zu laden.</div>';
                return;
            }
            
            console.log('âœ… Rendere', pageGroups.length, 'Partner-Gruppen');

            container.innerHTML = pageGroups.map((partner, index) => `
                <div style="border: 2px solid #e2e8f0; border-radius: 12px; overflow: hidden; background: white;">
                    <!-- Partner Header (klickbar) -->
                    <div onclick="togglePartnerVertraege('partner-${startIndex + index}')" 
                         style="padding: 16px 20px; background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); color: white; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s;">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div style="background: rgba(255,255,255,0.2); width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 700;">
                                ${partner.name.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div style="font-size: 18px; font-weight: 700;">${partner.name}</div>
                                <div style="font-size: 13px; opacity: 0.9;">${partner.email}</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 24px; align-items: center;">
                            <div style="text-align: center;">
                                <div style="font-size: 28px; font-weight: 700;">${partner.anzahl}</div>
                                <div style="font-size: 12px; opacity: 0.9;">VertrÃ¤ge</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 28px; font-weight: 700;">${partner.gesamtProvision.toFixed(2)}â‚¬</div>
                                <div style="font-size: 12px; opacity: 0.9;">Provision</div>
                            </div>
                            <i class="fas fa-chevron-down" id="partner-${startIndex + index}-icon" style="font-size: 20px; transition: transform 0.3s;"></i>
                        </div>
                    </div>

                    <!-- Partner VertrÃ¤ge (aufklappbar) -->
                    <div id="partner-${startIndex + index}-content" style="display: none; padding: 20px; background: #f7fafc;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Vertragsnr.</th>
                                    <th>Datum</th>
                                    <th>Kunde</th>
                                    <th>Kategorie</th>
                                    <th>Provision</th>
                                    <th>Status</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${partner.vertraege.map(v => `
                                    <tr>
                                        <td><strong>${v.vertragsnummer || 'N/A'}</strong></td>
                                        <td>${new Date(v.erstellt_am).toLocaleDateString('de-DE')}</td>
                                        <td>${v.kunde_name || ((v.kunde_vorname || '') + ' ' + (v.kunde_nachname || '')).trim() || 'N/A'}</td>
                                        <td><span class="badge badge-info">${v.kategorie || 'N/A'}</span></td>
                                        <td><strong>â‚¬${parseFloat(v.gesamt_provision || 0).toFixed(2)}</strong></td>
                                        <td>
                                            ${v.vertrag_status === 'neu_eingegangen' || v.vertrag_status === 'neu'
                                                ? `<span class="badge badge-neu-eingegangan" title="Status: Neu eingegangen"><i class="fas fa-star"></i> NEU EINGEGANGEN</span>`
                                                : v.vertrag_status === 'in_pruefung'
                                                ? `<span class="badge badge-in-pruefung" title="Status: In PrÃ¼fung"><i class="fas fa-hourglass-half"></i> IN PRÃœFUNG</span>`
                                                : v.vertrag_status === 'aktiviert' || v.vertrag_status === 'akzeptiert'
                                                ? `<span class="badge badge-aktiviert" title="Status: Aktiviert"><i class="fas fa-check-circle"></i> AKTIVIERT</span>`
                                                : v.vertrag_status === 'abgelehnt'
                                                ? `<span class="badge badge-abgelehnt" title="Status: Abgelehnt"><i class="fas fa-times-circle"></i> ABGELEHNT</span>`
                                                : `<span class="badge badge-info">${v.vertrag_status || 'N/A'}</span>`
                                            }
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-primary" onclick="showVertragDetails('${v.id}')">
                                                <i class="fas fa-eye"></i> Details
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `).join('');

            // Pagination aktualisieren
            const totalPages = Math.ceil(filteredPartnerGroups.length / vertraegePerPage);
            document.getElementById('vertraege-page-info').textContent = `Seite ${vertraegeCurrentPage} von ${totalPages}`;
            document.getElementById('vertraege-prev-btn').disabled = vertraegeCurrentPage === 1;
            document.getElementById('vertraege-next-btn').disabled = vertraegeCurrentPage >= totalPages;
        }

        function togglePartnerVertraege(partnerId) {
            const content = document.getElementById(partnerId + '-content');
            const icon = document.getElementById(partnerId + '-icon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function vertraegePrevPage() {
            if (vertraegeCurrentPage > 1) {
                vertraegeCurrentPage--;
                renderVertraegePage();
            }
        }

        function vertraegeNextPage() {
            const totalPages = Math.ceil(filteredPartnerGroups.length / vertraegePerPage);
            if (vertraegeCurrentPage < totalPages) {
                vertraegeCurrentPage++;
                renderVertraegePage();
            }
        }

        // Handler fÃ¼r Zeitraum-Ã„nderung (VertrÃ¤ge)
        function handleVertraegeZeitraumChange() {
            const zeitraum = document.getElementById('vertraege-zeitraum-filter')?.value;
            const vonDatum = document.getElementById('vertraege-von-datum');
            const bisDatum = document.getElementById('vertraege-bis-datum');
            
            if (zeitraum === 'benutzerdefiniert') {
                // Datum-Felder aktivieren
                vonDatum.disabled = false;
                bisDatum.disabled = false;
                vonDatum.style.opacity = '1';
                bisDatum.style.opacity = '1';
            } else {
                // Datum-Felder deaktivieren und leeren
                vonDatum.disabled = true;
                bisDatum.disabled = true;
                vonDatum.value = '';
                bisDatum.value = '';
                vonDatum.style.opacity = '0.5';
                bisDatum.style.opacity = '0.5';
            }
            
            filterVertraegeByPartner();
        }
        
        function filterVertraegeByPartner() {
            const zeitraum = document.getElementById('vertraege-zeitraum-filter')?.value || 'alle';
            const kategorie = document.getElementById('vertraege-kategorie-filter')?.value || 'alle';
            const status = document.getElementById('vertraege-status-filter')?.value || 'alle';
            const partnerSearch = document.getElementById('vertraege-partner-search')?.value?.toLowerCase() || '';
            const vonDatum = document.getElementById('vertraege-von-datum')?.value;
            const bisDatum = document.getElementById('vertraege-bis-datum')?.value;

            // Filter anwenden
            filteredPartnerGroups = allPartnerGroups.map(partner => {
                let filtered = partner.vertraege;

                // Zeitraum-Filter
                if (zeitraum === 'benutzerdefiniert' && (vonDatum || bisDatum)) {
                    // Benutzerdefinierter Datumsbereich
                    filtered = filtered.filter(v => {
                        const datum = new Date(v.erstellt_am || v.created_at);
                        const von = vonDatum ? new Date(vonDatum) : null;
                        const bis = bisDatum ? new Date(bisDatum) : null;
                        
                        if (von && datum < von) return false;
                        if (bis && datum > bis) return false;
                        return true;
                    });
                } else if (zeitraum !== 'alle' && zeitraum !== 'benutzerdefiniert') {
                    const heute = new Date();
                    heute.setHours(0, 0, 0, 0); // Start des Tages
                    
                    // âœ… KORRIGIERT: Woche = Aktuelle Kalenderwoche (Montag-Sonntag)
                    const wocheStart = new Date(heute);
                    const tagDerWoche = wocheStart.getDay(); // 0 = Sonntag, 1 = Montag, ..., 6 = Samstag
                    const tageSeitMontag = (tagDerWoche === 0) ? 6 : tagDerWoche - 1; // Sonntag zÃ¤hlt als letzter Tag der Woche
                    wocheStart.setDate(wocheStart.getDate() - tageSeitMontag);
                    
                    const monatStart = new Date(heute.getFullYear(), heute.getMonth(), 1);

                    filtered = filtered.filter(v => {
                        const datum = new Date(v.erstellt_am || v.created_at);
                        datum.setHours(0, 0, 0, 0);
                        
                        if (zeitraum === 'heute') {
                            return datum.toDateString() === heute.toDateString();
                        }
                        if (zeitraum === 'woche') {
                            return datum >= wocheStart && datum <= heute;
                        }
                        if (zeitraum === 'monat') {
                            return datum >= monatStart && datum <= heute;
                        }
                        return true;
                    });
                }

                // Kategorie-Filter
                if (kategorie !== 'alle') {
                    filtered = filtered.filter(v => v.kategorie === kategorie);
                }

                // Status-Filter
                if (status !== 'alle') {
                    filtered = filtered.filter(v => v.vertrag_status === status);
                }

                return {
                    ...partner,
                    vertraege: filtered,
                    anzahl: filtered.length,
                    gesamtProvision: filtered.reduce((sum, v) => sum + parseFloat(v.gesamt_provision || 0), 0)
                };
            }).filter(partner => {
                // Partner-Name-Filter
                if (partnerSearch && !partner.name.toLowerCase().includes(partnerSearch) && !partner.email.toLowerCase().includes(partnerSearch)) {
                    return false;
                }
                // Nur Partner mit VertrÃ¤gen anzeigen
                return partner.anzahl > 0;
            }).sort((a, b) => b.anzahl - a.anzahl);

            // ğŸ’° GESAMT-PROVISION berechnen & anzeigen
            const gesamtProvision = filteredPartnerGroups.reduce((sum, partner) => sum + partner.gesamtProvision, 0);
            const provisionEl = document.getElementById('stat-vertraege-provision-all');
            if (provisionEl) {
                provisionEl.textContent = gesamtProvision.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' â‚¬';
            }
            
            // Stats aktualisieren
            const gesamt = filteredPartnerGroups.reduce((sum, p) => sum + p.anzahl, 0);
            const aktiviert = filteredPartnerGroups.reduce((sum, p) => sum + p.vertraege.filter(v => v.vertrag_status === 'aktiviert' || v.vertrag_status === 'akzeptiert').length, 0);
            const bearbeitung = filteredPartnerGroups.reduce((sum, p) => sum + p.vertraege.filter(v => v.vertrag_status === 'in_pruefung' || v.vertrag_status === 'neu_eingegangen' || v.vertrag_status === 'neu').length, 0);
            const abgelehnt = filteredPartnerGroups.reduce((sum, p) => sum + p.vertraege.filter(v => v.vertrag_status === 'abgelehnt').length, 0);
            
            document.getElementById('stat-vertraege-gesamt-all').textContent = gesamt;
            document.getElementById('stat-vertraege-aktiviert-all').textContent = aktiviert;
            document.getElementById('stat-vertraege-bearbeitung-all').textContent = bearbeitung;
            document.getElementById('stat-vertraege-abgelehnt-all').textContent = abgelehnt;
            
            vertraegeCurrentPage = 1;
            renderVertraegePage();
        }

        // ğŸ“Š DASHBOARD-DATEN LADEN (fÃ¼r Charts)
        window.loadDashboardData = async function() {
            console.log('ğŸ  Lade Dashboard-Daten fÃ¼r Charts...');
            
            try {
                // Filter-Werte aus den Inputs holen
                const vonDatum = document.getElementById('umsatz-von-datum')?.value;
                const bisDatum = document.getElementById('umsatz-bis-datum')?.value;
                const kategorie = document.getElementById('umsatz-kategorie-filter')?.value || 'alle';
                
                console.log('ğŸ“Š Filter:', { vonDatum, bisDatum, kategorie });
                
                // Parallel: Provisionen & VertrÃ¤ge laden
                const [provisionenRes, vertraegeRes] = await Promise.all([
                    fetch('tables/provisionen?limit=1000').then(r => r.json()).catch(() => ({data: []})),
                    fetch('tables/vertragsabschluesse?limit=1000').then(r => r.json()).catch(() => ({data: []}))
                ]);
                
                let provisionen = provisionenRes.data || [];
                let vertraege = vertraegeRes.data || [];
                
                console.log('ğŸ“Š Ungefilterte Daten:', { 
                    provisionen: provisionen.length, 
                    vertraege: vertraege.length 
                });
                
                // Filter anwenden
                if (kategorie && kategorie !== 'alle') {
                    vertraege = vertraege.filter(v => v.kategorie && v.kategorie.toLowerCase() === kategorie.toLowerCase());
                    provisionen = provisionen.filter(p => p.typ && p.typ.toLowerCase() === kategorie.toLowerCase());
                    console.log('ğŸ“Š Nach Kategorie-Filter:', { vertraege: vertraege.length, provisionen: provisionen.length });
                }
                
                // Datum-Filter
                if (vonDatum || bisDatum) {
                    if (vonDatum) {
                        const vonDate = new Date(vonDatum);
                        vertraege = vertraege.filter(v => new Date(v.erstellt_am || v.created_at) >= vonDate);
                        provisionen = provisionen.filter(p => new Date(p.datum || p.created_at) >= vonDate);
                    }
                    if (bisDatum) {
                        const bisDate = new Date(bisDatum);
                        bisDate.setHours(23, 59, 59, 999);
                        vertraege = vertraege.filter(v => new Date(v.erstellt_am || v.created_at) <= bisDate);
                        provisionen = provisionen.filter(p => new Date(p.datum || p.created_at) <= bisDate);
                    }
                    console.log('ğŸ“Š Nach Datum-Filter:', { vertraege: vertraege.length, provisionen: provisionen.length });
                }
                
                console.log('âœ… Dashboard-Daten geladen (nach Filter):', {
                    provisionen: provisionen.length,
                    vertraege: vertraege.length
                });
                
                // Charts rendern
                renderCharts(provisionen, vertraege);
                
            } catch (error) {
                console.error('âŒ Fehler beim Laden der Dashboard-Daten:', error);
                // Charts mit Demo-Daten rendern
                renderCharts([], []);
            }
        }

        // ğŸ“Š CHARTS RENDERN
        let chartUmsatzZeit, chartVertraegeKategorie, chartProvisionPartner;

        function renderCharts(provisionen, vertraege) {
            console.log('ğŸ“Š renderCharts() aufgerufen mit:', {
                provisionen: provisionen.length,
                vertraege: vertraege.length
            });
            
            // 1ï¸âƒ£ Linien-Chart: Provision Ã¼ber Zeit (basierend auf GEFILTERTEN Daten)
            // Ermittle den Datumsbereich aus den gefilterten Daten
            const vonDatum = document.getElementById('umsatz-von-datum')?.value;
            const bisDatum = document.getElementById('umsatz-bis-datum')?.value;
            
            let startDate, endDate;
            if (vonDatum && bisDatum) {
                startDate = new Date(vonDatum);
                endDate = new Date(bisDatum);
            } else {
                // Fallback: Letzte 30 Tage
                endDate = new Date();
                startDate = new Date();
                startDate.setDate(startDate.getDate() - 29);
            }
            
            console.log('ğŸ“… Chart-Zeitraum:', {
                von: startDate.toISOString().split('T')[0],
                bis: endDate.toISOString().split('T')[0]
            });
            
            // Erstelle Array aller Tage im Zeitraum
            const dateRange = [];
            const currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                dateRange.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            console.log('ğŸ“… Anzahl Tage im Chart:', dateRange.length);

            // DEBUG: PrÃ¼fe Datum-Formate
            if (provisionen.length > 0) {
                console.log('ğŸ“‹ Provision Datum-Format Check:', {
                    datum: provisionen[0].datum,
                    created_at: provisionen[0].created_at,
                    erstellt_am: provisionen[0].erstellt_am
                });
            }

            let provisionPerDay = dateRange.map(date => {
                return provisionen
                    .filter(p => {
                        // Robuste Datum-PrÃ¼fung - Datum kann String oder Number (Timestamp) sein!
                        const rawDate = p.datum || p.created_at || p.erstellt_am;
                        let pDateStr = '';
                        if (typeof rawDate === 'number') {
                            pDateStr = new Date(rawDate).toISOString().split('T')[0];
                        } else if (typeof rawDate === 'string') {
                            pDateStr = rawDate.substring(0, 10);
                        }
                        return pDateStr === date && p.status !== 'storniert';
                    })
                    .reduce((sum, p) => sum + parseFloat(p.betrag || 0), 0);
            });
            
            console.log('ğŸ“Š Provision pro Tag (Summe):', provisionPerDay.reduce((a,b) => a+b, 0));

            const ctxUmsatz = document.getElementById('chart-umsatz-zeit')?.getContext('2d');
            console.log('ğŸ“ˆ Chart 1 - Provision Ã¼ber Zeit:', {
                element: !!ctxUmsatz,
                daten: provisionPerDay.length,
                summe: provisionPerDay.reduce((a,b) => a+b, 0)
            });
            if (ctxUmsatz) {
                if (chartUmsatzZeit) chartUmsatzZeit.destroy();
                chartUmsatzZeit = new Chart(ctxUmsatz, {
                    type: 'line',
                    data: {
                        labels: dateRange.map(d => new Date(d).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' })),
                        datasets: [{
                            label: 'Provision (â‚¬)',
                            data: provisionPerDay,
                            borderColor: '#3b82f6',
                            backgroundColor: (context) => {
                                const ctx = context.chart.ctx;
                                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                                gradient.addColorStop(0, 'rgba(102, 126, 234, 0.3)');
                                gradient.addColorStop(1, 'rgba(102, 126, 234, 0.0)');
                                return gradient;
                            },
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#3b82f6',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#3b82f6',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: false,
                                callbacks: {
                                    label: (context) => `Provision: ${context.parsed.y.toFixed(2)}â‚¬`
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    callback: (value) => value + 'â‚¬'
                                }
                            }
                        }
                    }
                });
            }

            // 2ï¸âƒ£ Balken-Chart: VertrÃ¤ge pro Kategorie - DYNAMISCH aus DB!
            // Sammle alle echten Kategorien aus den Daten
            const kategorienMap = {};
            vertraege.forEach(v => {
                const kat = (v.kategorie || 'sonstige').toLowerCase();
                kategorienMap[kat] = (kategorienMap[kat] || 0) + 1;
            });
            
            // Sortiere nach Anzahl (absteigend) und nimm Top 8
            const sortedKategorien = Object.entries(kategorienMap)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            const kategorieLabels = sortedKategorien.map(k => {
                const icons = {
                    'mobilfunk': 'ğŸ“±', 'sim-only': 'ğŸ“²', 'dsl': 'ğŸŒ', 'internet': 'ğŸŒ',
                    'strom': 'âš¡', 'gas': 'ğŸ”¥', 'versicherung': 'ğŸ›¡ï¸', 'sonstige': 'ğŸ“„'
                };
                return (icons[k[0]] || 'ğŸ“‹') + ' ' + k[0].charAt(0).toUpperCase() + k[0].slice(1);
            });
            const kategorieWerte = sortedKategorien.map(k => k[1]);
            
            console.log('ğŸ“Š Dynamische Kategorien:', kategorienMap);

            const ctxKategorie = document.getElementById('chart-vertraege-kategorie')?.getContext('2d');
            console.log('ğŸ“Š Chart 2 - VertrÃ¤ge pro Kategorie:', {
                element: !!ctxKategorie,
                kategorien: kategorieLabels,
                daten: kategorieWerte
            });
            if (ctxKategorie) {
                if (chartVertraegeKategorie) chartVertraegeKategorie.destroy();
                chartVertraegeKategorie = new Chart(ctxKategorie, {
                    type: 'bar',
                    data: {
                        labels: kategorieLabels,
                        datasets: [{
                            label: 'Anzahl VertrÃ¤ge',
                            data: kategorieWerte,
                            backgroundColor: ['#3b82f6', '#60a5fa', '#f093fb', '#4facfe', '#43e97b', '#f59e0b', '#ef4444', '#8b5cf6'],
                            borderRadius: 12,
                            borderSkipped: false,
                            barThickness: 50
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#3b82f6',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: false,
                                callbacks: {
                                    label: (context) => `VertrÃ¤ge: ${context.parsed.y}`
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    stepSize: 10
                                }
                            }
                        }
                    }
                });
            }

            // 3ï¸âƒ£ Kreisdiagramm: Provision pro Partner (Top 5)
            const partnerProvisionMap = {};
            provisionen.forEach(p => {
                if (p.status !== 'storniert') {
                    const email = p.partner_email || 'Unbekannt';
                    if (!partnerProvisionMap[email]) partnerProvisionMap[email] = 0;
                    partnerProvisionMap[email] += parseFloat(p.betrag || 0);
                }
            });

            let sortedPartners = Object.entries(partnerProvisionMap)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            // âœ… NUR ECHTE DATEN - Keine Demo-Daten mehr!
            // Falls keine Partner: Zeige leeres Chart mit "Keine Daten"-Hinweis
            if (sortedPartners.length === 0) {
                sortedPartners = [['Keine Daten vorhanden', 0]];
            }

            const ctxPartner = document.getElementById('chart-provision-partner')?.getContext('2d');
            console.log('ğŸ’° Chart 3 - Provision pro Partner:', {
                element: !!ctxPartner,
                partner: sortedPartners.length,
                top5: sortedPartners.map(p => p[0])
            });
            if (ctxPartner) {
                if (chartProvisionPartner) chartProvisionPartner.destroy();
                chartProvisionPartner = new Chart(ctxPartner, {
                    type: 'doughnut',
                    data: {
                        labels: sortedPartners.map(p => p[0]),
                        datasets: [{
                            data: sortedPartners.map(p => p[1]),
                            backgroundColor: [
                                '#3b82f6',
                                '#60a5fa',
                                '#f093fb',
                                '#4facfe',
                                '#43e97b'
                            ],
                            borderWidth: 4,
                            borderColor: '#fff',
                            hoverOffset: 15
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '65%',
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: 12,
                                        weight: '600'
                                    },
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#3b82f6',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: true,
                                callbacks: {
                                    label: (context) => {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return ` ${label}: ${value.toFixed(2)}â‚¬ (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // ğŸ’° PROVISIONEN: Partner-basierte Ansicht
        function renderProvisionenByPartner(provisionen) {
            console.log('ğŸ”„ renderProvisionenByPartner() aufgerufen mit', provisionen.length, 'Provisionen');
            
            const partnerMap = {};
            provisionen.forEach(p => {
                const email = p.partner_email || 'Unbekannt';
                const name = p.partner_name || email;
                if (!partnerMap[email]) {
                    partnerMap[email] = {
                        email: email,
                        name: name,
                        provisionen: [],
                        anzahl: 0,
                        gesamtBetrag: 0
                    };
                }
                partnerMap[email].provisionen.push(p);
                partnerMap[email].anzahl++;
                partnerMap[email].gesamtBetrag += parseFloat(p.betrag || 0);
            });

            allProvisionenPartnerGroups = Object.values(partnerMap).sort((a, b) => b.gesamtBetrag - a.gesamtBetrag);
            filteredProvisionenPartnerGroups = [...allProvisionenPartnerGroups];
            provisionenCurrentPage = 1;
            
            console.log('âœ… Provisionen-Gruppen erstellt:', allProvisionenPartnerGroups.length);
            if (allProvisionenPartnerGroups.length > 0) {
                console.log('ğŸ“‹ Erste Gruppe:', allProvisionenPartnerGroups[0]);
            }
            
            renderProvisionenPage();
        }

        function renderProvisionenPage() {
            const container = document.getElementById('provisionen-partner-list-all');
            if (!container) return;

            const startIndex = (provisionenCurrentPage - 1) * provisionenPerPage;
            const endIndex = startIndex + provisionenPerPage;
            const pageGroups = filteredProvisionenPartnerGroups.slice(startIndex, endIndex);

            if (pageGroups.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #718096;">Keine Provisionen gefunden.</div>';
                return;
            }

            container.innerHTML = pageGroups.map((partner, index) => `
                <div style="border: 2px solid #e2e8f0; border-radius: 12px; overflow: hidden; background: white;">
                    <div onclick="togglePartnerProvisionen('prov-partner-${startIndex + index}')" 
                         style="padding: 16px 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s;">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div style="background: rgba(255,255,255,0.2); width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 700;">
                                ${(partner.name || partner.email).charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div style="font-size: 18px; font-weight: 700;">${partner.name || partner.email}</div>
                                <div style="font-size: 13px; opacity: 0.9;">${partner.email} â€¢ ${partner.anzahl} Provisionen</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 24px; align-items: center;">
                            <div style="text-align: center;">
                                <div style="font-size: 28px; font-weight: 700;">${partner.gesamtBetrag.toFixed(2)}â‚¬</div>
                                <div style="font-size: 12px; opacity: 0.9;">Gesamt</div>
                            </div>
                            <i class="fas fa-chevron-down" id="prov-partner-${startIndex + index}-icon" style="font-size: 20px; transition: transform 0.3s;"></i>
                        </div>
                    </div>

                    <div id="prov-partner-${startIndex + index}-content" style="display: none; padding: 20px; background: #f7fafc;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Betrag</th>
                                    <th>Typ</th>
                                    <th>Tarif</th>
                                    <th>Datum</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${partner.provisionen.map(p => `
                                    <tr>
                                        <td><strong>â‚¬${parseFloat(p.betrag || 0).toFixed(2)}</strong></td>
                                        <td>${p.typ || 'N/A'}</td>
                                        <td>${p.tarif || 'N/A'}</td>
                                        <td>${new Date(p.datum).toLocaleDateString('de-DE')}</td>
                                        <td>
                                            ${p.status === 'ausgezahlt' 
                                                ? `<span class="badge badge-ausgezahlt" onclick="springZuProvisionen('ausgezahlt')" title="Klick: Ausgezahlte Provisionen anzeigen"><i class="fas fa-check-circle"></i> AUSGEZAHLT</span>`
                                                : p.status === 'ausstehend' 
                                                ? `<span class="badge badge-ausstehend" onclick="springZuProvisionen('ausstehend')" title="Klick: Ausstehende Provisionen anzeigen"><i class="fas fa-clock"></i> AUSSTEHEND</span>`
                                                : `<span class="badge badge-storniert" onclick="springZuProvisionen('storniert')" title="Klick: Stornierte Provisionen anzeigen"><i class="fas fa-times-circle"></i> STORNIERT</span>`
                                            }
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `).join('');

            const totalPages = Math.ceil(filteredProvisionenPartnerGroups.length / provisionenPerPage);
            document.getElementById('provisionen-page-info').textContent = `Seite ${provisionenCurrentPage} von ${totalPages}`;
            document.getElementById('provisionen-prev-btn').disabled = provisionenCurrentPage === 1;
            document.getElementById('provisionen-next-btn').disabled = provisionenCurrentPage >= totalPages;
        }

        function togglePartnerProvisionen(partnerId) {
            const content = document.getElementById(partnerId + '-content');
            const icon = document.getElementById(partnerId + '-icon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function provisionenPrevPage() {
            if (provisionenCurrentPage > 1) {
                provisionenCurrentPage--;
                renderProvisionenPage();
            }
        }

        function provisionenNextPage() {
            const totalPages = Math.ceil(filteredProvisionenPartnerGroups.length / provisionenPerPage);
            if (provisionenCurrentPage < totalPages) {
                provisionenCurrentPage++;
                renderProvisionenPage();
            }
        }

        function filterProvisionenByPartner() {
            const partnerFilter = document.getElementById('provisionen-partner-filter')?.value?.toLowerCase() || '';
            const typFilter = document.getElementById('provisionen-typ-filter')?.value || 'alle';
            const statusFilter = document.getElementById('provisionen-status-filter')?.value || 'alle';

            filteredProvisionenPartnerGroups = allProvisionenPartnerGroups.map(partner => {
                let filtered = partner.provisionen;

                if (typFilter !== 'alle') {
                    filtered = filtered.filter(p => p.typ === typFilter);
                }
                if (statusFilter !== 'alle') {
                    filtered = filtered.filter(p => p.status === statusFilter);
                }

                return {
                    ...partner,
                    provisionen: filtered,
                    anzahl: filtered.length,
                    gesamtBetrag: filtered.reduce((sum, p) => sum + parseFloat(p.betrag || 0), 0)
                };
            }).filter(partner => {
                if (partnerFilter && !partner.email.toLowerCase().includes(partnerFilter)) {
                    return false;
                }
                return partner.anzahl > 0;
            }).sort((a, b) => b.gesamtBetrag - a.gesamtBetrag);

            provisionenCurrentPage = 1;
            renderProvisionenPage();
        }

        // ğŸ’³ AUSZAHLUNGEN: Partner-basierte Ansicht
        function renderAuszahlungenByPartner(provisionen) {
            const partnerMap = {};
            provisionen.forEach(p => {
                const email = p.partner_email || 'Unbekannt';
                if (!partnerMap[email]) {
                    partnerMap[email] = {
                        email: email,
                        auszahlungen: [],
                        anzahl: 0,
                        gesamtBetrag: 0
                    };
                }
                partnerMap[email].auszahlungen.push(p);
                partnerMap[email].anzahl++;
                partnerMap[email].gesamtBetrag += parseFloat(p.betrag || 0);
            });

            allAuszahlungenPartnerGroups = Object.values(partnerMap).sort((a, b) => b.gesamtBetrag - a.gesamtBetrag);
            filteredAuszahlungenPartnerGroups = [...allAuszahlungenPartnerGroups];
            auszahlungenCurrentPage = 1;
            
            renderAuszahlungenPage();
        }

        function renderAuszahlungenPage() {
            const container = document.getElementById('auszahlungen-partner-list-all');
            if (!container) return;

            const startIndex = (auszahlungenCurrentPage - 1) * auszahlungenPerPage;
            const endIndex = startIndex + auszahlungenPerPage;
            const pageGroups = filteredAuszahlungenPartnerGroups.slice(startIndex, endIndex);

            if (pageGroups.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #718096;">Keine Auszahlungen gefunden.</div>';
                return;
            }

            container.innerHTML = pageGroups.map((partner, index) => `
                <div style="border: 2px solid #e2e8f0; border-radius: 12px; overflow: hidden; background: white;">
                    <div onclick="togglePartnerAuszahlungen('ausz-partner-${startIndex + index}')" 
                         style="padding: 16px 20px; background: linear-gradient(135deg, #ff9500 0%, #ff5e3a 100%); color: white; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s;">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div style="background: rgba(255,255,255,0.2); width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 700;">
                                ${partner.email.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div style="font-size: 18px; font-weight: 700;">${partner.email}</div>
                                <div style="font-size: 13px; opacity: 0.9;">${partner.anzahl} Auszahlungen</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 24px; align-items: center;">
                            <div style="text-align: center;">
                                <div style="font-size: 28px; font-weight: 700;">${partner.gesamtBetrag.toFixed(2)}â‚¬</div>
                                <div style="font-size: 12px; opacity: 0.9;">Gesamt</div>
                            </div>
                            <i class="fas fa-chevron-down" id="ausz-partner-${startIndex + index}-icon" style="font-size: 20px; transition: transform 0.3s;"></i>
                        </div>
                    </div>

                    <div id="ausz-partner-${startIndex + index}-content" style="display: none; padding: 20px; background: #f7fafc;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Betrag</th>
                                    <th>Datum</th>
                                    <th>Status</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${partner.auszahlungen.map(p => `
                                    <tr>
                                        <td><strong>â‚¬${parseFloat(p.betrag || 0).toFixed(2)}</strong></td>
                                        <td>${new Date(p.datum).toLocaleDateString('de-DE')}</td>
                                        <td>
                                            ${p.status === 'ausgezahlt' 
                                                ? `<span class="badge badge-ausgezahlt" onclick="springZuAuszahlungen('ausgezahlt')" title="Klick: Ausgezahlte Auszahlungen anzeigen"><i class="fas fa-check-circle"></i> AUSGEZAHLT</span>`
                                                : p.status === 'ausstehend' 
                                                ? `<span class="badge badge-ausstehend" onclick="springZuAuszahlungen('ausstehend')" title="Klick: Ausstehende Auszahlungen anzeigen"><i class="fas fa-clock"></i> AUSSTEHEND</span>`
                                                : `<span class="badge badge-storniert" onclick="springZuAuszahlungen('storniert')" title="Klick: Stornierte Auszahlungen anzeigen"><i class="fas fa-times-circle"></i> STORNIERT</span>`
                                            }
                                        </td>
                                        <td>
                                            ${p.status === 'ausstehend' ? '<button class="btn btn-sm btn-success" onclick="markAsAusgezahlt(\'' + p.id + '\')"><i class="fas fa-check"></i> Auszahlen</button>' : '-'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `).join('');

            const totalPages = Math.ceil(filteredAuszahlungenPartnerGroups.length / auszahlungenPerPage);
            document.getElementById('auszahlungen-page-info').textContent = `Seite ${auszahlungenCurrentPage} von ${totalPages}`;
            document.getElementById('auszahlungen-prev-btn').disabled = auszahlungenCurrentPage === 1;
            document.getElementById('auszahlungen-next-btn').disabled = auszahlungenCurrentPage >= totalPages;
        }

        function togglePartnerAuszahlungen(partnerId) {
            const content = document.getElementById(partnerId + '-content');
            const icon = document.getElementById(partnerId + '-icon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        /**
         * Markiert eine Auszahlung als "ausgezahlt"
         */
        async function markAsAusgezahlt(provisionId) {
            if (!confirm('MÃ¶chten Sie diese Auszahlung wirklich als "Ausgezahlt" markieren?')) {
                return;
            }
            
            try {
                console.log('ğŸ’³ Markiere Auszahlung als ausgezahlt:', provisionId);
                
                // Status auf "ausgezahlt" setzen + Datum speichern
                const response = await fetch(`tables/provisionen/${provisionId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        status: 'ausgezahlt',
                        ausgezahlt_am: new Date().toISOString()
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // Toast-Benachrichtigung
                showToast('âœ… Auszahlung erfolgreich als "Ausgezahlt" markiert!', 'success');
                
                // Daten neu laden
                setTimeout(() => {
                    loadAllInOneData();
                }, 500);
                
            } catch (error) {
                console.error('âŒ Fehler beim Markieren der Auszahlung:', error);
                showToast('âŒ Fehler: Auszahlung konnte nicht markiert werden.', 'error');
            }
        }
        
        function auszahlungenPrevPage() {
            if (auszahlungenCurrentPage > 1) {
                auszahlungenCurrentPage--;
                renderAuszahlungenPage();
            }
        }

        function auszahlungenNextPage() {
            const totalPages = Math.ceil(filteredAuszahlungenPartnerGroups.length / auszahlungenPerPage);
            if (auszahlungenCurrentPage < totalPages) {
                auszahlungenCurrentPage++;
                renderAuszahlungenPage();
            }
        }

        function filterAuszahlungenByPartner() {
            const partnerFilter = document.getElementById('auszahlungen-partner-filter')?.value?.toLowerCase() || '';
            const statusFilter = document.getElementById('auszahlungen-status-filter')?.value || 'alle';

            filteredAuszahlungenPartnerGroups = allAuszahlungenPartnerGroups.map(partner => {
                let filtered = partner.auszahlungen;

                if (statusFilter !== 'alle') {
                    filtered = filtered.filter(p => p.status === statusFilter);
                }

                return {
                    ...partner,
                    auszahlungen: filtered,
                    anzahl: filtered.length,
                    gesamtBetrag: filtered.reduce((sum, p) => sum + parseFloat(p.betrag || 0), 0)
                };
            }).filter(partner => {
                if (partnerFilter && !partner.email.toLowerCase().includes(partnerFilter)) {
                    return false;
                }
                return partner.anzahl > 0;
            }).sort((a, b) => b.gesamtBetrag - a.gesamtBetrag);

            auszahlungenCurrentPage = 1;
            renderAuszahlungenPage();
        }
    </script>
    
    <!-- Interessenten Detail Modal -->
    <div id="interessentModal" style="display: none;" class="modal-overlay">
        <div class="modal-content" style="max-width: 1200px; max-height: 95vh;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-user-circle"></i>
                    <span id="modalInteressentName">Interessent Details</span>
                </h2>
                <button class="close-btn" onclick="closeInteressentModal()">&times;</button>
            </div>

            <div id="modalContent" style="display: grid; grid-template-columns: 2fr 1fr; gap: 25px;">
                <!-- Linke Spalte: Daten -->
                <div>
                    <!-- PersÃ¶nliche Daten -->
                    <div style="background: var(--bg); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-user"></i> PersÃ¶nliche Daten
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;" id="modalPersonalData">
                        </div>
                    </div>

                    <!-- Business Informationen -->
                    <div style="background: var(--bg); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-briefcase"></i> Business Informationen
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;" id="modalBusinessData">
                        </div>
                        <div id="modalKiTools" style="margin-top: 15px;"></div>
                    </div>

                    <!-- Standort & Eigenkapital -->
                    <div style="background: var(--bg); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-map-marker-alt"></i> Standort & Finanzierung
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;" id="modalStandortKapital">
                        </div>
                    </div>

                    <!-- Website-Details (nur fÃ¼r Online-Shop) -->
                    <div id="modalWebsiteDetails" style="margin-bottom: 20px;">
                    </div>

                    <!-- System & KI-Tools -->
                    <div style="background: var(--bg); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-cogs"></i> System & KI-Tools
                        </h3>
                        <div id="modalSystemTools">
                        </div>
                    </div>

                    <!-- Notizen Section -->
                    <div style="background: var(--bg); padding: 20px; border-radius: 12px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-sticky-note"></i> Notizen
                        </h3>
                        <textarea id="modalNewNote" placeholder="Neue Notiz hinzufÃ¼gen..." 
                                  style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; min-height: 80px; font-family: inherit; resize: vertical;"></textarea>
                        <button onclick="addInteressentNote()" class="btn btn-primary" style="margin-top: 10px;">
                            <i class="fas fa-plus"></i> Notiz speichern
                        </button>
                        <div id="modalNotesList" style="margin-top: 20px;"></div>
                    </div>
                </div>

                <!-- Rechte Spalte: Actions & Status -->
                <div>
                    <!-- Status Card -->
                    <div style="background: var(--bg); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-traffic-light"></i> Status
                        </h3>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-size: 12px; color: var(--text-light); margin-bottom: 5px;">AKTUELLER STATUS</label>
                            <span id="modalCurrentStatus" class="badge" style="font-size: 14px; padding: 8px 15px;">-</span>
                        </div>
                        <select id="modalStatusSelect" onchange="changeInteressentStatus()" 
                                style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px; margin-top: 10px;">
                            <option value="neu">ğŸ†• Neu</option>
                            <option value="kontaktiert">ğŸ“ Kontaktiert</option>
                            <option value="termin_vereinbart">ğŸ“… Termin vereinbart</option>
                            <option value="qualifiziert">âœ… Qualifiziert</option>
                            <option value="abgelehnt">âŒ Abgelehnt</option>
                        </select>
                    </div>

                    <!-- Aktionen -->
                    <div style="background: var(--bg); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-bolt"></i> Schnell-Aktionen
                        </h3>
                        <button onclick="openTerminVereinbarenModalFromDetails()" class="btn btn-primary" style="width: 100%; margin-bottom: 10px; background: linear-gradient(135deg, #3b82f6, #60a5fa); border: none; box-shadow: 0 4px 12px rgba(102,126,234,0.3);">
                            <i class="fas fa-calendar-plus"></i> Termin vereinbaren
                        </button>
                        <button onclick="aktivierePartnerFromDetails()" class="btn" style="width: 100%; margin-bottom: 10px; background: linear-gradient(135deg, #48bb78, #38a169); color: white; border: none; box-shadow: 0 4px 12px rgba(72,187,120,0.3);">
                            <i class="fas fa-user-check"></i> Partner aktivieren
                        </button>
                        <button onclick="sendeEmailAnPartnerFromDetails()" class="btn" style="width: 100%; margin-bottom: 10px; background: linear-gradient(135deg, #4299e1, #3182ce); color: white; border: none; box-shadow: 0 4px 12px rgba(66,153,225,0.3);">
                            <i class="fas fa-envelope"></i> E-Mail senden
                        </button>
                        <button onclick="lehneAnfrageAbFromDetails()" class="btn" style="width: 100%; background: linear-gradient(135deg, #f56565, #e53e3e); color: white; border: none; box-shadow: 0 4px 12px rgba(245,101,101,0.3);">
                            <i class="fas fa-times-circle"></i> Anfrage ablehnen
                        </button>
                    </div>

                    <!-- Termine -->
                    <div style="background: var(--bg); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-calendar-alt"></i> Termine
                        </h3>
                        <div id="modalTermineList">
                            <p style="color: var(--text-light); text-align: center;">Keine Termine</p>
                        </div>
                    </div>

                    <!-- Zeitstempel -->
                    <div style="background: var(--bg); padding: 20px; border-radius: 12px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-clock"></i> Zeitstempel
                        </h3>
                        <div style="font-size: 13px;">
                            <div style="margin-bottom: 10px;">
                                <div style="color: var(--text-light); font-size: 11px; text-transform: uppercase;">Registriert am</div>
                                <div id="modalRegistriertAm" style="font-weight: 600;">-</div>
                            </div>
                            <div>
                                <div style="color: var(--text-light); font-size: 11px; text-transform: uppercase;">Letzte Aktualisierung</div>
                                <div id="modalUpdatedAt" style="font-weight: 600;">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Call Termin Modal -->
    <div id="callModal" style="display: none;" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-calendar-plus"></i> Call vereinbaren</h3>
                <button class="close-btn" onclick="closeCallModal()">&times;</button>
            </div>
            <div style="display: grid; gap: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Termin-Typ</label>
                    <select id="terminTyp" style="width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 8px;">
                        <option value="erstgespraech">ErstgesprÃ¤ch</option>
                        <option value="follow-up">Follow-up</option>
                        <option value="onboarding">Onboarding</option>
                        <option value="training">Training</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Datum & Uhrzeit</label>
                    <input type="datetime-local" id="terminDatum" style="width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 8px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Meeting Link (Zoom/Calendly)</label>
                    <input type="url" id="meetingLink" placeholder="https://calendly.com/..." style="width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 8px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Notizen (optional)</label>
                    <textarea id="terminNotizen" rows="3" style="width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 8px; resize: vertical;"></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="saveTermin()" class="btn btn-primary" style="flex: 1;">
                        <i class="fas fa-save"></i> Speichern
                    </button>
                    <button onclick="closeCallModal()" class="btn" style="flex: 1; background: var(--text-light); color: white;">
                        Abbrechen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Management Script -->
    <script src="js/task-management.js"></script>
    
    <!-- Umsatz-Tracking Script -->
    <script src="js/umsatz-tracking.js?v=20251201-final"></script>
    
    <!-- E-Mail & News System Script -->
    <script src="js/email-news-system.js"></script>
    <!-- Vertrags-Detail Modal -->
    <div id="vertragsDetailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
        <div style="background: white; border-radius: 15px; max-width: 1400px; width: 100%; max-height: 95vh; overflow-y: auto; position: relative;">
            <!-- Header -->
            <div style="position: sticky; top: 0; background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); color: white; padding: 20px 30px; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center; z-index: 10;">
                <h2 style="margin: 0; font-size: 1.5rem;">
                    <i class="fas fa-file-contract"></i> Vertrags-Details
                </h2>
                <button onclick="closeVertragsDetailModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Body -->
            <div id="vertragsDetailBody" style="padding: 30px;">
                <!-- Wird dynamisch gefÃ¼llt -->
            </div>
            
            <!-- Footer -->
            <div style="position: sticky; bottom: 0; background: var(--bg); padding: 20px 30px; border-radius: 0 0 15px 15px; display: flex; justify-content: space-between; align-items: center; border-top: 2px solid var(--border);">
                <div style="color: var(--text-light); font-size: 0.9rem;">
                    <i class="fas fa-info-circle"></i> Alle Ã„nderungen werden sofort gespeichert
                </div>
                <button onclick="closeVertragsDetailModal()" class="btn" style="background: var(--text-light); color: white;">
                    <i class="fas fa-times"></i> SchlieÃŸen
                </button>
            </div>
        </div>
    </div>

    <style>
        .detail-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .detail-item {
            padding: 8px 0;
            border-bottom: 1px solid var(--bg);
        }
        
        .detail-item:last-child {
            border-bottom: none;
        }
        
        .detail-item label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 3px;
        }
        
        .detail-item strong,
        .detail-item span,
        .detail-item code {
            display: block;
            font-size: 1rem;
            color: var(--text);
        }
        
        #vertragsDetailModal::-webkit-scrollbar {
            width: 10px;
        }
        
        #vertragsDetailModal::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        #vertragsDetailModal::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }
        
        #vertragsDetailModal::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>

    </div> <!-- END Container -->
    </div> <!-- END Main Content -->

    <!-- ğŸ« Ticket Modal -->
    <div id="ticket-modal-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9998;" onclick="closeTicketModal()"></div>
    <div id="ticket-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 20px; width: 90%; max-width: 700px; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 80px rgba(0,0,0,0.4); z-index: 9999;">
        <div style="padding: 2rem; border-bottom: 2px solid #e2e8f0; background: linear-gradient(135deg, #f093fb, #f5576c); color: white; border-radius: 20px 20px 0 0;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0; font-size: 1.5rem;"><i class="fas fa-ticket-alt"></i> Ticket Details</h2>
                <button onclick="closeTicketModal()" style="background: rgba(255,255,255,0.2); border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.5rem; color: white;">&times;</button>
            </div>
        </div>
        
        <div id="ticket-modal-content" style="padding: 2rem;"></div>
        
        <div style="padding: 1.5rem 2rem; border-top: 2px solid #e2e8f0; background: #f7fafc; border-radius: 0 0 20px 20px;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 700; color: #2d3748;">Antwort schreiben:</label>
            <textarea id="ticket-response" rows="3" placeholder="Deine Antwort..." style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 0.95rem; font-family: inherit; margin-bottom: 1rem; resize: vertical;"></textarea>
            
            <div style="display: flex; gap: 1rem;">
                <select id="ticket-status-select" style="flex: 1; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 0.95rem; font-weight: 600;">
                    <option value="offen">ğŸ”´ Offen</option>
                    <option value="in_bearbeitung">ğŸŸ¡ In Bearbeitung</option>
                    <option value="geloest">ğŸŸ¢ GelÃ¶st</option>
                </select>
                <button onclick="submitTicketResponse()" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #f093fb, #f5576c); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(240,147,251,0.3); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    <i class="fas fa-paper-plane"></i> Antworten
                </button>
            </div>
        </div>
    </div>

    <!-- ğŸ’¬ Chat Modal -->
    <div id="chat-modal-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9998;"></div>
    <div id="chat-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 20px; width: 90%; max-width: 800px; height: 80vh; box-shadow: 0 25px 80px rgba(0,0,0,0.4); z-index: 9999; flex-direction: column;">
        <!-- Header -->
        <div style="padding: 1.5rem 2rem; border-bottom: 2px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; border-radius: 20px 20px 0 0;">
            <div>
                <h2 style="margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-comments"></i> 
                    <span id="chat-partner-name">Chat</span>
                </h2>
                <p style="margin: 0.25rem 0 0 0; opacity: 0.9; font-size: 0.9rem;" id="chat-partner-email"></p>
            </div>
            <button onclick="closeChatModal()" style="background: rgba(255,255,255,0.2); border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.5rem; color: white; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                &times;
            </button>
        </div>
        
        <!-- Messages -->
        <div id="chat-messages" style="flex: 1; overflow-y: auto; padding: 2rem; background: #f7fafc;"></div>
        
        <!-- Input -->
        <div style="padding: 1.5rem 2rem; border-top: 2px solid #e2e8f0; background: white; border-radius: 0 0 20px 20px;">
            <div style="display: flex; gap: 1rem;">
                <textarea id="chat-input" rows="2" placeholder="Nachricht schreiben..." style="flex: 1; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 0.95rem; font-family: inherit; resize: none; transition: border 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'"></textarea>
                <button onclick="sendChatMessage()" style="padding: 0 1.5rem; background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(102,126,234,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(102,126,234,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102,126,234,0.3)'">
                    <i class="fas fa-paper-plane"></i> Senden
                </button>
            </div>
        </div>
    </div>

    <script>
        // ====================================
        // ğŸ« TICKET MODAL FUNKTIONEN
        // ====================================
        let currentTicket = null;
        let allTicketsData = [];
        
        async function openTicketModal(ticketId) {
            try {
                // Lade Tickets falls nicht vorhanden
                if (allTicketsData.length === 0) {
                    const res = await fetch('tables/tickets?limit=1000');
                    const data = await res.json();
                    allTicketsData = data.data;
                }
                
                currentTicket = allTicketsData.find(t => t.id === ticketId);
                if (!currentTicket) {
                    alert('Ticket nicht gefunden');
                    return;
                }
                
                document.getElementById('ticket-modal-overlay').style.display = 'block';
                document.getElementById('ticket-modal').style.display = 'block';
                
                // Setze Status-Select
                document.getElementById('ticket-status-select').value = currentTicket.status || 'offen';
                
                // Render Ticket
                const statusColors = {
                    'offen': {color: '#ed8936', text: 'ğŸ”´ Offen', bg: '#fff5e6'},
                    'in_bearbeitung': {color: '#4299e1', text: 'ğŸŸ¡ In Bearbeitung', bg: '#e6f2ff'},
                    'geloest': {color: '#48bb78', text: 'ğŸŸ¢ GelÃ¶st', bg: '#e6ffe6'}
                };
                const status = statusColors[currentTicket.status] || statusColors['offen'];
                
                const priorityColors = {
                    'hoch': '#f56565',
                    'mittel': '#ed8936',
                    'niedrig': '#48bb78'
                };
                
                let content = `
                    <div style="display: grid; gap: 1.5rem;">
                        <!-- Info Cards -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div style="padding: 1rem; background: ${status.bg}; border-left: 4px solid ${status.color}; border-radius: 8px;">
                                <div style="font-size: 0.85rem; color: #718096; font-weight: 600; margin-bottom: 0.25rem;">Status</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: ${status.color};">${status.text}</div>
                            </div>
                            <div style="padding: 1rem; background: #f7fafc; border-left: 4px solid ${priorityColors[currentTicket.prioritaet]}; border-radius: 8px;">
                                <div style="font-size: 0.85rem; color: #718096; font-weight: 600; margin-bottom: 0.25rem;">PrioritÃ¤t</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: ${priorityColors[currentTicket.prioritaet]};">${currentTicket.prioritaet || 'Mittel'}</div>
                            </div>
                        </div>
                        
                        <!-- Ticket Infos -->
                        <div style="background: #f7fafc; padding: 1.5rem; border-radius: 12px;">
                            <div style="display: grid; gap: 1rem;">
                                <div>
                                    <div style="font-size: 0.85rem; color: #718096; font-weight: 600; margin-bottom: 0.25rem;">Ticket-Nr.</div>
                                    <div style="font-weight: 700; color: #2d3748;">#${currentTicket.ticket_nr}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.85rem; color: #718096; font-weight: 600; margin-bottom: 0.25rem;">Partner</div>
                                    <div style="font-weight: 700; color: #2d3748;">${currentTicket.partner_name || 'N/A'}</div>
                                    <div style="font-size: 0.85rem; color: #a0aec0;">${currentTicket.partner_email || ''}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.85rem; color: #718096; font-weight: 600; margin-bottom: 0.25rem;">Betreff</div>
                                    <div style="font-weight: 700; color: #2d3748; font-size: 1.1rem;">${currentTicket.betreff}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.85rem; color: #718096; font-weight: 600; margin-bottom: 0.25rem;">Kategorie</div>
                                    <div><span style="background: #3b82f6; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">${currentTicket.kategorie || 'Allgemein'}</span></div>
                                </div>
                                <div>
                                    <div style="font-size: 0.85rem; color: #718096; font-weight: 600; margin-bottom: 0.25rem;">Erstellt am</div>
                                    <div style="color: #2d3748;">${new Date(currentTicket.erstellt_am).toLocaleString('de-DE')}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Nachricht -->
                        <div>
                            <div style="font-size: 0.85rem; color: #718096; font-weight: 600; margin-bottom: 0.75rem;">Nachricht:</div>
                            <div style="background: white; padding: 1.5rem; border: 2px solid #e2e8f0; border-radius: 12px; line-height: 1.6; color: #2d3748;">
                                ${currentTicket.nachricht || 'Keine Nachricht'}
                            </div>
                        </div>
                        
                        ${currentTicket.antwort ? `
                        <div style="background: #e6ffe6; padding: 1.5rem; border-left: 4px solid #48bb78; border-radius: 8px;">
                            <div style="font-size: 0.85rem; color: #2f855a; font-weight: 700; margin-bottom: 0.75rem;">âœ… Admin-Antwort:</div>
                            <div style="color: #2d3748; line-height: 1.6;">${currentTicket.antwort}</div>
                            <div style="font-size: 0.75rem; color: #718096; margin-top: 0.5rem;">Beantwortet am: ${new Date(currentTicket.beantwortet_am).toLocaleString('de-DE')}</div>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                document.getElementById('ticket-modal-content').innerHTML = content;
            } catch (error) {
                console.error('Fehler beim Laden des Tickets:', error);
                alert('Fehler beim Laden des Tickets');
            }
        }
        
        function closeTicketModal() {
            document.getElementById('ticket-modal-overlay').style.display = 'none';
            document.getElementById('ticket-modal').style.display = 'none';
            document.getElementById('ticket-response').value = '';
            currentTicket = null;
        }
        
        async function submitTicketResponse() {
            if (!currentTicket) return;
            
            const response = document.getElementById('ticket-response').value.trim();
            const newStatus = document.getElementById('ticket-status-select').value;
            
            if (!response) {
                alert('Bitte gib eine Antwort ein.');
                return;
            }
            
            try {
                const res = await fetch(`tables/tickets/${currentTicket.id}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        antwort: response,
                        status: newStatus,
                        beantwortet_am: new Date().toISOString()
                    })
                });
                
                if (res.ok) {
                    alert('âœ… Antwort wurde erfolgreich gesendet!');
                    closeTicketModal();
                    loadTickets(); // Reload
                    allTicketsData = []; // Reset cache
                } else {
                    alert('âŒ Fehler beim Senden der Antwort');
                }
            } catch (error) {
                console.error('Fehler:', error);
                alert('âŒ Fehler beim Senden der Antwort');
            }
        }
        
        // ====================================
        // ğŸ’¬ CHAT MODAL FUNKTIONEN
        // ====================================
        let currentChatPartner = null;
        let chatMessages = [];
        
        async function openChatModal(partnerEmail) {
            currentChatPartner = partnerEmail;
            
            document.getElementById('chat-modal-overlay').style.display = 'block';
            document.getElementById('chat-modal').style.display = 'flex';
            document.getElementById('chat-partner-email').textContent = partnerEmail;
            
            // Lade Nachrichten
            await loadChatConversation(partnerEmail);
        }
        
        function closeChatModal() {
            document.getElementById('chat-modal-overlay').style.display = 'none';
            document.getElementById('chat-modal').style.display = 'none';
            document.getElementById('chat-input').value = '';
            currentChatPartner = null;
        }
        
        async function loadChatConversation(partnerEmail) {
            try {
                const res = await fetch('tables/chat_nachrichten?limit=1000');
                const data = await res.json();
                
                chatMessages = data.data.filter(m => m.partner_email === partnerEmail)
                    .sort((a, b) => new Date(a.gesendet_am) - new Date(b.gesendet_am));
                
                renderChatMessages();
                
                // Scroll nach unten
                const container = document.getElementById('chat-messages');
                setTimeout(() => container.scrollTop = container.scrollHeight, 100);
            } catch (error) {
                console.error('Fehler beim Laden der Konversation:', error);
            }
        }
        
        function renderChatMessages() {
            const container = document.getElementById('chat-messages');
            
            if (chatMessages.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 4rem; color: #a0aec0;"><i class="fas fa-comment-slash" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i><p>Keine Nachrichten</p></div>';
                return;
            }
            
            let html = '';
            chatMessages.forEach(msg => {
                const isAdmin = msg.absender_typ === 'admin';
                const alignStyle = isAdmin ? 'flex-end' : 'flex-start';
                const bgColor = isAdmin ? 'linear-gradient(135deg, #3b82f6, #60a5fa)' : '#e2e8f0';
                const textColor = isAdmin ? 'white' : '#2d3748';
                
                html += `
                    <div style="display: flex; justify-content: ${alignStyle}; margin-bottom: 1rem;">
                        <div style="max-width: 70%; padding: 1rem 1.25rem; border-radius: 16px; background: ${bgColor}; color: ${textColor}; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; opacity: 0.9;">
                                ${isAdmin ? 'ğŸ‘¨â€ğŸ’¼ Admin' : 'ğŸ‘¤ ' + (msg.absender_name || 'Partner')}
                            </div>
                            <div style="line-height: 1.5; margin-bottom: 0.5rem;">
                                ${msg.nachricht}
                            </div>
                            <div style="font-size: 0.75rem; opacity: 0.7; text-align: right;">
                                ${new Date(msg.gesendet_am).toLocaleString('de-DE')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message || !currentChatPartner) return;
            
            try {
                const res = await fetch('tables/chat_nachrichten', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        partner_email: currentChatPartner,
                        absender_name: 'Admin',
                        absender_typ: 'admin',
                        nachricht: message,
                        gesendet_am: new Date().toISOString(),
                        gelesen: false
                    })
                });
                
                if (res.ok) {
                    input.value = '';
                    await loadChatConversation(currentChatPartner);
                } else {
                    alert('âŒ Fehler beim Senden der Nachricht');
                }
            } catch (error) {
                console.error('Fehler beim Senden:', error);
                alert('âŒ Fehler beim Senden der Nachricht');
            }
        }
        
        // Enter-Taste zum Senden
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.ctrlKey && document.getElementById('chat-modal').style.display === 'flex') {
                sendChatMessage();
            }
        });
    </script>
    
    <!-- MODAL: Neuer Termin (Admin) -->
    <div id="modal-neuer-termin" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
        <div style="background: white; border-radius: 16px; padding: 0; max-width: 700px; width: 90%; max-height: 90vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); padding: 32px; color: white;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; font-size: 28px; font-weight: 700;">
                        <i class="fas fa-calendar-plus"></i> Neuer Termin
                    </h3>
                    <button onclick="closeModalTermin()" style="background: rgba(255,255,255,0.2); border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; color: white; font-size: 20px; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div style="padding: 32px; max-height: calc(90vh - 140px); overflow-y: auto;">
                <div style="display: grid; gap: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568; font-size: 14px;">Titel*</label>
                        <input type="text" id="admin-termin-titel" placeholder="z.B. Partner-Meeting, Schulung, etc." style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px;" required>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568; font-size: 14px;">Datum*</label>
                            <input type="date" id="admin-termin-datum" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; cursor: pointer;" required>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568; font-size: 14px;">Uhrzeit*</label>
                            <input type="time" id="admin-termin-uhrzeit" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; cursor: pointer;" required>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568; font-size: 14px;">Partner (E-Mail)</label>
                            <input type="email" id="admin-termin-partner" placeholder="partner@example.com" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568; font-size: 14px;">Typ</label>
                            <select id="admin-termin-typ" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; cursor: pointer;">
                                <option value="Meeting">Meeting</option>
                                <option value="Schulung">Schulung</option>
                                <option value="Beratung">Beratung</option>
                                <option value="Follow-Up">Follow-Up</option>
                                <option value="Sonstiges">Sonstiges</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568; font-size: 14px;">Beschreibung</label>
                        <textarea id="admin-termin-beschreibung" placeholder="Optional..." style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; min-height: 100px; resize: vertical;"></textarea>
                    </div>
                </div>

                <!-- Buttons -->
                <div style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 24px; border-top: 1px solid #e2e8f0; margin-top: 24px;">
                    <button onclick="closeModalTermin()" style="padding: 12px 24px; background: #e2e8f0; color: #4a5568; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#cbd5e0'" onmouseout="this.style.background='#e2e8f0'">
                        Abbrechen
                    </button>
                    <button onclick="speichereAdminTermin()" style="padding: 12px 24px; background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 18px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)'">
                        <i class="fas fa-check"></i> Termin erstellen
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    // ğŸ“… ADMIN TERMIN FUNKTIONEN (falls noch nicht vorhanden)
    function closeModalTermin() {
        document.getElementById('modal-neuer-termin').style.display = 'none';
    }
    
    async function speichereAdminTermin() {
        try {
            const titel = document.getElementById('admin-termin-titel').value.trim();
            const datum = document.getElementById('admin-termin-datum').value;
            const uhrzeit = document.getElementById('admin-termin-uhrzeit').value;
            const partnerEmail = document.getElementById('admin-termin-partner').value.trim();
            const typ = document.getElementById('admin-termin-typ').value;
            const beschreibung = document.getElementById('admin-termin-beschreibung').value.trim();
            
            // Validierung
            if (!titel) {
                alert('âŒ Bitte gib einen Titel ein!');
                return;
            }
            if (!datum) {
                alert('âŒ Bitte wÃ¤hle ein Datum!');
                return;
            }
            if (!uhrzeit) {
                alert('âŒ Bitte wÃ¤hle eine Uhrzeit!');
                return;
            }
            
            // Termin speichern
            const response = await fetch('tables/termine', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    titel: titel,
                    datum: datum,
                    uhrzeit: uhrzeit,
                    typ: typ,
                    beschreibung: beschreibung,
                    partner_email: partnerEmail || null,
                    partner_name: null,
                    status: 'geplant',
                    erstellt_am: Date.now()
                })
            });
            
            if (!response.ok) {
                throw new Error('Fehler beim Speichern');
            }
            
            // Erfolgsmeldung
            alert(`âœ… Termin "${titel}" erfolgreich erstellt!\n\nDatum: ${new Date(datum).toLocaleDateString('de-DE')}\nUhrzeit: ${uhrzeit}`);
            
            // Modal schlieÃŸen & Termine neu laden
            closeModalTermin();
            loadTermine();
            renderCalendar();
            
        } catch (error) {
            console.error('Fehler beim Speichern des Termins:', error);
            alert('âŒ Fehler beim Erstellen des Termins!\n\n' + error.message);
        }
    }
    </script>

    <!-- ğŸš€ AUTO-SEED: LÃ¤dt 300+ Partner automatisch falls DB leer -->
    <script src="js/auto-seed-partners.js"></script>

</body>
</html>
