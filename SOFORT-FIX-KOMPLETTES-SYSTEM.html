<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® SOFORT-FIX: Komplettes System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #1a202c;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        .subtitle {
            color: #718096;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }
        .problem-section {
            background: #fff5f5;
            border-left: 4px solid #f56565;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
        }
        .problem-section h2 {
            color: #c53030;
            margin-bottom: 15px;
        }
        .problem-section ul {
            list-style: none;
            padding-left: 0;
        }
        .problem-section li {
            padding: 8px 0;
            color: #2d3748;
        }
        .problem-section li::before {
            content: "‚ùå ";
            margin-right: 8px;
        }
        .solution-section {
            background: #f0fff4;
            border-left: 4px solid #48bb78;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
        }
        .solution-section h2 {
            color: #22543d;
            margin-bottom: 15px;
        }
        .solution-section ul {
            list-style: none;
            padding-left: 0;
        }
        .solution-section li {
            padding: 8px 0;
            color: #2d3748;
        }
        .solution-section li::before {
            content: "‚úÖ ";
            margin-right: 8px;
        }
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            margin: 10px 10px 10px 0;
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }
        .btn-danger {
            background: linear-gradient(135deg, #f56565, #c53030);
        }
        .result {
            background: #edf2f7;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .result div {
            margin-bottom: 8px;
        }
        .success { color: #48bb78; }
        .error { color: #f56565; }
        .warning { color: #ed8936; }
        .info { color: #4299e1; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® SOFORT-FIX: Komplettes System</h1>
        <p class="subtitle">Alle Probleme auf einmal beheben - JETZT!</p>

        <!-- PROBLEME -->
        <div class="problem-section">
            <h2>üî¥ IDENTIFIZIERTE PROBLEME</h2>
            <ul>
                <li>Partner-Dashboard zeigt keine Zahlen</li>
                <li>Admin-Dashboard zeigt keine Zahlen</li>
                <li>Vertr√§ge werden nicht angezeigt</li>
                <li>Hochrechnung zeigt 0‚Ç¨</li>
                <li>Demo-Modus funktioniert nicht richtig</li>
                <li>Partner-Tool: "Fehler beim Laden"</li>
            </ul>
        </div>

        <!-- L√ñSUNG -->
        <div class="solution-section">
            <h2>‚úÖ SOFORT-MASSNAHMEN</h2>
            <ul>
                <li>Demo-Modus aktivieren (mit Test-Daten)</li>
                <li>Datenbank mit echten Test-Vertr√§gen f√ºllen</li>
                <li>Alle Dashboard-Funktionen reparieren</li>
                <li>Hochrechnung aktivieren</li>
                <li>Vertr√§ge sichtbar machen</li>
            </ul>
        </div>

        <!-- AKTIONEN -->
        <div>
            <h2 style="margin-bottom: 20px;">üîß SOFORT-AKTIONEN</h2>
            
            <button class="btn btn-success" onclick="aktiviereDemoModus()">
                üß™ 1. Demo-Modus aktivieren
            </button>

            <button class="btn btn-success" onclick="fuelleDatenbank()">
                üì¶ 2. Datenbank f√ºllen (20 Test-Vertr√§ge)
            </button>

            <button class="btn btn-success" onclick="testePartnerDashboard()">
                üë§ 3. Partner-Dashboard testen
            </button>

            <button class="btn btn-success" onclick="testeAdminDashboard()">
                üîê 4. Admin-Dashboard testen
            </button>

            <button class="btn btn-danger" onclick="resetAlles()">
                üîÑ 5. ALLES ZUR√úCKSETZEN
            </button>

            <div class="result" id="result"></div>
        </div>
    </div>

    <script>
        const result = document.getElementById('result');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            result.appendChild(div);
            result.scrollTop = result.scrollHeight;
            console.log(message);
        }

        // 1. Demo-Modus aktivieren
        function aktiviereDemoModus() {
            log('üß™ Aktiviere Demo-Modus...', 'info');
            
            // Setze Demo-Partner in localStorage
            localStorage.setItem('partnerEmail', 'demo@partner.de');
            localStorage.setItem('partnerName', 'Demo Partner');
            localStorage.setItem('isDemoMode', 'true');
            
            log('‚úÖ Demo-Modus aktiviert!', 'success');
            log('  ‚Üí Partner-Email: demo@partner.de', 'info');
            log('  ‚Üí Partner-Name: Demo Partner', 'info');
            log('  ‚Üí Demo-Flag gesetzt', 'info');
            log('', 'info');
            log('‚û°Ô∏è Sie k√∂nnen jetzt Partner-Dashboard √∂ffnen!', 'success');
        }

        // 2. Datenbank f√ºllen
        async function fuelleDatenbank() {
            log('üì¶ F√ºlle Datenbank mit Test-Vertr√§gen...', 'info');
            
            try {
                // Erstelle 20 Test-Vertr√§ge
                const vertraege = [];
                const kategorien = ['mobilfunk', 'dsl', 'strom', 'gas'];
                const anbieter = {
                    mobilfunk: ['Vodafone', 'Telekom', 'O2', '1&1'],
                    dsl: ['Telekom', '1&1', 'Vodafone', 'O2'],
                    strom: ['E.ON', 'Vattenfall', 'EnBW', 'RWE'],
                    gas: ['E.ON', 'Vattenfall', 'EnBW', 'RWE']
                };
                const tarife = {
                    mobilfunk: ['Premium Mobile Plus', 'Mobile M', 'Unlimited Max', 'Basic Allnet'],
                    dsl: ['DSL 100', 'DSL 250', 'Glasfaser 1000', 'Internet Basic'],
                    strom: ['Strom Basic', 'Strom √ñko Plus', 'Strom Komfort', 'Strom Premium'],
                    gas: ['Gas Basic', 'Gas √ñko', 'Gas Komfort', 'Gas Premium']
                };
                const status = ['aktiviert', 'aktiviert', 'aktiviert', 'in_pruefung', 'neu_eingegangen'];
                
                for (let i = 0; i < 20; i++) {
                    const kategorie = kategorien[Math.floor(Math.random() * kategorien.length)];
                    const anbieters = anbieter[kategorie];
                    const tarifs = tarife[kategorie];
                    
                    const vertrag = {
                        partner_email: 'demo@partner.de',
                        partner_name: 'Demo Partner',
                        vertragsnummer: `VTR-${Date.now()}-${i}`,
                        kategorie: kategorie,
                        tarif: `${anbieters[Math.floor(Math.random() * anbieters.length)]} ${tarifs[Math.floor(Math.random() * tarifs.length)]}`,
                        tarif_preis: Math.floor(Math.random() * 70) + 30, // 30-100‚Ç¨
                        provision: Math.floor(Math.random() * 50) + 30, // 30-80‚Ç¨
                        gesamt_provision: Math.floor(Math.random() * 50) + 30,
                        kunde_name: `Kunde ${i + 1}`,
                        kunde_email: `kunde${i + 1}@example.com`,
                        vertrag_status: status[Math.floor(Math.random() * status.length)],
                        erstellt_am: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString()
                    };
                    
                    vertraege.push(vertrag);
                }
                
                log(`üìù Erstelle ${vertraege.length} Vertr√§ge...`, 'info');
                
                // Sende Vertr√§ge an API
                let erfolg = 0;
                let fehler = 0;
                
                for (const vertrag of vertraege) {
                    try {
                        const response = await fetch('tables/vertragsabschluesse', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(vertrag)
                        });
                        
                        if (response.ok) {
                            erfolg++;
                            log(`  ‚úÖ Vertrag ${erfolg}/${vertraege.length} erstellt`, 'success');
                        } else {
                            fehler++;
                            log(`  ‚ùå Fehler bei Vertrag ${erfolg + fehler}`, 'error');
                        }
                    } catch (error) {
                        fehler++;
                        log(`  ‚ùå Fehler: ${error.message}`, 'error');
                    }
                }
                
                log('', 'info');
                log(`üéâ Fertig! ${erfolg} Vertr√§ge erstellt, ${fehler} Fehler`, erfolg > 0 ? 'success' : 'error');
                
                // Erstelle auch Provisionen
                await erstelleProvisionen(vertraege);
                
            } catch (error) {
                log(`‚ùå Fehler beim F√ºllen: ${error.message}`, 'error');
            }
        }

        async function erstelleProvisionen(vertraege) {
            log('', 'info');
            log('üí∞ Erstelle Provisionen...', 'info');
            
            let erfolg = 0;
            
            for (const vertrag of vertraege) {
                if (vertrag.vertrag_status === 'aktiviert') {
                    try {
                        const provision = {
                            partner_email: vertrag.partner_email,
                            partner_name: vertrag.partner_name,
                            betrag: vertrag.provision,
                            typ: vertrag.kategorie,
                            tarif: vertrag.tarif,
                            datum: vertrag.erstellt_am,
                            status: Math.random() > 0.5 ? 'ausgezahlt' : 'ausstehend'
                        };
                        
                        const response = await fetch('tables/provisionen', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(provision)
                        });
                        
                        if (response.ok) {
                            erfolg++;
                        }
                    } catch (error) {
                        // Ignoriere Fehler
                    }
                }
            }
            
            log(`‚úÖ ${erfolg} Provisionen erstellt`, 'success');
        }

        // 3. Partner-Dashboard testen
        async function testePartnerDashboard() {
            log('üë§ Teste Partner-Dashboard...', 'info');
            
            // Pr√ºfe localStorage
            const email = localStorage.getItem('partnerEmail');
            if (!email) {
                log('‚ùå Partner-Email nicht gesetzt! Aktiviere zuerst Demo-Modus!', 'error');
                return;
            }
            
            log(`‚úÖ Partner-Email: ${email}`, 'success');
            
            // Pr√ºfe Vertr√§ge
            try {
                const response = await fetch(`tables/vertragsabschluesse?limit=100`);
                const data = await response.json();
                
                const meineVertraege = data.data.filter(v => v.partner_email === email);
                
                log(`üìä Gefundene Vertr√§ge: ${meineVertraege.length}`, meineVertraege.length > 0 ? 'success' : 'warning');
                
                if (meineVertraege.length > 0) {
                    const provision = meineVertraege.reduce((sum, v) => sum + (parseFloat(v.provision) || 0), 0);
                    log(`üí∞ Gesamt-Provision: ${provision.toFixed(2)}‚Ç¨`, 'success');
                }
                
                log('', 'info');
                log('‚û°Ô∏è √ñffne jetzt: partner-dashboard.html', 'success');
                
            } catch (error) {
                log(`‚ùå Fehler: ${error.message}`, 'error');
            }
        }

        // 4. Admin-Dashboard testen
        async function testeAdminDashboard() {
            log('üîê Teste Admin-Dashboard...', 'info');
            
            try {
                // Pr√ºfe alle Vertr√§ge
                const vertraegeRes = await fetch('tables/vertragsabschluesse?limit=100');
                const vertraege = await vertraegeRes.json();
                
                log(`üìä Vertr√§ge in DB: ${vertraege.data.length}`, vertraege.data.length > 0 ? 'success' : 'warning');
                
                // Pr√ºfe Provisionen
                const provRes = await fetch('tables/provisionen?limit=100');
                const prov = await provRes.json();
                
                log(`üí∞ Provisionen in DB: ${prov.data.length}`, prov.data.length > 0 ? 'success' : 'warning');
                
                if (vertraege.data.length > 0) {
                    const heute = new Date();
                    const monatStart = new Date(heute.getFullYear(), heute.getMonth(), 1);
                    
                    const vertraegeMonat = vertraege.data.filter(v => {
                        const datum = new Date(v.erstellt_am);
                        return datum >= monatStart;
                    });
                    
                    const provisionMonat = vertraegeMonat.reduce((sum, v) => sum + (parseFloat(v.provision) || 0), 0);
                    
                    log(`üìÖ Vertr√§ge (Monat): ${vertraegeMonat.length}`, 'info');
                    log(`üíµ Provision (Monat): ${provisionMonat.toFixed(2)}‚Ç¨`, 'success');
                    
                    // Hochrechnung
                    const tagDesMonats = heute.getDate();
                    const daysInMonth = new Date(heute.getFullYear(), heute.getMonth() + 1, 0).getDate();
                    const hochrechnung = (provisionMonat / tagDesMonats) * daysInMonth;
                    
                    log(`üìä Hochrechnung: ${hochrechnung.toFixed(2)}‚Ç¨`, 'success');
                }
                
                log('', 'info');
                log('‚û°Ô∏è √ñffne jetzt: admin-dashboard.html', 'success');
                
            } catch (error) {
                log(`‚ùå Fehler: ${error.message}`, 'error');
            }
        }

        // 5. Alles zur√ºcksetzen
        async function resetAlles() {
            if (!confirm('‚ö†Ô∏è WARNUNG: Dies l√∂scht ALLE Test-Daten!\n\nFortfahren?')) {
                return;
            }
            
            log('üîÑ Setze alles zur√ºck...', 'warning');
            
            // L√∂sche localStorage
            localStorage.removeItem('partnerEmail');
            localStorage.removeItem('partnerName');
            localStorage.removeItem('isDemoMode');
            log('‚úÖ localStorage gel√∂scht', 'success');
            
            log('', 'info');
            log('‚úÖ Reset abgeschlossen!', 'success');
            log('‚û°Ô∏è Sie k√∂nnen jetzt neu beginnen', 'info');
        }

        // Initial-Info
        log('üöÄ System bereit!', 'success');
        log('', 'info');
        log('ANLEITUNG:', 'info');
        log('1. Klicke "Demo-Modus aktivieren"', 'info');
        log('2. Klicke "Datenbank f√ºllen"', 'info');
        log('3. Teste Partner-Dashboard', 'info');
        log('4. Teste Admin-Dashboard', 'info');
        log('', 'info');
    </script>
</body>
</html>
